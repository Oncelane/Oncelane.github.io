<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>åç¨‹åº“-fcontextåç¨‹åˆ‡æ¢</title>
      <link href="/2024/08/17/xiechengkufcontextxiechengqiehuan/"/>
      <url>/2024/08/17/xiechengkufcontextxiechengqiehuan/</url>
      
        <content type="html"><![CDATA[<h1 id="åç¨‹åº“åŸç†ä¹‹åç¨‹åˆ‡æ¢"><a href="#åç¨‹åº“åŸç†ä¹‹åç¨‹åˆ‡æ¢" class="headerlink" title="åç¨‹åº“åŸç†ä¹‹åç¨‹åˆ‡æ¢"></a>åç¨‹åº“åŸç†ä¹‹åç¨‹åˆ‡æ¢</h1><span id="more"></span><p>åç¨‹åˆ†ä¸ºæœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹ï¼Œä½†å®ƒä»¬è¿›è¡Œåç¨‹åˆ‡æ¢çš„æ ¸å¿ƒè¿‡ç¨‹æ˜¯ä¸€è‡´çš„ã€‚</p><p>æ— éå°±æ˜¯å°†å¯„å­˜å™¨ä¸Šçš„å€¼ä¿å­˜åˆ°ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ï¼Œæˆ–è€…åè¿‡æ¥ï¼Œå°†ä¹‹å‰ä¿å­˜å¥½çš„ä¸Šä¸‹æ–‡æ”¾åˆ°å½“å‰å¯„å­˜å™¨ä¸­</p><p>æˆ‘ä»¬å…ˆå­¦ä¹ ucontextçš„ä½¿ç”¨ï¼Œå†æ¥è§£é‡Šå¦‚ä½•ç”¨fcontextä»£æ›¿ucontextå®ç°æ›´é«˜æ•ˆçš„åˆ‡æ¢æ•ˆç‡</p><p>ä½¿ç”¨linuxä¸‹çš„ucontextè¿›è¡Œåç¨‹åˆ‡æ¢éå¸¸ç®€å•ï¼Œæ€»å…±åªéœ€è¦ç”¨åˆ°ä¸‰ä¸ªæ¥å£å’Œä¸€ä¸ªç»“æ„ä½“</p><ol><li><p>int getcontext(ucontext_t *ucp);</p><blockquote><p>è·å–å½“å‰ä¸Šä¸‹æ–‡</p></blockquote></li><li><p>void makecontext(ucontext_t *ucp, void (*func)(), int argc, â€¦);</p><blockquote><p>åˆå§‹åŒ–ä¸Šä¸‹æ–‡ï¼Œä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆä¸ºä¸Šä¸‹æ–‡å°†æ‰§è¡Œçš„å‡½æ•°ä½“</p></blockquote></li><li><p>int swapcontext(ucontext_t  *oucp, const ucontext_t *ucp);</p><blockquote><p>ä¿å­˜å’Œåˆ‡æ¢ä¸Šä¸‹æ–‡</p></blockquote></li></ol><p>ucontext_tç»“æ„ä½“å®šä¹‰å¦‚ä¸‹</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ucontext</span> <span class="token punctuation">{</span>              <span class="token keyword">struct</span> <span class="token class-name">ucontext</span> <span class="token operator">*</span>uc_link<span class="token punctuation">;</span><span class="token comment">// uc_link å½“å‰åç¨‹æ‰§è¡Œå®Œæ¯•åé»˜è®¤è·³è½¬åˆ°çš„ä¸‹ä¸€ä¸ªä¸Šä¸‹æ–‡</span>              sigset_t         uc_sigmask<span class="token punctuation">;</span><span class="token comment">// ä¿¡å·æ©ç </span>              stack_t          uc_stack<span class="token punctuation">;</span><span class="token comment">// æ ˆæŒ‡é’ˆ</span>              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>          <span class="token punctuation">}</span> ucontext_t<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œè®©gptå¸®å¿™å†™ä¸€ä¸ªdemoå¸®åŠ©ç†è§£ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucontext.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STACK_SIZE</span> <span class="token expression"><span class="token number">8192</span></span></span>ucontext_t main_context<span class="token punctuation">;</span>ucontext_t ctx1<span class="token punctuation">,</span> ctx2<span class="token punctuation">;</span><span class="token keyword">char</span> stack1<span class="token punctuation">[</span>STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">char</span> stack2<span class="token punctuation">[</span>STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// åç¨‹1</span><span class="token keyword">void</span> <span class="token function">coroutine1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Coroutine 1: Start\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åˆ‡æ¢åˆ°åç¨‹2</span>    <span class="token function">swapcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Coroutine 1: End\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// åç¨‹2</span><span class="token keyword">void</span> <span class="token function">coroutine2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Coroutine 2: Start\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åˆ‡æ¢åˆ°åç¨‹1</span>    <span class="token function">swapcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Coroutine 2: End\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// åˆå§‹åŒ–åç¨‹1ä¸Šä¸‹æ–‡</span>    <span class="token function">getcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx1<span class="token punctuation">)</span><span class="token punctuation">;</span>    ctx1<span class="token punctuation">.</span>uc_link <span class="token operator">=</span> <span class="token operator">&amp;</span>main_context<span class="token punctuation">;</span>  <span class="token comment">// å½“åç¨‹1å®Œæˆåï¼Œè¿”å›åˆ°ä¸»ä¸Šä¸‹æ–‡</span>    ctx1<span class="token punctuation">.</span>uc_stack<span class="token punctuation">.</span>ss_sp <span class="token operator">=</span> stack1<span class="token punctuation">;</span>    ctx1<span class="token punctuation">.</span>uc_stack<span class="token punctuation">.</span>ss_size <span class="token operator">=</span> STACK_SIZE<span class="token punctuation">;</span>    <span class="token function">makecontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx1<span class="token punctuation">,</span> coroutine1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åˆå§‹åŒ–åç¨‹2ä¸Šä¸‹æ–‡</span>    <span class="token function">getcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx2<span class="token punctuation">)</span><span class="token punctuation">;</span>    ctx2<span class="token punctuation">.</span>uc_link <span class="token operator">=</span> <span class="token operator">&amp;</span>main_context<span class="token punctuation">;</span>  <span class="token comment">// å½“åç¨‹2å®Œæˆåï¼Œè¿”å›åˆ°ä¸»ä¸Šä¸‹æ–‡</span>    ctx2<span class="token punctuation">.</span>uc_stack<span class="token punctuation">.</span>ss_sp <span class="token operator">=</span> stack2<span class="token punctuation">;</span>    ctx2<span class="token punctuation">.</span>uc_stack<span class="token punctuation">.</span>ss_size <span class="token operator">=</span> STACK_SIZE<span class="token punctuation">;</span>    <span class="token function">makecontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx2<span class="token punctuation">,</span> coroutine2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// å¯åŠ¨åç¨‹1</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Main: Starting Coroutine 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">swapcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>main_context<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Main: All coroutines completed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç”¨æ³•å°±æ˜¯ä½¿ç”¨getcontext + makecontextåˆå§‹åŒ–åç¨‹çš„ä¸Šä¸‹æ–‡ç»“æ„ä½“ï¼Œ</p><p>ç„¶åè°ƒç”¨swapcontextè¿›è¡Œåç¨‹ä¸Šä¸‹æ–‡çš„<strong>åˆ‡æ¢</strong>å’Œ<strong>ä¿å­˜</strong></p><p>ä¸Šé¢demoçš„ä»£ç æµä¸ºï¼š</p><blockquote><ol><li><p>ä¸»çº¿ç¨‹ -&gt; åç¨‹1</p></li><li><p>åç¨‹1 -&gt; åç¨‹2</p></li><li><p>åç¨‹2 -&gt; åç¨‹1</p></li><li><p>åç¨‹1 -&gt; ä¸»åç¨‹</p></li></ol></blockquote><p>è¿™å°±æ˜¯éå¸¸ç»å…¸çš„å¯¹ç§°åç¨‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåç¨‹å¯ä»¥ç›´æ¥åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåç¨‹ä¸­ï¼Œå¥½ä¼¼åŒæ–¹åœ°ä½å¯¹ç­‰ï¼Œå¤šä¹ˆç¾å¥½ã€‚</p><p>å¯¹åº”çš„è¿˜æœ‰éå¯¹ç§°åç¨‹ï¼šæ‰€æœ‰åç¨‹åˆ†ä¸ºä¸¤ç±»ï¼Œå”¯ä¸€çš„ä¸»åç¨‹å’Œè®¸å¤šå­åç¨‹</p><p>åœ¨çº¿ç¨‹å±€éƒ¨å˜é‡ä¸­ä¿å­˜å”¯ä¸€çš„ä¸»åç¨‹ï¼Œå› æ­¤ä¹Ÿå¯ä»¥è¯´ä¸»åç¨‹æ˜¯çº¿ç¨‹æœ¬èº«</p><p>ä¸»åç¨‹å¯ä»¥åˆ‡æ¢åˆ°ä»»æ„å­åç¨‹ï¼Œä½†æ˜¯å­åç¨‹åªèƒ½åˆ‡æ¢ä¸ºä¸»åç¨‹ï¼Œå³å­åç¨‹1åˆ‡æ¢åˆ°å­åç¨‹2çš„æœ€çŸ­æµç¨‹ä¸ºï¼š</p><blockquote><ol><li><p>åç¨‹1 -&gt; ä¸»åç¨‹</p></li><li><p>ä¸»åç¨‹ -&gt; åç¨‹2</p></li></ol><p>çµæ´»æ€§ç›¸æ¯”demoä¸­å±•ç¤ºå·®äº†è®¸å¤šï¼Œè¿˜æœ‰é¢å¤–çš„cpuå¼€é”€</p></blockquote><p>é‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘çš„åç¨‹åº“è¿˜æ˜¯é‡‡ç”¨éå¯¹ç§°åç¨‹è®¾è®¡å‘¢ï¼Ÿ</p><p>å› ä¸ºå¯¹ç§°åç¨‹åœ¨å®é™…ä½¿ç”¨ä¸­ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œåç¨‹åˆ‡æ¢ä¸åº”è¯¥æ˜¯æ‰‹åŠ¨çš„ï¼ˆå¦‚æœæ˜¯ï¼Œé‚£å°±æ˜¯çº¯çº¯çš„çŠ¶æ€æœºï¼Œè€Œä¸”æ˜¯æ‰‹æ“çš„çŠ¶æ€ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´åç¨‹åº“éœ€è¦ä¿è¯æ¯ä¸€ä¸ªåç¨‹éƒ½èƒ½é€šè¿‡æŸç§æ–¹å¼è‡ªåŠ¨å¾—çŸ¥å®ƒçš„ä¸‹ä¸€ä¸ªæ¥æ‰‹çº¿ç¨‹æ§åˆ¶æƒçš„åç¨‹æ˜¯è°ã€‚</p><p>å¦‚æœé‡‡ç”¨ç±»ä¼¼ä¸Šé¢å¯¹ç§°åç¨‹çš„è®¾è®¡ä¼šå¯¼è‡´å¾ˆä¸¥é‡çš„ä»£ç å¤æ‚åº¦ï¼Œä»£ç å¤æ‚åº¦åŒæ ·åè¿‡æ¥å½±å“æ€§èƒ½ã€‚</p><p>å› æ­¤ä¸‹é¢ä¸ä»…å°†ucontextåˆ‡æ¢æ–¹å¼æ”¹ä¸ºfcontextï¼ŒåŒæ—¶è¿˜å°†åˆæ­¥è®¾è®¡ä¸€ä¸ªéå¯¹ç§°åç¨‹çš„æœ€å°æ¨¡å‹</p><h1 id="fcontext"><a href="#fcontext" class="headerlink" title="fcontext"></a>fcontext</h1><blockquote><p>fcontextåœ¨1.61ç‰ˆæœ¬ä¹‹å‰çš„apiä¸ucontextä¸èƒ½è¯´ç±»ä¼¼ï¼Œåªèƒ½è¯´ä¸€æ‘¸ä¸€æ ·! åŸºæœ¬ä»€ä¹ˆä¹Ÿä¸ç”¨åšï¼Œæ”¹æ”¹å‡½æ•°åå°±èƒ½å®Œæˆå‡çº§</p><p>1.61ä¹‹åçš„boostå¯¹fcontextåº“åšäº†è®¸å¤šæ”¹åŠ¨ï¼Œå¯¼è‡´apiä½¿ç”¨æ–¹å¼ä¸ä¹‹å‰æœ‰äº†å¾ˆå¤§çš„ä¸åŒï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•å®˜æ–¹æ–‡æ¡£ï¼ï¼ï¼</p><p>æœ¬äººè¢«è¿«è¿›è¡Œäº†ä¸ºæœŸä¸€å¤©çš„æµ‹è¯•ï¼ŒåŸºæœ¬æ‘¸æ¸…äº†æ¥å£ç”¨æ³•</p></blockquote><p>fcontextçš„æ¥å£æœ‰ä¸‰ä¸ªï¼Œç»“æ„ä½“ä¸¤ä¸ªï¼š</p><ol><li><p>transfer_t  jump_fcontext( fcontext_t const to, void * vp);</p></li><li><p>fcontext_t  make_fcontext( void * sp, std::size_t size, void (* fn)( transfer_t) );</p></li><li><p>transfer_t  ontop_fcontext( fcontext_t const to, void * vp, transfer_t (* fn)( transfer_t) );</p></li></ol><p>fcontext_tï¼š å­æ®µä¸é‡è¦ï¼Œåªéœ€è¦çŸ¥é“å®ƒä¿å­˜äº†åç¨‹ä¸Šä¸‹æ–‡</p><p>transfer_t çš„å®šä¹‰å¦‚ä¸‹ï¼š </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">transfer_t</span> <span class="token punctuation">{</span>    fcontext_t  fctx<span class="token punctuation">;</span> <span class="token comment">// from åç¨‹ä¸Šä¸‹æ–‡ ï¼ˆfromï¼ï¼‰</span>    <span class="token keyword">void</span>    <span class="token operator">*</span>   data<span class="token punctuation">;</span> <span class="token comment">// é€ä¼ æŒ‡é’ˆ</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å®Œæ•´æºç å¦‚ä¸‹ï¼Œæ˜å¤©å†è§£æ</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;boost/context/detail/fcontext.hpp&gt;</span> <span class="token comment">//ä¸»è§’</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstddef&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> boost<span class="token double-colon punctuation">::</span>context<span class="token double-colon punctuation">::</span>detail<span class="token punctuation">;</span><span class="token comment">// å†…å­˜åˆ†é…æ¥å£ï¼Œå¯ä»¥ä¼˜åŒ–æˆå†…å­˜æ± </span><span class="token keyword">class</span> <span class="token class-name">Allocator</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">Alloc</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Dealloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> vp<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">free</span><span class="token punctuation">(</span>vp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">fFiber</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">thread_local</span> fFiber<span class="token operator">*</span> t_threadFiber<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">fFiber</span> <span class="token punctuation">{</span><span class="token keyword">private</span><span class="token operator">:</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">using</span> callBack <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">// æ— å‚æ„é€ ï¼Œç”¨äºæ„é€ æœ¬çº¿ç¨‹çš„ä¸»åç¨‹</span>    <span class="token function">fFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">m_stack</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_stackSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//ç©ºçš„ï¼Œåªæ˜¯éœ€è¦ç”¨åˆ°m_fctxæ¥å­˜ä¸€äº›ä¸œè¥¿</span>    <span class="token punctuation">}</span>    <span class="token comment">// å«å‚æ„é€ ï¼Œç”¨äºæ„é€ ä¸€ä¸ªå°†æ‰§è¡Œcbå‡½æ•°çš„åç¨‹å¯¹è±¡</span>    <span class="token function">fFiber</span><span class="token punctuation">(</span>callBack _cb<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">m_cb</span><span class="token punctuation">(</span>_cb<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_stackSize</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// ä½¿ç”¨malloc,åˆ†é…åç¨‹æ ˆï¼Œè¿™é‡Œå›ºå®šä¸º4kå¤§å°</span>        <span class="token comment">// (é—®é¢˜1ï¼šå¯ä»¥çŒœæµ‹ä¸ºä»€ä¹ˆä¸ç”¨newï¼Ÿ)</span>        m_stack <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token class-name">Allocator</span><span class="token double-colon punctuation">::</span><span class="token function">Alloc</span><span class="token punctuation">(</span>m_stackSize<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// æ„é€ ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œè¦æ‰§è¡Œçš„å‡½æ•°ä¸ºMainFunc</span>        <span class="token comment">// (é—®é¢˜2ï¼šä¸ºä»€ä¹ˆä¸å¯ä»¥ç›´æ¥å°†MainFuncç›´æ¥æ›¿æ¢ä¸ºcbï¼Ÿ)</span>        m_fctx <span class="token operator">=</span> boost<span class="token double-colon punctuation">::</span>context<span class="token double-colon punctuation">::</span>detail<span class="token double-colon punctuation">::</span><span class="token function">make_fcontext</span><span class="token punctuation">(</span>            m_stack <span class="token operator">+</span> m_stackSize<span class="token punctuation">,</span> m_stackSize<span class="token punctuation">,</span> MainFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// ææ„å‡½æ•°ï¼Œé‡Šæ”¾æ ˆå†…å­˜</span>    <span class="token operator">~</span><span class="token function">fFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Allocator</span><span class="token double-colon punctuation">::</span><span class="token function">Dealloc</span><span class="token punctuation">(</span>m_stack<span class="token punctuation">,</span> m_stackSize<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// åˆ‡å…¥åç¨‹ï¼Œæ‰§è¡Œcbå‡½æ•°</span>    <span class="token keyword">void</span> <span class="token function">swapIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">GetThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">auto</span> rt <span class="token operator">=</span> boost<span class="token double-colon punctuation">::</span>context<span class="token double-colon punctuation">::</span>detail<span class="token double-colon punctuation">::</span><span class="token function">jump_fcontext</span><span class="token punctuation">(</span>m_fctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// ä¿å­˜åç¨‹è¿›åº¦</span>        m_fctx <span class="token operator">=</span> rt<span class="token punctuation">.</span>fctx<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// ä»åç¨‹åˆ‡å‡ºåˆ°æœ¬çº¿ç¨‹çš„ä¸»åç¨‹</span>    <span class="token keyword">void</span> <span class="token function">swapOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè¿™é‡Œä¸éœ€è¦æ¥å—è¿”å›å€¼ï¼Œå¹¶ä¿å­˜å†™æˆè¿›åº¦ï¼Ÿ</span>        <span class="token function">jump_fcontext</span><span class="token punctuation">(</span>t_threadFiber<span class="token operator">-&gt;</span>m_fctx<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// MainFuncç”¨äºåŒ…è£…cbï¼Œæ‰§è¡Œä¸€äº›åˆå§‹åŒ–å’Œå–„åå·¥ä½œ</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">MainFunc</span><span class="token punctuation">(</span>transfer_t in<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// ä¸»åç¨‹çš„ä¸Šä¸‹æ–‡ä¿å­˜ä¸º swapInæ—¶çš„ä¸Šä¸‹æ–‡</span>        t_threadFiber<span class="token operator">-&gt;</span>m_fctx <span class="token operator">=</span> in<span class="token punctuation">.</span>fctx<span class="token punctuation">;</span>        <span class="token comment">// æ‹¿åˆ°swainInä¸­ä¼ å…¥çš„åç¨‹ä½“æŒ‡é’ˆ</span>        fFiber<span class="token operator">*</span> readyFiber <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>fFiber<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// æ‰§è¡Œcbå‡½æ•°</span>        readyFiber<span class="token operator">-&gt;</span><span class="token function">m_cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// é»˜è®¤åœ¨å‡½æ•°æ‰§è¡Œå®Œæ¯•ååˆ‡å›ä¸»åç¨‹</span>        readyFiber<span class="token operator">-&gt;</span><span class="token function">swapOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// åˆå§‹åŒ–å¹¶è·å–ä¸»åç¨‹</span>    <span class="token keyword">static</span> fFiber<span class="token operator">*</span> <span class="token function">GetThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>t_threadFiber <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            t_threadFiber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">fFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> t_threadFiber<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    fcontext_t       m_fctx<span class="token punctuation">;</span>       <span class="token comment">// åç¨‹ä¸Šä¸‹æ–‡</span>    fFiber<span class="token double-colon punctuation">::</span>callBack m_cb<span class="token punctuation">;</span>         <span class="token comment">// å‡½æ•°ä½“</span>    <span class="token keyword">char</span><span class="token operator">*</span>            m_stack<span class="token punctuation">;</span>      <span class="token comment">// åç¨‹æ ˆ</span>    size_t           m_stackSize<span class="token punctuation">;</span>  <span class="token comment">// åç¨‹æ ˆå¤§å°</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">testFiberSwapOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fFiber<span class="token operator">*</span> f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">fFiber</span><span class="token punctuation">(</span><span class="token punctuation">[</span>f1<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"in f1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"swap out first\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        f1<span class="token operator">-&gt;</span><span class="token function">swapOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"in f1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"swap out second\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        f1<span class="token operator">-&gt;</span><span class="token function">swapOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"in f1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"exit f1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"in main\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"swap in first\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    f1<span class="token operator">-&gt;</span><span class="token function">swapIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"in main\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"swap in second\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    f1<span class="token operator">-&gt;</span><span class="token function">swapIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"in main\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"swap in third\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    f1<span class="token operator">-&gt;</span><span class="token function">swapIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"in main\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"exit main\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">testFiberSwapOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> åç¨‹åº“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç°</title>
      <link href="/2024/04/05/mit65840lab4shixian/"/>
      <url>/2024/04/05/mit65840lab4shixian/</url>
      
        <content type="html"><![CDATA[<h1 id="6-5840-Lab-4-Fault-tolerant-Key-Value-Service"><a href="#6-5840-Lab-4-Fault-tolerant-Key-Value-Service" class="headerlink" title="6.5840 Lab 4: Fault-tolerant Key/Value Service"></a>6.5840 Lab 4: Fault-tolerant Key/Value Service</h1><p>æœ¬æ¬¡å®éªŒéœ€è¦ç»“åˆLab2å®ç°çš„ç®€æ˜“KVserverå’ŒLab3å®ç°çš„Raftç®—æ³•ï¼Œæœ€åå®ç°ä¸€ä¸ªå…·æœ‰å®¹é”™åŠŸèƒ½çš„åˆ†å¸ƒå¼KVServeré›†ç¾¤ï¼Œéš¾åº¦è¾ƒé«˜</p><span id="more"></span><p>Introduction</p><blockquote><p>In this lab you will build a fault-tolerant key/value storage service using your Raft library from Lab 3. Your key/value service will be a replicated state machine, consisting of several key/value servers that each maintain a database of key/value pairs, as in Lab 2, but additionally use Raft for replication. Your key/value service should continue to process client requests as long as a majority of the servers are alive and can communicate, in spite of other failures or network partitions. After Lab 4, you will have implemented all parts (Clerk, Service, and Raft) shown in the diagram of Raft interactions.</p></blockquote><p>ç›¸æ¯”äºLab3Raftç®—æ³•çš„å®ç°ï¼Œæœ¬æ¬¡å®éªŒçš„ä»£ç é‡æ›´å°‘ï¼Œé€»è¾‘ä¹Ÿç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯æ—¥å¿—é‡ä¼šå¢é•¿ä¸€ä¸ªæ•°é‡çº§ï¼Œååˆ†ä¸å¥½debugï¼Œå†åŠ ä¸Šä¸€äº›Lab3æµ‹è¯•éƒ½æ— æ³•æµ‹å‡ºæ¥çš„raftå±‚çš„bugï¼Œå¯ä»¥è¯´å®Œå…¨æ˜¯debugåœ°ç‹±äº†ã€‚</p><p>æœ¬æ¬¡å®éªŒéœ€è¦å®ç°æˆ‘ä»¬å®ç°ä¸€ä¸ªä¾èµ–äºraftçš„å¤„äºä¸Šå±‚çš„KVserverï¼Œå®ƒæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„Getï¼ŒPutï¼ŒAppendè¯·æ±‚ï¼Œåœ¨å®¢æˆ·ç«¯çœ‹æ¥ï¼ŒKVServeræä¾›çš„æœåŠ¡æ˜¯æ˜¯çº¿æ€§ä¸€è‡´æ€§çš„ï¼Œä¹Ÿå«å¼ºä¸€è‡´æ€§çš„</p><p>è¿™é‡Œæœ‰ä¸€ç¯‡æ˜æ™°å„ç§ä¸€è‡´æ€§æ¦‚å¿µçš„æ–‡ç« ï¼Œå…¨é¢è¯¦ç»†æ˜“æ‡‚ï¼Œ<del>å”¯ä¸€ä¸å¥½çš„åœ°æ–¹å°±æ˜¯æˆ‘äº‹åå†™åšå®¢çš„æ—¶å€™æ‰å‘ç°å®ƒğŸ˜­</del></p><blockquote><p><a href="https://segmentfault.com/a/1190000022248118">https://segmentfault.com/a/1190000022248118</a></p></blockquote><p>å¦‚æœå°†å®¢æˆ·ç«¯çš„Getæ“ä½œä¹Ÿå†™å…¥æ—¥å¿—ï¼Œç­‰å¾…Getæ—¥å¿—è¢«Raftå±‚æäº¤åå†å“åº”å®¢æˆ·ç«¯ï¼Œæœ¬å®éªŒå®ç°èµ·æ¥ä¼šç®€æ´å¾ˆå¤šï¼Œå®éªŒæŒ‡å¯¼ä¹Ÿæ˜¯è¿™ä¹ˆå»ºè®®çš„ã€‚</p><p>ä½†æ˜¯æˆ‘é€‰æ‹©ä¸å°†getè¯·æ±‚å†™å…¥æ—¥å¿—ï¼ˆäººè¦æœ‰è¿½æ±‚</p><p>è®ºæ–‡ä¸­æœ‰æåˆ°å¦‚ä½•å®ç°è¿™ç‚¹</p><p>1.å³leaderå“åº”Getè¯·æ±‚å‰å…ˆå‘èµ·ä¸€æ¬¡ check quorum ç¯èŠ‚ç¡®ä¿è‡ªå·±æ˜¯åˆæ³•çš„leaderï¼Œæˆ‘é€šè¿‡å¤ç”¨å¿ƒè·³æ¥å®ç°ï¼Œä¸‹é¢ä¼šä»‹ç»</p><p>2.è¿˜æœ‰å°±æ˜¯ReadIndexï¼Œè®°å½•æ”¶åˆ°Getè¯·æ±‚é‚£ä¸€åˆ»çš„Raftå±‚çš„CommitIndexå€¼ï¼Œç­‰å¾…åº”ç”¨å±‚ä»raftå±‚æ”¶åˆ°çš„logçš„indexå€¼ç­‰äºReadIndexå€¼çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¿”å›æ­¤æ¬¡Getè¯·æ±‚äº†ã€‚</p><p>é‚£ä¹ˆå°±å¯ä»¥å¼€å§‹å†™ä»£ç äº†ï¼š</p><h2 id="Part-A-Key-value-service-without-snapshots-moderate-hard"><a href="#Part-A-Key-value-service-without-snapshots-moderate-hard" class="headerlink" title="Part A: Key/value service without snapshots (moderate/hard)"></a>Part A: Key/value service without snapshots (moderate/hard)</h2><h3 id="ç»“æ„ä½“å®šä¹‰"><a href="#ç»“æ„ä½“å®šä¹‰" class="headerlink" title="ç»“æ„ä½“å®šä¹‰"></a>ç»“æ„ä½“å®šä¹‰</h3><p>æ—¥å¿—ç»“æ„ä½“çš„å®šä¹‰</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Op <span class="token keyword">struct</span> <span class="token punctuation">{</span>ClientId <span class="token builtin">int64</span> <span class="token comment">//å®¢æˆ·ç«¯æ ‡è¯†ï¼Œç”¨äºåº”å¯¹é‡å¤è¯·æ±‚</span>Offset   <span class="token builtin">int32</span> <span class="token comment">//å®¢æˆ·ç«¯çš„è¯·æ±‚åºåˆ—å·</span>OpType   <span class="token builtin">int</span>   <span class="token comment">//è¯·æ±‚/æ“ä½œç±»å‹</span>Key      <span class="token builtin">string</span>Value    <span class="token builtin">string</span><span class="token punctuation">}</span><span class="token keyword">const</span> <span class="token punctuation">(</span>getT <span class="token operator">=</span> <span class="token boolean">iota</span>putTappendTemptyT <span class="token comment">//indicate a empty log only use to update leader commitIndex</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>emptyTæ˜¯ä¸ºäº†å¸®åŠ©leaderæ›´æ–°commitIndexçš„å€¼è€Œä½¿ç”¨çš„</p><p>KVServeræˆå‘˜å˜é‡ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> KVServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>mu      sync<span class="token punctuation">.</span>Mutexme      <span class="token builtin">int</span>rf      <span class="token operator">*</span>raft<span class="token punctuation">.</span>RaftapplyCh <span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsgdead    <span class="token builtin">int32</span> <span class="token comment">// set by Kill()</span>maxraftstate <span class="token builtin">int</span> <span class="token comment">// snapshot if log grows this big</span>persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>PersisterlastAppliedIndex <span class="token builtin">int</span> <span class="token comment">//æœ€è¿‘æ·»åŠ åˆ°çŠ¶æ€æœºä¸­çš„raftå±‚çš„logçš„index</span>lastIncludeIndex <span class="token builtin">int</span> <span class="token comment">//lastInclude</span>kvMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//log state machine</span><span class="token comment">//ç¼“å­˜çš„log, seq-&gt;index,reply</span>duplicateMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">}</span><span class="token keyword">type</span> duplicateType <span class="token keyword">struct</span> <span class="token punctuation">{</span>Offset <span class="token builtin">int32</span>Reply  <span class="token builtin">string</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">StartKVServer</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">,</span> me <span class="token builtin">int</span><span class="token punctuation">,</span> persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>Persister<span class="token punctuation">,</span> maxraftstate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>KVServer <span class="token punctuation">{</span><span class="token comment">// call labgob.Register on structures you want</span><span class="token comment">// Go's RPC library to marshall/unmarshall.</span>labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>kv <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>KVServer<span class="token punctuation">)</span>kv<span class="token punctuation">.</span>me <span class="token operator">=</span> mekv<span class="token punctuation">.</span>maxraftstate <span class="token operator">=</span> maxraftstatekv<span class="token punctuation">.</span>persister <span class="token operator">=</span> persister<span class="token comment">// You may need initialization code here.</span>kv<span class="token punctuation">.</span>applyCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span>kv<span class="token punctuation">.</span>rf <span class="token operator">=</span> raft<span class="token punctuation">.</span><span class="token function">Make</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> me<span class="token punctuation">,</span> persister<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">)</span><span class="token comment">// You may need initialization code here.</span>kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">=</span> <span class="token number">0</span>kv<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token comment">//state machine</span>kv<span class="token punctuation">.</span>kvMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token comment">//log</span>kv<span class="token punctuation">.</span>duplicateMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">)</span>kv<span class="token punctuation">.</span><span class="token function">readPersist</span><span class="token punctuation">(</span>persister<span class="token punctuation">.</span><span class="token function">ReadSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">HandleApplych</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// go kv.HandleSnapshot()</span><span class="token comment">// go kv.handleGetTask()</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] restart"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">)</span><span class="token keyword">return</span> kv<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸ºä»€ä¹ˆéœ€è¦emptyTï¼Ÿ</p><p>å›é¡¾commitIndexæ›´æ–°çš„é™åˆ¶ï¼Œleaderè‡³å°‘åœ¨è‡ªå·±ä»»æœŸå†…è¾¾æˆä¸€æ¡æ—¥å¿—çš„å¤§å¤šæ•°å…±è¯†ï¼Œæ‰èƒ½å¤Ÿæ›´æ–°è‡ªå·±çš„commitIndexï¼Œå…¶ä»–followeræ‰èƒ½æ ¹æ®leaderå¿ƒè·³çš„LeaderCommitæ›´æ–°è‡ªå·±çš„commitIndex</p><p>å¦‚æœè¿™æ®µæ—¶é—´é‡Œå®¢æˆ·ç«¯ç‹‚å‘Getè¯·æ±‚ï¼ˆGetè¯·æ±‚ä¸å†™å…¥æ—¥å¿—ï¼‰æ²¡ä¸€ä¸ªå®¢æˆ·ç«¯å‘Putå’ŒAppendè¯·æ±‚ï¼Œé‚£ä¹ˆleaderçš„commmitIndexå°±å®Œå…¨å¡ä½äº†ï¼Œåº”ç”¨å±‚æ°¸è¿œæ”¶ä¸åˆ°æ–°çš„applylog</p><blockquote><p>é‚£ä¸ºå•¥lab3å®éªŒçš„å„ç§å˜æ€æµ‹è¯•å°±è¡¨ç°çš„å¥½å¥½çš„ï¼Œç°åœ¨åˆä¸è¡Œäº†æï¼Ÿ</p></blockquote><p>å› ä¸ºæµ‹è¯•ä»£ç æ£€æŸ¥é€šè¿‡startï¼ˆï¼‰æäº¤æ—¥å¿—ï¼Œå½“å®ƒå‘ç°æäº¤çš„è¿™æ¡logæ²¡æœ‰åœ¨å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šè¾¾åˆ°å…±è¯†çš„æ—¶å€™ï¼Œæˆ–è€…è¯´è¾¾æˆå…±è¯†çš„è¿™ä¸ªIndexæ˜¯ä¸æ˜¯å®ƒæ‰€æäº¤çš„logçš„æ—¶å€™ï¼Œå®ƒä¼šè¿›è¡Œ5æ¬¡é‡è¯•ï¼Œï¼ˆå½“ç„¶äº†å¦‚æœæµ‹è¯•ç¨‹åºä¿è¯åœ¨ç½‘ç»œå·²ç»æ¢å¤æ­£å¸¸ä¸€æ®µæ—¶é—´ä¹‹åå†æäº¤æ—¥å¿—ï¼Œè¿™æ—¶å€™æµ‹è¯•ç¨‹åºæ£€æŸ¥åˆ°Indexä¸Šä¸æ˜¯å®ƒæ‰€æäº¤çš„æ—¥å¿—ï¼Œé‚£ç›´æ¥å°±Fail Testäº†ï¼‰ä¿è¯leaderä¸€ç›´æœ‰logå¯ä»¥æ·»åŠ ï¼Œleaderå¯ä»¥åœ¨è¿™äº”æ¬¡é‡è¯•æ—¶é—´å†…æ›´æ–°å¥½è‡ªå·±çš„commitIndexï¼Œä»è€Œå°†åº”ç”¨å±‚æƒ³è¦çš„</p><p>æ—¢ç„¶åœ¨Lab4æ²¡æœ‰æµ‹è¯•ç¨‹åºå¸®æˆ‘ä»¬åšæ·»åŠ logè¿™ä»¶äº‹ï¼Œæˆ‘ä»¬å°±è‡ªå·±æ¥ï¼Œ</p><p>åœ¨raftå±‚å¤šè®¾ç½®ä¸¤ä¸ªæ ‡å¿—ï¼ŒIisBackå¦‚æœä¸ºtrueï¼šè¡¨æ˜leaderåœ¨å½“å‰ä»»æœŸå†…è¾¾æˆcommitIndexçš„æ›´æ–°ï¼Œå¹¶ä¸”å°†è¿™æ¡å±äºå½“å‰ä»»æœŸçš„æ—¥å¿—é€šè¿‡applyChå‘é€ç»™äº†serverå±‚</p><p>IisBackIndexè¾…åŠ©IisBackæ›´æ–°</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Raft <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token comment">//Man,what can i say?</span>IisBack      <span class="token builtin">bool</span>IisBackIndex <span class="token builtin">int</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>leaderæ¯æ¬¡åˆšåˆšå½“é€‰çš„æ—¶å€™è®¾ç½®IisBackä¸ºfalseï¼Œæ›´æ–°commitIndexçš„æ—¶å€™è®¾ç½®IisBackIndex = commitIndexï¼Œå½“applyIndexå¤§äºç­‰äºIisBackIndexæ—¶ï¼Œå°±å¯ä»¥è®¾ç½®IisBackä¸ºtrueäº†</p><p>leaderæ¯æ¬¡å“åº”è¯»è¯·æ±‚å‰éœ€è¦æ£€æŸ¥Iisbackæ˜¯å¦ä¸ºTrueï¼Œè‹¥ä¸ºfalseï¼Œåˆ™éœ€è¦é€šè¿‡startï¼ˆï¼‰å‘raftå±‚æäº¤ä¸€ä¸ªOpType = emptyT çš„ç©ºæ—¥å¿—ï¼Œé€šçŸ¥clientè¿‡ä¸€ä¼šå†æ¥å°è¯•ï¼Œç­‰å¾…å½“å‰leaderå®ŒæˆåŒæ­¥</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//åˆ¤æ–­è‡ªå·±æœ‰æ²¡æœ‰ä»é‡å¯ä¸­æ¢å¤å®Œæ¯•çŠ¶æ€æœº</span><span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span>IisBack <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [recovering] reject a [Get]ğŸ”° args[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecoverkv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span>OpType<span class="token punctuation">:</span> emptyT<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®¢æˆ·ç«¯ä»£ç "><a href="#å®¢æˆ·ç«¯ä»£ç " class="headerlink" title="å®¢æˆ·ç«¯ä»£ç "></a>å®¢æˆ·ç«¯ä»£ç </h3><p>å®¢æˆ·ç«¯ç»“æ„ä½“å®šä¹‰ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Clerk <span class="token keyword">struct</span> <span class="token punctuation">{</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token comment">// You will have to modify this struct.</span>nextSendLocalId <span class="token builtin">int</span>LatestOffset    <span class="token builtin">int32</span>clientId        <span class="token builtin">int64</span>cTos            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>sToc            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®¢æˆ·ç«¯å‘é€è¯·æ±‚é€»è¾‘ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>max <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">62</span><span class="token punctuation">)</span>bigx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> max<span class="token punctuation">)</span>x <span class="token operator">:=</span> bigx<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> x<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">MakeClerk</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">)</span> <span class="token operator">*</span>Clerk <span class="token punctuation">{</span>ck <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Clerk<span class="token punctuation">)</span>ck<span class="token punctuation">.</span>servers <span class="token operator">=</span> servers<span class="token comment">// You'll have to add code here.</span>ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>ck<span class="token punctuation">.</span>LatestOffset <span class="token operator">=</span> <span class="token number">1</span>ck<span class="token punctuation">.</span>clientId <span class="token operator">=</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ck<span class="token punctuation">.</span>cTos <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>ck<span class="token punctuation">.</span>sToc <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ck<span class="token punctuation">.</span>cTos <span class="token punctuation">{</span>ck<span class="token punctuation">.</span>cTos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token keyword">return</span> ck<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token comment">// You will have to modify this function.</span>args <span class="token operator">:=</span> GetArgs<span class="token punctuation">{</span>Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>ClientId<span class="token punctuation">:</span>     ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>LatestOffset<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span><span class="token punctuation">}</span>count <span class="token operator">:=</span> <span class="token number">0</span>lastSendLocalId <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">for</span> <span class="token punctuation">{</span><span class="token keyword">if</span> ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">==</span> lastSendLocalId <span class="token punctuation">{</span>count<span class="token operator">++</span><span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>count <span class="token operator">=</span> <span class="token number">0</span>ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>reply <span class="token operator">:=</span> GetReply<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">// DPrintf("clinet [%d] [Get]:send[%d] args[%v]", ck.clientId, ck.nextSendLocalId, args)</span>ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>nextSendLocalId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.Get"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token comment">//æ ¹æ®replyåˆå§‹åŒ–ä¸€ä¸‹æœ¬åœ°serverè¡¨</span>lastSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span><span class="token comment">// DPrintf("clinet [%d] [Get]:[lost] args[%v]", ck.clientId, args)</span><span class="token comment">//å¯¹é¢å¤±è”ï¼Œé‚£å°±æ¢ä¸‹ä¸€ä¸ªç»§ç»­å‘</span>ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">}</span>ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>ServerId<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId<span class="token keyword">switch</span> reply<span class="token punctuation">.</span>Err <span class="token punctuation">{</span><span class="token keyword">case</span> OK<span class="token punctuation">:</span>ck<span class="token punctuation">.</span>LatestOffset<span class="token operator">++</span><span class="token comment">// DPrintf("clinet [%d] [Get]:[OK] get args[%v] reply[%v]", ck.clientId, args, reply)</span><span class="token keyword">return</span> reply<span class="token punctuation">.</span>Value<span class="token keyword">case</span> ErrNoKey<span class="token punctuation">:</span><span class="token comment">// DPrintf("clinet [%d] [Get]:[ErrNo key] get args[%v]", ck.clientId, args)</span><span class="token keyword">return</span> <span class="token string">""</span><span class="token keyword">case</span> ErrWrongLeader<span class="token punctuation">:</span><span class="token comment">// DPrintf("clinet [%d] [Get]:[ErrWrong LeaderId][%d] get args[%v] reply[%v]", ck.clientId, ck.nextSendLocalId, args, reply)</span><span class="token comment">//å¯¹æ–¹ä¹Ÿä¸çŸ¥é“leader</span><span class="token keyword">if</span> reply<span class="token punctuation">.</span>LeaderId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span><span class="token comment">//å¯»æ‰¾ä¸‹ä¸€ä¸ª</span>ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//è®°å½•å¯¹æ–¹è¿”å›çš„ä¸å¯é leaderId</span><span class="token keyword">if</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//ä½†æ˜¯æœ¬åœ°è¿˜æ²¡åˆå§‹åŒ–å‘¢ï¼Œé‚£å°±å¾€ä¸‹ä¸€ä¸ªå‘</span>ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//æœ¬åœ°è¿˜çœŸçŸ¥é“ï¼Œé‚£ä¸‹ä¸€ä¸ªå°±å‘å®ƒæ‰€æŒ‡å®šçš„localServerAddress</span>ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">case</span> ErrWaitForRecover<span class="token punctuation">:</span><span class="token comment">// DPrintf("client [%d] [Get]:[Wait for leader recover]", ck.clientId)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">default</span><span class="token punctuation">:</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Client [%d] Get reply unknown err [%s](probaly not init)"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">,</span> op <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// You will have to modify this function.</span>args <span class="token operator">:=</span> PutAppendArgs<span class="token punctuation">{</span>Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>Value<span class="token punctuation">:</span>        value<span class="token punctuation">,</span>Op<span class="token punctuation">:</span>           op<span class="token punctuation">,</span>ClientId<span class="token punctuation">:</span>     ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>LatestOffset<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span><span class="token punctuation">}</span>count <span class="token operator">:=</span> <span class="token number">0</span>lastSendLocalId <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">for</span> <span class="token punctuation">{</span><span class="token keyword">if</span> ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">==</span> lastSendLocalId <span class="token punctuation">{</span>count<span class="token operator">++</span><span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>count <span class="token operator">=</span> <span class="token number">0</span>ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// DPrintf("clinet [%d] [PutAppend]:send[%d] args[%v]", ck.clientId, ck.nextSendLocalId, args)</span>reply <span class="token operator">:=</span> PutAppendReply<span class="token punctuation">{</span><span class="token punctuation">}</span>ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>nextSendLocalId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.PutAppend"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token comment">//æ ¹æ®replyåˆå§‹åŒ–ä¸€ä¸‹æœ¬åœ°serverè¡¨</span>lastSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span><span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[lost] args[%v]", ck.clientId, args)</span><span class="token comment">//å¯¹é¢å¤±è”ï¼Œé‚£å°±æ¢ä¸‹ä¸€ä¸ªç»§ç»­å‘</span>ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">}</span>ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>ServerId<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId<span class="token keyword">switch</span> reply<span class="token punctuation">.</span>Err <span class="token punctuation">{</span><span class="token keyword">case</span> OK<span class="token punctuation">:</span>ck<span class="token punctuation">.</span>LatestOffset<span class="token operator">++</span><span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[OK] args[%v] reply[%v]", ck.clientId, args, reply)</span><span class="token keyword">return</span><span class="token keyword">case</span> ErrNoKey<span class="token punctuation">:</span><span class="token comment">// log.Fatalf("Client [%d] [PutAppend]:reply ErrNokey, but should not happend to putAndAppend args", ck.clientId)</span><span class="token keyword">case</span> ErrWrongLeader<span class="token punctuation">:</span><span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[ErrWrong LeaderId][%d] get args[%v] reply[%v]", ck.clientId, ck.nextSendLocalId, args, reply)</span><span class="token comment">//å¯¹æ–¹ä¹Ÿä¸çŸ¥é“leader</span><span class="token keyword">if</span> reply<span class="token punctuation">.</span>LeaderId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span><span class="token comment">//å¯»æ‰¾ä¸‹ä¸€ä¸ª</span>ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//è®°å½•å¯¹æ–¹è¿”å›çš„ä¸å¯é leaderId</span><span class="token keyword">if</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//ä½†æ˜¯æœ¬åœ°è¿˜æ²¡åˆå§‹åŒ–å‘¢ï¼Œé‚£å°±å¾€ä¸‹ä¸€ä¸ªå‘</span>ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//æœ¬åœ°è¿˜çœŸçŸ¥é“ï¼Œé‚£ä¸‹ä¸€ä¸ªå°±å‘å®ƒæ‰€æŒ‡å®šçš„localServerAddress</span>ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">default</span><span class="token punctuation">:</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Client [%d] [PutAppend]:reply unknown err [%s](probaly not init)"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> <span class="token punctuation">(</span>ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span>servers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ck<span class="token punctuation">.</span><span class="token function">PutAppend</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"Put"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Append</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ck<span class="token punctuation">.</span><span class="token function">PutAppend</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"Append"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®¢æˆ·ç«¯å®ç°çš„éš¾ç‚¹åªæœ‰ä¸€ä¸ªï¼šå®ç°å¿«é€Ÿå®šä½leader</p><p>å®¢æˆ·ç«¯æ‰€çŸ¥é“çš„æœåŠ¡å™¨ID servers []*labrpc.ClientEnd ä¸æœåŠ¡å™¨è‡ªå·±è®¤çŸ¥ä½“ç³»é‡Œçš„æœåŠ¡å™¨IDå®Œå…¨æ²¡æœ‰å…³ç³»  </p><p>å®¢æˆ·ç«¯æƒ³è¦è§£ææœåŠ¡ç«¯å‘é€å›æ¥çš„LeaderIdç©¶ç«Ÿå¯¹åº”è‡ªå·±æœ¬åœ°serveræ•°ç»„é‡Œçš„å“ªä¸ªä¸‹æ ‡ï¼Œå°±éœ€è¦å»ºç«‹ä¸€ä¸ªæ˜ å°„è¡¨ï¼ˆåœ°å€å˜æ¢è¡¨ï¼‰</p><p>æˆ‘ä¹Ÿæ˜¯ç”¨ä¸€ä¸ªç¬¨æ–¹æ³•æ¥å®ç°ï¼ŒæœåŠ¡å™¨æ¯æ¬¡å“åº”éƒ½åŒæ—¶å¸¦ä¸Šè‡ªå·±çš„indexå’Œå®ƒæ‰€çŸ¥é“çš„leaderIdï¼Œå®¢æˆ·ç«¯æ ¹æ®indexæ›´æ–°æ˜ å°„è¡¨ï¼Œç„¶åæ£€æŸ¥leaderIdåœ¨æ˜ å°„è¡¨é‡Œæœ‰æ²¡æœ‰è¢«æ›´æ–°è¿‡ï¼Œæ²¡æœ‰å°±å‘ä¸‹ä¸€ä¸ªæœåŠ¡å™¨ç»§ç»­å‘ï¼Œæœ‰å°±å¥½åŠäº†ï¼Œä¸‹æ¬¡å‘è¯·æ±‚ç›´è¾¾leader</p><p>å½“ç„¶ï¼ŒæœåŠ¡å™¨è¿”å›çš„leaderIdå¹¶éæ˜¯é‚£ä¹ˆçš„æœ‰å‚è€ƒä»·å€¼ï¼Œè€ƒè™‘åˆ°ç½‘ç»œåˆ†åŒºçš„æƒ…å†µï¼Œåœ¨ä¸€ä¸ªå°åˆ†åŒºä¸­followerä»¬è·Ÿå®šäº†ä¸€ä¸ªå°leaderï¼Œå¯¼è‡´å®¢æˆ·ç«¯å¾—åˆ°äº†å‡leaderIdï¼Œåç»­æ€ä¹ˆå‘é€è¯·æ±‚éƒ½å¾—ä¸åˆ°å›åº”</p><p>æˆ‘çš„å¤„ç†æ–¹æ³•æ˜¯åªå¯¹åŒä¸€ä¸ªleaderé‡è¯•5æ¬¡ï¼Œå†æœ‰ä¸‹æ¬¡å°±æ¢äººï¼æƒ¯ä¸äº†ä¸€ç‚¹</p><h3 id="æœåŠ¡ç«¯ä»£ç "><a href="#æœåŠ¡ç«¯ä»£ç " class="headerlink" title="æœåŠ¡ç«¯ä»£ç "></a>æœåŠ¡ç«¯ä»£ç </h3><p>çº¿æ€§ä¸€è‡´çš„è¯»è¯·æ±‚å¤„ç†ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>args <span class="token operator">*</span>GetArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>GetReply<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// Your code here.</span>reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">"i should not with ok symble"</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeaderreply<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetleaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>reply<span class="token punctuation">.</span>ServerId <span class="token operator">=</span> kv<span class="token punctuation">.</span>me<span class="token comment">//åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯leader</span><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span><span class="token comment">// DPrintf("server [%d] [info] i am leader", kv.me)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">// DPrintf("server [%d] [info] i am not leader ,leader is [%d]", kv.me, reply.LeaderId)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token comment">//åˆ¤æ–­è‡ªå·±æœ‰æ²¡æœ‰ä»é‡å¯ä¸­æ¢å¤å®Œæ¯•çŠ¶æ€æœº</span><span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span>IisBack <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [recovering] reject a [Get]ğŸ”° args[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecoverkv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span>OpType<span class="token punctuation">:</span> emptyT<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span>readLastIndex <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>term <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//éœ€è¦å‘é€ä¸€è½®å¿ƒè·³è·å¾—å¤§å¤šæ•°å›å¤ï¼Œåªæ˜¯ä¸ºäº†ç¡®å®šæ²¡æœ‰ä¸€ä¸ªä»»æœŸæ›´åŠ æ–°çš„leaderï¼Œä¿è¯è‡ªå·±çš„æ•°æ®ä¸æ˜¯è„çš„</span><span class="token keyword">if</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">CheckIfDepose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader<span class="token keyword">return</span><span class="token punctuation">}</span><span class="token comment">//return falseè¡¨æ˜è‡ªå·±æ˜¯åˆæ³•leader</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//è·Ÿraftå±‚ä¹‹é—´çš„åŒæ­¥é—®é¢˜ï¼Œraftåˆšå½“é€‰leaderçš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰</span><span class="token comment">//ç›´æ¥è¿”å›</span>value<span class="token punctuation">,</span> find <span class="token operator">:=</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">]</span><span class="token keyword">if</span> find <span class="token punctuation">{</span><span class="token keyword">if</span> kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">&gt;=</span> readLastIndex <span class="token operator">&amp;&amp;</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> term <span class="token operator">==</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OKreply<span class="token punctuation">.</span>Value <span class="token operator">=</span> value<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [ok] lastAppliedIndex[%d] readLastIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> readLastIndex<span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [Ok] the get args[%v] reply[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover<span class="token comment">// DPrintf("server [%d] [Get] [ErrWaitForRecover] kv.lastAppliedIndex &lt; readLastIndex args[%v] reply[%v]", kv.me, *args, *reply)</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [NoKey] the get args[%v] reply[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [map] -&gt; %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>kv.lastAppliedIndex &gt;= readLastIndex &amp;&amp; kv.rf.GetLeader() &amp;&amp; term == kv.rf.GetTerm()</p><p>å®ç°å¥½è¿™ä¸ªåˆ¤æ–­åŸºæœ¬å°±èƒ½è§£å†³è¯»æ“ä½œçº¿æ€§ä¸€è‡´äº†</p><p>Putå’ŒAppendæ“ä½œçš„çº¿æ€§ä¸€è‡´æ€§å®ç°ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>args <span class="token operator">*</span>PutAppendArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>PutAppendReply<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// Your code here.</span>reply<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetleaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeaderreply<span class="token punctuation">.</span>ServerId <span class="token operator">=</span> kv<span class="token punctuation">.</span>me<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span><span class="token comment">// DPrintf("server [%d] [info] i am leader", kv.me)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">// DPrintf("server [%d] [info] i am not leader ,leader is [%d]", kv.me, reply.LeaderId)</span><span class="token keyword">return</span><span class="token punctuation">}</span>op <span class="token operator">:=</span> Op<span class="token punctuation">{</span>ClientId<span class="token punctuation">:</span> args<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>Offset<span class="token punctuation">:</span>   args<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>Key<span class="token punctuation">:</span>      args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span>Value<span class="token punctuation">:</span>    args<span class="token punctuation">.</span>Value<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token keyword">switch</span> args<span class="token punctuation">.</span>Op <span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token string">"Put"</span><span class="token punctuation">:</span>op<span class="token punctuation">.</span>OpType <span class="token operator">=</span> putT<span class="token keyword">case</span> <span class="token string">"Append"</span><span class="token punctuation">:</span>op<span class="token punctuation">.</span>OpType <span class="token operator">=</span> appendT<span class="token keyword">default</span><span class="token punctuation">:</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unreconize put append args.Op:%s"</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>Op<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// DPrintf("server [%d] [PutAppend] ğŸ“¨receive a args[%v]", kv.me, *args)</span><span class="token comment">// defer DPrintf("server [%d] [PutAppend] ğŸ“¨complete a args[%v]", kv.me, *args)</span><span class="token comment">//startå‰éœ€è¦æŸ¥çœ‹æœ¬åœ°logç¼“å­˜æ˜¯å¦æœ‰seq</span><span class="token comment">//è¿™é‡Œé€šè¿‡ç¼“å­˜æäº¤ï¼Œä¸€æ–¹é¢æé«˜äº†kvserveråº”å¯¹ç½‘ç»œé”™è¯¯çš„å›å¤é€Ÿåº¦ï¼Œå¦ä¸€æ–¹é¢è¿›è¡Œäº†ç¬¬ä¸€å±‚çš„é‡å¤æ£€æµ‹</span><span class="token comment">//ä½†æ˜¯æ³¨æ„å¯èƒ½åŒæ—¶æœ‰ä¸¤ä¸ªç›¸åŒçš„getDuplicateMapé€šè¿‡è¿™é‡Œ</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">&lt;</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OKkv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//æ²¡æœ‰åœ¨æœ¬åœ°ç¼“å­˜å‘ç°è¿‡seq</span><span class="token comment">//å‘raftæäº¤æ“ä½œ</span>index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">SendAppendEntriesToAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] submit to raft key[%v] value[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token comment">//æäº¤åé˜»å¡ç­‰å¾…</span><span class="token comment">//ç­‰å¾…applyChæ‹¿åˆ°å¯¹åº”çš„indexï¼Œæ¯”å¯¹seqæ˜¯å¦æ­£ç¡®</span>startWait <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> index <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token punctuation">{</span><span class="token comment">//åŒé‡é˜²é‡å¤</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">&lt;</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OKkv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token comment">// DPrintf("server [%d] [PutAppend] appliedIndex available :PutAppend index[%d] lastAppliedIndex[%d]", kv.me, index, kv.lastAppliedIndex)</span><span class="token keyword">if</span> term <span class="token operator">!=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//termä¸åŒ¹é…äº†ï¼Œè¯´æ˜æœ¬æ¬¡æäº¤å¤±æ•ˆ</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span> <span class="token comment">//termåŒ¹é…ï¼Œè¯´æ˜æœ¬æ¬¡æäº¤ä¸€å®šæ˜¯æœ‰æ•ˆçš„</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK<span class="token comment">// DPrintf("server [%d] [PutAppend] success args.index[%d], args[%v] reply[%v]", kv.me, index, *args, *reply)</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader<span class="token punctuation">}</span><span class="token keyword">return</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//è¶…è¿‡2sæ²¡ç­‰åˆ°applychï¼Œé‚£å°±è¿”å›wrong</span><span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startWait<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">500</span> <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [PutAppend] fail [time out] args.index[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸è¦å¹»æƒ³åƒåœ¨Lab2é‡Œå®ç°çš„é‚£æ ·ï¼Œåœ¨serverå“åº”clientçš„æ—¶å€™é€šè¿‡ç®€å•çš„ClientIdå’ŒOffsetæ¯”è¾ƒå°±èƒ½æå®šé‡å¤çš„éå®‰å…¨éå¹‚ç­‰è¯·æ±‚</p><p>å¤šæœåŠ¡ç«¯çš„æƒ…å†µä¸‹ï¼Œå¯¹äºæ–°leaderçš„duplicateMapï¼Œè¿™é¡¹å€¼åªä¿éšœæœ€ç»ˆä¸€è‡´æ€§ï¼Œå¹¶ä¸ä¸€ä¿éšœä»»ä½•æ—¶åˆ»éƒ½æ˜¯æœ€æ–°çš„å¼ºä¸€è‡´æ€§ï¼Œæ‰€ä»¥è¿™é¡¹åˆ¤æ–­æ”¾åœ¨clientå’Œserverä¹‹é—´æ˜¯ä¸èƒ½ç™¾åˆ†ç™¾ä¿è¯æ•°æ®åº“å®‰å…¨çš„ï¼Œè¿˜éœ€è¦åœ¨serverå±‚å’Œraftå±‚ä¹‹é—´å®ç°å»é‡ã€‚</p><p>ä¸è¿‡è¿™æ®µä»£ç æ”¾åœ¨è¿™é‡Œç¡®å®æœ‰æ„ä¹‰çš„ï¼Œç½‘ç»œæ··ä¹±çš„æƒ…å†µä¸‹å®ƒç¡®å®ä¸èƒ½ç™¾åˆ†ç™¾è§£å†³é—®é¢˜ï¼Œä½†åœ¨ç½‘ç»œä¸€åˆ‡æ­£å¸¸çš„æ—¶å€™å®ƒè¿˜æ˜¯èƒ½èµ·åˆ°ä½œç”¨çš„</p><p>å¦‚ä½•å®ç°serverå±‚å’Œraftå±‚ä¹‹é—´çš„å»é‡ï¼Ÿæ ¹æ®logä¸­ä¿å­˜çš„clientIndexå’ŒOfferã€‚</p><p>è¿™ä¸¤é¡¹å€¼ç»è¿‡raftè½¬æ‰‹åå†æ¬¡å›åˆ°serverï¼Œé‚£æ„ä¹‰å¯å°±å¤§äº†ï¼Œå› ä¸ºå®ƒå€ŸåŠ©raftå±‚å®ç°äº†å¼ºä¸€è‡´æ€§ï¼Œå³å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šï¼Œlogæ˜¯çº¿æ€§ä¸€è‡´çš„ï¼Œæ‰€æœ‰æœåŠ¡å™¨çš„logé¡ºåºéƒ½ä¸€æ¨¡ä¸€æ ·</p><p>å¤„ç†raftå±‚æäº¤logçš„ä»£ç ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">/</span> state machine<span class="token comment">// å°†valueé‡æ–°è½¬æ¢ä¸º Opï¼Œæ·»åŠ åˆ°æœ¬åœ°kvMapä¸­</span><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">HandleApplych</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">select</span> <span class="token punctuation">{</span><span class="token keyword">case</span> raft_type <span class="token operator">:=</span> <span class="token operator">&lt;-</span>kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">:</span><span class="token keyword">if</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> raft_type<span class="token punctuation">.</span>CommandValid <span class="token punctuation">{</span>kv<span class="token punctuation">.</span><span class="token function">HandleApplychCommand</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">)</span>kv<span class="token punctuation">.</span><span class="token function">checkIfExcExccdLog</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">)</span>kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">=</span> raft_type<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> raft_type<span class="token punctuation">.</span>SnapshotValid <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“· server [%d] receive raftSnapshotIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> raft_type<span class="token punctuation">.</span>SnapshotIndex<span class="token punctuation">)</span>kv<span class="token punctuation">.</span><span class="token function">HandleApplychSnapshot</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Unrecordnized applyArgs type"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">HandleApplychCommand</span><span class="token punctuation">(</span>raft_type raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>op_type<span class="token punctuation">,</span> ok <span class="token operator">:=</span> raft_type<span class="token punctuation">.</span>Command<span class="token punctuation">.</span><span class="token punctuation">(</span>Op<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"raft applyArgs.command -&gt; Op å¤±è´¥,raft_type.Command = %v"</span><span class="token punctuation">,</span> raft_type<span class="token punctuation">.</span>Command<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> op_type<span class="token punctuation">.</span>OpType <span class="token operator">==</span> emptyT <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">switch</span> op_type<span class="token punctuation">.</span>OpType <span class="token punctuation">{</span><span class="token keyword">case</span> putT<span class="token punctuation">:</span><span class="token comment">//æ›´æ–°çŠ¶æ€æœº</span><span class="token comment">//æœ‰å¯èƒ½æœ‰å¤šä¸ªstarté‡å¤æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸€æ­¥è¦æ£€éªŒé‡å¤</span><span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"â›”server [%d] [Put] [%v] lastapplied[%v]find in the cache and discard %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> op_type<span class="token punctuation">.</span>Value<span class="token comment">// DPrintf("server [%d] [Update] [Put]-&gt;[%s,%s] [map] -&gt; %v", kv.me, op_type.Key, op_type.Value, kv.kvMap)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Update] [Put]-&gt;[%s : %s] "</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token keyword">case</span> appendT<span class="token punctuation">:</span><span class="token comment">//æ›´æ–°çŠ¶æ€æœº</span><span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"â›”server [%d] [Append] [%v] lastapplied[%v]find in the cache and discard %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">+=</span> op_type<span class="token punctuation">.</span>Value<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Update] [Append]-&gt;[%s : %s]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token keyword">case</span> getT<span class="token punctuation">:</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æ—¥å¿—ä¸­ä¸åº”è¯¥å‡ºç°getType"</span><span class="token punctuation">)</span><span class="token keyword">default</span><span class="token punctuation">:</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æ—¥å¿—ä¸­å‡ºç°æœªçŸ¥optype = [%d]"</span><span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>OpType<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å»é‡ä»£ç çš„åŸç†è·ŸLab2ä¸­å®ç°çš„å»é‡åŸç†æ˜¯ä¸€è‡´çš„</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Part-B-Key-value-service-with-snapshots-hard"><a href="#Part-B-Key-value-service-with-snapshots-hard" class="headerlink" title="Part B: Key/value service with snapshots (hard)"></a>Part B: Key/value service with snapshots (hard)</h2><p>æœ¬æ¬¡å®éªŒå¢åŠ äº†å¯¹raftStateå¤§å°çš„é™åˆ¶ï¼Œå½“raftå±‚çš„logæ•°é‡æ¥è¿‘é™åˆ¶çš„æ—¶å€™ï¼Œserverå±‚å°±å‘raftå‘å‡ºsnapshotå‘½ä»¤ï¼Œç„¶åå°†serverå±‚çš„kvMap duplicateMapè¿™ä¸¤é¡¹æ”¾å…¥snapshotDateé‡Œè®©raftå¸®å¿™æŒä¹…åŒ–ã€‚</p><p>ç”±äºsnapshotæˆªæ–­æ—¥å¿—çš„æ•ˆæœï¼ŒduplicateMapå¦‚æœä¸åŒæ­¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œå¾ˆæœ‰å¯èƒ½å› ä¸ºç¼ºå°‘logè€Œæ— æ³•æ­£ç¡®å»é‡</p><blockquote><p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿå¾ˆç®€å•ï¼Œä¸¤ä¸ªé‡è¯»çš„Putè¯·æ±‚ï¼Œä¸€ä¸ªåœ¨å› ä¸ºsnapshotè€Œæˆªæ–­ä¸¢å¼ƒçš„logä¸­ï¼Œå¦ä¸€ä¸ªåœ¨snpashotIndexä¹‹å</p><p>serverå±‚å’Œraftå±‚ä¹‹é—´å»é‡çš„æ—¶å€™ï¼ŒduplicateMapæ— æ³•ç¼“å­˜åˆ°å‰ä¸€ä¸ªPutè¯·æ±‚ï¼Œä»è€Œå…è®¸ä¸‹ä¸€ä¸ªé‡å¤çš„putè¯·æ±‚è¢«åº”ç”¨åˆ°æ•°æ®åº“ä¸­</p></blockquote><p>ä»£ç å®ç°ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ä¸»åŠ¨å¿«ç…§,æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½åœ¨è‡ªå·±logè¶…æ ‡çš„æ—¶å€™å¯åŠ¨å¿«ç…§</span><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">checkIfNeedSnapshot</span><span class="token punctuation">(</span>spanshotindex <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">IfNeedExceedLog</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>maxraftstate<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span> <span class="token comment">//éœ€è¦è¿›è¡Œå¿«ç…§äº†</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] need snapshot limit[%d] curRaftStatesize[%d] snapshotIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>maxraftstate<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>persister<span class="token punctuation">.</span><span class="token function">RaftStateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanshotindex<span class="token punctuation">)</span><span class="token comment">//é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹è‡ªå·±çš„çŠ¶æ€æœºåº”ç”¨åˆ°äº†é‚£ä¸€æ­¥</span><span class="token keyword">var</span> buf bytes<span class="token punctuation">.</span>Bufferenc <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"snapshot duplicateMap encoder fail:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"snapshot kvMap encoder fail:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//å°†çŠ¶æ€æœºä¼ äº†è¿›å»</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Snapshot</span><span class="token punctuation">(</span>spanshotindex<span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// è¢«åŠ¨å¿«ç…§</span><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">readPersist</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] passive ğŸ“· len of snapshotdate[%d] "</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] before map[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>r <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>d <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>kvMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>duplicateMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>duplicateMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"decode err:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"decode err:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>kvMap <span class="token operator">=</span> kvMapkv<span class="token punctuation">.</span>duplicateMap <span class="token operator">=</span> duplicateMap<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] after map[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä¸»åŠ¨å¿«ç…§æ˜¯ä¸ºäº†ä¿éšœraftStateçš„å¤§å°ä¸è¦å¤ªå¤§ï¼Œç”±serverä¸»è§‚è°ƒç”¨</p><p>è¢«åŠ¨å¿«ç…§æ˜¯raftå±‚ä¸ºäº†è§£å†³ä¸»åŠ¨å¿«ç…§å¸¦æ¥çš„æ—¥å¿—å¤åˆ¶é—®é¢˜è€Œè¿›è¡Œçš„ï¼Œä¸¤è€…æ„ä¹‰ä¸åŒ</p></blockquote><p><img src="/2024/04/05/mit65840lab4shixian/11.png" alt="æµ‹è¯•"></p><p><img src="/2024/04/05/mit65840lab4shixian/10.png" alt="å¤šæ¬¡æµ‹è¯•"></p><p>å®éªŒè¿‡ç¨‹è¿˜æœ‰ä¸€äº›ç»†èŠ‚</p><p>æƒ³èµ·æ¥å†å†™</p>]]></content>
      
      
      
        <tags>
            
            <tag> MIT6.5840 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIT6.5840 Lab3 å®ç°</title>
      <link href="/2024/04/04/mit65840lab3shixian/"/>
      <url>/2024/04/04/mit65840lab3shixian/</url>
      
        <content type="html"><![CDATA[<h1 id="6-5840-Lab-3-Raft"><a href="#6-5840-Lab-3-Raft" class="headerlink" title="6.5840 Lab 3: Raft"></a>6.5840 Lab 3: Raft</h1><p>æœ¬èŠ‚å®éªŒçš„ç›®æ ‡æ˜¯å®ç°Raftåˆ†å¸ƒä¸€è‡´æ€§ç®—æ³•ï¼Œä¸å¿…å¤šè¯´ï¼Œæ­¤èŠ‚ä¸ºæ‰€æœ‰å®éªŒä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ€èƒ½åŠé€€å®éªŒè€…çš„ä¸€èŠ‚</p><p>åœ¨å®éªŒå¼€å§‹å‰ä¸€å®šè¦ä»”ç»†é˜…è¯»raftè®ºæ–‡ï¼Œç¼–å†™ä»£ç ä¸­ä¹Ÿè¦åå¤ç¡®è®¤æœ‰æ²¡æœ‰æ­£ç¡®å®ç°è®ºæ–‡ä¸­çš„è§„åˆ™</p><p><a href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">extended Raft paper</a></p><span id="more"></span><p>è®ºæ–‡ä¸­æœ€é‡è¦çš„å›¾ï¼š</p><p><img src="/2024/04/04/mit65840lab3shixian/7.png" alt="Raftåè®®"></p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>raftç®—æ³•å°±ä¸åœ¨è¿™è¯¦ç»†ä»‹ç»äº†ï¼Œä¸è‡ªè¡Œé˜…è¯»è®ºæ–‡ç­‰èµ„æ–™æ˜¯ä¸å¯èƒ½ç‹¬ç«‹å®Œæˆæœ¬å®éªŒçš„</p><p>ç”±äºæœ¬äººä¸€å¼€å§‹æ²¡æœ‰ä½¿ç”¨gitè¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œå› æ­¤åˆæ¬¡é€šè¿‡Aã€Bã€Céƒ¨åˆ†çš„ä»£ç éƒ½æ²¡æœ‰å¾—åˆ°ä¿ç•™ï¼Œåªç•™ä¸‹äº†æœ€ç»ˆé€šè¿‡Déƒ¨åˆ†çš„ä»£ç ã€‚</p><p>ç”±äºABCDå››ä¸ªpartçš„å®éªŒæ˜¯å¢é‡çš„å…³ç³»ï¼Œåç»­çš„æµ‹è¯•è¿˜ä¼šé—´æ¥åœ°åŠ å¼ºæµ‹è¯•å‰é¢å®ç°çš„å†…å®¹ï¼Œåˆæ¬¡é€šè¿‡æµ‹è¯•é€šè¿‡çš„ä»£ç æ®µå¹¶ä¸ä¸€å®šå°±æ˜¯æ­£ç¡®çš„ï¼Œä¼šåœ¨åç»­çš„ä¸¥æ ¼æµ‹è¯•ä¸­æš´éœ²å‡ºé—®é¢˜ã€‚</p><p>æ‰€ä»¥ABCä¸‰éƒ¨åˆ†å°±ä¸æ”¾å…·ä½“ä»£ç äº†ï¼Œä¸»è¦ä»¥ä»‹ç»æˆ‘åœ¨å®éªŒä¸­çš„æ€è·¯ï¼Œé‡åˆ°çš„å‘ä¸ºä¸»ã€‚</p><p>å†æ¬¡å¼ºè°ƒçš„æ˜¯ï¼Œå‰æœŸå®ç°çš„raftç®—æ³•å¿…é¡»åšå›ºå¯é ï¼Œå¦åˆ™åé¢å›è¿‡å¤´æ¥ä¿®æ”¹ä¼šéå¸¸çš„ç—›è‹¦ã€‚å»ºè®®ä½¿ç”¨ç¬¬ä¸‰æ–¹æµ‹è¯•è„šæœ¬å¹¶è¡Œè·‘å®éªŒæµ‹è¯•ï¼Œè‡³å°‘ä¹Ÿè¦ä¿è¯èƒ½å¤Ÿè¿ç»­100æ¬¡é€šè¿‡å®éªŒï¼Œç†æƒ³çš„é€šè¿‡æ¬¡æ•°åº”è¯¥æ˜¯åƒæ¬¡å§â€¦é‰´äºæœ¬äººç”µè„‘CPUæ¯”è¾ƒåƒåœ¾ï¼Œä¹Ÿå°±è·‘è·‘ç™¾æ¬¡çº§åˆ«çš„å®éªŒã€‚ï¼ˆåœ¨æ”¥å†™åšå®¢æœŸé—´è¿›è¡Œè¿‡å‡ æ¬¡é«˜å¹¶è¡Œæµ‹è¯•ï¼Œä¹Ÿæ˜¯ç›´æ¥æŠŠè™šæ‹Ÿæœºå¹²å´©æºƒäº†</p><h2 id="Part-3A-leader-election-moderate"><a href="#Part-3A-leader-election-moderate" class="headerlink" title="Part 3A: leader election (moderate)"></a>Part 3A: leader election (moderate)</h2><p>ç®€ä»‹ï¼š</p><blockquote><p>Implement Raft <strong>leader election</strong> and <strong>heartbeats</strong> (AppendEntries RPCs with no log entries). The goal for Part 3A is for a single leader to be elected, for the leader to remain the leader if there are no failures, and for a new leader to take over if the old leader fails or if packets to/from the old leader are lost. Run go test -run 3A to test your 3A code.</p></blockquote><p>partAéœ€è¦å®ç°<strong>é¢†å¯¼äººé€‰ä¸¾æœºåˆ¶</strong>å’Œ<strong>å¿ƒè·³æœºåˆ¶</strong></p><p>åˆ—ä¸¾ä¸€ä¸‹å®éªŒä¸­æ¯”è¾ƒé‡è¦çš„Hintï¼š</p><blockquote><p>The tester requires that the leader send heartbeat RPCs no more than ten times per second.</p></blockquote><p>è¿™é¡¹é™åˆ¶å¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆä¸¥æ ¼ï¼Œæ˜¯å¯ä»¥ç›´æ¥è®©leaderå‘é€AEçš„é—´éš”ä¸º90~100msçš„ï¼Œå¿ƒè·³åŒ…æ£€æµ‹æµ‹è¯•åªç»Ÿè®¡æœ€åçš„æ€»RPCæ•°ç›®</p><blockquote><p>The tester requires your Raft to elect a new leader within five seconds of the failure of the old leader (if a majority of peers can still communicate).</p></blockquote><p>å¦‚æœå½“å‰ç½‘ç»œç¯å¢ƒæ˜¯å¯ä»¥äº§ç”Ÿé¢†å¯¼äººçš„ï¼ˆå³ä½¿ç½‘ç»œæ•…éšœåˆ†åŒºäº†ï¼Œå¦‚æœæŸä¸ªåˆ†åŒºåŒ…å«äº†åŠæ•°ä»¥ä¸Šçš„æœåŠ¡å™¨ï¼‰ï¼Œè¿™æ˜¯ä¸ªéå¸¸é‡è¦çš„é™åˆ¶ï¼Œåˆæ¬¡å®éªŒå¤§å¤šæ•°çš„é”™è¯¯éƒ½å¯ä»¥è¢«è¿™æ¡è§„åˆ™æ£€æµ‹å‡ºæ¥ï¼ŒåŒæ—¶ï¼Œåœ¨åé¢çš„å®éªŒä¸­ï¼Œè¿™æ¡è§„åˆ™ä¹Ÿè®¸ä¼šæˆä¸ºæœ€éš¾é€¾è¶Šçš„ä¸€é“éš¾å…³</p><blockquote><p>The paperâ€™s Section 5.2 mentions election timeouts in the range of 150 to 300 milliseconds. Such a range only makes sense if the leader sends heartbeats considerably more often than once per 150 milliseconds (e.g., once per 10 milliseconds). Because the tester limits you tens of heartbeats per second, you will have to use an election timeout larger than the paperâ€™s 150 to 300 milliseconds, but not too large, because then you may fail to elect a leader within five seconds.</p></blockquote><p>åˆç†è®¾è®¡Election Timeout Intervalï¼Œå®ƒå¿…é¡»æ˜¯ä¸ªéšæœºå€¼ï¼Œä¸‹é™åº”å½“èƒ½å¤Ÿå®¹çº³ä¸‰å››æ¬¡å¿ƒè·³åŒ…çš„æ­£å¸¸å‘é€ï¼Œéšæœºå–å€¼èŒƒå›´ä¸èƒ½å¤ªå°ï¼Œå¦åˆ™é€‰ä¸¾è¿‡ç¨‹å¾ˆéš¾æˆåŠŸã€‚å¤ªå¤§åˆ™å½±å“æ•ˆç‡</p><blockquote><p><strong>Youâ€™ll need to write code that takes actions periodically or after delays in time. The easiest way to do this is to create a goroutine with a loop that calls time.Sleep(); see the ticker() goroutine that Make() creates for this purpose. Donâ€™t use Goâ€™s time.Timer or time.Ticker, which are difficult to use correctly.</strong></p></blockquote><p>è¿™æ˜¯ç›¸å½“æœ‰ä»·å€¼çš„å¿ å‘Šï¼Œå»ºè®®ç”¨sleepçš„æ–¹å¼å®ç°è¶…æ—¶æœºåˆ¶ï¼Œæ…ç”¨timerå’Œtickerï¼Œå®ƒä»¬éå¸¸è¢«éš¾ä»¥æ­£ç¡®ä½¿ç”¨ã€‚</p><p>æœ¬äººä¹Ÿæ˜¯å°è¯•è¿‡ä½¿ç”¨timerå’Œtickeré‡æ„ä»£ç ï¼Œå±äºæ˜¯æŠŠè„‘å­æ¦¨å¹²äº†éƒ½æ²¡æå®šã€‚</p><blockquote><p>The tester calls your Raftâ€™s rf.Kill() when it is permanently shutting down an instance. You can check whether Kill() has been called using rf.killed(). You may want to do this in all loops, to avoid having dead Raft instances print confusing messages.</p></blockquote><p>è¿™ä¸ªæ˜¯è·Ÿæµ‹è¯•ç¯å¢ƒæœ‰å…³çš„å¿ å‘Šï¼Œä»»ä½•ä½¿ç”¨äº†foræ­»å¾ªç¯çš„åœ°æ–¹éƒ½è¦åŠ ä¸Š!rf.killed()ä»£ç æä¾›ä¸­æ­¢ï¼Œä¸»è¦æ˜¯ç»™æµ‹è¯•æ¡†æ¶ä½¿ç”¨çš„ï¼Œå¦‚æœè¿™é‡Œæ²¡å®ç°å¥½ï¼Œåé¢ä¼šå‡ºç°åŠå…¶ç„å­¦ä¸”æ— æ³•æ’æŸ¥çš„bugã€‚å…·ä½“è¡¨ç°ä¸ºå•ä¸ªæµ‹è¯•èƒ½å¤Ÿå¤šæ¬¡é€šè¿‡ï¼Œä½†æ˜¯è¿èµ·æ¥æµ‹è¯•å°±ç–¯ç‹‚å‡ºé”™â€¦</p><blockquote><p>Go RPC sends only struct fields whose names start with capital letters. Sub-structures must also have capitalized field names (e.g. fields of log records in an array). The labgob package will warn you about this; donâ€™t ignore the warnings.</p></blockquote><p>RPCè°ƒç”¨å‡½æ•°å’Œå…¶å‚æ•°ï¼šargså’Œreplysç»“æ„ä½“ä¸­çš„åå­—éƒ½å¿…é¡»ä»¥å¤§å†™å¼€å¤´ï¼Œè¿™æ˜¯goè¯­è¨€çš„ç‰¹æ€§ï¼Œæ— è®ºæ˜¯æ–¹æ³•åã€å¸¸é‡ã€å˜é‡åè¿˜æ˜¯ç»“æ„ä½“çš„åç§°ï¼Œå¦‚æœé¦–å­—æ¯å¤§å†™ï¼Œåˆ™å¯ä»¥è¢«å…¶ä»–çš„åŒ…è®¿é—®ï¼›å¦‚æœé¦–å­—æ¯å°å†™ï¼Œåˆ™åªèƒ½åœ¨æœ¬åŒ…ä¸­ä½¿ç”¨ã€‚å¯ä»¥ç²—æš´çš„ç†è§£ä¸ºé¦–å­—æ¯å¤§å†™æ˜¯å…¬æœ‰çš„ï¼Œé¦–å­—æ¯å°å†™æ˜¯ç§æœ‰çš„ã€‚</p><blockquote><p>The most challenging part of this lab may be the debugging. Spend some time making your implementation easy to debug. Refer to the Guidance page for debugging tips.</p></blockquote><p><strong>DEBUGï¼ï¼ï¼</strong><br>æ‰“logçš„æ—¶å€™ä¸€å®šè¦è§„èŒƒåŒ–ï¼Œä¸è¦è‡ªå·±å†™ä¸€å¤§å¨æ–‡å­—ä¸Šå­—ä¸Šå»ï¼Œè¿å¯¹é½éƒ½åšä¸åˆ°ï¼Œåç»­æˆ‘ä»¬è¦é¢ä¸´çš„logæ•°é‡æ˜¯ä»¥æ•°åä¸‡æ¥è®¡ç®—çš„ï¼Œä¸ºäº†ä¿æŠ¤çœ¼ç›ï¼Œä½ ä¹Ÿå¯ä»¥è·Ÿæˆ‘ä¸€æ ·ä¸ºlogåŠ ä¸€äº›äº®çœ¼çš„é¢œè¡¨æƒ…ï¼Œä¸ºæ¼«é•¿çš„debugä¹‹æ—…å¢æ·»ä¸€ç‚¹ç‚¹ä¹è¶£</p><p>æ€»ä¹‹debugæ˜¯éå¸¸æŠ˜ç£¨çš„ï¼Œæœ¬äººå®ç°raftç®—æ³•ä¹Ÿæ˜¯èŠ±äº†ä¸¤ä¸‰ç™¾å°æ—¶ï¼Œç»å¯¹æœ‰å››äº”æˆçš„æ—¶é—´éƒ½æ¯ååœ¨ç”µè„‘å‰åå¤æŸ¥çœ‹logï¼Œä¿®æ”¹logçš„æ˜¾ç¤ºï¼Œå‰©ä¸‹ä¸‰å››æˆæ—¶é—´æ˜¯åå¤ç”¨çªçœ¼æ³•æŸ¥çœ‹è‡ªå·±å†™çš„ä»£ç ï¼Œä¸æ–­åœ¨è„‘æµ·é‡Œå’Œraftç®—æ³•çš„å„ç§è§„åˆ™è¿›è¡Œæ ¡éªŒã€‚å¯ä»¥è¯´å¯¹raftç®—æ³•çš„ç†è§£æœ‰å¤šæ·±ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºdebugçš„æ—¶é—´æœ‰å¤šé•¿</p><hr><p>é‚£ä¹ˆå¼€å§‹æ­£é¢˜å§</p><p>PartAéœ€è¦æˆ‘ä»¬å®ç°leaderé€‰ä¸¾æœºåˆ¶ï¼Œ</p><p>ç®€å•åœ°è¯´leaderè¦ä¸€ç›´å‘é€å¿ƒè·³åŒ…ï¼Œä¿è¯followerèƒ½å¤Ÿåœ¨ElecltionTimeoutå‰èƒ½è‡³å°‘æ”¶åˆ°ä¸€æ¬¡å¿ƒè·³ï¼Œå¹¶é‡ç½®ElecltionTimeoutã€‚</p><p>å¦‚æœå› ä¸ºç½‘ç»œé—®é¢˜ï¼Œæˆ–è€…å¹²è„†æ˜¯leaderæŒ‚æ‰äº†ï¼Œfollowerç›´åˆ°è¶…æ—¶éƒ½æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œé‚£å®ƒå¯ä»¥åˆæ³•è®¤ä¸ºleaderçœŸçš„æŒ‚äº†ï¼Œfollowerå°±ä¼šè½¬å˜ä¸ºcandidataå¼€å§‹é€‰ä¸¾æµç¨‹ï¼Œé€‰ä¸¾å‡ºæ–°çš„leaderåé‡å¤ä»¥ä¸Šæ­¥éª¤ã€‚</p><p>è¯´èµ·æ¥ç®€å•ï¼Œé‡Œé¢çš„ç»†èŠ‚å¯æ˜¯ç›¸å½“çš„å¤šï¼Œä¸æ€¥ï¼Œåœ¨ä¸‹é¢è¯¦ç»†ä»‹ç»</p><p>PartAæˆ‘ä»¬éœ€è¦å®ç°çš„ç‚¹æœ‰</p><ol><li>å®Œæˆserverç»“æ„ä½“ï¼Œå¿ƒè·³åŒ…ç»“æ„ä½“çš„å®šä¹‰</li><li>leaderå¿ƒè·³æœºåˆ¶</li><li>é€‰ä¸¾æœºåˆ¶</li></ol><h3 id="ç»“æ„ä½“å®šä¹‰"><a href="#ç»“æ„ä½“å®šä¹‰" class="headerlink" title="ç»“æ„ä½“å®šä¹‰"></a>ç»“æ„ä½“å®šä¹‰</h3><p>å¾ˆå¤šå®šä¹‰çš„ä¸œè¥¿æˆ‘ä»¬è¿˜æš‚æ—¶ç”¨ä¸ä¸Šï¼Œä½†æ˜¯æå‰æŒ‰ç…§è®ºæ–‡è¯´çš„å®šä¹‰å¥½å‡†æ²¡é”™</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Raft <span class="token keyword">struct</span> <span class="token punctuation">{</span>mu        sync<span class="token punctuation">.</span>Mutex          <span class="token comment">// Lock to protect shared access to this peer's state</span>peers     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd <span class="token comment">// RPC end points of all peers</span>persister <span class="token operator">*</span>Persister          <span class="token comment">// Object to hold this peer's persisted state</span>me        <span class="token builtin">int</span>                 <span class="token comment">// this peer's index into peers[]</span>dead      <span class="token builtin">int32</span>               <span class="token comment">// set by Kill()</span><span class="token comment">// Your data here (3A, 3B, 3C).</span><span class="token comment">// Look at the paper's Figure 2 for a description of what</span><span class="token comment">// state a Raft server must maintain.</span><span class="token comment">//peer state</span>state <span class="token builtin">int32</span><span class="token comment">//persister æŒä¹…æ€§</span>currentTerm      <span class="token builtin">int</span>votedFor         <span class="token builtin">int</span>log              <span class="token punctuation">[</span><span class="token punctuation">]</span>LogTypelastIncludeIndex <span class="token builtin">int</span>lastIncludeTerm  <span class="token builtin">int</span><span class="token comment">//volatility æ˜“å¤±æ€§</span>commitIndex <span class="token builtin">int</span>lastApplied <span class="token builtin">int</span><span class="token comment">//leader volatility</span>nextIndex  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>matchIndex <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token comment">//AppendEntris info</span>lastHearBeatTime      time<span class="token punctuation">.</span>TimelastSendHeartbeatTime time<span class="token punctuation">.</span>Time<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¿ƒè·³åŒ…ç»“æ„çš„å®šä¹‰</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> AppendEntriesArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>Term         <span class="token builtin">int</span> <span class="token comment">//leaderä»»æœŸ</span>LeaderId     <span class="token builtin">int</span><span class="token comment">//leaderId</span><span class="token punctuation">}</span><span class="token keyword">type</span> AppendEntriesReply <span class="token keyword">struct</span> <span class="token punctuation">{</span>Term          <span class="token builtin">int</span>  <span class="token comment">//æ¥æ”¶è€…ä»»æœŸ</span>Success       <span class="token builtin">bool</span> <span class="token comment">//æ˜¯å¦æ¥å—äº†å¿ƒè·³åŒ…çš„é™„å¸¦æ—¥å¿—</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é€‰ä¸¾æœºåˆ¶"><a href="#é€‰ä¸¾æœºåˆ¶" class="headerlink" title="é€‰ä¸¾æœºåˆ¶"></a>é€‰ä¸¾æœºåˆ¶</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> RequestVoteArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token comment">// Your data here (3A, 3B).</span>Term         <span class="token builtin">int</span>CandidateId  <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">type</span> RequestVoteReply <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token comment">// Your data here (3A).</span>Term        <span class="token builtin">int</span>VoteGranted <span class="token builtin">bool</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸€ä¸ªå¤§å¾ªç¯ä¸­è¿›è¡Œæµç¨‹ï¼Œæ¯å¾ªç¯ä¸€æ¬¡sleep 10ms</p><ol><li>æ£€æŸ¥çŠ¶æ€ï¼Œå·²ç»æ˜¯leaderäº†ï¼Œcontinueä¸‹ä¸€æ¬¡å¾ªç¯</li><li>æ£€æŸ¥è¶…æ—¶æ—¶é—´timeCount := time.Since(rf.lastHearBeatTime).Milliseconds()<ol><li>æ²¡æœ‰è¶…æ—¶ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</li><li>è¶…æ—¶ï¼Œç»§ç»­å¾€ä¸‹èµ°</li></ol></li><li>æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯followerï¼ŒçŠ¶æ€æ”¹ä¸ºcandidateï¼Œç»§ç»­å¾€ä¸‹èµ°</li><li>æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€ï¼Œè‹¥æœæ˜¯candidateï¼Œæ›´æ–°è®¡æ—¶å™¨ï¼Œè‡ªå¢ä»»æœŸï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼Œç»§ç»­å¾€ä¸‹èµ°</li><li>å‘é€æŠ•ç¥¨è¯·æ±‚ï¼Œé˜»å¡ç»Ÿè®¡æŠ•ç¥¨ç»“æœ<ol><li>è¿˜æ²¡ç»Ÿè®¡å®Œæ¯•å°±è¶…æ—¶äº†ï¼Œè§£é™¤é˜»å¡ï¼Œç»§ç»­å¾€ä¸‹èµ°</li><li>è¶…æ—¶å‰æ‹¿åˆ°äº†ç»“æœï¼Œå¾€ä¸‹èµ°</li></ol></li><li><strong>æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€è¿˜æ˜¯ä¸æ˜¯candidate</strong>ï¼Œå¦‚æœä¸æ˜¯äº†ï¼Œcontinueè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå¦‚æœè¿˜æ˜¯candidateï¼Œç»§ç»­å¾€ä¸‹èµ°</li><li>æŸ¥çœ‹æŠ•ç¥¨ç»“æœï¼Œ<ol><li>å¾—åˆ°åŠæ•°åŠä»¥ä¸ŠæŠ•ç¥¨ï¼ˆåŠ ä¸Šè‡ªå·±ç»™è‡ªå·±å¤´çš„ä¸€ç¥¨å°±è¶…åŠæ•°äº†ï¼‰åˆ™è½¬å˜çŠ¶æ€ä¸ºleaderï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</li><li>é€‰ä¸¾å¤±è´¥ï¼Œä¸åšæ“ä½œï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</li></ol></li></ol><p>ä¸ºä»€ä¹ˆéœ€è¦åœ¨ç¬¬6æ­¥æ£€æŸ¥è‡ªå·±æ˜¯ä¸æ˜¯candidateï¼Ÿå› ä¸ºæ‰€æœ‰RPCçš„å‘é€å’Œå“åº”éƒ½å¸¦æœ‰Termä¿¡æ¯ï¼Œæ¥æ”¶æ–¹éƒ½éœ€è¦å¯¹Termçš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæŠ•ç¥¨RPCè¯·æ±‚çš„å“åº”çš„Termæ¯”è‡ªå·±å¤§ï¼Œéœ€è¦å°†è‡ªå·±çš„çŠ¶æ€è½¬å˜ä¸ºfollowerï¼Œæ›´æ–°è‡ªå·±çš„ä»»æœŸï¼Œæ¸…ç©ºvoteForã€‚</p><p>å¦‚æœçŠ¶æ€è½¬å˜ä¸ºfollowerï¼Œå…¶ä»–æ‰€æœ‰æµç¨‹ï¼ˆcandidateé€‰ä¸¾æµç¨‹ï¼Œleaderå‘é€å¿ƒè·³ï¼‰éƒ½è¦ç«‹åˆ»ä¸­æ–­ï¼Œè¿™å°±æ˜¯ä½¿ç”¨å¤§å¾ªç¯çš„å¥½å¤„ï¼Œå¯ä»¥éšæ—¶ä½¿ç”¨continueä¸­æ–­å½“å‰æµç¨‹ã€‚å¦‚æœä½¿ç”¨å„ç§å‡½æ•°åµŒå¥—å®ç°æµç¨‹ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯ä¼ é€’å¾ˆå¤æ‚ï¼Œæå…¶å®¹æ˜“å‡ºé”™ã€‚</p><p>æœ¬äººå°±å› ä¸ºè¿™ä¸€ç‚¹åƒè¿‡è‹¦</p><h3 id="å¿ƒè·³æœºåˆ¶"><a href="#å¿ƒè·³æœºåˆ¶" class="headerlink" title="å¿ƒè·³æœºåˆ¶"></a>å¿ƒè·³æœºåˆ¶</h3><p>leaderå½“é€‰åå®šæ—¶å‘é€å¿ƒè·³åŒ…ç»™å…¶ä»–followeræˆ–candidate</p><p>ç”±äºlab1åªéœ€è¦å®ç°æ— æ—¥å¿—çš„é¢†å¯¼äººé€‰ä¸¾ï¼Œæ‰€ä»¥å¿ƒè·³åŒ…çš„å‚æ•°åªéœ€è¦æœ‰Termå’ŒLeaderIdå°±å¤Ÿäº†</p><p>ä¸»è¦æ€è·¯æ˜¯ä½¿ç”¨forå¤§å¾ªç¯ï¼Œæ£€æµ‹è‡ªå·±æ˜¯å¦ä¸ºleaderï¼Œæ˜¯åˆ™è¿›è¡Œå¿ƒè·³åŒ…å‘é€åˆ¤æ–­</p><p>æ£€æŸ¥ä¸Šæ¬¡å‘é€å¿ƒè·³åŒ…çš„æ—¶é—´è·ç¦»å½“å‰æ—¶é—´çš„å€¼ï¼Œå¦‚æœè¶…è¿‡äº†è§„å®šçš„å¿ƒè·³åŒ…å‘é€é—´éš”å°±è¿›è¡Œä¸€æ¬¡å¿ƒè·³åŒ…çš„å‘é€</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">appendEntriesLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token operator">!</span>rf<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> leader <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>countTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>lastSendHeartbeatTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> countTime <span class="token operator">&lt;</span> HeartBeatInterval <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>rf<span class="token punctuation">.</span>lastSendHeartbeatTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//å‘é€å¿ƒè·³</span>rf<span class="token punctuation">.</span><span class="token function">SendAppendEntriesToAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»leaderçš„è§’åº¦æ¥çœ‹ï¼Œå¿ƒè·³åŒ…æœ‰è¿™äº”ç§å“åº”ç±»å‹ï¼Œæ³¨æ„è¿™å¹¶ä¸æ˜¯éœ€è¦å†™åœ¨å¿ƒè·³åŒ…çš„å‚æ•°ï¼Œåªæ˜¯ä¸ºäº†debugæ–¹ä¾¿è¢«æˆ‘å®šä¹‰å‡ºæ¥çš„</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>AEresult_Accept      <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//æ¥å—æ—¥å¿—</span>AEresult_Reject             <span class="token comment">//ä¸æ¥å—æ—¥å¿—</span>AEresult_StopSending        <span class="token comment">//æˆ‘ä»»æœŸæ¯”ä½ å¤§ï¼</span>AEresult_Ignore             <span class="token comment">//ä¸Šä¸ªä»»æœŸæˆ–æ›´ä¹…å‰å‘é€çš„å¿ƒè·³çš„å“åº”</span>AEresult_Lost               <span class="token comment">//è¶…æ—¶ï¼Œå¯¹æ–¹æ²¡æ”¶åˆ°å¿ƒè·³åŒ…/å·±æ–¹æ²¡æ”¶åˆ°å“åº”</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äºlab1éƒ½æ˜¯æ— æ—¥å¿—çš„ç©ºå¿ƒè·³åŒ…ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°AEresult_Rejectï¼Œä½†å…¶å®ƒæƒ…å†µéƒ½æœ‰å¯èƒ½</p><p>leaderæ”¶åˆ°çš„å¿ƒè·³åŒ…å“åº”åéœ€è¦ç«‹åˆ»ç¡®è®¤åŒ…è¿”å›å‚æ•°ä¸­çš„Termï¼Œå¦‚æœTermæ¯”è‡ªå·±çš„ä»»æœŸå¤§ï¼Œ</p><ol><li>éœ€è¦ç«‹åˆ»åœæ­¢å‰©ä½™å¿ƒè·³çš„å‘é€ï¼Œå°†è‡ªå·±çš„çŠ¶æ€æ›´æ”¹ä¸ºfollower</li><li>æ›´æ–°è‡ªå·±çš„term</li><li><strong>ä¸è¦</strong>é‡ç½®å®šæ—¶å™¨</li></ol><p>è¿™é‡Œä»‹ç»ä¸€ä¸‹å¦‚ä½•å®ç°ElectionTimeoutå®šæ—¶å™¨ï¼Œæ€è·¯å¾ˆç®€å•ï¼Œå¯¹äºfollowerå’Œcandidateï¼Œä»ç„¶æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ä¸åœæ£€æµ‹å½“å‰æ—¶é—´å’Œä¸Šæ¬¡æ”¶åˆ°å¿ƒè·³çš„æ—¶é—´lastHearBeatTimeçš„å·®å€¼ï¼Œå¦‚æœè·ç¦»ä¸Šæ¬¡æ”¶åˆ°å¿ƒè·³åŒ…çš„æ—¶é—´æ²¡è¶…è¿‡è®¾å®šçš„éšæœºå€¼ï¼Œç¡ä¸€å°ä¼šï¼ˆ10msï¼‰ç„¶åé‡å¤æ£€æµ‹ï¼Œå¦‚æœè¶…è¿‡äº†ï¼Œå°±å¯ä»¥åœ¨å¾ªç¯é‡Œå¾€ä¸‹èµ°æµç¨‹ï¼ˆåˆæ¬¡é€‰ä¸¾æµç¨‹ï¼Œé€‰ä¸¾è¶…æ—¶æµç¨‹ï¼Œé€‰ä¸¾å¤±è´¥æµç¨‹ï¼‰</p><p>é‚£ä¹ˆæ‰€è°“çš„é‡ç½®å®šæ—¶å™¨å°±åªæ˜¯æ›´æ–°lastHearBeatTimeä¸ºå½“å‰æ—¶é—´è€Œå·²ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé‡ç½®æ¦‚å¿µä¸è¦æ··æ·†ï¼š</p><ol><li>followerè¶…æ—¶/candiataé€‰ä¸¾è¶…æ—¶ï¼Œè¶…æ—¶åˆ°è¾¾åé‡ç½®ä¸€ä¸ªæ–°çš„æ—¶é—´é—´éš”ï¼Œæ¯”å¦‚åŸæœ¬çš„ElectionTimeoutæ—¶é—´é•¿åº¦ä¸º359msï¼Œä¸‹ä¸€æ¬¡å°±éšæœºä¸€ä¸ªæ–°çš„ElectionTimeoutæ—¶é—´ï¼Œæ¯”å¦‚524ms</li><li>follower/candidateæ”¶åˆ°ä¸€ä¸ªåˆæ³•ï¼ˆä»»æœŸå¤§äºç­‰äºè‡ªå·±çš„ä»»æœŸï¼‰leaderçš„å¿ƒè·³ï¼Œé‡ç½®<strong>lastHearbeatTime</strong>ä¸ºæ”¶åˆ°leaderå¿ƒè·³çš„æ—¶é—´ï¼Œå½“ç„¶ç»†è¯»è®ºæ–‡åï¼Œè¿˜æœ‰ä¸¤ä¸ªæ²¡æœ‰æ”¶åˆ°å¿ƒè·³å´è¦é‡ç½®å®šæ—¶å™¨çš„æ—¶æœºï¼Œåˆ†åˆ«æ˜¯ï¼š<ol><li>followerå› ä¸ºè¶…æ—¶ï¼Œæˆä¸ºcandidateçš„æ—¶å€™ï¼Œ </li><li>followeræ”¶åˆ°é€‰ç¥¨è¯·æ±‚å¹¶ä¸”<strong>æŠ•å‡ºèµåŒç¥¨</strong>æ—¶ã€‚</li></ol></li></ol><p>   åªæœ‰è¿™ä¸‰ç§æƒ…å†µå¯ä»¥æ›´æ–°lastHearBeatTimeï¼Œï¼ˆå½“ç„¶è¯ä¸èƒ½è¯´å¤ªç»ï¼Œåé¢åŠ å…¥å¿«ç…§æœºåˆ¶çš„æ—¶å€™ï¼Œfolloweræ”¶åˆ°å¿«ç…§ååŒæ ·å¯ä»¥é‡ç½®</p><p>ä»Šåæœ¬æ–‡æ‰€è¯´çš„é‡ç½®å®šæ—¶å™¨å‡æ˜¯æŒ‡çš„ç¬¬äºŒç§æƒ…å†µï¼šæ›´æ–°lastHeartbeatTIme</p><p><strong>å¿ƒè·³åŒ…æ¥æ”¶è€…çš„ä¸¥æ ¼æŒ‰é¡ºåºæµç¨‹ï¼š</strong></p><ol><li>å¿ƒè·³åŒ…çš„ä»»æœŸæ¯”è‡ªå·±å°ï¼Œç›´æ¥å¿½è§†ï¼Œå½“ç„¶è¿”å›å€¼è¿˜æ˜¯è¦å¸¦ä¸Šè‡ªå·±çš„ä»»æœŸï¼Œä»¥ä¾¿ä»»æœŸè½åçš„leaderæ›´æ–°è‡ªå·±çš„çŠ¶æ€ã€‚ä¸­æ­¢æµç¨‹ï¼Œä¸‹é¢æ“ä½œéƒ½ä¸åšï¼Œç›´æ¥è¿”å›</li><li>å¿ƒè·³åŒ…çš„ä»»æœŸå¤§äºè‡ªå·±çš„ä»»æœŸï¼ŒæŠŠè‡ªå·±çš„ä»»æœŸæ›´æ–°åˆ°å¿ƒè·³åŒ…çš„ä»»æœŸï¼Œæ¸…ç©ºvoteforï¼Œå¦‚æœè‡ªå·±çš„çŠ¶æ€æ˜¯candidateï¼Œé€€åŒ–ä¸ºfollowerï¼Œç»§ç»­å¾€ä¸‹èµ°</li><li>å¿ƒè·³åŒ…çš„ä»»æœŸç­‰äºè‡ªå·±çš„ä»»æœŸï¼Œå¦‚æœè‡ªå·±çš„çŠ¶æ€æ˜¯candidateï¼Œé€€åŒ–ä¸ºfollowerï¼Œæ¸…ç©ºvoteforï¼Œç»§ç»­å¾€ä¸‹èµ°</li><li>æ›´æ–°å®šæ—¶å™¨ï¼Œæ›´æ–°leaderIdä¸ºå¿ƒè·³åŒ…çš„leaderidï¼Œè¿”å›successå’Œè‡ªå·±çš„term</li></ol><p>æ— æ—¥å¿—æƒ…å†µä¸‹çš„å¿ƒè·³æœºåˆ¶å°±è¿™äº›</p><p>å®ç°å¥½ä¸¤è¿™ä¸ªæµç¨‹ï¼ŒPartAåŸºæœ¬å°±èƒ½é€šè¿‡äº†</p><p>åˆæ¬¡å®éªŒå¯èƒ½ä¼šå‡ºç°æµ‹è¯•é€šè¿‡äº†ï¼Œä½†æµ‹è¯•å´è­¦å‘Šï¼šâ€œåœ¨æ²¡æœ‰ç½‘ç»œå´©æºƒçš„æƒ…å†µä¸‹å‘ç”Ÿäº†é€‰ä¸¾â€</p><p>è¿™è¯´æ˜ä¸€å®šæœ‰å“ªä¸ªæµç¨‹æ²¡æœ‰è¢«æ­£ç¡®å®ç°ï¼Œæ¯”è¾ƒå¸¸è§çš„é”™è¯¯æ˜¯æ”¶åˆ°å¿ƒè·³çš„æ—¶å€™æ²¡æœ‰æ­£ç¡®æ›´æ–°å®šæ—¶å™¨</p><hr><h2 id="Part-3B-log-hard"><a href="#Part-3B-log-hard" class="headerlink" title="Part 3B: log (hard)"></a>Part 3B: log (hard)</h2><p>åœ¨è¿™ä¸€èŠ‚å¼€å§‹å…³äºé”çš„ä½¿ç”¨å°±éœ€è¦é‡è§†äº†ï¼Œä¸åœä½¿ç”¨å¤§é”æŠŠæ¯ä¸ªå‡½æ•°é”èµ·æ¥ç¡®å®å¯ä»¥å¾ˆå¤§ä¸€éƒ¨åˆ†å¹¶å‘å¸¦æ¥çš„é—®é¢˜ï¼Œä½†æ˜¯æ•ˆç‡ä¹Ÿæ˜¯ä½ä¸‹çš„ï¼Œæœ€å¥½åœ¨è€ƒè™‘å¹¶å‘å®‰å…¨çš„åŒæ—¶å°½å¯èƒ½ç¼©å°é”çš„èŒƒå›´ã€‚</p><p>ç…§ä¾‹çœ‹Hint</p><blockquote><p>You will need to implement the election restriction (section 5.4.1 in the paper).</p></blockquote><p><img src="/"></p><p>ç®€å•ç¿»è¯‘ï¼Œcandidateçš„æ—¥å¿—å¦‚æœä¸æ¯”è‡ªå·±ï¼ˆfollowerï¼‰çš„æ—¥å¿—æ–°ï¼Œé‚£å°±æ‹’ç»æŠ•ç¥¨</p><p>å¦‚ä½•å®šä¹‰æ–°ï¼Ÿæ¯”è¾ƒä¸¤è€…çš„æœ€åä¸€æ¡æ—¥å¿—çš„termï¼Œtermæ›´å¤§çš„å°±æ˜¯æ›´æ–°ï¼Œå¦‚æœtermä¸€æ ·ï¼Œæ¯”è¾ƒæœ€åä¸€æ¡æ—¥å¿—çš„indexï¼Œè°çš„indexæ›´å¤§è°å°±æ–°</p><p>æ‰€ä»¥followeræ¯”candidateæ–°,followerå°±ä¸ä¼šæŠ•èµæˆç¥¨ï¼Œå¦‚æœcandidateæ›´æ–°ï¼Œæˆ–è€…ä¸¤è€…åŒæ ·æ–°ï¼Œå°±å¯ä»¥èµåŒæŠ•ç¥¨</p><p>ä¸ºäº†å®ç°æ¯”è¾ƒtermå’Œindexï¼Œå¢åŠ voteç»“æ„ä½“æˆå‘˜ LastLogIndexå’ŒLastLogTermï¼Œå¦‚æœä¸€å¼€å§‹å¤§å®¶éƒ½æ²¡æœ‰æ—¥å¿—ï¼Œé‚£å°±è®¾ç½®ä¸ºæŸä¸ªé»˜è®¤å€¼ï¼Œæˆ‘æ˜¯è®¾æˆ-1</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> RequestVoteArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token comment">// Your data here (3A, 3B).</span>Term         <span class="token builtin">int</span>CandidateId  <span class="token builtin">int</span>LastLogIndex <span class="token builtin">int</span>LastLogTerm  <span class="token builtin">int</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>followerå¤„ç†æŠ•ç¥¨çš„å…·ä½“å®ç°ä»£ç ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> rf<span class="token punctuation">.</span>votedFor <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> rf<span class="token punctuation">.</span>votedFor <span class="token operator">==</span> args<span class="token punctuation">.</span>CandidateId <span class="token punctuation">{</span>lastLogTerm <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">lastTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LastLogTerm <span class="token operator">&gt;</span> lastLogTerm <span class="token operator">||</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>LastLogTerm <span class="token operator">==</span> lastLogTerm <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>LastLogIndex <span class="token operator">&gt;=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> args<span class="token punctuation">.</span>CandidateIdreply<span class="token punctuation">.</span>VoteGranted <span class="token operator">=</span> <span class="token boolean">true</span>rf<span class="token punctuation">.</span>lastHearBeatTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ«Rec Term[%d] [%d] -&gt; [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>CandidateId<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„ç»†èŠ‚</p><p>1ï¼šrf.votedFor == -1çš„åˆ¤æ–­ï¼Œä¸€ä¸ªä»»æœŸå†…ï¼Œfolloweråªèƒ½æŠ•ä¸€å¼ èµæˆç¥¨ï¼Œè¿™ä¿è¯äº†ä¸€ä¸ªä»»æœŸå†…åªä¼šåˆæ³•äº§ç”Ÿä¸€ä¸ªleaderã€‚</p><p>2ï¼šrf.votedFor == args.CandidateId è¿™ä¸ªåˆ¤æ–­æ˜¯æˆ‘åœ¨debugä¹‹æ—…åšå‡ºçš„å°è¯•ï¼Œé€»è¾‘ä¸Šå¹¶æ²¡æœ‰é—®é¢˜ï¼Œfollowerå‘å‡ºçš„èµæˆç¥¨å¯èƒ½å› ä¸ºç½‘ç»œä¸¢åŒ…å¯¼è‡´candidateæ²¡æ”¶åˆ°è¿™å¼ ç¥¨ï¼Œé‚£ä¹ˆfollowerå†æ¬¡æ”¶åˆ°åŒä¸€ä¸ªcandidateçš„æŠ•ç¥¨è¯·æ±‚æ—¶ï¼Œæ—¢ç„¶å·²ç»æŠ•ç»™å®ƒäº†é‚£ä¹ˆå†æŠ•ä¸€æ¬¡ä¹Ÿæ— å¦¨ã€‚ä½†å®é™…ä¸Šcandidateåœ¨ä¸€ä¸ªä»»æœŸå†…åªä¼šå‘ä¸€ä¸ªæœåŠ¡å™¨å‘é€ä¸€æ¬¡æŠ•ç¥¨RPCï¼Œä½•æ¥é‡å¤ä¸€è¯´â€¦ä½†æ—¢ç„¶ç•™ç€æ²¡é—®é¢˜ï¼Œæˆ‘ä¹Ÿä¸åˆ äº†</p><h3 id="æ—¥å¿—å¤åˆ¶"><a href="#æ—¥å¿—å¤åˆ¶" class="headerlink" title="æ—¥å¿—å¤åˆ¶"></a>æ—¥å¿—å¤åˆ¶</h3><p>ä¿®æ”¹å¿ƒè·³åŒ…ç›¸å…³ä»£ç </p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> AppendEntriesArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>Term         <span class="token builtin">int</span> <span class="token comment">//leaderä»»æœŸ</span>LeaderId     <span class="token builtin">int</span> <span class="token comment">//leaderId</span>PrevLogIndex <span class="token builtin">int</span>PrevLogTerm  <span class="token builtin">int</span>Entries      <span class="token punctuation">[</span><span class="token punctuation">]</span>LogTypeLeaderCommit <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">type</span> AppendEntriesReply <span class="token keyword">struct</span> <span class="token punctuation">{</span>Term          <span class="token builtin">int</span>  <span class="token comment">//æ¥æ”¶è€…ä»»æœŸ</span>Success       <span class="token builtin">bool</span> <span class="token comment">//æ˜¯å¦æ¥å—å¿ƒè·³åŒ…</span>ConflictIndex <span class="token builtin">int</span>ConflictTerm  <span class="token builtin">int</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ConflictIndex ConflictTermï¼šè¿™ä¸¤ä¸ªå‚æ•°è®ºæ–‡ä¸Šæ²¡æœ‰ï¼Œè¿™æ˜¯ç”¨äºåŠ å¿«leaderä¼ è¾“æ—¥å¿—çš„å›é€€é€Ÿåº¦æ‰€éœ€è¦ä½¿ç”¨çš„å‚æ•°ï¼Œæš‚æ—¶æŒ‰ä¸‹ä¸è¡¨</p><p>æ—¢ç„¶è¦å®ç°æ—¥å¿—å¤åˆ¶ï¼Œé‚£é¦–å…ˆå¾—æœ‰æ—¥å¿—ã€‚</p><p>æµ‹è¯•æ¡†æ¶é€šè¿‡Start()å‡½æ•°ï¼Œä¸ºå½“å‰leaderæ–°å¢æ—¥å¿—ï¼Œ</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>command <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>index <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>term <span class="token operator">:=</span> rf<span class="token punctuation">.</span>currentTermisLeader <span class="token operator">:=</span> rf<span class="token punctuation">.</span>state <span class="token operator">==</span> leader<span class="token comment">// Your code here (3B).</span><span class="token keyword">if</span> <span class="token operator">!</span>isLeader <span class="token punctuation">{</span><span class="token keyword">return</span> index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isLeader<span class="token punctuation">}</span><span class="token comment">//æ·»åŠ æ¡ç›®åˆ°æœ¬åœ°</span>rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">,</span> LogType<span class="token punctuation">{</span>Term<span class="token punctuation">:</span>  rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span>Value<span class="token punctuation">:</span> command<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"CLIENTğŸ“¨ Term[%d] [%d] Receive [%v] logIndex[%d](leader action)\n"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> command<span class="token punctuation">,</span> index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">return</span> index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isLeader<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯éleaderè¢«è°ƒç”¨äº†Start()ï¼Œè¿”å›falseå³å¯ï¼Œæˆ‘å‘æµ‹è¯•æ¡†æ¶è¿”å›çš„indexä¸ºrf.lastIndex() + 2ï¼Œè¿™æ˜¯å› ä¸ºå®˜æ–¹çš„è®¤ä¸ºç¬¬ä¸€æ¡logçš„indexä¸º1ï¼Œæˆ‘è¿™é‡Œå¹¶æ²¡æœ‰åœ¨logä¸­å®ç°å“¨å…µä½ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¡logçš„indexæ˜¯ä»0å¼€å§‹çš„ï¼Œæ‰€ä»¥å¢åŠ ä¸€æ¡logä¹‹åindexçš„å€¼è¿˜å¾—+1ï¼Œæ‰æ˜¯æµ‹è¯•ç¨‹åºå¸Œæœ›å¾—åˆ°çš„è¿”å›å€¼ã€‚</p><p>è¿½åŠ å®Œæ–°æ—¥å¿—æ¡ç›®åå¯ä»¥é€‰æ‹©ç›´æ¥ç”¨ä¸€ä¸ªåç¨‹æ¥å‘é€AppendEntries RPCåŒæ­¥æ—¥å¿—ï¼Œå¯ä»¥ç­‰leaderä¸‹ä¸€æ¬¡å¿ƒè·³å‘¨æœŸåˆ°è¾¾ï¼Œå†è‡ªåŠ¨å‘é€ã€‚</p><blockquote><p>æˆ‘ä¸€å¼€å§‹å¹¶æ²¡æœ‰å¤ªåœ¨æ„è¿™ä¸ªåœ°æ–¹ï¼Œæ²¡æƒ³åˆ°åœ¨lab4ä¸€ä¸ªæ¯”è¾ƒä¸¥æ ¼çš„æµ‹è¯•ä¸­èƒŒåˆºåˆ°äº†ï¼Œé‚£ä¸ªæµ‹è¯•æ€»å…±å‘é€å‘leaderå‘é€1000æ—¥å¿—ï¼Œè€Œä¸”åªæœ‰å‰ä¸€æ¡æ—¥å¿—è¢«ç¡®è®¤å¤åˆ¶åˆ°äº†å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šä¹‹åï¼Œæ‰å‘é€ä¸‹ä¸€æ¡æ—¥å¿—ï¼Œæœ€åç»Ÿè®¡å‡ºæ¥100ms/op &gt; 33.3ms/op Fail Test</p></blockquote><p>leaderæœ‰äº†æ–°æ—¥å¿—ä¹‹åå°±å¯ä»¥å¼€å§‹æ—¥å¿—å¤åˆ¶æµç¨‹äº†ï¼Œæ—¥å¿—å¤åˆ¶çš„éƒ¨åˆ†æ”¾åœ¨å¿ƒè·³åŒ…çš„å‘é€æµç¨‹ä¸­ï¼Œè¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ªæ•°ç»„æ¥ç¡®å®šleaderéœ€è¦å‘é€å“ªäº›æ—¥å¿—ï¼Œ</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">nextIndex  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>matchIndex <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>nextIndexæ•°ç»„</strong></p><p>nextIndexæ•°ç»„çš„æ„ä¹‰éå¸¸æ˜ç¡®ï¼Œleaderæ¯æ¬¡å‘idä¸ºiçš„followerå‘é€çš„å¿ƒè·³åŒ…ä¸­ï¼Œéœ€è¦é™„åŠ nextIndex[i]åˆ°æœ€æ–°æ—¥å¿—æ¡ç›®çš„æ‰€æœ‰æ—¥å¿—</p><p>æ¯æ¬¡leaderå½“é€‰åéƒ½è¦é‡ç½®nextIndexæ•°ç»„ï¼Œè®©å…¶æ‰€æœ‰å…ƒç´ çš„å€¼æŒ‡å‘leaderå½“å‰æœ€æ–°æ—¥å¿—çš„ä¸‹ä¸€ä½ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡å‘äº†ä¸€ä¸ªç©ºä½ç½®</p><p>æ‰€ä»¥æ–°leaderå½“é€‰åå‘é€çš„ç¬¬ä¸€æ¡AEå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ç©ºæ—¥å¿—</p><p>leaderå½“é€‰åè¿˜è¦é‡ç½®matchIndexæ•°ç»„çš„å€¼ä¸º0ï¼Œå½“ç„¶è¿˜æ˜¯å› ä¸ºæˆ‘çš„logæ²¡æœ‰è®¾ç½®å“¨å…µä½ï¼Œæ‰€ä»¥æˆ‘è®¾ç½®æˆ-1</p><p><strong>matchIndexæ•°ç»„</strong></p><p>matchIndexæ•°ç»„çš„æ„ä¹‰æ˜¯è¡¨ç¤ºï¼šleaderç¡®è®¤è¿‡çš„ï¼Œfollowerã€iã€‘ä¸è‡ªå·±æ—¥å¿—ä¿æŒä¸€è‡´çš„æœ€æ–°Indexï¼Œå…·ä½“å¦‚ä½•æ›´æ–°å®ƒçš„å€¼åé¢ä¼šè¯´æ˜</p><p>matchIndexæ•°ç»„çš„ä½œç”¨åªæ˜¯ä¸ºäº†ç»™commitIndexçš„æ›´æ–°åšå‚è€ƒ</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> voteCount <span class="token operator">&gt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>IisBack <span class="token operator">=</span> <span class="token boolean">false</span>rf<span class="token punctuation">.</span>state <span class="token operator">=</span> leaderrf<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> rf<span class="token punctuation">.</span>merf<span class="token punctuation">.</span>nextIndex <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span>rf<span class="token punctuation">.</span>matchIndex <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token comment">//è¿™æ¡logä¸å…¶ä»–logç›¸æ¯”æ‰“å°åœ¨å±å¹•ä¸Šä¼šæœ‰å¾ˆæ˜æ˜¾çš„é”™ä½æ•ˆæœï¼Œæ¯”è¾ƒé‡è¦çš„logå¯ä»¥æ•…æ„ä¸éµå®ˆæ ¼å¼ï¼Œæ–¹ä¾¿ç¬¬ä¸€çœ¼æ‰¾åˆ°ï¼Œå½“ç„¶åé¢å®éªŒæ•°åä¸‡æ¡logï¼Œideè‡ªå·±éƒ½ä¸æ„¿æ„æ‰“å¼€çš„è¶…å¤§æ—¥å¿—æ–‡ä»¶å†æ€ä¹ˆæ˜¾çœ¼éƒ½æ²¡åµç”¨ã€‚åªèƒ½æ˜¯è®¾ç½®å¥½å…³é”®è¯ï¼Œå–„ç”¨æœç´¢åŠŸèƒ½äº†</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"â— Term[%d] [%d] candidate -&gt; leader"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>lastSendHeartbeatTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">-</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> HeartBeatInterval<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åleaderå°±å¯ä»¥å¼€å§‹æ ¹æ®nextIndexçš„å€¼å‘é€æ—¥å¿—äº†</p><h4 id="leaderæ—¥å¿—å‘é€"><a href="#leaderæ—¥å¿—å‘é€" class="headerlink" title="leaderæ—¥å¿—å‘é€"></a>leaderæ—¥å¿—å‘é€</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">*</span>args <span class="token operator">=</span> AppendEntriesArgs<span class="token punctuation">{</span>Term<span class="token punctuation">:</span>         rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span>LeaderId<span class="token punctuation">:</span>     rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span>PrevLogIndex<span class="token punctuation">:</span> rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>PrevLogTerm<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>Entries<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LogType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>LeaderCommit<span class="token punctuation">:</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//æœ‰PrevIndex</span>args<span class="token punctuation">.</span>PrevLogTerm <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term<span class="token punctuation">}</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//æœ‰nextIndex</span>args<span class="token punctuation">.</span>Entries <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Entries<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>leaderå°†ä¸‹æ ‡ä¸ºnextIndexåˆ°æœ€æ–°ä¸‹æ ‡çš„æ‰€æœ‰æ—¥å¿—æ”¾åˆ°å¿ƒè·³åŒ…é‡Œå‘ç»™å¯¹åº”çš„æœåŠ¡å™¨</p><p>argsä¸­çš„PreLogIndexå’ŒPreLogTermæ˜¯leaderè¦å‘ç»™è¯¥serveçš„æ—¥å¿—æ®µçš„å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œfolloweréœ€è¦æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°çš„å€¼åˆ¤æ–­è‡ªå·±çš„æ—¥å¿—æœ‰æ²¡æœ‰è·ŸleaderåŒ¹é…ä¸Šï¼Œæ²¡åŒ¹é…ä¸Šçš„è¯æ˜¯ä¸èƒ½å¤åˆ¶è¿™ä»½å¿ƒè·³é‡Œçš„æ—¥å¿—çš„</p><p>leaderå‘é€å®Œå¿ƒè·³RPCåå¤„ç†å›å‚çš„éƒ¨åˆ†æ”¾åœ¨ä¸‹æ–‡</p><p>LeaderCommitç”¨æ¥æ›´æ–°followerçš„commitIndex</p><p>å›é¡¾matchIndexçš„ä½œç”¨ï¼Œ</p><p>leaderçš„commitIndexç”±matchIndexå†³å®šï¼Œ</p><p>followerçš„commitInedxç”±leaderå¿ƒè·³çš„LeaderCommitï¼ˆcommitIndexï¼‰å†³å®šï¼Œ</p><p>matchIndexçš„å€¼æ ¹æ®followerçš„å¿ƒè·³å›å‚å†³å®šï¼Œå¦‚æœfolloweråŒ¹é…ä¸Šäº†æ—¥å¿—ï¼Œé‚£ä¹ˆleaderå°±å¯ä»¥æ›´æ–°matchIndexçš„å€¼ä¸ºå‘é€å¿ƒè·³æ—¶çš„æœ€æ–°æ—¥å¿—æ¡ç›®çš„index</p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå¼¯å¼¯ç»•ç»•çš„æ›´æ–°commitIndexçš„å€¼å‘¢ã€‚è¿™æ˜¯ä¿è¯æ—¥å¿—åœ¨å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šä¿æŒä¸€è‡´çš„å…³é”®ã€‚</p><p>leaderå¯ä»¥åªåœ¨ä¸€æ¬¡å¿ƒè·³å‘¨æœŸå†…æ›´æ–°è‡ªå·±çš„commitIndexçš„å€¼ï¼Œè¿™æ˜¯å› ä¸ºleaderæ‹¥æœ‰è·Ÿå¤§å¤šæ•°followeré€šä¿¡çš„ç‰¹æƒï¼Œå®ƒç¡®å®çŸ¥é“commitIndexåœ¨å¤šæ•°æœåŠ¡å™¨ä¸Šè¾¾æˆå…±è¯†äº†æ‰€ä»¥leaderå¯ä»¥æ›´æ–°ã€‚</p><p>å…¶ä»–æœåŠ¡å™¨åˆ™è‡³å°‘éœ€è¦ç»è¿‡<strong>ä¸¤æ¬¡å¿ƒè·³å‘¨æœŸ</strong>æ‰èƒ½æ›´æ–°è‡ªå·±çš„commitIndexåˆ°leaderæ°´å¹³ï¼Œå› ä¸ºfollowerä¾èµ–äºleaderçš„åˆ¤æ–­ã€‚ </p><p>è¿™æœ‰ç‚¹ç±»ä¼¼äºTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œåªæœ‰ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ‰èƒ½ä½¿åŒæ–¹è¾¾æˆå…±è¯†ï¼Œå°‘ä¸€æ¬¡éƒ½æ— æ³•ç¡®è®¤ã€‚</p><p><strong>followeræ—¥å¿—å¤åˆ¶</strong></p><p>followerä¹Ÿä¸æ˜¯æ”¶åˆ°æ—¥å¿—å°±ä¸‡äº‹å¤§å‰çš„ï¼Œéœ€è¦ç»è¿‡é¢å¤–åˆ¤æ–­ç¡®è®¤èƒ½å¦æ¥å—æ—¥å¿—</p><p>é‚£å°±æ˜¯åˆ¤æ–­PrevLogIndexå’ŒPrevLogTermå’Œè‡ªå·±çš„æ—¥å¿—æ˜¯å¦åŒ¹é…ä¸Šäº†</p><p>æ²¡åŒ¹é…ä¸Šå°±ä¸¢å¼ƒæœ¬æ¬¡æ¥æ”¶åˆ°çš„æ—¥å¿—ï¼Œå›å¤leaderé¢å¤–ä¿¡æ¯æŒ‡å¯¼leaderä¸‹æ¬¡è¯¥å‘é€å“ªäº›æ—¥å¿—ã€‚</p><p>åŒ¹é…ä¸Šäº†ï¼Œå°±å¯ä»¥å°†å¿ƒè·³é™„åŠ æ—¥å¿—ä¸­è‡ªå·±æ²¡æœ‰çš„é‚£ä¸€éƒ¨åˆ†è¿½åŠ åˆ°è‡ªå·±logä¸­</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>PrevLogIndex <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>ConflictIndex <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’”Rec Term[%d] [%d] Reject:PreLogIndex[%d] Out of Len -&gt;[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>PrevLogIndex <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">!=</span> args<span class="token punctuation">.</span>PrevLogTerm <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>ConflictTerm <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term<span class="token keyword">for</span> index <span class="token operator">:=</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> index <span class="token operator">&lt;=</span> args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">;</span> index<span class="token operator">++</span> <span class="token punctuation">{</span> <span class="token comment">// æ‰¾åˆ°å†²çªtermçš„é¦–æ¬¡å‡ºç°ä½ç½®ï¼Œæœ€å·®å°±æ˜¯PrevLogIndex</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">==</span> reply<span class="token punctuation">.</span>ConflictTerm <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>ConflictIndex <span class="token operator">=</span> index<span class="token keyword">break</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’”Rev Term[%d] [%d] Reject :PreLogTerm Not Match [%d] != [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term<span class="token punctuation">,</span> args<span class="token punctuation">.</span>PrevLogTerm<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span>rf<span class="token punctuation">.</span><span class="token function">CopyEntries</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="followeræ—¥å¿—å¤åˆ¶"><a href="#followeræ—¥å¿—å¤åˆ¶" class="headerlink" title="followeræ—¥å¿—å¤åˆ¶"></a>followeræ—¥å¿—å¤åˆ¶</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">CopyEntries</span><span class="token punctuation">(</span>args <span class="token operator">*</span>AppendEntriesArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>logchange <span class="token operator">:=</span> <span class="token boolean">false</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Entries<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>rfIndex <span class="token operator">:=</span> i <span class="token operator">+</span> args<span class="token punctuation">.</span>PrevLogIndex <span class="token operator">+</span> <span class="token number">1</span>logPos <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rfIndex<span class="token punctuation">)</span><span class="token keyword">if</span> rfIndex <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//è¶…å‡ºåŸæœ¬logé•¿åº¦äº†</span>rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Entries<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>logchange <span class="token operator">=</span> <span class="token boolean">true</span><span class="token keyword">break</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>logPos<span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">!=</span> args<span class="token punctuation">.</span>Entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token punctuation">{</span> <span class="token comment">//æœ‰è„ä¸œè¥¿</span>rf<span class="token punctuation">.</span>log <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span><span class="token punctuation">:</span>logPos<span class="token punctuation">]</span> <span class="token comment">//åˆ é™¤è„æ•°æ®</span><span class="token comment">//ä¸€å£æ°”å¤åˆ¶å®Œ</span>rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Entries<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>logchange <span class="token operator">=</span> <span class="token boolean">true</span><span class="token keyword">break</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">//ç”¨äºdebug</span><span class="token keyword">if</span> logchange <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’–Rev Term[%d] [%d] Copy: Len -&gt; [%d] "</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"Term[%d] [%d] after copy:"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">)</span>i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">10</span><span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"Term[%d] [%d] index[%d] log[%v]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> i<span class="token operator">+</span>rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">var</span> min <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LeaderCommit <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>min <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>min <span class="token operator">=</span> args<span class="token punctuation">.</span>LeaderCommit<span class="token punctuation">}</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span>commitIndex <span class="token operator">&lt;</span> min <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"COMIT Term[%d] [%d] CommitIndex: [%d] -&gt; [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">,</span> min<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>commitIndex <span class="token operator">=</span> min<span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä½¿ç”¨äº†ConflictIndexå’ŒConflictTermçš„å¿«é€Ÿå›é€€ä¼˜åŒ–ã€‚</p><p>è®ºæ–‡å¹¶æ²¡æœ‰å®ç°å¿«é€Ÿå›é€€ï¼Œè®ºæ–‡å¯¹äºå¿ƒè·³æ—¥å¿—è¢«æ‹’ç»çš„å¤„ç†ä¸ºï¼šleaderæ”¶åˆ°æ—¥å¿—å¤åˆ¶å¤±è´¥çš„å“åº”åï¼Œå°†å¯¹åº”çš„nextIndex[i] -= 1å³å¯ï¼Œä¸‹ä¸€æ¬¡å¿ƒè·³å‘¨æœŸleaderå¾€å›å¤šå‘ä¸€ä¸ªlogï¼ˆå½“ç„¶æ–°çš„logä¹Ÿä¸ä¼šè½ä¸‹ï¼Œä¸€èµ·å‘ï¼Œåªæ˜¯è¿˜éœ€è¦å¾€å‰å¤šå‘ä¸€ä¸ªæ—§çš„æ—¥å¿—ï¼‰ï¼Œçœ‹çœ‹è¿™æ¬¡è¿˜ä¸åŒ¹é…çš„è¯ï¼Œé‚£å°±æ…¢æ…¢æ¥ç€å§ï¼Œä¸€ç›´å›é€€åˆ°åŒ¹é…ä¸ºæ­¢ã€‚è¿™å°±æ˜¯æ—¥å¿—å›é€€ç°è±¡ï¼šå‡ºç°äºleaderå’Œfollowerä¹‹é—´æ—¥å¿—å·®å¼‚è¾ƒå¤§çš„æ—¶å€™ï¼Œä¸ºäº†åŒæ­¥ï¼Œleaderéœ€è¦å¤šå‘ä¸€äº›æ—¥å¿—</p><p>è®ºæ–‡ä¹Ÿè¯´ï¼Œè¿™ç§æ“ä½œçœ‹ä¼¼æ•ˆç‡ä½ä¸‹ï¼Œä½†å‘ç”Ÿæƒ…å†µå¾ˆå°‘ï¼Œåœ¨ç°å®ä¸­è°å®¶çš„ç½‘ç»œæœåŠ¡ä¼šå·®åˆ°ä¸¢åŒ…ç‡30%ï¼Œç½‘ç»œå»¶è¿Ÿè¾¾åˆ°2000msï¼ŒæœåŠ¡å™¨åå¤å®•æœºä»°å§èµ·åï¼Œè„‘è£‚å¦‚åŒå®¶å¸¸ä¾¿é¥­å‘¢ï¼Œè¿˜è¦ç»§ç»­åšæŒæä¾›å¯é åŒæ­¥æœåŠ¡å‘¢ï¼Ÿä½†æ˜¯åœ¨æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œå¦‚æœä¸æ—¥å¿—å¿«é€Ÿå›é€€çš„ä¼˜åŒ–ï¼Œæå¤§æ¦‚ç‡ä¼šåœ¨æŸä¸ªTestæŒ‚æ‰</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°æ—¥å¿—å¿«é€Ÿå›é€€æœºåˆ¶ï¼Œå¥½åœ¨å®éªŒå®˜æ–¹æŒ‡å¯¼ä¸­ç»™äº†è§£å†³åŠæ³•</p><blockquote><p>how to roll back quickly  the Figure 2 design backs up one entry per RPC â€“ slow!  </p><p>lab tester may require faster roll-back  </p><p>paper outlines a scheme towards end of Section 5.3    no details; </p><p>hereâ€™s my guess; </p><p>better schemes are possible </p><table><thead><tr><th></th><th>Case 1</th><th>Case 2</th><th>Case 2</th></tr></thead><tbody><tr><td>S1</td><td>4 5 5</td><td>4 4 4</td><td>4</td></tr><tr><td>S2</td><td>4 6 6 6</td><td>4 6 6 6</td><td>4 6 6 6</td></tr></tbody></table><p>is leader for term 6, S1 comes back to life, S2 sends AE for last 6    AE has prevLogTerm=6  rejection from S1 includes:</p><p>XTerm:  term in the conflicting entry (if any)    </p><p>XIndex: index of first entry with that term (if any)    </p><p>XLen:   log length  </p><p>Case 1 (leader doesnâ€™t have XTerm):    nextIndex = XIndex  </p><p>Case 2 (leader has XTerm):   nextIndex = leaderâ€™s last entry for XTerm  </p><p>Case 3 (followerâ€™s log is too short):    nextIndex = XLen</p></blockquote><p>åŠ©æ•™è¿˜æä¾›äº†ä¸€ä¸ªæ”¹è¿›ç‰ˆï¼Œä¹Ÿå°±æ˜¯æˆ‘æ‰€ä½¿ç”¨çš„ç‰ˆæœ¬</p><blockquote><p>If a follower does not have prevLogIndex in its log, it should return with conflictIndex = len(log) and conflictTerm = None.</p><p>If a follower does have prevLogIndex in its log, but the term does not match, it should return conflictTerm = log[prevLogIndex].Term, and then search its log for the first index whose entry has term equal to conflictTerm.</p><p>Upon receiving a conflict response, the leader should first search its log for conflictTerm. If it finds an entry in its log with that term, it should set nextIndex to be the one beyond the index of the last entry in that term in its log.</p><p>If it does not find an entry with that term, it should set nextIndex = conflictIndex.</p></blockquote><h4 id="æ—¥å¿—å¿«é€Ÿå›é€€"><a href="#æ—¥å¿—å¿«é€Ÿå›é€€" class="headerlink" title="æ—¥å¿—å¿«é€Ÿå›é€€"></a>æ—¥å¿—å¿«é€Ÿå›é€€</h4><p>ä»£ç å®ç°</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">ok <span class="token operator">:=</span> rf<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"Raft.AppendEntries"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> ok <span class="token punctuation">{</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">!=</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’”Rec Term[%d] [%d] Receive Send.Term[%d][too OLD]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Term<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span>currentTerm <span class="token operator">&lt;</span> reply<span class="token punctuation">.</span>Term <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>rf<span class="token punctuation">.</span>state <span class="token operator">=</span> followerrf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> reply<span class="token punctuation">.</span>Termrf<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’”Rec Term[%d] [%d] Receive Discover newer Term[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Term<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">if</span> reply<span class="token punctuation">.</span>Success <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>PrevLogIndex <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Entries<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">//å·¦é—­å³å¼€ï¼Œå› æ­¤curLatestIndexæŒ‡å‘çš„æ˜¯æœ€åä¸€ä¸ªå‘é€çš„logçš„ä¸‹ä¸€ä½å¯èƒ½ä¸ºç©º</span><span class="token keyword">return</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token keyword">if</span> reply<span class="token punctuation">.</span>ConflictTerm <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>searchIndex <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">for</span> i <span class="token operator">:=</span> args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">==</span> reply<span class="token punctuation">.</span>ConflictTerm <span class="token punctuation">{</span>searchIndex <span class="token operator">=</span> i<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> searchIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> searchIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">.</span>ConflictIndex<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">.</span>ConflictIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ—¥å¿—æäº¤"><a href="#æ—¥å¿—æäº¤" class="headerlink" title="æ—¥å¿—æäº¤"></a>æ—¥å¿—æäº¤</h3><p>æ¯ä¸€ä¸ªæœåŠ¡å™¨followerï¼Œcandidatï¼Œleaderéƒ½éœ€è¦å°†LastAppliedåˆ°commitIndexä¹‹é—´çš„æ—¥å¿—é€šè¿‡applychæäº¤ç»™ä¸Šå±‚åº”ç”¨</p><blockquote><p>lastappliedå’ŒcommitIndexä¸æ˜¯æ˜“å¤±æ€§çŠ¶æ€å—ï¼Ÿ</p></blockquote><p>æ˜¯çš„ï¼Œæ‰€ä»¥ä¸Šå±‚åº”ç”¨è¦å…·æœ‰æ¥å—raftå±‚çš„é‡å¤æ—¥å¿—çš„èƒ½åŠ›</p><blockquote><p>æ—¢ç„¶å·²ç»æœ‰äº†commitIndexï¼Œè€Œä¸”ä¸Šå±‚åº”ç”¨ä¹Ÿèƒ½æ¥å—é‡å¤æ—¥å¿—ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦æœ‰lastappliedï¼Ÿ</p></blockquote><p>å¤§æ¦‚è€ƒè™‘åˆ°è¿™å‡ ç‚¹å§</p><p>1ï¼šcommitIndexæ˜¯è·³å˜çš„ï¼Œå¦‚æœä¸å®ç°lastappliedï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è®°å½•commitIndexå˜åŒ–ä¹‹å‰çš„ä½ç½®ï¼Œç„¶åå‘åº”ç”¨å±‚å‘é€è¿™ä¸€æ®µlogï¼Œè€Œä¸”ä¸ºäº†ä¿è¯åº”ç”¨å±‚èƒ½æ¥æ”¶åˆ°æ‰€æœ‰æ—¥å¿—å‘ï¼Œéœ€è¦åœ¨commitIndexå†æ¬¡å˜åŒ–ä¹‹å‰ï¼Œç™¾åˆ†ç™¾å®Œæˆä¹‹å‰è¿™æ¬¡å‘é€logçš„æµç¨‹ï¼Œè¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®ç°å°±å¾ˆå¤æ‚äº†</p><p>2ï¼šlastAppliedæœ‰ä¸ªç‰¹ç‚¹ï¼Œå®ƒä¸€æ¬¡åªå¢åŠ 1ï¼Œåœ¨å‰ä¸€ä¸ªlogè¢«åº”ç”¨å±‚ç¡®å®šæ¥å—ä¹‹å‰ï¼Œä¸ä¼šæäº¤ä¸‹ä¸€æ¡logã€‚è¿™å°±å¾ˆå¤§ç¨‹åº¦ä¿éšœäº†åº”ç”¨å±‚çš„æ•°æ®å®‰å…¨</p><blockquote><p>éœ€è¦ç•™æ„çš„æ˜¯ä»»ä½•æ“ä½œapplychçš„ä¸èƒ½è¿›è¡ŒåŠ é”æ“ä½œï¼Œå› ä¸ºapplyChæ˜¯ä¸ªæ— ç¼“å†²channelï¼ŒåŠ é”å‡ ä¹ç™¾åˆ†ç™¾å¯¼è‡´æ­»é”é—®é¢˜<br>ä½†æ˜¯å¦‚æœä¸åŠ é”åˆä¼šå‡ºç°ä¸€äº›å°é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜ä¸»è¦åœ¨3Då®éªŒä¸­ä½“ç°ï¼Œåé¢ç»†è¯´</p></blockquote><p>Applyå‡½æ•°ï¼Œä½¿ç”¨goå•ç‹¬å¼€è¾Ÿçš„åç¨‹</p><p>ä½¿ç”¨<strong>å‡½æ•°é—­åŒ…+return+defer</strong>æœ‰å¥‡æ•ˆï¼Œä¸»æ‰“çš„å°±æ˜¯ä¸€ä¸ªæ€€å¿µgotoå…³é”®å­—</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ä¿®æ”¹rf.lastApplied</span><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">undateLastApplied</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">var</span> nomore <span class="token operator">=</span> <span class="token boolean">false</span><span class="token keyword">for</span> <span class="token operator">!</span>rf<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> nomore <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// rf.snapshotXapplych.Lock()</span><span class="token comment">// defer rf.snapshotXapplych.Unlock()</span><span class="token comment">// DPrintf("APPLY Term[%d] [%d] Wait for the lockğŸ”", rf.currentTerm, rf.me)</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// DPrintf("APPLY Term[%d] [%d] Hode the lockğŸ”", rf.currentTerm, rf.me)</span>nomore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span>lastApplied <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span>commitIndex <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>lastApplied <span class="token operator">+=</span> <span class="token number">1</span>index <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>lastApplied<span class="token punctuation">)</span><span class="token keyword">if</span> index <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> index <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>lastApplied <span class="token operator">=</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ERROR? ğŸ‘¿ [%d]Ready to apply index[%d] But index out of Len of log, lastApplied[%d] commitIndex[%d] lastIncludeIndex[%d] logLen:%d"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> index<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastApplied<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"APPLY Term[%d] [%d] -&gt; LOG [%d] value:[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastApplied<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">)</span>ApplyMsg <span class="token operator">:=</span> ApplyMsg<span class="token punctuation">{</span>CommandValid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>Command<span class="token punctuation">:</span>      rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">,</span>CommandIndex<span class="token punctuation">:</span> rf<span class="token punctuation">.</span>lastApplied <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"APPLY Term[%d] [%d] Unlock the lockğŸ” For Start applyerCh &lt;- len[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>applyChTerm<span class="token punctuation">)</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span>applyChTerm <span class="token operator">&lt;-</span> ApplyMsg<span class="token keyword">if</span> rf<span class="token punctuation">.</span>IisBackIndex <span class="token operator">==</span> rf<span class="token punctuation">.</span>lastApplied <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"Term [%d] [%d] iisback = true iisbackIndex =[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>IisBackIndex<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>IisBack <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token comment">// DPrintf("APPLY Term[%d] [%d] lock the lockğŸ” For Finish applyerCh &lt;-", rf.currentTerm, rf.me)</span>nomore <span class="token operator">=</span> <span class="token boolean">false</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"APPLY Term[%d] [%d] AppliedIndex [%d] CommitIndex [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastApplied<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">)</span><span class="token punctuation">}</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// DPrintf("APPLY Term[%d] [%d] Open the lockğŸ”“", rf.currentTerm, rf.me)</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ›´æ–°commitindexçš„å‡½æ•°ï¼Œæˆ‘è¿™é‡Œè¿˜æ˜¯å•ç‹¬å¼€è¾Ÿäº†ä¸€ä¸ªåç¨‹ç‹¬ç«‹è¿›è¡Œï¼Œä¸»è¦è¿˜æ˜¯ä¸ºäº†ç®€åŒ–é€»è¾‘å§ï¼Œå…¶å®æ”¾åˆ°leaderçš„å¿ƒè·³å‘é€å‘¨æœŸé‡Œé¢æ›´æ–°ä¹Ÿé—®é¢˜ä¸å¤§</p><blockquote><p>æ³¨æ„åªæœ‰leaderå¯ä»¥å‚è€ƒmatchIndexçš„æ–¹å¼æ›´æ–°commitIndex</p><p>followeråªèƒ½å‚è€ƒå¿ƒè·³ä¸­çš„LeaderCommitIndexæ›´æ–°è‡ªå·±çš„commitIndex</p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">updateCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//ä»matchIndexå¯»æ‰¾ä¸€ä¸ªå¤§å¤šæ•°æœåŠ¡å™¨è®¤åŒçš„N</span><span class="token keyword">for</span> <span class="token operator">!</span>rf<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token boolean">_</span><span class="token punctuation">,</span> isleader <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> isleader <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>matchIndex <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>matchIndex <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>matchIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> rf<span class="token punctuation">.</span>peers <span class="token punctuation">{</span><span class="token keyword">if</span> i <span class="token operator">!=</span> rf<span class="token punctuation">.</span>me <span class="token punctuation">{</span>matchIndex <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>matchIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>sort<span class="token punctuation">.</span><span class="token function">Ints</span><span class="token punctuation">(</span>matchIndex<span class="token punctuation">)</span>lenMat <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>matchIndex<span class="token punctuation">)</span> N <span class="token operator">:=</span> matchIndex<span class="token punctuation">[</span>lenMat<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">if</span> N <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>commitIndex <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>N <span class="token operator">&lt;=</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">||</span> rf<span class="token punctuation">.</span>currentTerm <span class="token operator">==</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// DPrintf("COMIT Term[%d] [%d] It's matchIndex = %v", rf.currentTerm, rf.me, matchIndex)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"COMIT Term[%d] [%d] commitIndex [%d] -&gt; [%d] (leader action)"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">,</span> N<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>IisBackIndex <span class="token operator">=</span> Nrf<span class="token punctuation">.</span>commitIndex <span class="token operator">=</span> N<span class="token punctuation">}</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éœ€è¦å¯†åˆ‡å…³æ³¨çš„ç»†èŠ‚æ˜¯ï¼š<br>if N &gt; rf.commitIndex &amp;&amp; (N &lt;= rf.lastIncludeIndex || <strong>rf.currentTerm == rf.log[rf.index2LogPos(N)].Term</strong>)</p><p>è®ºæ–‡ä¸­æœ‰æåˆ°</p><p><img src="/2024/04/04/mit65840lab3shixian/12.png" alt="å›¾ç‰‡"></p><p>commitIndexå°†è¦è¢«æ›´æ–°åˆ°çš„Nè¿™ä¸ªå€¼ï¼Œå…¶Termå¿…é¡»ç­‰äºleaderçš„currentTermï¼Œå¦åˆ™å°±ä¸èƒ½è¿›è¡Œæ›´æ–°ã€‚</p><p>è¿™æ˜¯å› ä¸ºé¢†å¯¼äººä¸å¯ä»¥ç›´æ¥æäº¤ä»¥å‰ä»»æœŸçš„æ—¥å¿—ï¼Œåªæœ‰é¢†å¯¼äººè‡ªå·±å‘å‡ºå»çš„æ—¥å¿—è¢«å¤šæ•°followeråº”ç”¨ä¹‹åï¼Œä»–æ‰å¯ä»¥å°†CommitIndexæ›´æ–°åˆ°è¿™ä¸ªä»»æœŸè·Ÿè‡ªå·±åŒ¹é…çš„æ–°çš„indexï¼Œå¦åˆ™ä¼šå‘ç”Ÿæ•°æ®é”™ä¹±é—®é¢˜ã€‚</p><p>è¿™é‡Œè´´ä¸Šä¸­æ–‡è§£é‡Š</p><p><img src="/2024/04/04/mit65840lab3shixian/14.png" alt="å›¾ç‰‡"></p><p>è¿™æ˜¯ä¸ªæ¯”è¾ƒéšç§˜çš„è§„åˆ™ï¼Œå¾ˆå®¹æ˜“è¢«å¿½ç•¥ä»è€Œå¯¼è‡´æ•°æ®é”™ä¹±</p><hr><h2 id="Part-3C-persistence-hard"><a href="#Part-3C-persistence-hard" class="headerlink" title="Part 3C: persistence (hard)"></a>Part 3C: persistence (hard)</h2><p>æœ¬æ¬¡å®éªŒçš„ä»£ç é‡æœ€å°‘ï¼Œé˜…è¯»å®˜æ–¹å®éªŒæŒ‡å¯¼ï¼Œå®ƒæ˜ç¡®é“åœ¨æ¯ä¸€ä¸ªæŒä¹…åŒ–æˆå‘˜å‘ç”Ÿæ”¹å˜çš„æ—¶å€™è°ƒç”¨persistï¼ˆï¼‰å‡½æ•°è¿›è¡ŒæŒä¹…åŒ–å³å¯ã€‚</p><p>æ‰€è°“æŒä¹…åŒ–å°±æ˜¯å°†æ•°æ®è¯»åˆ°ç¡¬ç›˜ï¼ŒæœåŠ¡å™¨å´©æºƒåèƒ½ä»ç¡¬ç›˜ä¸­è¯»å–åˆ°æœ€è¿‘ä¸€æ¬¡æŒä¹…åŒ–çš„æ•°æ®ã€‚</p><p>ä»£ç å®ç°ç®€å•ï¼Œä½†å®ƒç¡®å®æ˜¯å¡æˆ‘ï¼ˆç›¸ä¿¡ä¹Ÿæ˜¯å¤§å¤šæ•°äººï¼‰æœ€ä¹…çš„Partï¼ŒåŸå› æ— å®ƒï¼Œæµ‹è¯•ä»£ç å¤ªå˜æ€äº†</p><p>è€Œå³ä½¿æ˜¯å¦‚æ­¤å˜æ€çš„Testç¯å¢ƒï¼Œä»ç„¶æ— æ³•å®Œå…¨æµ‹å‡ºå…³äºraftç®—æ³•çš„bugï¼Œè¿™ä¹Ÿæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œraftç®—æ³•æœ¬èº«å†å®Œå¤‡ï¼Œç»ç¨‹åºå‘˜å®ç°ä¸€æ‰‹ååˆå¤§ä¸ä¸€æ ·äº†</p><p>æœ¬æ¬¡å®éªŒæˆ‘æ‰€æ£€æŸ¥å‡ºçš„bugæœ‰è¿™äº›ï¼š</p><p>followeræŠ•å‡ºèµæˆç¥¨åå¿˜è®°æ›´æ–°å®šæ—¶å™¨äº†</p><p>è¿˜æœ‰ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„åŸå› ï¼šä¸€æ˜¯RPCå›å¤çš„é€Ÿåº¦å¤ªå¿«ï¼Œä»¥è‡³äºåŸæœ¬æœŸæœ›çš„Leaderå¹¶è¡ŒåŒæ—¶å‘é€å¤šä¸ªå¿ƒè·³RPCï¼Œç„¶åå†ä¸å—å¹²æ‰°çš„ä¸€ä¸ªä¸€ä¸ªå¤„ç†è¿”å›çš„RPCè¿™ç§æƒ…æ™¯å¯èƒ½ä¸ä¼šå‡ºç°ï¼Œå®é™…æƒ…å†µå¯èƒ½ä¼šå‡ºç°Leaderå‘é€äº†ç¬¬1ä¸ªRPCï¼Œç„¶åæ”¶åˆ°äº†å›å¤ï¼Œæ ¹æ®å›å¤è¿›è¡Œäº†å¤„ç†ï¼Œç„¶åå†ç»§ç»­å‘é€å‰©ä½™çš„å¿ƒè·³RPC</p><p>äºŒæ˜¯å‡½æ•°åµŒå¥—å¤ªå¤šï¼Œå¯¼è‡´æœ€å¤–å±‚çš„å‡½æ•°å¾ˆéš¾æ ¹æ®å†…å±‚å‡½æ•°çš„ç»“æœè¿›è¡Œå“åº”ï¼Œæ¯”å¦‚å†…å±‚å‡½æ•°æœ¬æ„æ˜¯æƒ³è¦ç»ˆæ­¢æœ€å¤–å±‚å‡½æ•°çš„æ•´ä¸ªæ“ä½œï¼Œäºæ˜¯å®ƒè¿›è¡Œäº†returnï¼Œä½†æ˜¯åªreturnäº†è‡ªå·±è¿™ä¸€å±‚ï¼Œå¤–å±‚å¾ªç¯è¿˜åœ¨ç»§ç»­</p><p>å‡è®¾leaderçš„Termæ¯”æ¥æ”¶è€…ä½ï¼Œä½†æ˜¯å®ƒåˆšä»ç½‘ç»œä¸­éš”ç¦»äº†æ‰€ä»¥ä¸çŸ¥é“ï¼Œç»§ç»­å‘é€å¸¦æœ‰æ—§Termçš„RPCï¼Œç”±äºleaderå¹¶è¡Œå‘é€å¤šä¸ªå¸¦æœ‰æ¡ç›®çš„RPCï¼Œä½†ä¸æ˜¯çœŸçš„å¹¶è¡Œï¼Œæ‰€ä»¥å‘é€å‰é¢çš„RPCä¸­ï¼Œleaderå¦‚æœåœ¨ä¸€ä¸ªå¿ƒè·³RPCçš„å“åº”ä¸­ï¼Œå‘ç°æ¥æ”¶è€…çš„ä»»æœŸæ¯”è‡ªå·±é«˜ï¼Œäºæ˜¯æ›´æ–°è‡ªå·±çš„ä»»æœŸï¼Œå¹¶è½¬å˜ä¸ºfollowerï¼Œä½†æ˜¯æ­¤æ—¶å¿ƒè·³å‘é€æµç¨‹å¹¶æ²¡æœ‰ç«‹åˆ»è¢«åœæ­¢ï¼Œåé¢è¿˜åœ¨ä¸åœçš„å‘é€RPCï¼Œå¹¶ä¸”ç”±äºå·²ç»æ›´æ–°åˆ°äº†æ–°ä»»æœŸï¼Œåé¢è¿™äº›RPCå°±çœŸçš„è¢«æ¥æ”¶è€…é‡‡ç”¨äº†ï¼Œä»è€Œå¯¼è‡´æ•°æ®é”™ä¹±</p><p>æœ¬æ¬¡å®éªŒéœ€è¦è¾ƒé•¿æ—¶é—´è¿›è¡Œdebugï¼Œçˆ±æŠ¤çœ¼ç›ï¼Œå†™å¥½è¯¦ç»†çš„logä¿¡æ¯ï¼Œç¥å„ä½debugæ„‰å¿«</p><h2 id="Part-3D-log-compaction-hard"><a href="#Part-3D-log-compaction-hard" class="headerlink" title="Part 3D: log compaction (hard)"></a>Part 3D: log compaction (hard)</h2><p>3Dè¦æ±‚å®ç°å¿«ç…§æœºåˆ¶ï¼Œç”±äºä¸æ­¢leaderå¯ä»¥è¿›è¡Œå¿«ç…§ï¼ŒfolloweråŒæ ·å¯ä»¥è‡ªè¡Œå¤‡ä»½å¿«ç…§ã€‚</p><p>å…³äºå¿ƒè·³æœºåˆ¶ä¸­æ—¥å¿—å¤åˆ¶çš„éƒ¨åˆ†ï¼Œè¿˜æœ‰leaderå’Œfolloweräº¤äº’è¿™éƒ¨åˆ†è¦è¿›è¡Œå¤§æ”¹ã€‚</p><p>å»ºè®®æ¯æ”¹åŠ¨ä¸€å¤„åœ°æ–¹å°±é©¬ä¸Šå†å»æµ‹ä¸€éABCçš„æµ‹è¯•ï¼Œå¦åˆ™åç»­å†debugä¸å ªè®¾æƒ³</p><h3 id="å¿«ç…§æµç¨‹"><a href="#å¿«ç…§æµç¨‹" class="headerlink" title="å¿«ç…§æµç¨‹"></a>å¿«ç…§æµç¨‹</h3><p>å‰é¢çš„å®éªŒä¸­ï¼Œleaderé€šè¿‡applychå°†è¢«åº”ç”¨çš„æ—¥å¿—å‘é€ç»™åº”ç”¨å±‚ï¼ˆä¸Šå±‚ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬lab4éœ€è¦å®ç°çš„kvRaftä¸­çš„kvserverå±‚ï¼‰</p><p>ä¸Šå±‚å®é™…ä¸Šå¹¶æ²¡æœ‰ä¸€æ¯”ä¸€ä¿å­˜è¿™äº›logï¼Œä¸Šå±‚è¦åšçš„æ˜¯è¯»å–logä¸­çš„æ“ä½œä¿¡æ¯ï¼Œå°†å…¶ä¸­çš„putï¼Œappendç­‰æ“ä½œåº”ç”¨åˆ°æ•°æ®åº“é‡Œï¼Œæ—¢ç„¶æ˜¯æ•°æ®åº“ï¼Œè‚¯å®šåŒ…å«äº†å¾ˆå¤šå¯¹åŒä¸€ä¸ªé”®å€¼å¯¹çš„æ“ä½œï¼Œè¿™äº›æ“ä½œæ˜¯å¯ä»¥å‹ç¼©çš„</p><p>å‡è®¾ä¸€ä¸ªä¾‹å­ï¼š</p><blockquote><p>ä¸Šå±‚æ•°æ®åº“<strong>åˆå§‹çŠ¶æ€</strong> ã€keyï¼š1ï¼Œvalueï¼šx 0 yã€‘</p><p>ä¸Šå±‚æ•°æ®åº“ä»raftå±‚çš„applychæŒ‰é¡ºåºæ”¶åˆ°ä¸€äº›æ“ä½œæ•°æ®åº“çš„logï¼š log1ã€putï¼Œ1ï¼Œx 10 yã€‘ï¼Œlog2ã€appendï¼Œ1ï¼Œx 11 yã€‘â€¦. log42ã€<strong>put</strong>ï¼Œ1ï¼Œx 100 yã€‘ï¼Œé€æ¡åº”ç”¨ï¼Œæœ€åæ˜¯ä¸€æ¡putå‘½ä»¤</p><p>ä¸Šå±‚æ•°æ®åº“log42åº”ç”¨åçš„æ•°æ®åº“æœ€æ–°çŠ¶æ€ã€keyï¼š1ï¼Œvalueï¼šx 100 yã€‘</p><p>ä¸Šå±‚æ•°æ®åº“å°†å½“å‰æ•°æ®åº“çš„çŠ¶æ€å¤åˆ¶ä¸€ä»½ï¼Œä¿å­˜åˆ°ç¡¬ç›˜é‡Œï¼Œè¿™ä»½å¤‡ä»½å°±æ˜¯<strong>æ•°æ®åº“å¿«ç…§</strong>ï¼Œä¹‹åæ— è®ºé‡å¯å¤šå°‘æ¬¡ï¼Œéƒ½è¯»å–è¿™ä»½å¿«ç…§ä½œä¸ºæœåŠ¡å™¨é‡å¯åçš„æ•°æ®åº“<strong>åˆå§‹çŠ¶æ€</strong></p><p>é‚£ä¹ˆå¾ˆæ˜¾ç„¶ï¼Œraftå±‚å°±å†ä¹Ÿä¸éœ€è¦å‘ä¸Šå±‚å‘é€log42ä¹‹å‰çš„å¿«ç…§ï¼Œè€Œä¸”ä¹Ÿä¸éœ€è¦ä¿å­˜å®ƒä»¬ï¼ˆé™¤äº†æŸäº›å¿…è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚lastInludeIndex,lastIncludeTermï¼‰</p></blockquote><p>è¿™å°±æ˜¯å¿«ç…§æœºåˆ¶,å‡å°‘raftå±‚åœ¨å†…å­˜å’Œç¡¬ç›˜ä¸­ä¿å­˜çš„logæ•°é‡ï¼ŒåŠ å¿«é‡å¯ååº”ç”¨å±‚(ä¸Šå±‚æ•°æ®åº“)æ¢å¤æ•°æ®åº“çš„é€Ÿåº¦</p><p>ç”±ä¸Šå±‚è°ƒç”¨çš„Snapshotï¼ˆï¼‰å‡½æ•°ï¼š</p><h4 id="leaderä¸»åŠ¨å¿«ç…§"><a href="#leaderä¸»åŠ¨å¿«ç…§" class="headerlink" title="leaderä¸»åŠ¨å¿«ç…§"></a>leaderä¸»åŠ¨å¿«ç…§</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">Snapshot</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">,</span> snapshot <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// Your code here (3D).</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] ğŸ“·Snapshot ask to snap Index[%d] Raft log Len:[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>index <span class="token operator">-=</span> <span class="token number">1</span><span class="token keyword">if</span> index <span class="token operator">&lt;=</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>compactLoglen <span class="token operator">:=</span> index <span class="token operator">-</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] AfterğŸ“·,lastIncludeIndex[%d]-&gt;[%d] lastIncludeTerm[%d]-&gt;[%d] len of Log-&gt;[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> index<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token operator">-</span>compactLoglen<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>lastIncludeTerm <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Termrf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">=</span> index<span class="token comment">//å‹ç¼©æ—¥å¿—</span>afterLog <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LogType<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token operator">-</span>compactLoglen<span class="token punctuation">)</span><span class="token function">copy</span><span class="token punctuation">(</span>afterLog<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>compactLoglen<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span>log <span class="token operator">=</span> afterLog<span class="token comment">//æŠŠsnapshotå’ŒraftstateæŒä¹…åŒ–</span>rf<span class="token punctuation">.</span>SnapshotDate <span class="token operator">=</span> snapshotrf<span class="token punctuation">.</span>persister<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span><span class="token function">persistWithSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“·Cmi Term[%d] [%d] ğŸ“¦Save snapshot to application[%d] (Receive from up Application)"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>persister<span class="token punctuation">.</span>snapshot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2024æ–°ç‰ˆlabæœ€å‘çš„ä¸€ç‚¹æ¥äº†ï¼Œrf.persister.SaveåŒæ—¶ä¿å­˜raftStateå’Œsnapshot</p><p>åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œå®éªŒæŒ‡å¯¼ç»™ç¬¬äºŒä¸ªå‚æ•°èµ‹å€¼nilï¼Œä½†æ˜¯åœ¨lab3Dä¸­ï¼Œä»»ä½•ä¸€å¤„rf.persister.Save(rf.persistWithSnapshot(), nil)éƒ½ä¼šå°†å·²ä¿å­˜çš„snapshotæ•°æ®<strong>å®Œå…¨åˆ æ‰</strong>ï¼Œå¾ˆå‘ï¼Œéå¸¸å‘</p><p>å› ä¸ºå¿«ç…§æœºåˆ¶ï¼Œleaderä¼šå°†indexå‰çš„æ‰€æœ‰logåˆ å¹²å‡€ï¼Œé‚£å¦‚æœå‘ç”Ÿæ—¥å¿—å›é€€äº†ï¼ŒnextIndexä¸€ç›´å›é€€åˆ°ç­‰äºlog42åŠä¹‹å‰æ€ä¹ˆåŠå‘¢</p><p>åœ¨è¿™ç§æƒ…å†µï¼Œæ ¹æ®è®ºæ–‡ï¼Œæˆ‘ä»¬éœ€è¦leaderä¸»åŠ¨å°†è‡ªå·±çš„å¿«ç…§å‘é€è¿‡å»ï¼Œè¦†ç›–æ‰è¿™ä¸ªè½åfollowrçš„å¿«ç…§ï¼Œç„¶åleaderå¯¹äºè¿™ä¸ªfollowerçš„matchIndexè‡³å°‘ä¹Ÿæ˜¯42äº†ï¼Œåç»­å†å‘ç”Ÿæ—¥å¿—å›é€€ï¼Œä¹Ÿä¸å¯èƒ½å›é€€åˆ°42ï¼Œå› ä¸ºå‘é€è¿‡å¿«ç…§çš„ç¼˜æ•…ä¸¤è€…ä¹‹é—´çš„æ—¥å¿—åœ¨42å¤„ä¸€å®šæ˜¯åŒ¹é…çš„</p><h4 id="leaderå‘é€å¿«ç…§ï¼š"><a href="#leaderå‘é€å¿«ç…§ï¼š" class="headerlink" title="leaderå‘é€å¿«ç…§ï¼š"></a>leaderå‘é€å¿«ç…§ï¼š</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">sendInstallSnapshotToPeerId</span><span class="token punctuation">(</span>server <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// DPrintf("SNAPS Term[%d] [%d] goSendğŸ“·Wait for a lockğŸ¤¨ to [%d],", rf.currentTerm, rf.me, server)</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>args <span class="token operator">:=</span> <span class="token operator">&amp;</span>SnapshotInstallArgs<span class="token punctuation">{</span><span class="token punctuation">}</span>args<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>currentTermargs<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> rf<span class="token punctuation">.</span>meargs<span class="token punctuation">.</span>LastIncludeIndex <span class="token operator">=</span> rf<span class="token punctuation">.</span>lastIncludeIndexargs<span class="token punctuation">.</span>LastIncludeTerm <span class="token operator">=</span> rf<span class="token punctuation">.</span>lastIncludeTermargs<span class="token punctuation">.</span>Data <span class="token operator">=</span> rf<span class="token punctuation">.</span>SnapshotDate<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] goSendğŸ“· to [%d] args.LastIncludeIndex[%d],args.LastIncludeTerm[%d],len of snapshot[%d],"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> server<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeTerm<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">*</span>SnapshotInstallArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>reply <span class="token operator">:=</span> <span class="token operator">&amp;</span>SnapshotInstallreplys<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span><span class="token function">sendInstallSnapshot</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span>currentTerm <span class="token operator">!=</span> args<span class="token punctuation">.</span>Term <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">if</span> reply<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>state <span class="token operator">=</span> followerrf<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>rf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> reply<span class="token punctuation">.</span>Termrf<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] leader success to Send a ğŸ“· to [%d] nextIndex for it [%d] -&gt; [%d] matchIndex [%d] -&gt; [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> server<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="followeræ¥å—å¿«ç…§ï¼š"><a href="#followeræ¥å—å¿«ç…§ï¼š" class="headerlink" title="followeræ¥å—å¿«ç…§ï¼š"></a>followeræ¥å—å¿«ç…§ï¼š</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">InstallSnapshot</span><span class="token punctuation">(</span>args <span class="token operator">*</span>SnapshotInstallArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>SnapshotInstallreplys<span class="token punctuation">)</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] ReceivğŸ“· from[%d] lastIncludeIndex[%d] lastIncludeTerm[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LeaderId<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeTerm<span class="token punctuation">)</span>reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>currentTerm<span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] rejectğŸ“· for it's Term[%d] [too old]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Term<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> args<span class="token punctuation">.</span>Termrf<span class="token punctuation">.</span>state <span class="token operator">=</span> followerrf<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>rf<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> args<span class="token punctuation">.</span>LeaderIdrf<span class="token punctuation">.</span>lastHearBeatTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LastIncludeIndex <span class="token operator">&lt;=</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LastIncludeIndex <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">!=</span> args<span class="token punctuation">.</span>LastIncludeTerm <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LogType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">// leftLog := make([]LogType, rf.lastIndex()-args.LastIncludeIndex)</span><span class="token comment">// copy(leftLog, rf.log[rf.index2LogPos(rf.lastIncludeIndex+1):])</span><span class="token comment">// rf.log = leftLog</span>rf<span class="token punctuation">.</span>log <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>LastIncludeIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LogType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] AcceptğŸ“· Now it's lastIncludeIndex [%d] -&gt; [%d] lastIncludeTerm [%d] -&gt; [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeTerm<span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"snaps Term[%d] [%d] after snapshot log:"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">=</span> args<span class="token punctuation">.</span>LastIncludeIndexrf<span class="token punctuation">.</span>lastIncludeTerm <span class="token operator">=</span> args<span class="token punctuation">.</span>LastIncludeTermi <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">10</span><span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"Term[%d] [%d] index[%d] value[%v]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> i<span class="token operator">+</span>rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“·Cmi Term[%d] [%d] ğŸ“¦Save snapshot to application[%d] (Receive from leader)"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>persister<span class="token punctuation">.</span>snapshot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//snapshotæäº¤ç»™åº”ç”¨å±‚</span>applyMsg <span class="token operator">:=</span> ApplyMsg<span class="token punctuation">{</span>SnapshotValid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>Snapshot<span class="token punctuation">:</span>      args<span class="token punctuation">.</span>Data<span class="token punctuation">,</span>SnapshotIndex<span class="token punctuation">:</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//è®°å¾—è¿™é‡Œæœ‰ä¸ªå‘</span>SnapshotTerm<span class="token punctuation">:</span>  rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token comment">//å¿«ç…§æäº¤ç»™äº†application</span>rf<span class="token punctuation">.</span>lastApplied <span class="token operator">=</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“·Cmi Term[%d] [%d] Ready to commit snapshot snapshotIndex[%d] snapshotTerm[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">)</span>rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>rf<span class="token punctuation">.</span>applyChTerm <span class="token operator">&lt;-</span> applyMsgrf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//æŒä¹…åŒ–å¿«ç…§</span>rf<span class="token punctuation">.</span>SnapshotDate <span class="token operator">=</span> args<span class="token punctuation">.</span>Datarf<span class="token punctuation">.</span>persister<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span><span class="token function">persistWithSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“·Cmi Term[%d] [%d] Done Success to comit snapshot snapshotIndex[%d] snapshotTerm[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äºæ—¥å¿—ä¼šå› ä¸ºå¿«ç…§è¢«åˆ é™¤ï¼Œæ‰€ä»¥logåœ¨logsæ•°ç»„ä¸­çš„ä½ç½®å‘ç”Ÿäº†é”™è¯¯ï¼Œå…·ä½“æ¥è¯´ï¼šrealPos = index - lastIncludeIndex - 1</p><p>è¿™å°±æ˜¯æˆ‘å®ç°Lab3 Raftçš„ä¸»è¦æ€è·¯äº†ï¼Œå®é™…å®ç°çš„æ—¶å€™è¿˜æœ‰å¾ˆå¤šå…¶ä»–ç»†èŠ‚éœ€è¦è€ƒè™‘ï¼Œç•™ç»™è¯»è€…è‡ªè¡Œä½“éªŒäº†</p><p><img src="/2024/04/04/mit65840lab3shixian/8.png" alt="æµ‹è¯•å›¾"></p><p><img src="/15.png" alt="å¤šæ¬¡æµ‹è¯•å›¾"></p>]]></content>
      
      
      
        <tags>
            
            <tag> MIT6.5840 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIT6.5840 Lab2 å®ç°</title>
      <link href="/2024/04/04/mit65840lab2shixian/"/>
      <url>/2024/04/04/mit65840lab2shixian/</url>
      
        <content type="html"><![CDATA[<h1 id="6-5840-Lab-2-Key-Value-Server"><a href="#6-5840-Lab-2-Key-Value-Server" class="headerlink" title="6.5840 Lab 2: Key/Value Server"></a>6.5840 Lab 2: Key/Value Server</h1><p>æ­¤èŠ‚ä¸ºæ–°å¢å®éªŒï¼Œæ¯”Lab 1è¿˜ç®€å•ä¸å°‘ã€‚ä¸»è¦å®ç°ä¸€ä¸ªå•æœåŠ¡å™¨çš„KVé”®å€¼å¯¹æ•°æ®åº“ï¼Œåœ¨ç½‘ç»œæƒ…å†µå˜å¾—å¤æ‚è€Œä¸å¯é çš„æƒ…å†µä¸‹ï¼Œä»ç„¶ä¸ºå®¢æˆ·ç«¯æä¾›çº¿æ€§ä¸€è‡´çš„æ•°æ®åº“æŸ¥è¯¢/ä¿®æ”¹æœåŠ¡</p><span id="more"></span><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p>Introduction<br>In this lab you will build a key/value server for a single machine that ensures that each operation is executed exactly once despite network failures and that the operations are linearizable. Later labs will replicate a server like this one to handle server crashes.</p><p>Clients can send three different RPCs to the key/value server: Put(key, value), Append(key, arg), and Get(key). The server maintains an in-memory map of key/value pairs. Keys and values are strings. Put(key, value) installs or replaces the value for a particular key in the map, Append(key, arg) appends arg to keyâ€™s value and returns the old value, and Get(key) fetches the current value for the key. A Get for a non-existent key should return an empty string. An Append to a non-existent key should act as if the existing value were a zero-length string. Each client talks to the server through a Clerk with Put/Append/Get methods. A Clerk manages RPC interactions with the server.</p></blockquote><p>å¤§æ„å°±æ˜¯å®¢æˆ·ç«¯cleckä¼šä½¿ç”¨putï¼ŒAppendï¼Œå’ŒGetè¿™ä¸‰ä¸ªRPCè°ƒç”¨serveræœåŠ¡å™¨çš„kvæ•°æ®åº“ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯åœ¨å•æœåŠ¡å™¨ï¼Œå¤šå®¢æˆ·ç«¯ï¼Œç½‘ç»œä¸å¯é ï¼ˆä¸¢åŒ…ç‡å·¨é«˜çš„ç½‘ç»œç¯å¢ƒï¼‰ä¸‹<strong>é›¶é”™è¯¯</strong>ï¼Œ<strong>çº¿æ€§</strong>åœ°å®Œæˆæ‰€æœ‰å®¢æˆ·ç«¯è°ƒç”¨è¯·æ±‚</p><p>è¿™ä¸ªå®éªŒä½“éªŒä¸‹æ¥è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œå¾ˆå¿«å°±èƒ½å®Œæˆï¼Œlab2çš„kvserverä¸»è¦æ˜¯ä¸ºäº†ä¸Lab3çš„raftå®ç°å½¢æˆè”åŠ¨ï¼Œæœ€ç»ˆåœ¨lab4å®ç°å¤šæœåŠ¡å™¨çš„å®¹é”™kvæ•°æ®åº“</p><p>æœ¬èŠ‚å®éªŒä¸»è¦ç¼–å†™kvsrvæ–‡ä»¶å¤¹ä¸‹çš„client.goï¼Œserver.go</p><h2 id="Key-value-server-with-no-network-failures-easy"><a href="#Key-value-server-with-no-network-failures-easy" class="headerlink" title="Key/value server with no network failures (easy)"></a><strong>Key/value server with no network failures (easy)</strong></h2><p>è¿™ä¸ªè¦æ±‚éå¸¸ç®€å•ï¼Œæ—¢ç„¶æ˜¯kvserverï¼Œç›´æ¥åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨map[string]string å“ˆå¸Œè¡¨ä½œä¸ºæ•°æ®åº“çš„å­˜å‚¨ç»“æ„å³å¯</p><p>å—åˆ°lab1çš„å¯å‘ï¼Œæˆ‘åœ¨ä»£ç ä¸­é¢å¤–å®ç°äº†ç®€å•çš„åŸºäºå“ˆå¸Œç®—æ³•çš„<strong>ç¼“å­˜åˆ†ç‰‡</strong>ï¼Œé€šè¿‡å“ˆå¸Œæ•£åˆ—å°†æ•°æ®åˆ†æ•£åˆ°ä¸åŒçš„å“ˆå¸Œè¡¨ä¸­å­˜å‚¨ï¼Œå‡å°‘å•ä¸ªå“ˆå¸Œè¡¨çš„å¤§å°</p><p>Serverä½¿ç”¨maps []map[string]stringä½œä¸ºå­˜å‚¨ç»“æ„ï¼Œå¯¹æ¯ä¸€ä¸ªéœ€è¦æ“ä½œçš„keyé€šè¿‡å“ˆå¸Œç®—æ³•æ•£åˆ—åè½åˆ°0-NèŒƒå›´å†…çš„æŸä¸ªå›ºå®šå€¼ï¼Œç„¶åå¯¹è¿™ä¸ªkeyçš„æ‰€æœ‰æ“ä½œå°±å¯ä»¥éƒ½åœ¨maps[i]ä¸Šè¿›è¡Œäº†ï¼Œå®¢è§‚ä¸Šå¢åŠ äº†ä¸€æ¬¡å“ˆå¸Œè®¡ç®—ï¼Œä½†å‡å°‘äº†åœ¨å®é™…å­˜å‚¨æ•°æ®çš„å“ˆå¸Œè¡¨ä¸­å‘ç”Ÿå“ˆå¸Œç¢°æ’çš„æ¦‚ç‡ã€‚</p><p><img src="/4.png" alt="ç¼“å­˜åˆ†ç‰‡"></p><p>ä»£ç å®ç°ï¼š</p><p><strong>å“ˆå¸Œæ•£åˆ—ç®—æ³•ï¼š</strong></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">ihash</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><span class="token comment">// task number for each KeyValue emitted by Map.</span>h <span class="token operator">:=</span> fnv<span class="token punctuation">.</span><span class="token function">New32a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>h<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">Sum32</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7fffffff</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">ApplyGet</span><span class="token punctuation">(</span>Key <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token keyword">return</span> kv<span class="token punctuation">.</span>maps<span class="token punctuation">[</span><span class="token function">ihash</span><span class="token punctuation">(</span><span class="token operator">*</span>Key<span class="token punctuation">)</span><span class="token operator">%</span>kv<span class="token punctuation">.</span>nMap<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">*</span>Key<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">ApplyPut</span><span class="token punctuation">(</span>Key <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">,</span> Value <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>index <span class="token operator">:=</span> <span class="token function">ihash</span><span class="token punctuation">(</span><span class="token operator">*</span>Key<span class="token punctuation">)</span> <span class="token operator">%</span> kv<span class="token punctuation">.</span>nMapkv<span class="token punctuation">.</span>maps<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">*</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>Value<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">ApplyAppend</span><span class="token punctuation">(</span>Key <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">,</span> Value <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>index <span class="token operator">:=</span> <span class="token function">ihash</span><span class="token punctuation">(</span><span class="token operator">*</span>Key<span class="token punctuation">)</span> <span class="token operator">%</span> kv<span class="token punctuation">.</span>nMappreValue <span class="token operator">:=</span> kv<span class="token punctuation">.</span>maps<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">*</span>Key<span class="token punctuation">]</span>kv<span class="token punctuation">.</span>maps<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">*</span>Key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token operator">*</span>Value<span class="token keyword">return</span> preValue<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç±»ä¼¼çš„æ€æƒ³è¿˜æœ‰ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<br>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´æ˜ å°„æˆä¸€ä¸ªæŒ‰é¡ºæ—¶é’ˆæ–¹å‘ç»„ç»‡çš„è™šæ‹Ÿåœ†ç¯,ä½¿ç”¨å“ˆå¸Œç®—æ³•ç®—å‡ºæ•°æ®å“ˆå¸Œå€¼ï¼Œç„¶åæ ¹æ®å“ˆå¸Œå€¼çš„ä½ç½®æ²¿åœ†ç¯é¡ºæ—¶é’ˆæŸ¥æ‰¾ï¼Œå°†æ•°æ®åˆ†é…åˆ°ç¬¬ä¸€ä¸ªé‡åˆ°çš„é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œç¼“å­˜ã€‚</p><p>å®ç°æ€è·¯ï¼š<br>1.å¯¹ä¸åŒèŠ‚ç‚¹æœåŠ¡å™¨çš„æŸäº›å‚æ•°(macåœ°å€ã€IPåœ°å€ç­‰)è¿›è¡Œhashè®¡ç®—ï¼Œç”¨hashå€¼å¯¹2^32å–æ¨¡ï¼Œç¡®å®šå½“å‰æœåŠ¡å™¨è½åœ¨ç¯æŸä¸€ä¸ªèŠ‚ç‚¹ä¸Š<br>2.æ•°æ®å­˜å‚¨æ—¶ï¼Œå¯¹æŒ‡å®šçš„keyè¿›è¡Œhashè®¡ç®—ï¼Œç„¶åç”¨hashå€¼å¯¹2^32å–æ¨¡ï¼Œç¡®å®šæ•°æ®è½åœ¨ç¯çš„å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¾—åˆ°ç¯çš„èŠ‚ç‚¹å€¼ä¹‹åï¼Œé¡ºæ—¶é’ˆæ–¹å‘æ‰¾åˆ°é‡åˆ°çš„ç¬¬ä¸€å°æœåŠ¡å™¨ï¼Œè¿™å°æœåŠ¡å™¨å°±æ˜¯å­˜å‚¨å½“å‰æ•°æ®çš„åœ°æ–¹ã€‚</p><p><img src="/5.png" alt="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"></p><p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä¸¤å¤§ä¼˜ç‚¹ï¼š<br>å‡å°‘èŠ‚ç‚¹ï¼šæœåŠ¡å™¨2å‘ç”Ÿæ•…éšœï¼Œå­˜åœ¨ä¸Šé¢çš„æ•°æ®éƒ½éœ€è¦è¿ç§»ï¼Œé‚£ä¹ˆï¼Œæ­¤æ—¶åªéœ€è¦è¿ç§»æœåŠ¡å™¨1ä¸æœåŠ¡å™¨2ä¹‹é—´çš„æ•°æ®Bã€Cåˆ°æœåŠ¡å™¨3å³å¯ã€‚</p><p>å¢åŠ èŠ‚ç‚¹ï¼šåœ¨æ•°æ®Bã€Cä¹‹é—´æ·»åŠ æœåŠ¡å™¨4ï¼Œé‚£ä¹ˆåªéœ€è¦è¿ç§»å­˜å‚¨åœ¨æœåŠ¡å™¨2ä¸Šçš„æ•°æ®Båˆ°æœåŠ¡å™¨4å³å¯ã€‚</p><p>1ï¼‰å¯æ‰©å±•æ€§ã€‚ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¿è¯äº†å¢åŠ æˆ–å‡å°‘æœåŠ¡å™¨æ—¶ï¼Œæ•°æ®å­˜å‚¨çš„æ”¹å˜æœ€å°‘,ç›¸æ¯”ä¼ ç»Ÿå“ˆå¸Œç®—æ³•å¤§å¤§èŠ‚çœäº†æ•°æ®ç§»åŠ¨çš„å¼€é”€ã€‚</p><p>2ï¼‰ æ›´å¥½åœ°é€‚åº”æ•°æ®çš„å¿«é€Ÿå¢é•¿ã€‚</p><p>ä¸è¿‡æœ¬æ¬¡å®éªŒåªæ˜¯å•æœåŠ¡å™¨çš„ç®€å•kvserverï¼Œå¹¶ä¸éœ€è¦ä¸€è‡´æ€§å“ˆå¸Œçš„è¿™äº›ä¼˜ç‚¹ï¼Œåªæ˜¯ä½œä¸ºçŸ¥è¯†ç‚¹è¡¥å……</p><h2 id="Key-value-server-with-dropped-messages-easy"><a href="#Key-value-server-with-dropped-messages-easy" class="headerlink" title="Key/value server with dropped messages (easy)"></a><strong>Key/value server with dropped messages (easy)</strong></h2><p>å½“åŠ å…¥äº†ä¸ç¨³å®šç½‘ç»œå› ç´ åï¼Œæƒ…å†µä¸€ä¸‹ä¼šå˜å¾—å¤æ‚å¾ˆå¤šï¼Œä¸ç¨³å®šç½‘ç»œä¼šé€ æˆåŒ…çš„å»¶è¿Ÿï¼ŒåŒ…çš„ä¸¢å¤±ã€‚ä¸ºäº†ä¿è¯æœåŠ¡ç«¯èƒ½æ”¶åˆ°è¯·æ±‚ï¼Œå®¢æˆ·ç«¯èƒ½å¾—åˆ°å“åº”ï¼Œå¿…é¡»è¿›è¡Œå®¢æˆ·ç«¯çš„<strong>é‡å¤è¯·æ±‚</strong>å’ŒæœåŠ¡ç«¯<strong>é‡å¤å“åº”</strong>ã€‚</p><p><strong>å®¢æˆ·ç«¯é‡å¤è¯·æ±‚ï¼š</strong></p><p>å®¢æˆ·ç«¯çš„é‡å¤è¯·æ±‚å¾ˆå¥½è§£å†³ï¼Œå› ä¸ºRPCè°ƒç”¨æœ¬èº«æ˜¯ä¸€å®šä¼šæœ‰è¿”å›çš„ï¼ŒRPCè¿”å›å€¼å¦‚æœä¸ºfalseï¼Œè¯´æ˜è¯·æ±‚å‘ç”Ÿäº†é”™è¯¯ï¼Œä¾‹å¦‚è¶…æ—¶æœªé€è¾¾ï¼Œè¶…æ—¶æœªå“åº”ç­‰ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯ç«‹åˆ»é‡å‘ä¸Šä¸€æ¬¡è¯·æ±‚å³å¯ï¼Œä»£ç å®ç°å°±æ˜¯ç”¨ä¸€ä¸ªwhile<del>ï¼ˆforï¼‰</del>å¾ªç¯ä¸€ç›´ä¸åœå°è¯•ã€‚</p><p><strong>æœåŠ¡ç«¯çš„åº”å¯¹ï¼š</strong></p><p>ç”±äºä¸ç¨³å®šç½‘ç»œçš„å› ç´ ï¼ŒæœåŠ¡ç«¯å¯èƒ½å¤šæ¬¡æ”¶åˆ°åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„å¤šæ¬¡ç›¸åŒè¯·æ±‚ï¼Œé‡å¤çš„getè¯·æ±‚è¿˜å¥½å¤„ç†ï¼Œå› ä¸ºgetè¯·æ±‚æ˜¯<strong>å®‰å…¨çš„</strong> <strong>å¹‚ç­‰çš„</strong> </p><p>â€œå®‰å…¨â€æ˜¯æŒ‡è¯·æ±‚æ–¹æ³•ä¸ä¼šç ´åæœåŠ¡å™¨ä¸Šçš„èµ„æº</p><p>â€œå¹‚ç­‰â€æŒ‡çš„æ˜¯å¤šæ¬¡æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œç»“æœéƒ½æ˜¯ç›¸åŒçš„ï¼Œå³å¤šæ¬¡â€œå¹‚â€åç»“æœâ€œç›¸ç­‰â€</p><p>æƒ³å¯¹åº”çš„ï¼Œputå’Œappendè¯·æ±‚å°±æ˜¯æ—¢ä¸å®‰å…¨ï¼Œä¹Ÿä¸å¹‚ç­‰ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹åœ¨æ•°æ®åº“é‡Œé‡å¤æ‰§è¡Œäº†æœ¬ä¸è¯¥é‡å¤çš„putå’Œappendéƒ½ä¼šé€ æˆæ•°æ®é”™ä¹±ã€‚</p><p>å› æ­¤ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„åšæ³•æ˜¯ç»™æ¯ä¸€ä¸ªæ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åŠ ä¸Šå”¯ä¸€æ ‡è¯†ï¼ŒæœåŠ¡å™¨æ¯æ¬¡åº”ç”¨putå’Œappendæ“ä½œå‰éƒ½è¦æ£€æŸ¥ä¹‹å‰æ˜¯å¦å·²ç»åº”ç”¨è¿‡ç›¸åŒçš„å‘½ä»¤ï¼Œè‹¥æœ‰ï¼Œåˆ™å¯ä»¥è·³è¿‡åº”ç”¨åˆ°æ•°æ®åº“çš„è¿‡ç¨‹ï¼Œç›´æ¥è¿”å›ç»“æœç»™å®¢æˆ·ç«¯</p><p>ä½†æ˜¯ä¸ºäº†è§£å†³é‡ä¼ é—®é¢˜ï¼Œéš¾é“è¿˜éœ€è¦åœ¨æ¯æ¬¡åº”ç”¨æ“ä½œå‰æœç´¢å…¨éƒ¨çš„å†å²æ“ä½œæ£€æŸ¥é‡å¤å—ï¼Ÿæˆ–è€…å¹²è„†å†å»ºç«‹ä¸€ä¸ªå“ˆå¸Œé›†åˆä¸“é—¨å­˜æ”¾å†å²æ“ä½œçš„å”¯ä¸€æ ‡è¯†ï¼Ÿä»£ä»·æœªå…å¤ªå¤§äº†ã€‚</p><p>å¥½åœ¨æœ‰ä¼˜åŒ–çš„æ–¹æ³•ï¼šç”±äºå®¢æˆ·ç«¯åªä¼šé‡ä¼ ä¸Šä¸€ä¸ªæ²¡å¾—åˆ°ç»“æœçš„æ“ä½œï¼Œè€Œä¸”åœ¨å¾—åˆ°ç¡®è®¤ç»“æœå‰ç»ä¸ä¼šç»§ç»­è¯·æ±‚æ–°çš„æ“ä½œï¼Œæˆ‘ä»¬å¾—ä»¥ç¼©å°æœåŠ¡ç«¯ä¿å­˜å†å²æ“ä½œçš„èŒƒå›´</p><p>å³æœåŠ¡å™¨ä»…ä»…ä¸ºæ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¿å­˜å®ƒçš„ä¸Šä¸€æ¬¡æ“ä½œåº”è¿”å›çš„ç»“æœï¼Œå¦‚æœåŒä¸€ä¸ªå®¢æˆ·ç«¯çš„æ–°çš„æ“ä½œåˆ°æ¥ï¼Œè¯´æ˜æ—§çš„æ“ä½œå·²ç»è¢«å®¢æˆ·ç«¯ç¡®è®¤äº†ï¼Œè¿™å°±å¯ä»¥ä¸¢å¼ƒæ‰ä¸Šä¸€æ¬¡æ“ä½œï¼Œä»…è¦†ç›–ä¿å­˜æ–°çš„æ“ä½œå³å¯</p><p>å…·ä½“å®ç°å¦‚ä¸‹</p><h3 id="client-goçš„ä»£ç å®ç°"><a href="#client-goçš„ä»£ç å®ç°" class="headerlink" title="client.goçš„ä»£ç å®ç°"></a><strong>client.goçš„ä»£ç å®ç°</strong></h3><p>ä¸ºclerk å¢åŠ äº†ä¸¤ä¸ªæˆå‘˜ï¼Œä½¿ç”¨éšæœºæ•°ä½œä¸ºèº«ä»½æ ‡è¯†çš„clientidï¼Œè¿˜æœ‰å‘é€è¯·æ±‚çš„åºåˆ—å·</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Clerk <span class="token keyword">struct</span> <span class="token punctuation">{</span>server       <span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEndclientId     <span class="token builtin">int64</span>latestOffset <span class="token builtin">int</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®¢æˆ·ç«¯ç”Ÿæˆæ—¶å€™ï¼ŒæŒ‡å®šä¸€ä¸ªéšæœºæ•°ä½œä¸ºèº«ä»½æ ‡è¯†ï¼Œè®¾ç½®offsetä¸º0</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">MakeClerk</span><span class="token punctuation">(</span>server <span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">)</span> <span class="token operator">*</span>Clerk <span class="token punctuation">{</span>ck <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Clerk<span class="token punctuation">)</span><span class="token operator">*</span>ck <span class="token operator">=</span> Clerk<span class="token punctuation">{</span>server<span class="token punctuation">:</span>       server<span class="token punctuation">,</span>clientId<span class="token punctuation">:</span>     <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>latestOffset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token keyword">return</span> ck<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éšæœºæ•°äº§ç”Ÿç®—æ³•ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>max <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">62</span><span class="token punctuation">)</span>bigx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> max<span class="token punctuation">)</span>x <span class="token operator">:=</span> bigx<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> x<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯·æ±‚æ“ä½œï¼Œå¤±è´¥åé‡å¤å°è¯•å³å¯ï¼ŒæˆåŠŸå‰å°±ä¸ä¼šè¿›è¡Œæ–°çš„è¯·æ±‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">for</span> <span class="token punctuation">{</span>ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer."</span><span class="token operator">+</span>op<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token keyword">if</span> ok <span class="token punctuation">{</span><span class="token comment">//è¯·æ±‚æˆåŠŸåè‡ªå¢åºåˆ—å·</span>ck<span class="token punctuation">.</span>latestOffset<span class="token operator">++</span><span class="token keyword">break</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="serverç«¯ä»£ç å®ç°"><a href="#serverç«¯ä»£ç å®ç°" class="headerlink" title="serverç«¯ä»£ç å®ç°"></a><strong>serverç«¯ä»£ç å®ç°</strong></h3><p>ä¸»è¦æ˜¯å®ç°å¤„ç†é‡ä¼ çš„ä»£ç ï¼š</p><p>KVServerç»“æ„ä½“ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> KVServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>mu        sync<span class="token punctuation">.</span>MutexnMap      <span class="token builtin">int</span>maps      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>     <span class="token comment">//ç¼“å­˜åˆ†ç‰‡</span>duplicate <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>intStringPair <span class="token comment">//ç¼“å­˜å®¢æˆ·ç«¯ä¸Šä¸€æ¬¡æ“ä½œ</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>KVServeråˆå§‹åŒ–ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>kv<span class="token punctuation">.</span>nMap <span class="token operator">=</span> <span class="token number">10</span>kv<span class="token punctuation">.</span>maps <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> kv<span class="token punctuation">.</span>maps <span class="token punctuation">{</span>kv<span class="token punctuation">.</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">}</span>kv<span class="token punctuation">.</span>duplicate <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>intStringPair<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦é€»è¾‘ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span>args <span class="token operator">*</span>ApplyArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>Reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>dupli<span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>duplicate<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token comment">//åœ¨mapä¸­ç™»è®°æ–°å®¢æˆ·ç«¯ï¼Œè¿™æ­¥ä¸»è¦æ˜¯ä¸ºäº†ç®€åŒ–é€»è¾‘</span><span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>dupli<span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>dupli<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">}</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> dupli<span class="token punctuation">.</span>offset <span class="token punctuation">{</span> <span class="token comment">//ä¹‹å‰ä¸¢å¤±çš„å›å¤ï¼Œäºæ˜¯ç›´æ¥å›å¤dupli.value</span>reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> dupli<span class="token punctuation">.</span>value<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//ç¡®è®¤dupliä¸­çš„å€¼å·²è¢«clientæ¥æ”¶åˆ°,äºæ˜¯ç›´æ¥æ›´æ–°</span><span class="token keyword">switch</span> args<span class="token punctuation">.</span>OpT <span class="token punctuation">{</span><span class="token keyword">case</span> getT<span class="token punctuation">:</span>reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">ApplyGet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token keyword">case</span> putT<span class="token punctuation">:</span>kv<span class="token punctuation">.</span><span class="token function">ApplyPut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token keyword">case</span> appendT<span class="token punctuation">:</span>reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">ApplyAppend</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//æ›´æ–°offset æ›´æ–°reply.Value</span>kv<span class="token punctuation">.</span>duplicate<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> intStringPair<span class="token punctuation">{</span>offset<span class="token punctuation">:</span> args<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span> value<span class="token punctuation">:</span> reply<span class="token punctuation">.</span>Value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯golangçš„mapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œéœ€è¦åŠ é”ä¿æŠ¤ï¼Œä¸è¿‡æœ¬èº«ä¸ºäº†ç®€åŒ–å¤„ç†é€»è¾‘ï¼Œæˆ‘ä¹Ÿç›´æ¥ç»™æ¯ä¸ªå‡½æ•°ä¸Šäº†æŠŠå¤§é”</p><p>å®éªŒç»“æœï¼š</p><p><img src="/2024/04/04/mit65840lab2shixian/6.png" alt="æµ‹è¯•"></p>]]></content>
      
      
      
        <tags>
            
            <tag> MIT6.5840 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIT6.5840 Lab1 å®ç°</title>
      <link href="/2024/04/03/mit65840lab1shixian/"/>
      <url>/2024/04/03/mit65840lab1shixian/</url>
      
        <content type="html"><![CDATA[<h1 id="What-is-6-5840-about"><a href="#What-is-6-5840-about" class="headerlink" title="What is 6.5840 about?"></a>What is 6.5840 about?</h1><p>MIT6.5840ï¼ˆåŸMIT6.824ï¼‰æ˜¯éº»çœç†å·¥çš„ä¸€é—¨åˆ†å¸ƒå¼ç³»ç»Ÿè¯¾ç¨‹ï¼Œè¯¾å ‚ä¸Šä¸»è¦è®²æˆåˆ†å¸ƒå¼é¢†åŸŸçš„è®ºæ–‡ï¼Œé‡ç‚¹æ˜¯å®ƒçš„å®éªŒéƒ¨åˆ†ï¼Œé€šè¿‡å‡ ä¸ªå®éªŒå¾ªåºæ¸è¿›ï¼Œè®©å­¦ç”Ÿæœ€åèƒ½äº²æ‰‹å®Œæ•´å®ç°åŸºäºRaftåè®®çš„åˆ†å¸ƒå¼å®¹é”™æ•°æ®åº“ã€‚</p><p>å¾€å¹´åªæœ‰å››ä¸ªå®éªŒï¼Œä»Šå¹´é¢å¤–å¢åŠ äº†ä¸€ä¸ªï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯:</p><p>å®éªŒä¸€ï¼šå®ç°ï¼ˆç®€å•çš„ï¼‰MapReduceåˆ†å¸ƒå¼ç®—æ³•æ¡†æ¶</p><p>å®éªŒäºŒï¼šå®ç°å•ä¸€æœåŠ¡å™¨ä¸Šçš„å®¹é”™é”®å€¼å¯¹æ•°æ®åº“</p><p>å®éªŒä¸‰ï¼šå®ç°Raftåè®®</p><p>å®éªŒå››ï¼šåŸºäºRaftåè®®ï¼Œå®ç°å…·æœ‰å®¹é”™åŠŸèƒ½ã€å¼ºä¸€è‡´æ€§çš„åˆ†å¸ƒå¼KVserveré›†ç¾¤</p><p>å®éªŒäº”ï¼šå®ç°åˆ†ç‰‡æ•°æ®åº“ï¼Œåœ¨å¤šä¸ªåŸºäºRaftåè®®çš„KVserveré›†ç¾¤ä¹‹é—´å®ç°è´Ÿè½½å‡è¡¡ï¼Œæ•°æ®è½¬ç§»ï¼Œé…ç½®æ›´æ–°ç­‰</p><span id="more"></span><h2 id="å®˜æ–¹ä»‹ç»"><a href="#å®˜æ–¹ä»‹ç»" class="headerlink" title="å®˜æ–¹ä»‹ç»"></a>å®˜æ–¹ä»‹ç»</h2><blockquote><p>6.5840 is a core 12-unit graduate subject with lectures, readings, programming labs, an optional project, a mid-term exam, and a final exam. It will present abstractions and implementation techniques for engineering distributed systems. Major topics include <strong>fault tolerance, replication, and consistency</strong>. Much of the class consists of studying and discussing case studies of <strong>distributed systems.</strong> </p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ•´ä½“å®éªŒçš„éš¾åº¦å¾ˆé«˜ï¼Œä½†æœ€åå®Œæˆå®éªŒæ‰€éœ€è¦çš„ä»£ç é‡å´ä¸æ¯«ä¸å¤šã€‚</p><p>è¿™å¾ˆå¤§ç¨‹åº¦å¾—ç›Šäºgoç®€æ´çš„è¯­æ³•ï¼Œå¤§æ¦‚ä¹Ÿåªæœ‰goè¯­è¨€èƒ½è®©åˆå­¦è€…åœ¨ä¸€å¤©å†…å®Œæˆè¯­æ³•çº§å…¥é—¨ï¼Œå¹¶ä¸”ç«‹åˆ»å…·æœ‰å®ç°å¤æ‚å®éªŒçš„èƒ½åŠ›å§ï¼Œå¯ä»¥è¯´golangæ˜¯ä¸€ä¸ªéå¸¸ç¥å¥‡çš„è¯­è¨€ã€‚åç»­æˆ‘å¤§æ¦‚ä¼šå•ç‹¬å‡ºä¸€ç¯‡ä»‹ç»åœ¨æœ¬å®éªŒéœ€è¦ç•™æ„çš„golangç‰¹æ€§ã€‚</p><p>å®éªŒæœ¬èº«æ˜¯ä¸€ç›´åœ¨è¿­ä»£çš„ï¼Œæ¯å¹´å˜åŒ–éƒ½ä¸å¤§ï¼Œæ¯”å¦‚ä¼˜åŒ–ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ä¹‹ç±»çš„ã€‚ä½†æ˜¯ä»Šå¹´æ˜¥å­£å­¦æœŸçš„MIT6.5840ç¡®å®æœ‰ä¸€äº›å¯ä»¥ç§°é“çš„å˜åŒ–äº†ï¼ŒåŸæœ¬å››ä¸ªå®éªŒç°å¦‚ä»Šå¢åŠ åˆ°äº†äº”ä¸ªï¼Œä¸»è¦åœ¨LAB2çš„ä½ç½®å¢åŠ äº†ä¸€ä¸ªç®€æ˜“kvserverçš„å®éªŒï¼Œä¸è¿‡å½±å“ä¸å¤§ã€‚</p><h2 id="Lab1-MapReduce"><a href="#Lab1-MapReduce" class="headerlink" title="Lab1: MapReduce"></a>Lab1: MapReduce</h2><p>Lab1å…·ä½“è¦å®ç°çš„ç®—æ³•è¿‡ç¨‹ç§°ä¸ºMapReduceï¼Œä¸€ä¸ªåˆ†å¸ƒå¼è¿ç®—ç¨‹åºçš„ç¼–ç¨‹æ¡†æ¶ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯å¡«å……mræ–‡ä»¶å¤¹ä¸‹çš„coordinator.go, rpc.go, worker.go è¿™ä¸‰ä¸ªæ–‡ä»¶</p><p>å…·ä½“æ€è·¯ç›´æ¥çœ‹å®˜æ–¹ä»£ç  mrsequential.go</p><p>é¦–å…ˆæ˜ å…¥çœ¼å¸˜çš„æ˜¯loadPluginå‡½æ•°ï¼Œå®ƒçš„è¾“å…¥æ˜¯os.Args[1]ï¼Œè¿”å›å€¼æ˜¯ä¸¤ä¸ªå‡½æ•°</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">mapf<span class="token punctuation">,</span> reducef <span class="token operator">:=</span> <span class="token function">loadPlugin</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>os.Args[1]æ˜¯æˆ‘ä»¬åœ¨bashè¿è¡Œç¨‹åºæ—¶æŒ‡å®šçš„ç¬¬äºŒä¸ªå‚æ•°</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go run mrsequential.go wc.so pg*.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ˜¯golangçš„Pluginç³»ç»Ÿï¼Œä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ã€‚</p><p>è§‚å¯ŸæŒ‡ä»¤ï¼Œç¨‹åºè¿è¡ŒæŒ‡å®šçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <strong>wc.so</strong> ï¼Œå¯¹äº.soåç¼€çš„æ–‡ä»¶ï¼Œç†Ÿæ‚‰ç¼–è¯‘è¿‡ç¨‹çš„è‚¯å®šèƒ½å¾€åŠ¨æ€é“¾æ¥åº“çš„æ–¹é¢å»çŒœæµ‹ã€‚äº‹å®ä¸Šå®ƒç¡®å®è·Ÿå…±äº«åº“æœ‰ç€å¾ˆæ·±çš„æ¸Šæºï¼Œä½†ç”¨æ³•å´ç€å®ä¸é‚£ä¹ˆæ–¹ä¾¿</p><p>é¦–å…ˆæ˜ç¡®åœ¨C++ä¸­ï¼Œä¸»ç¨‹åºè¿è¡Œæ—¶é™¤äº†éœ€è¦æä¾›.lib .a .dll .soç­‰åº“çš„æºæ–‡ä»¶å¤–ï¼Œè¿˜å¿…é¡»æä¾›å¤´æ–‡ä»¶ã€‚å¤´æ–‡ä»¶æ ‡è¯†åº“é‡Œé¢æä¾›äº†å¯ä»¥ä¾›å¤–ç•Œä½¿ç”¨çš„æ¥å£</p><p>è€Œä¸”è™½ç„¶åŠ¨æ€é“¾æ¥åº“çš„é“¾æ¥å‘ç”Ÿåœ¨ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘ç¯èŠ‚ï¼Œç¼–è¯‘å™¨ä»ç„¶ä¼š<strong>æ‰§è¡Œé“¾æ¥æ£€æŸ¥</strong>,è¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯éœ€è¦åŠ¨æ€åº“çš„å¤´æ–‡ä»¶å‚ä¸è¿›æ¥çš„ã€‚è™½ç„¶ä»æ–‡ä»¶çš„è§’åº¦çœ‹ï¼Œcppçš„ä¸€ä¸ªåŠ¨æ€åº“å°±å¾—ç”±ä¸¤ä¸ªæ–‡ä»¶ç»„æˆå¸¦æ¥äº†äº›è®¸éº»çƒ¦ï¼Œä½†å®ƒå¸¦æ¥çš„å¸®åŠ©æ˜¯å·¨å¤§çš„</p><p>(1)ä»£ç ç¼–å†™æ—¶å€™ï¼šç”±äºæœ‰å¤´æ–‡ä»¶çš„å¸®åŠ©ï¼Œç¼–å†™ä¸»ç¨‹åºçš„æ—¶å€™å¯ä»¥å¾ˆæ–¹ä¾¿çš„é€šè¿‡é˜…è¯»æºç ï¼ŒIDEæ™ºèƒ½æç¤ºç­‰æ–¹å¼è·çŸ¥å‡½æ•°çš„å‚æ•°ï¼Œè¿”å›å€¼ç­‰ç­‰ï¼Œä¸éœ€è¦ç¼–è¯‘ä¹Ÿèƒ½å¾—åˆ°é”™è¯¯æç¤ºã€‚è€Œä¸”ä½¿ç”¨æ–¹å¼è·Ÿè‡ªå·±å†™çš„å‡½æ•°æ²¡ä»€ä¹ˆä¸¤æ ·</p><p>(2)ä»£ç ç¼–è¯‘æ—¶ï¼šä»£ç ç¼–è¯‘æ—¶å¯ä»¥ç”±ç¼–è¯‘å™¨æä¾›æ­£ç¡®æ€§æ›´å¼ºçš„æ£€æŸ¥ï¼Œå½“ç„¶è¿™æ˜¯å› ä¸ºåº“çš„å¤´æ–‡ä»¶ä¹Ÿå‚ä¸åˆ°äº†ç¼–è¯‘è¿‡ç¨‹å½“ä¸­</p><p>ä½†æ˜¯CPPä¹Ÿæä¾›äº†å¦å¤–ä¸€ç§åŠ è½½åŠ¨æ€åº“çš„æ–¹å¼ï¼Œ<strong>åŠ¨æ€åŠ è½½</strong>æ–¹å¼ï¼šåŠ¨æ€åŠ è½½ä»ç„¶æ˜¯è¿è¡Œæ—¶åŠ è½½ï¼Œä½†å¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶ç”±æˆ‘ä»¬å†³å®šä½•æ—¶åŠ è½½æŒ‡å®šçš„æ¨¡å—ã€‚</p><p>å…·ä½“å‡½æ•°å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// æŒ‰æŒ‡å®šçš„æ¨¡å¼æ‰“å¼€åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œå¹¶è¿”å›å¥æŸ„</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é€šè¿‡å¥æŸ„è·å–å…±äº«å¯¹è±¡æˆ–å¯æ‰§è¡Œæ–‡ä»¶ä¸­ç¬¦å·çš„åœ°å€</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">dlsym</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>handle<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>symbol<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¸è½½æ‰“å¼€çš„åº“</span><span class="token keyword">int</span> <span class="token function">dlclose</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯åŠ¨æ€åŠ è½½åŠ¨æ€åº“(dlopen(åº“å)/load(åº“å)ç­‰æ–¹æ³•),åˆ™ä¸éœ€è¦å¤´æ–‡ä»¶,åªéœ€è¦åº“æ–‡ä»¶.å‰ææ˜¯è°ƒç”¨æ–¹çŸ¥é“<strong>å‡½æ•°åå’Œå‚æ•°åˆ—è¡¨,è¿”å›å€¼</strong>ç­‰ä¿¡æ¯,æ–¹å¯æ­£ç¡®è°ƒç”¨;</p><p>æ ·ä¾‹å¦‚ä¸‹ï¼š<br>åœ¨libcaculator.soä¸­å®šä¹‰äº†addå‡½æ•°</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨mainä¸­åŠ¨æ€è°ƒç”¨libcaculator.soçš„è¿‡ç¨‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//å‡½æ•°æŒ‡é’ˆ</span><span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>CAC_FUNC<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ‰“å¼€åŠ¨æ€é“¾æ¥åº“</span>handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"./libcaculator.so"</span><span class="token punctuation">,</span> RTLD_LAZY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–ä¸€ä¸ªå‡½æ•°</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>cac_func<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä½¿ç”¨å‡½æ•°</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add: %d\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>cac_func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…³é—­åŠ¨æ€é“¾æ¥åº“</span><span class="token function">dlclose</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¾“å‡ºï¼š</span><span class="token comment">//add: 9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†çœ‹çœ‹golangä¸­pluginçš„ä½¿ç”¨ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">p<span class="token punctuation">,</span> err <span class="token operator">:=</span> plugin<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>xmapf<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"Map"</span><span class="token punctuation">)</span>mapf <span class="token operator">:=</span> xmapf<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>mr<span class="token punctuation">.</span>KeyValue<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨èµ·æ¥è·ŸCPPåŠ¨æ€åº“çš„åŠ¨æ€åŠ è½½æ–¹å¼æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œä½†æ˜¯golangä¸æ”¯æŒä¸»åŠ¨å…³é—­åŠ¨æ€åº“ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ”¯æŒçƒ­é‡è½½åŠ¨æ€åº“åŠŸèƒ½ï¼Œé‰´äºgolangæè‡´ç®€æ´çš„é£æ ¼å°±åŸè°…å®ƒäº†ã€‚</p><p>ä½†æ˜¯è¿™ç§è°ƒç”¨æ–¹å¼è‚¯å®šä¸å¦‚CPPä½¿ç”¨äº†å¤´æ–‡ä»¶çš„æ–¹å¼ï¼Œå¦‚æœæ‰€æœ‰åŠ¨æ€åº“éƒ½åªèƒ½è¿™æ ·ä½¿ç”¨ï¼Œå¯¹äºç¨‹åºç¼–å†™è€…æ¥è¯´æ— ç–‘æ˜¯ä¸€ç§æŠ˜ç£¨ã€‚</p><p>å›åˆ°å®éªŒæœ¬èº«<br>å¯¹äºå®˜æ–¹çš„ç¬¬ä¸€ä¸ªä¾‹å­wc.goï¼Œå®ƒçš„åŠŸèƒ½æ˜¯è¯é¢‘ç»Ÿè®¡ï¼Œç”±Mapï¼ˆï¼‰å’ŒReduceï¼ˆï¼‰å®ç°</p><p>Mapå‡½æ•°</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Map</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">,</span> contents <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>mr<span class="token punctuation">.</span>KeyValue <span class="token punctuation">{</span><span class="token comment">// function to detect word separators.</span>ff <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token builtin">rune</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span>unicode<span class="token punctuation">.</span><span class="token function">IsLetter</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token comment">// split contents into an array of words.</span>words <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">FieldsFunc</span><span class="token punctuation">(</span>contents<span class="token punctuation">,</span> ff<span class="token punctuation">)</span>kva <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>mr<span class="token punctuation">.</span>KeyValue<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> w <span class="token operator">:=</span> <span class="token keyword">range</span> words <span class="token punctuation">{</span>kv <span class="token operator">:=</span> mr<span class="token punctuation">.</span>KeyValue<span class="token punctuation">{</span>w<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">}</span>kva <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>kva<span class="token punctuation">,</span> kv<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> kva<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Mapå‡½æ•°è¾“å…¥ä¸€ä¸ªé•¿æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œç„¶åä»¥ä»»ä½•éå­—æ¯ç¬¦å·ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå°†æ–‡æœ¬æ–‡ä»¶åˆ†å‰²æˆå•è¯ï¼Œå­˜å‚¨åˆ°åˆ‡ç‰‡ä¸­ã€‚</p><p>è¿™äº›å•è¯è‡ªç„¶ä¼šæœ‰å¾ˆå¤šé‡å¤ï¼Œä½†æ˜¯è¿™é‡Œä¸å¤„ç†é‡å¤ï¼Œä¸ºæ¯ä¸€ä¸ªå•è¯åŠ ä¸Šâ€œ1â€ä½œä¸ºvalueå°±ç»“æŸäº†ã€‚</p><p>è‚¯å®šæœ‰äººè·Ÿæˆ‘å½“æ—¶é˜…è¯»æºç æ—¶æœ‰ç›¸åŒçš„ç–‘æƒ‘ï¼Œè¿™é‡Œç›´æ¥ç”¨mapä¸å°±èƒ½å®Œæˆå­—ç¬¦ä¸²ç»Ÿè®¡äº†å—ï¼Œè€Œä¸”å¹¶ä¸å½±å“å¹¶è¡ŒåŠŸèƒ½ã€‚æ²¡é”™ï¼ŒMapå‡½æ•°ä¸­ç¡®å®å¯ä»¥æå‰å¯¹ä¸­é—´æ•°æ®è¿›è¡Œä¸€äº›ç®€å•çš„shrinkæ“ä½œã€‚åªæ˜¯è¿™é‡Œæ²¡æœ‰è¿™ä¹ˆåš</p><p>MapReduceæ˜¯ä¸€ç§åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ï¼Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ çš„æ˜¯åªæ˜¯è¿™ç§æ€æƒ³ï¼Œä¸ºåé¢å®ç°Raftåè®®æ‰“ä¸‹åŸºç¡€ï¼Œä¸å¿…çº ç»“äºæ­¤ã€‚</p><p>Reduceå‡½æ•°</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Reduce</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> values <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token comment">// return the number of occurrences of this word.</span><span class="token keyword">return</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å…¥[hello : [â€œ1â€,â€1â€,â€1â€,â€1â€]]ï¼Œç»Ÿè®¡â€œ1â€çš„ä¸ªæ•°ï¼Œç»“æœè½¬æˆå­—ç¬¦ä¸²å½¢å¼ï¼Œä¹Ÿå°±æ˜¯â€4â€ï¼›</p><h3 id="MapReduceæµç¨‹"><a href="#MapReduceæµç¨‹" class="headerlink" title="MapReduceæµç¨‹"></a>MapReduceæµç¨‹</h3><p><img src="/2024/04/03/mit65840lab1shixian/2.png" alt="ä½¿ç”¨jsonå­˜å‚¨çš„é”®å€¼å¯¹æ•°æ®"></p><p>æºæ•°æ®éœ€è¦ç»è¿‡åˆ†ç‰‡åˆ†ç»™ä¸åŒæœºå™¨ä¸Šçš„Mapperè¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—ç»“æœç§°ä¸ºintermidiateã€‚ç„¶åå¯¹intermidiateç»è¿‡ä¸€è½®æ±‡æ€»åå†åˆ†ç‰‡ï¼Œäº¤ç”±reducerå¤„ç†ï¼Œæœ€åå†æ±‡æ€»reducerçš„è¾“å‡ºï¼Œåˆå¹¶åå½¢æˆæœ€ç»ˆç»“æœã€‚</p><p>å› æ­¤æ¯ä¸ªworkerï¼ˆåˆ†å¸ƒåœ¨ä¸åŒä¸»æœºä¸Šçš„ç¨‹åºï¼‰çš„ä»»åŠ¡éƒ½ç›¸å½“ç®€å•ï¼Œä»ç½‘ç»œæ¥æ”¶è¾“å…¥ï¼Œæ‰§è¡Œå„è‡ªçš„mapfæˆ–è€…reducerfï¼Œä»ç½‘ç»œè¾“å‡ºç»“æœã€‚</p><p>MapReducerçš„æ ¸å¿ƒåœ¨äºä»»åŠ¡çš„åˆ†é…å’Œæ¥æ”¶ï¼Œä»»åŠ¡å†…éƒ¨å…·ä½“å¦‚ä½•æ‰§è¡Œå¹¶éæ­¤å®éªŒé‡ç‚¹ã€‚</p><p>åœ¨ç°å®ä¸­ï¼Œæ— è®ºæ˜¯Mapä»»åŠ¡å’ŒReduceä»»åŠ¡ï¼Œéƒ½æ˜¯åœ¨ä¸åŒç°å®åœ°å€çš„ä¸»æœºä¸Šçš„workerè¿›ç¨‹ä¸­è¿è¡Œçš„ï¼Œåœ¨å®éªŒä¸­è™½ç„¶æ²¡æ³•å®ç°ä¸åŒä¸»æœºï¼Œä½†ä»ç„¶å¯ä»¥ç”¨ç½‘ç»œæŠ€æœ¯RPCå’Œå¤šè¿›ç¨‹æ¥è¿›è¡Œæ¨¡æ‹Ÿã€‚</p><p>è´Ÿè´£åˆ†é…ä»»åŠ¡çš„è¿›ç¨‹ç§°ä¸ºcoordinatorï¼Œå®ƒè´Ÿè´£äº§ç”Ÿå’Œåˆ†æ´¾ä»»åŠ¡ï¼Œæ˜¯MapReduceç®—æ³•æ¡†æ¶çš„æ ¸å¿ƒï¼Œå› ä¸ºæ¯ä¸ªworkerçš„è§†é‡é‡Œåªæœ‰è‡ªå·±çš„ä»»åŠ¡ï¼Œå¯¹äºæ•´ä¸ªè®¡ç®—ç›®æ ‡å´ä¸€æ— æ‰€çŸ¥ï¼Œcoordinatorå°±è´Ÿè´£æŠŠæ¡å…¨å±€è§†é‡ã€‚ï¼ˆåœ¨ä»¥å‰å®éªŒä¸­å®ƒçš„åå­—è¿˜æ˜¯masterï¼Œæ”¹åçš„åŸå› å¯èƒ½è·Ÿgithubå°†é»˜è®¤åˆ†æ”¯ä»masteræ”¹åè‡³mainæ˜¯ä¸€è‡´çš„ï¼‰</p><p>ä¸€ä¸ªå¾ˆç›´è§‚çš„MapReduceå®ç°æ–¹æ³•å°±æ˜¯è®©coodinatorä¸»åŠ¨é€šè¿‡ç½‘ç»œé€šä¿¡ï¼Œè½®è¯¢workerè¿›ç¨‹</p><ol><li><p>workeræ˜¯å¦å¤„äºæ— ä»»åŠ¡çš„ç©ºé—²çŠ¶æ€ï¼Ÿå¦‚æœç©ºé—²å°±é€šè¿‡ä¸€æ¬¡RPCè°ƒç”¨åˆ†é…å®é™…ä»»åŠ¡ï¼Œå¦åˆ™å°±æ‰¾ä¸‹ä¸€ä¸ªworker</p></li><li><p>workerå¦‚æœå¹¶éç©ºé—²ï¼Œé‚£ä¹ˆæ˜¯å¦å·²ç»å®Œæˆäº†ä»»åŠ¡ï¼Ÿå¦‚æœå®Œæˆä»»åŠ¡å°±æ¥å—workerçš„è¾“å‡ºï¼Œæ”¾åˆ°è‡ªå·±çš„å­˜å‚¨ç©ºé—´é‡Œæš‚å­˜</p></li><li><p>workeré™¤äº†ç©ºé—²çŠ¶æ€å’Œå®Œæˆä»»åŠ¡çŠ¶æ€ï¼Œè¿˜æœ‰ä¸€ä¸ªå¤±è´¥çŠ¶æ€</p><ol><li><p>workerå¤±è”ï¼šå¯èƒ½workerå·²ç»å®Œæˆäº†ä»»åŠ¡ï¼Œä½†æ˜¯å´å› ä¸ºç½‘ç»œä¸­æ–­æ— æ³•æäº¤ä»»åŠ¡ï¼Œæˆ–è€…å¯èƒ½workerè¿›ç¨‹ç›´æ¥å°±æ˜¯æŒ‚æ‰äº†ï¼Œå¯èƒ½åªæ˜¯è¿™æ¬¡çš„è½®è¯¢ä¸¢åŒ…äº†ï¼Œcoordinatorå†è¯¢é—®ä¸€æ¬¡è¯´ä¸å®šå°±è”ç³»ä¸Šäº†ã€‚</p></li><li><p>workeræ²¡æœ‰å¤±è”ï¼Œä½†æ˜¯å®ƒå› ä¸ºæ•…éšœé‡å¯è¿‡äº†ï¼Œå®ƒä¸çŸ¥é“è‡ªå·±é‡å¯å‰è¢«åˆ†é…è¿‡ä»»åŠ¡ã€‚å¥½åœ¨coordinatoræ˜¯çŸ¥é“çš„ï¼Œå½“æˆä»»åŠ¡å¤±è´¥å³å¯ã€‚</p></li></ol></li></ol><p>å¯ä»¥çœ‹åˆ°å¦‚æœç”±coodinatoræ¥å…¨æƒæŠŠæ¡ä»»åŠ¡åˆ†é…è¿‡ç¨‹ï¼Œå®ç°èµ·æ¥æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œcoodinatorè¦ä¸åœè½®è¯¢æ¥æŠŠæ¡workerçš„çŠ¶æ€ã€‚</p><p>ä½†æ˜¯è¿™æ ·æ•ˆç‡ä¹Ÿæ˜¯ç›¸å¯¹è¾ƒé«˜çš„ï¼Œåˆ†é…æ–¹å¼å¾ˆçµæ´»ï¼Œå®ƒå¯ä»¥æ ¹æ®æœºå™¨çš„æ€§èƒ½å‚æ•°è®¾ç½®ä»»åŠ¡åˆ†é…ä¼˜å…ˆçº§å®ç°æœ€ä¼˜åˆ†é…ï¼Œè¿˜å¯ä»¥æ ¹æ®ä»»åŠ¡çš„å®æ—¶æ€§/è®¡ç®—é‡æ¥å†³å®šè¦è®©å¤šå°‘ä¸ªworkerå¹¶è¡Œä»¥è¾¾åˆ°å‡å°‘èµ„æºæ¶ˆè€—çš„ç›®çš„ã€‚ä¸è¿‡è¿™æ¯•ç«Ÿåªæ˜¯å…¥é—¨å®éªŒlab1ï¼Œæˆ‘ä»¬å°±ä¸è¦å¥¢æ±‚å¤ªå¤šäº†ã€‚æˆ‘ä»¬é€‰æ‹©å¦ä¸€ç§æ–¹å¼å®ç°ä»»åŠ¡è°ƒåº¦</p><h3 id="worksteal"><a href="#worksteal" class="headerlink" title="worksteal"></a>worksteal</h3><p>æˆ‘ä»¬å€Ÿé‰´work-stealçš„æ€æƒ³ï¼Œè®©workè‡ªå·±ä»coordinatorä¸­å–ä»»åŠ¡ï¼Œè¿™æ ·å¯ä»¥è‡ªåŠ¨å®ç°è´Ÿè½½å‡è¡¡</p><p><a href="https://blog.csdn.net/blog_programb/article/details/134893638">å·¥ä½œçªƒå–ï¼ˆWork-Stealingï¼‰æ˜¯ä¸€ç§å¤šçº¿ç¨‹å’Œå¹¶è¡Œè®¡ç®—ä¸­çš„è´Ÿè½½å¹³è¡¡ç­–ç•¥ï¼Œä¸»è¦åœ¨Javaçš„Fork/Joinæ¡†æ¶ä¸­å¾—åˆ°åº”ç”¨_java workstealing-CSDNåšå®¢</a></p><p>workerçš„çŠ¶æ€åªæœ‰workerè‡ªå·±æœ€æ¸…æ¥šï¼Œå› æ­¤é‡‡ç”¨workerä¸»åŠ¨è”ç³»coordinatorå–ä»»åŠ¡çš„æ–¹å¼å®ç°èµ·æ¥ä¼šç®€å•å¾ˆå¤šï¼Œcoordinatoræ¥å—åˆ°workerçš„ä»»åŠ¡è¯·æ±‚åä»è‡ªå·±çš„æœªå®Œæˆä»»åŠ¡é‡Œå–ä¸€ä¸ªäº¤ä»˜ç»™workerå°±å®Œäº‹äº†ï¼Œæ¥æ”¶åˆ°workerçš„ä»»åŠ¡å®Œæˆåä¹Ÿçœ‹æƒ…å†µæ¥å—å°±è¡Œ</p><p>å…·ä½“å®ç°æ€è·¯å°±æ˜¯workerå‘¨æœŸæ€§è°ƒç”¨RPCè¯·æ±‚ä»»åŠ¡ï¼Œæ ¹æ®è¿”å›å€¼åˆ¤æ–­ä»»åŠ¡æœ‰æ²¡æœ‰åˆ†é…æˆåŠŸï¼ŒæˆåŠŸå°±åšï¼Œåšå®Œå†è°ƒç”¨RPCé€šçŸ¥coordinatorä»»åŠ¡å®Œæˆ</p><h3 id="Coordinatorä»£ç å®ç°"><a href="#Coordinatorä»£ç å®ç°" class="headerlink" title="Coordinatorä»£ç å®ç°"></a>Coordinatorä»£ç å®ç°</h3><p>coordinatorå¯¹äºä»»åŠ¡çŠ¶æ€çš„ä¸‰ç§æ ‡è¯†:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span> <span class="token comment">//task çš„çŠ¶æ€æ ‡è¯†</span>unassigned <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//taskæœªåˆ†é…</span>working           <span class="token comment">//taskå·²åˆ†é…ï¼Œæœªç¡®è®¤æ˜¯å¦å®Œæˆ</span>finish            <span class="token comment">//taskå·²å®Œæˆ</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Coordinatorçš„æˆå‘˜å˜é‡ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Coordinator <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token comment">// Your definitions here.</span>AllDone       <span class="token builtin">bool</span>       <span class="token comment">//æ ‡å¿—ï¼šä»»åŠ¡å…¨éƒ¨å®Œæˆ</span>AllMapDone    <span class="token builtin">bool</span>       <span class="token comment">//æ ‡å¿—ï¼šMapä»»åŠ¡å…¨éƒ¨å®Œæˆ</span>AllReduceDone <span class="token builtin">bool</span>       <span class="token comment">//æ ‡å¿—ï¼šReduceä»»åŠ¡å…¨éƒ¨å®Œæˆ</span>Mu            sync<span class="token punctuation">.</span>Mutex <span class="token comment">//Coordinatorå…±äº«èµ„æºè®¿é—®é”</span>TaskMu        sync<span class="token punctuation">.</span>Mutex <span class="token comment">//taskèµ„æºè®¿é—®é”</span>TaskTotalNum  <span class="token builtin">int</span>        <span class="token comment">//æ€»ä»»åŠ¡æ•°</span>TaskLeft      <span class="token builtin">int</span>        <span class="token comment">//å‰©ä½™æœªå®Œæˆä»»åŠ¡æ•°</span>TaskTotal     <span class="token punctuation">[</span><span class="token punctuation">]</span>mrTask   <span class="token comment">//ä»»åŠ¡æ•°ç»„</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Taskçš„æˆå‘˜å˜é‡ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> mrTask <span class="token keyword">struct</span> <span class="token punctuation">{</span>TaskType  <span class="token builtin">int</span>      <span class="token comment">//åˆ†è¾¨æ˜¯Mapä»»åŠ¡è¿˜æ˜¯Reduceä»»åŠ¡</span>TaskState <span class="token builtin">int</span>      <span class="token comment">//ä¸‰ç§ä»»åŠ¡çŠ¶æ€ï¼šæœªåˆ†é…/å·²åˆ†é…ä½†æœªç¡®è®¤å®Œæˆ/ç¡®è®¤å®Œæˆ</span>FileName  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//ä»»åŠ¡å‚æ•°</span>NReduce   <span class="token builtin">int</span>TaskId    <span class="token builtin">int</span>RecuderId <span class="token builtin">int</span>StartTime time<span class="token punctuation">.</span>Time <span class="token comment">//ä»»åŠ¡å¼€å§‹æ—¶é—´</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ‰äº†æ˜ç¡®å®šä¹‰åå°±å¾ˆç®€å•äº†<br>å®éªŒä¸è¦æ±‚å®ç°Mapreduceç®—æ³•ä¸­çš„splitéƒ¨åˆ†ï¼Œæˆ‘ä»¬å°±æ ¹æ®è¾“å…¥çš„æ–‡ä»¶æ•°é‡ç”Ÿæˆå¯¹åº”çš„Mapä»»åŠ¡å³å¯</p><p>coordinator</p><ol><li><p>generateMapTask() ç”ŸæˆMapä»»åŠ¡ç„¶åæ”¾åˆ°TaskTotalæ•°ç»„é‡Œ</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">generateMapTask</span><span class="token punctuation">(</span>file <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> NReduce <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">for</span> index<span class="token punctuation">,</span> FileName <span class="token operator">:=</span> <span class="token keyword">range</span> file <span class="token punctuation">{</span>newTask <span class="token operator">:=</span> mrTask<span class="token punctuation">{</span>TaskType<span class="token punctuation">:</span>  mapTask<span class="token punctuation">,</span>TaskState<span class="token punctuation">:</span> unassigned<span class="token punctuation">,</span>NReduce<span class="token punctuation">:</span>   NReduce<span class="token punctuation">,</span>TaskId<span class="token punctuation">:</span>    index<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token comment">//ä½¿ç”¨appendé¿å…æµ…æ‹·è´</span>newTask<span class="token punctuation">.</span>FileName <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newTask<span class="token punctuation">.</span>FileName<span class="token punctuation">,</span> FileName<span class="token punctuation">)</span>c<span class="token punctuation">.</span>TaskTotal <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">}</span>c<span class="token punctuation">.</span>TaskTotalNum <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">)</span>c<span class="token punctuation">.</span>TaskLeft <span class="token operator">=</span> c<span class="token punctuation">.</span>TaskTotalNum<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>scheduler() ä¸€å¼€å§‹è°ƒç”¨generateMapTask()ç”Ÿæˆå¥½mapä»»åŠ¡ï¼Œç­‰å¾…mapä»»åŠ¡å…¨éƒ¨å®Œæˆåå†ç”Ÿæˆreduceä»»åŠ¡</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">Schedule</span><span class="token punctuation">(</span>files <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> NReduce <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>c<span class="token punctuation">.</span><span class="token function">generateMapTask</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> NReduce<span class="token punctuation">)</span><span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">HandleCrashTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// fmt.Println("success: generateMapTask :", c.TaskTotal)</span>c<span class="token punctuation">.</span>AllDone <span class="token operator">=</span> <span class="token boolean">false</span>c<span class="token punctuation">.</span>AllMapDone <span class="token operator">=</span> <span class="token boolean">false</span>c<span class="token punctuation">.</span>AllReduceDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token keyword">for</span> <span class="token punctuation">{</span> <span class="token comment">//ä¸€ç§’æ£€æŸ¥ä¸€æ¬¡å¯ä¸å¯åˆ‡æ¢é˜¶æ®µ</span><span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>AllMapDone <span class="token punctuation">{</span><span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">checkTaskDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>c<span class="token punctuation">.</span>AllMapDone <span class="token operator">=</span> <span class="token boolean">true</span>c<span class="token punctuation">.</span><span class="token function">generateReduceTask</span><span class="token punctuation">(</span>NReduce<span class="token punctuation">)</span><span class="token comment">// fmt.Println("AllMapDone")</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>AllReduceDone <span class="token punctuation">{</span><span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">checkTaskDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>c<span class="token punctuation">.</span>AllReduceDone <span class="token operator">=</span> <span class="token boolean">true</span>c<span class="token punctuation">.</span>AllDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token comment">// fmt.Println("AllMapDone")s</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> c<span class="token punctuation">.</span>AllDone <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// fmt.Println("AllDone")</span><span class="token keyword">for</span> <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>é‡ç‚¹ï¼šAssignTasks()ï¼Œè¿™æ˜¯coordinatorçš„å‡½æ•°ï¼Œä½†æ˜¯ä¸ç”±coordinateè‡ªå·±è°ƒç”¨ï¼Œè€Œæ˜¯ä¸“ç”¨äºworkerè¿œç¨‹è°ƒç”¨ï¼Œè¿”å›ç»™workerçš„æ•°æ®å­˜æ”¾åœ¨replyç»“æ„ä½“ä¸­ã€‚è´Ÿè´£å“åº”workerçš„ä»»åŠ¡è¯·æ±‚ã€‚</p></li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> WorkerAskTask <span class="token keyword">struct</span> <span class="token punctuation">{</span> <span class="token comment">//æ­¤å‡½æ•°è¢«è°ƒç”¨æœ¬èº«è¯´æ˜äº†ä¸€åˆ‡ï¼Œä¸éœ€è¦ä½ æ¥è¡¥å……è¯´æ˜äº†</span><span class="token punctuation">}</span><span class="token keyword">type</span> WorkerAskTaskReply <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token comment">//å°†ä»»åŠ¡å‚æ•°è¿”å›ç»™workerï¼Œå› ä¸ºæ˜¯å®éªŒç¯å¢ƒï¼Œè¿”å›ä»»åŠ¡å‚æ•°å°±å¤Ÿäº†</span><span class="token comment">//ç°å®ä¸­çš„MapReduceå½“ç„¶è¿˜éœ€è¦æŠŠä»»åŠ¡å®Œæ•´æ•°æ®éƒ½ä¼ ç»™worker</span>Task mrTask<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">AssignTasks</span><span class="token punctuation">(</span>args <span class="token operator">*</span>WorkerAskTask<span class="token punctuation">,</span> reply <span class="token operator">*</span>WorkerAskTaskReply<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>c<span class="token punctuation">.</span>Mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span>TaskMu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> c<span class="token punctuation">.</span>Mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> c<span class="token punctuation">.</span>TaskMu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// fmt.Println("Coordinator get a askTask from worker")</span><span class="token comment">// for _, task := range c.TaskTotal {</span><span class="token comment">// fmt.Printf(" %d", task.TaskState)</span><span class="token comment">// }</span><span class="token comment">// fmt.Println(" ")</span><span class="token keyword">if</span> c<span class="token punctuation">.</span>AllDone <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Task <span class="token operator">=</span> mrTask<span class="token punctuation">{</span>TaskType<span class="token punctuation">:</span> finishTask<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> c<span class="token punctuation">.</span>TaskLeft <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>reply<span class="token punctuation">.</span>Task <span class="token operator">=</span> mrTask<span class="token punctuation">{</span>TaskType<span class="token punctuation">:</span> waitForMonent<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//éå†æ€»ä»»åŠ¡è¡¨ï¼Œæ‰¾åˆ°ä¸€ä¸ªæœªåˆ†é…ä»»åŠ¡ï¼Œå°†å®ƒåˆ†é…å‡ºå»ï¼Œå¹¶è®¾ç½®taskçŠ¶æ€ä¸ºå·¥ä½œä¸­</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>TaskTotal <span class="token punctuation">{</span><span class="token keyword">if</span> c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>TaskState <span class="token operator">==</span> unassigned <span class="token punctuation">{</span><span class="token comment">// fmt.Println("Coordinator assign worker a task,taskId = ", c.TaskTotal[i].TaskId)</span>c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>TaskState <span class="token operator">=</span> working<span class="token comment">//è®°å½•ä»»åŠ¡è¢«åˆ†é…å‡ºå»çš„æ—¶é—´</span>c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>StartTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// fmt.Println("now the task", c.TaskTotal[i].TaskId, "have been set ", c.TaskTotal[i].TaskState)</span>reply<span class="token punctuation">.</span>Task <span class="token operator">=</span> c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token keyword">break</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>ComfirmTaskFinish() åŒæ ·æ˜¯ä¾›ç»™workerè°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºç¡®è®¤ä»»åŠ¡ç¡®å®å®Œæˆäº†</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">ComfirmTaskFinish</span><span class="token punctuation">(</span>args <span class="token operator">*</span>WorkerFinishTask<span class="token punctuation">,</span> reply <span class="token operator">*</span>WorkerFinTaskReply<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>c<span class="token punctuation">.</span>TaskMu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> c<span class="token punctuation">.</span>TaskMu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// fmt.Println("Coordinator comfirm a task has finished,taskId =", args.Task.TaskId)</span><span class="token keyword">var</span> TaskId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">if</span> args<span class="token punctuation">.</span>Task<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> mapTask <span class="token punctuation">{</span>TaskId <span class="token operator">=</span> args<span class="token punctuation">.</span>Task<span class="token punctuation">.</span>TaskId<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>Task<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> reduceTask <span class="token punctuation">{</span>TaskId <span class="token operator">=</span> args<span class="token punctuation">.</span>Task<span class="token punctuation">.</span>RecuderId<span class="token punctuation">}</span><span class="token comment">//æ—¢ç„¶workerå·²ç»è¿”å›äº†ç»“æœï¼Œè¯´æ˜ä»»åŠ¡å½“ç„¶æ˜¯è¢«åˆ†é…è¿‡çš„woringçŠ¶æ€</span><span class="token comment">//ä¸ºä»€ä¹ˆè¿˜æœ‰è¿™ä¸€è¡Œåˆ¤æ–­å‘¢ï¼Ÿè¿™é‡Œè·Ÿåé¢çš„è¶…æ—¶æœºåˆ¶æœ‰å…³</span><span class="token keyword">if</span> c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>TaskId<span class="token punctuation">]</span><span class="token punctuation">.</span>TaskState <span class="token operator">==</span> working <span class="token punctuation">{</span>c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>TaskId<span class="token punctuation">]</span><span class="token punctuation">.</span>TaskState <span class="token operator">=</span> finishc<span class="token punctuation">.</span>TaskLeft<span class="token operator">--</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="workerä»£ç å®ç°"><a href="#workerä»£ç å®ç°" class="headerlink" title="workerä»£ç å®ç°"></a>workerä»£ç å®ç°</h3><p>workerçš„ä»£ç ç›¸å¯¹å¤æ‚ä¸€ç‚¹ï¼Œè¿™ä¸ªWorkerå‡½æ•°å°±ç›¸å½“äºmain()å‡½æ•°ï¼Œå®ƒçš„æ‰§è¡Œé€€å‡ºä»£è¡¨ç€æ•´ä¸ªMapReducerç®—æ³•çš„ç»“æŸï¼Œå…¨éƒ¨ä»»åŠ¡éƒ½è¢«å®Œæˆäº†ï¼ŒfinishTask</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span> <span class="token comment">//worker è·å¾—çš„ä»»åŠ¡æ ‡è¯†</span>waitForMonent <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//ç­‰å¾…æ ‡è¯†</span>mapTask              <span class="token comment">//mapä»»åŠ¡æ ‡è¯†</span>reduceTask           <span class="token comment">//reduceä»»åŠ¡æ ‡è¯†</span>finishTask           <span class="token comment">//ç®—æ³•ç»“æŸæ ‡è¯†</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸ºä»€ä¹ˆéœ€è¦æœ‰waitForMonentæ ‡è¯†ï¼Ÿè¿™æ˜¯å› ä¸ºreducerä»»åŠ¡éœ€è¦åœ¨å…¨éƒ¨mapä»»åŠ¡å®Œæˆåæ‰èƒ½ç”Ÿæˆå’Œè¢«åˆ†é…ã€‚æ‰€ä»¥å¯ä»¥é¢„è§åˆ°è‚¯å®šä¼šå‡ºç°ä¸€ä¸¤ä¸ªmapä»»åŠ¡è¿˜åœ¨è®¡ç®—ï¼Œè€Œä¸€å †ç©ºé—²workerè¿›ç¨‹åœ¨ä¸æ–­è¯·æ±‚ä»»åŠ¡çš„æƒ…æ™¯ï¼Œä½¿ç”¨æ­¤æ ‡è¯†å‘Šè¯‰workerï¼Œæ²¡ä»»åŠ¡å¹¶ä¸ä»£è¡¨ç€ç®—æ³•ç»“æŸäº†ï¼Œè¯·ç­‰ä¼šå†æ¥è¯·æ±‚ä¸€æ¬¡</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// main/mrworker.go calls this function.</span><span class="token keyword">func</span> <span class="token function">Worker</span><span class="token punctuation">(</span>mapf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue<span class="token punctuation">,</span>reducef <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token punctuation">{</span>curTask <span class="token operator">:=</span> <span class="token function">CallForATask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> curTask<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> waitForMonent <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> curTask<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> mapTask <span class="token punctuation">{</span><span class="token function">ApplyMap</span><span class="token punctuation">(</span>mapf<span class="token punctuation">,</span> curTask<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> curTask<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> reduceTask <span class="token punctuation">{</span><span class="token function">ApplyReduce</span><span class="token punctuation">(</span>reducef<span class="token punctuation">,</span> curTask<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> curTask<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> finishTask <span class="token punctuation">{</span><span class="token keyword">break</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ—¢ç„¶coordinateåªå®ç°äº†ä»»åŠ¡åˆ†é…ï¼Œé‚£ä¹ˆworkeråˆ°åº•æ˜¯å¦‚ä½•å®ŒæˆMapReduceç®—æ³•è¿‡ç¨‹çš„å‘¢ï¼Ÿ</p><ol><li>å¦‚æœæ¥å—åˆ°çš„æ˜¯Mapä»»åŠ¡ï¼Œæ¨¡ä»¿mrsequential.goä¸­çš„å¤„ç†ï¼Œæ‰“å¼€ä»»åŠ¡filenameæŒ‡å®šçš„æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶å†…å®¹å¹¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™mapf</li></ol><p>mrsequential.go:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">intermediate <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>mr<span class="token punctuation">.</span>KeyValue<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> filename <span class="token operator">:=</span> <span class="token keyword">range</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"cannot open %v"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">}</span>content<span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"cannot read %v"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">}</span>file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>kva <span class="token operator">:=</span> <span class="token function">mapf</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>intermediate <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>intermediate<span class="token punctuation">,</span> kva<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>é‚£ä¹ˆworkerçš„è¿ç®—äº§ç”Ÿçš„ä¸­é—´æ–‡ä»¶intermediateè¯¥æ”¾åˆ°å“ªé‡Œå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ç›´æ¥å†™åˆ°ç¡¬ç›˜é‡Œï¼Œå…ˆåœ¨æœ¬åœ°æš‚å­˜ä¸€ä¼šï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ç»Ÿè®¡å®Œä¹‹åï¼Œå†é€šè¿‡ç½‘ç»œä¼ è¾“æ–‡ä»¶ç»™coordinatorã€‚å½“ç„¶ä¼ è¾“è¿‡ç¨‹å¹¶ä¸æ˜¯lab1çš„é‡ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥è®©coordinatorä»ç¡¬ç›˜é‡Œæ‹¿ç»“æœå°±æ˜¯äº†ï¼Œåˆä¸æ˜¯çœŸçš„åœ¨ä¸åŒä¸»æœºä¸Šã€‚</li></ol><blockquote><p>A reasonable naming convention for intermediate files is mr-X-Y, where X is the Map task number, and Y is the reduce task number.<br>The workerâ€™s map task code will need a way to store intermediate key/value pairs in files in a way that can be correctly read back during reduce tasks. One possibility is to use Goâ€™s encoding/json package. To write key/value pairs in JSON format to an open file:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">enc <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> kv <span class="token operator">:=</span> <span class="token operator">...</span> <span class="token punctuation">{</span>err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>and to read such a file back:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">&gt;</span>dec <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token keyword">for</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> kv KeyValue <span class="token keyword">if</span> err <span class="token operator">:=</span> dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kv<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>   <span class="token keyword">break</span> <span class="token punctuation">}</span> kva <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>kva<span class="token punctuation">,</span> kv<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="workerçš„ApplyMap-å‡½æ•°å®ç°"><a href="#workerçš„ApplyMap-å‡½æ•°å®ç°" class="headerlink" title="workerçš„ApplyMap()å‡½æ•°å®ç°"></a>workerçš„ApplyMap()å‡½æ•°å®ç°</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">ApplyMap</span><span class="token punctuation">(</span>mapf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue<span class="token punctuation">,</span> curTask mrTask<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//ç…§æŠ„mrsequential.goä¸­çš„å¤„ç†</span>intermidiates <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fileName <span class="token operator">:=</span> <span class="token keyword">range</span> curTask<span class="token punctuation">.</span>FileName <span class="token punctuation">{</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"fatel: Woker can't open file: "</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">}</span>content<span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"fatel: Woker can't read all of file: "</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//æ·»åŠ åˆ°ä¸­é—´æ–‡ä»¶</span>intermidiates <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>intermidiates<span class="token punctuation">,</span> <span class="token function">mapf</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//å­˜å‚¨ä¸­é—´æ–‡ä»¶-------</span>numRecuce <span class="token operator">:=</span> curTask<span class="token punctuation">.</span>NReducemidKVfileName <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> numRecuce<span class="token punctuation">)</span>midFile <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">var</span> midEnco <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>json<span class="token punctuation">.</span>Encoder<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numRecuce<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>midKVfileName<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"mr-"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>curTask<span class="token punctuation">.</span>TaskId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>mFile<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>midKVfileName<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>midFile <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>midFile<span class="token punctuation">,</span> mFile<span class="token punctuation">)</span>mEnco <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>mFile<span class="token punctuation">)</span>midEnco <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>midEnco<span class="token punctuation">,</span> mEnco<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//å°†intermediate å†™å…¥æ–‡ä»¶</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> kv <span class="token operator">:=</span> <span class="token keyword">range</span> intermidiates <span class="token punctuation">{</span>i <span class="token operator">:=</span> <span class="token function">ihash</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>Key<span class="token punctuation">)</span> <span class="token operator">%</span> numRecucemidEnco<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//å…³é—­æ‰“å¼€çš„æ–‡ä»¶ç¬¦</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> file <span class="token operator">:=</span> <span class="token keyword">range</span> midFile <span class="token punctuation">{</span>file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//æŠ¥å‘Šä»»åŠ¡å®Œæˆ</span><span class="token function">CallForFinishATast</span><span class="token punctuation">(</span>curTask<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>MapTaskç»“æœå¦‚ä¸‹</p><p><img src="/2024/04/03/mit65840lab1shixian/2.png" alt="å›¾ç‰‡"></p><p>æ¯ä¸€ä¸ªæ‰§è¡ŒMapTaskçš„workeræœ€åéƒ½ä¼šè¾“å‡ºNReduceä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯MapTaskçš„è¾“å‡ºã€key,valueã€‘é€šè¿‡å®˜æ–¹æä¾›çš„å“ˆå¸Œç®—æ³•å¹³å‡åˆ†é…åˆ°Nä¸ªæ–‡ä»¶ä¸­ï¼Œè¿™ç§æ–¹å¼çš„å¥½å¤„åœ¨äºå®ƒæ‰€ç”Ÿæˆçš„Nä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯ç›¸ä¼¼çš„ï¼Œåç»­çš„Reducerä»»åŠ¡åˆ†é…èµ·æ¥å°±å¾ˆæ–¹ä¾¿äº†</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// use ihash(key) % NReduce to choose the reduce</span><span class="token keyword">func</span> <span class="token function">ihash</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><span class="token comment">// task number for each KeyValue emitted by Map.</span>h <span class="token operator">:=</span> fnv<span class="token punctuation">.</span><span class="token function">New32a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>h<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">Sum32</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7fffffff</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="workerçš„ApplyReduce-å‡½æ•°å®ç°"><a href="#workerçš„ApplyReduce-å‡½æ•°å®ç°" class="headerlink" title="workerçš„ApplyReduce()å‡½æ•°å®ç°"></a>workerçš„ApplyReduce()å‡½æ•°å®ç°</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">ApplyReduce</span><span class="token punctuation">(</span>reducef <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span><span class="token punctuation">,</span> curTask mrTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>files <span class="token operator">:=</span> curTask<span class="token punctuation">.</span>FileName<span class="token comment">//å°†æ–‡ä»¶ä¸­çš„é”®å€¼å¯¹æŒ‰å­—å…¸åºæ’åˆ—</span>intermidiates <span class="token operator">:=</span> <span class="token function">shuffle</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token comment">//å€Ÿé‰´çš„å†™æ³•ï¼Œç”Ÿæˆéšæœºåå­—çš„tempæ–‡ä»¶ä»¥é˜²æ­¢æ–‡ä»¶åé‡å¤</span>dir<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">CreateTemp</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">"mr-out-tempfile-"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"failed: os.CreateTemp failde"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>intermidiates<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token punctuation">{</span>j <span class="token operator">:=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token keyword">for</span> j <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span> intermidiates<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Key <span class="token operator">==</span> intermidiates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Key <span class="token punctuation">{</span>j<span class="token operator">++</span><span class="token punctuation">}</span><span class="token keyword">var</span> values <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token keyword">for</span> k <span class="token operator">:=</span> i<span class="token punctuation">;</span> k <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> k<span class="token operator">++</span> <span class="token punctuation">{</span>values <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> intermidiates<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//æ”¶é›†keyç›¸åŒçš„é”®å€¼å¯¹ï¼Œäº¤ç»™reducefå¤„ç†</span>v <span class="token operator">:=</span> <span class="token function">reducef</span><span class="token punctuation">(</span>intermidiates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Key<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token comment">//fmt.Fprintf å†™æ–‡ä»¶</span>fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">"%v %v\n"</span><span class="token punctuation">,</span> intermidiates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Key<span class="token punctuation">,</span> v<span class="token punctuation">)</span>i <span class="token operator">=</span> j<span class="token punctuation">}</span>file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>newFileName <span class="token operator">:=</span> <span class="token string">"mr-out-"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>curTask<span class="token punctuation">.</span>RecuderId<span class="token punctuation">)</span>err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Rename</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dir<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>newFileName<span class="token punctuation">)</span><span class="token comment">// fmt.Println(file.Name())</span><span class="token comment">// fmt.Println(dir + "/" + newFileName)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"failed: os.Rename faile err ="</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//æŠ¥å‘Šä»»åŠ¡å®Œæˆ</span><span class="token function">CallForFinishATast</span><span class="token punctuation">(</span>curTask<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæœ‰ä¸¤ä¸ªé‡è¦çš„ç»†èŠ‚</p><p>ä¸€ä¸ªæ˜¯<strong>shuffleå‡½æ•°</strong>çš„å®ç°</p><p>å¦ä¸€ä¸ªæ˜¯<strong>éšæœºæ–‡ä»¶å</strong>ï¼Œå®ŒæˆReducerä»»åŠ¡åæ‰å°†éšæœºæ–‡ä»¶åé‡æ–°å‘½å</p><p><strong>éšæœºæ–‡ä»¶åï¼š</strong></p><blockquote><p>ä¸ºä»€ä¹ˆä¸€å®šè¦éšæœºæ–‡ä»¶åï¼Ÿ</p></blockquote><p>å› ä¸ºworkerå¦‚æœä¸­é€”å› ä¸ºå´©æºƒäº†ï¼Œï¼ˆé˜…è¯»å®éªŒæºç ï¼Œæ˜¯é€šè¿‡os.exit(1)å®ç°çš„</p><p>workeræ˜¯æ¥ä¸åŠæ­£ç¡®å…³é—­æ–‡ä»¶æˆ–è€…é”€æ¯æ–‡ä»¶çš„ï¼Œä¼šç•™ä¸‹ä¸€ä¸ªå†™å…¥ä¸€åŠä¸”æ²¡æœ‰è¢«æ­£ç¡®å…³é—­çš„æ–‡ä»¶</p><p>é‚£ä¹ˆäº¤ç»™ä¸‹ä¸€ä¸ªç»§æ‰¿ç›¸åŒReducerä»»åŠ¡çš„workerå¤„ç†ä¸å°±å¥½äº†ï¼Ÿå®ƒå¦‚æœå‘ç°ç›¸åŒidå‰è¾ˆå·²ç»å†™è¿‡ä¸€ä¸ªmr-out-idçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±å°†å‰è¾ˆçš„æ–‡ä»¶åˆ é™¤ï¼Œè‡ªå·±å†åˆ›ä¸€ä¸ªæ–°çš„åŒåæ–‡ä»¶ï¼Œè¿™ç§æƒ…å†µä¸‹ç¡®å®æ²¡é—®é¢˜ã€‚</p><p>ä½†è€ƒè™‘åˆ°å…¶ä»–æƒ…å†µï¼Œè¿™æ ·çš„æ“ä½œé—®é¢˜å°±å¤§äº†ï¼Œè¿™è·Ÿæˆ‘ä»¬åé¢å®ç°çš„ä»»åŠ¡è¶…æ—¶é‡æ–°åˆ†é…çš„æœºåˆ¶æœ‰å…³</p><blockquote><p>å¦‚æœä¸€ä¸ªä»»åŠ¡æ‰§è¡Œçš„å¤ªä¹…äº†ä¹Ÿæ²¡æœ‰å¾—åˆ°è¿”å›ï¼Œcoordinatorä¼šè®¤ä¸ºä»»åŠ¡å¤±è´¥ï¼Œå›æ”¶ä»»åŠ¡å¹¶é‡æ–°åˆ†é…</p></blockquote><p>é—®é¢˜å°±åœ¨è¿™é‡Œã€‚ä»»åŠ¡åªæ˜¯è¶…æ—¶äº†ï¼Œworkerå´å¹¶ä¸ä¸€å®šå¤„äºæ­»äº¡çŠ¶æ€(os.exit(1))ï¼Œå®ƒå¯èƒ½çœŸçš„åªæ˜¯å› ä¸ºåšçš„å¤ªæ…¢ï¼Œä½†workerè¿˜å¥åœ¨ï¼Œè¿˜åœ¨å†™æ–‡ä»¶å‘¢ï¼</p><p>ç„¶åå°±ä¼šå‘ç”Ÿä¸¤ä¸ªworkerå¯¹åŒä¸€ä¸ªæ–‡ä»¶åŒæ—¶å†™å…¥çš„æ“ä½œï¼Œæˆ–è€…åè¾ˆæŠŠå‰è¾ˆæ­£åœ¨å†™çš„æ–‡ä»¶åˆ é™¤äº†ï¼Œè¿™æ˜¯å¾ˆä¸¥é‡çš„bug</p><p>æ¥ä¸‹æ¥è®²shuffle</p><h3 id="shuffleä»£ç å®ç°ï¼š"><a href="#shuffleä»£ç å®ç°ï¼š" class="headerlink" title="shuffleä»£ç å®ç°ï¼š"></a>shuffleä»£ç å®ç°ï¼š</h3><p>è¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œä½¿ç”¨decoderè§£ç ä¸æ–­è·å¾—KeyValueç±»å‹çš„æ•°æ®ï¼Œå…¨éƒ¨è¯»å–åˆ°intermidiatesé‡Œé¢ç„¶åç”¨å®˜æ–¹å†™å¥½çš„sortæ¥å£æŒ‰å­—å…¸åºæ’åºå°±è¡Œ</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">shuffle</span><span class="token punctuation">(</span>files <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue <span class="token punctuation">{</span><span class="token keyword">var</span> intermidiates <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fileName <span class="token operator">:=</span> <span class="token keyword">range</span> files <span class="token punctuation">{</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"failed: shuffle open file "</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> <span class="token string">" failed, error ="</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span>Decode <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token punctuation">{</span><span class="token keyword">var</span> kv KeyValueerr <span class="token operator">=</span> Decode<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kv<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">break</span><span class="token punctuation">}</span>intermidiates <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>intermidiates<span class="token punctuation">,</span> kv<span class="token punctuation">)</span><span class="token punctuation">}</span>file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token function">ByKey</span><span class="token punctuation">(</span>intermidiates<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> intermidiates<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦ä»£ç å°±æ˜¯è¿™äº›ï¼Œä¸‹é¢å†è®²è®²è¶…æ—¶é‡åˆ†é…çš„ç»†èŠ‚</p><p>åœ¨coordinator.goä¸­HandleCrashTask()æ˜¯è¢«goå…³é”®å­—æŒ‚èµ·æ¥çš„ä¸€ä¸ªåç¨‹å‡½æ•°ä½“</p><p>å®ƒç”¨äºå¯»æ‰¾coordinatorä¸­è¶…æ—¶æœªå®Œæˆçš„ä»»åŠ¡ï¼Œå°†å®ƒä»¬çš„ä»»åŠ¡çŠ¶æ€ä»workingé€€åŒ–ä¸ºunassignedï¼Œè¿™æ ·åˆ«çš„workeræ¥ç”³è¯·ä»»åŠ¡çš„æ—¶å€™ï¼Œcoordinatorå°±èƒ½ç»§ç»­åˆ†é…å®ƒä»¬äº†ã€‚</p><p>è¿™ä¹Ÿæ˜¯åœ¨ä¸ºä»€ä¹ˆåœ¨ ComfirmTaskFinish()å‡½æ•°ä¸­è¦æ±‚ä»»åŠ¡è¿”å›çš„æ—¶å€™è¦é‡æ–°åˆ¤æ–­coordinatorç™»è®°çš„ä»»åŠ¡çŠ¶æ€è¿˜æ˜¯ä¸æ˜¯workingçš„åŸå› </p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">HandleCrashTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>c<span class="token punctuation">.</span>TaskMu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> c<span class="token punctuation">.</span>AllDone <span class="token punctuation">{</span>c<span class="token punctuation">.</span>TaskMu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">}</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>TaskTotal <span class="token punctuation">{</span><span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>StartTime<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>TaskState <span class="token operator">==</span> working <span class="token punctuation">{</span><span class="token comment">// fmt.Println("task", c.TaskTotal[i].TaskId, "time out :", time.Since(c.TaskTotal[i].StartTime))</span>c<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>TaskState <span class="token operator">=</span> unassignedc<span class="token punctuation">.</span>TaskTotal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>StartTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>c<span class="token punctuation">.</span>TaskMu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡ªæ­¤å°±èƒ½å®Œå…¨é€šè¿‡lab1çš„å…¨éƒ¨æµ‹è¯•äº†ï¼è¿™æ¬¡è¯•éªŒå¯¹äºé”çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†æ˜¯åœ¨åé¢å®éªŒå°±ä¸æ˜¯è¿™æ ·äº†</p><p><img src="/2024/04/03/mit65840lab1shixian/3.png" alt="æµ‹è¯•"></p>]]></content>
      
      
      
        <tags>
            
            <tag> MIT6.5840 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸ªäººæ­å»ºåšå®¢æ•™ç¨‹-part2</title>
      <link href="/2024/03/16/gerendajianbokejiaochengpart2/"/>
      <url>/2024/03/16/gerendajianbokejiaochengpart2/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ­¤Partä»…åšç›¸å…³å‘½ä»¤è¡Œæ“ä½œçš„ä¿å­˜ï¼Œæ–¹ä¾¿æ²¡è·Ÿä¸Šçš„åŒå­¦å›æ¥æŸ¥æ‰¾è¦ç”¨åˆ°çš„æŒ‡ä»¤</p><span id="more"></span><h2 id="ç»ˆç«¯"><a href="#ç»ˆç«¯" class="headerlink" title="ç»ˆç«¯"></a>ç»ˆç«¯</h2><h3 id="æ–‡ä»¶å¤¹å‘½ä»¤"><a href="#æ–‡ä»¶å¤¹å‘½ä»¤" class="headerlink" title="æ–‡ä»¶å¤¹å‘½ä»¤"></a>æ–‡ä»¶å¤¹å‘½ä»¤</h3><p>è¿›å…¥æ–‡ä»¶å¤¹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> D:<span class="token punctuation">\</span>typora<span class="token punctuation">\</span>file<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿”å›ä¸Šä¸€çº§</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è·³è½¬åˆ°æ ¹ç›®å½•</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> <span class="token punctuation">\</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŸ¥çœ‹å½“å‰è·¯å¾„ä¸‹æ‰€æœ‰æ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">dir</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ›å»ºæ–‡ä»¶å¤¹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> myblog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ–°å»ºéç©ºæ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> æ–‡ä»¶ä¸­çš„å†…å®¹<span class="token operator">&gt;</span>new.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŸ¥çœ‹æ–‡ä»¶ä¸­çš„æ–‡æœ¬å†…å®¹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">type</span> æ–‡ä»¶å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ é™¤æ–‡ä»¶(å¦‚æœæ˜¯del æ–‡ä»¶å¤¹Aæ˜¯åˆ é™¤æ–‡ä»¶å¤¹Aå†…çš„æ‰€æœ‰å¸¦åç¼€çš„æ–‡ä»¶ï¼Œè‹¥æ–‡ä»¶å¤¹Aä¸­æœ‰æ–‡ä»¶å¤¹Bï¼Œæ–‡ä»¶å¤¹Bä¸ä¼šè¢«ä¿®æ”¹)</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">del æ–‡ä»¶å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ é™¤æ‰€æœ‰æŒ‡å®šåç¼€çš„æ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">del *.txtdel *.docx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åˆ é™¤åä¸ºfileçš„ç©ºæ–‡ä»¶å¤¹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rd <span class="token function">file</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ é™¤fileæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rd <span class="token function">file</span> /s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç”Ÿæˆç›®å½•æ ‘</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tree<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¤åˆ¶æ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">copy è·¯å¾„<span class="token punctuation">\</span>æ–‡ä»¶å è·¯å¾„<span class="token punctuation">\</span>æ–‡ä»¶å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç§»åŠ¨æ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">move è·¯å¾„<span class="token punctuation">\</span>æ–‡ä»¶å è·¯å¾„<span class="token punctuation">\</span>æ–‡ä»¶å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŸ¥çœ‹æœ¬æœºipåœ°å€</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ipconfig<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>pingæµ‹è¯•ç½‘ç»œè¿æ¥</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ping</span> www.csdn.net<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="é…ç½®git"><a href="#é…ç½®git" class="headerlink" title="é…ç½®git"></a>é…ç½®git</h2><p>åœ¨ç»ˆç«¯ç›´æ¥è¾“å…¥å³å¯<br>ç”¨æˆ·åå’Œé‚®ç®±æœ€å¥½é€‰æ‹©ä¸githubçš„ç”¨æˆ·åå’Œé‚®ç®± </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.name <span class="token string">"ç”¨æˆ·å"</span><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.email <span class="token string">"é‚®ç®±"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¾“å…¥è¯¥å‘½ä»¤å¯ä»¥æ£€æŸ¥è‡ªå·±è®¾ç½®çš„æ‰€æœ‰config</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--list</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ç”Ÿæˆssh-key"><a href="#ç”Ÿæˆssh-key" class="headerlink" title="ç”Ÿæˆssh key"></a>ç”Ÿæˆssh key</h3><p>SSH ä¸º Secure Shell çš„ç¼©å†™ï¼ŒSSH ä¸ºå»ºç«‹åœ¨åº”ç”¨å±‚åŸºç¡€ä¸Šçš„å®‰å…¨åè®®ã€‚SSH æ˜¯ç›®å‰è¾ƒå¯é ï¼Œä¸“ä¸ºè¿œç¨‹ç™»å½•ä¼šè¯å’Œå…¶ä»–ç½‘ç»œæœåŠ¡æä¾›å®‰å…¨æ€§çš„åè®®ã€‚åˆ©ç”¨ SSH åè®®å¯ä»¥æœ‰æ•ˆé˜²æ­¢è¿œç¨‹ç®¡ç†è¿‡ç¨‹ä¸­çš„ä¿¡æ¯æ³„éœ²é—®é¢˜ã€‚</p><p>SSH key å°±æ˜¯ä¿è¯è¿æ¥å®‰å…¨çš„å¯†é’¥ï¼Œç”±æœ¬æœºç”µè„‘ç”Ÿæˆã€‚</p><p>æŠŠ <strong>.pub</strong> åç¼€çš„å…¬é’¥äº¤ä»˜ç»™ç½‘ç«™ï¼Œç½‘ç«™ä¾¿èƒ½é€šè¿‡å¯†é’¥ä¿è¯èº«ä»½è¯†åˆ«</p><p><a href="https://www.cnblogs.com/gloria-5/p/12203044.html">sshè§£é‡Š</a></p><p>æ£€æŸ¥æ˜¯å¦å­˜åœ¨SSH Key</p><p>ç¬¬ä¸€è¡Œçš„ä½œç”¨æ˜¯è¿›å…¥ç”¨æˆ·æ–‡ä»¶å¤¹ä¸‹çš„ **[.ssh]**æ–‡ä»¶å¤¹<br>åœ¨æˆ‘çš„ç”µè„‘ä¸Šï¼Œè¿™ä¸ªç›®å½•çš„å®Œæ•´è¡¨ç¤ºå°±æ˜¯ <strong>[C:\Users\Xiurt.ssh]</strong> å°†å…¶ä¸­çš„ <strong>[xiurt]</strong> æ¢æˆè‡ªå·±ç”µè„‘çš„ç”¨æˆ·åï¼Œä¸€æ ·èƒ½ç›´æ¥è¿›å…¥æ­¤æ–‡ä»¶å¤¹<br>ä¸ºä»€ä¹ˆèƒ½ç®€å†™æˆ ã€cd <del>/.sshã€‘å‘¢ï¼Œå› ä¸ºã€</del>ã€‘ç¬¦å·å°±æ˜¯C:\Users\Xiurtçš„ç¼©å†™<br> å¦‚å›¾ï¼š</p><p><img src="/" alt="å›¾ç‰‡"></p><p> ç¬¬äºŒè¡Œåœ¨ã€ç»ˆç«¯åˆè¯†ã€‘ä¸­è®²è¿‡ï¼Œå°±æ˜¯åˆ—å‡ºå½“å‰æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨windowç•Œé¢æ‰“å¼€.sshæ–‡ä»¶å¤¹æŸ¥çœ‹<br>å¦‚å›¾ï¼š</p><p><img src="/2024/03/16/gerendajianbokejiaochengpart2/3.png" alt="å›¾ç‰‡"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/.ssh<span class="token function">ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœæ²¡æœ‰çœ‹åˆ°ã€id_rsaã€‘å’Œã€id_rsa.pub ã€‘è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œå°±è¯´æ˜ä»æ¥æ²¡ç”Ÿæˆè¿‡ssh keyï¼Œæ‰€ä»¥å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆssh keyï¼ˆä½†å…¶å®å¯ä»¥é€šè¿‡æ­¤å‘½ä»¤è¦†ç›–æ‰åŸæœ¬çš„ssh keyï¼‰</p><p>ã€<a href="mailto:your_name@your_email.com">your_name@your_email.com</a>ã€‘è¿™éƒ¨åˆ†å†…å®¹å¯ä»¥è‡ªè¡Œæ›´æ”¹ï¼Œè¿™æ®µæ ¼å¼åªæ˜¯ä¸€ç§ä¹ æƒ¯ä¸Šçš„è§„èŒƒï¼Œå®ƒæœ¬è´¨ä¸Šå°±æ˜¯ä¸€æ®µæ³¨é‡Šï¼Œå†™ä»€ä¹ˆéƒ½å¯ä»¥ï¼Œå½“ç„¶ä¸­æ–‡é™¤å¤–</p><p>æ¨èå†™ä¸Šæ³¨å†Œgithubç”¨çš„é‚®ç®±</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-C</span> <span class="token string">"your_name@your_email.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç”Ÿæˆå¯†é’¥è¿‡ç¨‹ä¼šé˜»å¡ä¸‰æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ˜¯è®©ä½ è¾“å…¥ç”Ÿæˆå¯†é’¥çš„è·¯å¾„ï¼Œæˆ‘ä»¬é€‰æ‹©é»˜è®¤ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æ‹å›è½¦é”®å³å¯</p><p>ç¬¬äºŒï¼Œä¸‰æ¬¡æ˜¯è®©ä½ è¾“å…¥ä½¿ç”¨å¯†é’¥çš„å¯†ç ï¼Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ä¸è¦è®¾ç½®å¯†ç ï¼Œç›´æ¥æ‹å›è½¦é”®ï¼Œå†æ‹å›è½¦é”®å³å¯</p><p>ç„¶åå°±ä¼šåƒæˆ‘ä¸€æ ·åœ¨.sshæ–‡ä»¶å¤¹ä¸‹å‡ºç°ä¸¤ä¸ªå¯†é’¥æ–‡ä»¶</p><p><img src="/2024/03/16/gerendajianbokejiaochengpart2/4.png" alt="å›¾"></p><p>ç„¶åæˆ‘ä»¬éœ€è¦å°†SSHçš„å…¬é’¥å†…å®¹copyåˆ°githubä¸Š<br>å…¬é’¥å°±æ˜¯.pubåç¼€çš„é‚£ä¸ªï¼Œå³id_rsa.pubæ–‡ä»¶ï¼Œæƒ³è¦æŸ¥çœ‹é‡Œé¢çš„å¯†é’¥ï¼Œä¸¤ç§æ–¹æ³•ï¼š</p><p>æ–¹æ³•ä¸€ï¼šç›´æ¥åœ¨windowsç•Œé¢ä¸­æ‰“å¼€.sshæ–‡ä»¶å¤¹ï¼Œå³é”®ä½¿ç”¨è®°äº‹æœ¬æ‰“å¼€</p><p><img src="/2024/03/16/gerendajianbokejiaochengpart2/5.png" alt="å›¾"></p><p>æ‰“å¼€åå¦‚å›¾æ˜¯ä¸€é•¿ä¸²å­—ç¬¦</p><p><img src="/2024/03/16/gerendajianbokejiaochengpart2/6.png" alt="å›¾"></p><p>å…¨éƒ¨é€‰ä¸­ï¼Œå¤åˆ¶</p><p>æ–¹æ³•äºŒï¼šåœ¨å‘½ä»¤è¡Œç•Œé¢ï¼Œé¦–å…ˆç¡®ä¿è‡ªå·±åœ¨.sshæ–‡ä»¶å¤¹ä¸‹</p><p><img src="/2024/03/16/gerendajianbokejiaochengpart2/7.png" alt="å›¾"></p><p>ç„¶åä½¿ç”¨typeå‘½ä»¤æ˜¾ç¤ºå­—ç¬¦ä¸²</p><p><img src="/2024/03/16/gerendajianbokejiaochengpart2/8.png" alt="å›¾"></p><p>ä¸€æ ·å…¨é€‰å¤åˆ¶</p><p>æ‹¿åˆ°.pubå…¬é’¥åï¼Œæ‰“å¼€github-&gt;setting-&gt;ssh-&gt;add ssh key<br>ä¿¡æ¯éšæ„å¡«å†™</p><p>ç„¶åæµ‹è¯•å¯†é’¥æœ‰æ²¡æœ‰æ·»åŠ æˆåŠŸ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-T</span> git@github.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åƒä¸‹å›¾å‡ºç°hi ã€ç”¨æˆ·åã€‘çš„ä¿¡æ¯å°±ç®—æˆåŠŸ</p><p><img src="/2024/03/16/gerendajianbokejiaochengpart2/2.png" alt="å›¾ç‰‡"></p><hr><h2 id="SublimeTextå®‰è£…æ’ä»¶"><a href="#SublimeTextå®‰è£…æ’ä»¶" class="headerlink" title="SublimeTextå®‰è£…æ’ä»¶"></a>SublimeTextå®‰è£…æ’ä»¶</h2><ol><li><p>å®‰è£…ä¸­æ–‡</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Install packagechinese<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>å®‰è£…Markdownçš„é¢„è§ˆåŠŸèƒ½ï¼Œé¦–å…ˆéœ€è¦å®‰è£…ç›¸å…³æ’ä»¶ï¼š</p></li></ol><p>Ctrl+Shift+pï¼Œè¾“å…¥Install Packageå›è½¦<br>ç­‰å¾…ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œè¾“å…¥MarkdomnPreviewå›è½¦å¼€å§‹å®‰è£…<br>å¼¹å‡ºå®‰è£…å®Œæˆçš„æ–‡æ¡£ï¼Œé‡å¯SublimeText</p><ol start="3"><li>SublimeTextå¦‚ä½•å¿«é€Ÿé¢„è§ˆMarkdown</li></ol><p>Ctrl+Shift+pï¼Œè¾“å…¥Markdown Preview: Preview in Browserå›è½¦<br>å‡ºç°çš„é€‰é¡¹ä¸­é€‰æ‹©Markdownï¼Œå³å¯è·³è½¬è‡³é»˜è®¤æµè§ˆå™¨ä»¥mdæ ¼å¼æŸ¥çœ‹</p><ol start="4"><li>è‡ªå®šä¹‰é¢„è§ˆå¿«æ·é”®</li></ol><p>åœ¨Preferences -&gt; Key Bindingsæ‰“å¼€çš„æ–‡ä»¶å³ä¾§æ çš„ä¸­æ‹¬å·ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼Œå…¶ä¸­alt+qå¯ä»¥è®¾ç½®ä¸ºä»»æ„æŒ‰é”®ï¼›</p><p>æ³¨æ„è¦è®©ä¸‹é¢è¿™æ®µä»£ç ä½äº[ ]é‡Œé¢</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ctrl+q"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"markdown_preview"</span><span class="token punctuation">,</span> <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"browser"</span><span class="token punctuation">,</span> <span class="token property">"parser"</span><span class="token operator">:</span><span class="token string">"markdown"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>SublimeTextå¦‚ä½•å¿«é€Ÿé¢„è§ˆMarkdown</p><p>Ctrl+Shift+pï¼Œè¾“å…¥Markdown Preview: Preview in Browserå›è½¦<br>å‡ºç°çš„é€‰é¡¹ä¸­é€‰æ‹©Markdownï¼Œå³å¯è·³è½¬è‡³é»˜è®¤æµè§ˆå™¨ä»¥mdæ ¼å¼æŸ¥çœ‹</p><hr><h2 id="Hexoå®‰è£…"><a href="#Hexoå®‰è£…" class="headerlink" title="Hexoå®‰è£…"></a>Hexoå®‰è£…</h2><p><strong>æ³¨æ„äº‹é¡¹</strong> ï¼Œä»¥ä¸‹æ‰€æœ‰æ“ä½œè¯·åœ¨win+xé”®ä¸‹çš„ <strong>ã€ç»ˆç«¯ç®¡ç†å‘˜ç•Œé¢ã€‘</strong> ä¸­è¿›è¡Œ</p><ol><li>æ‰€æœ‰å¿…å¤‡çš„åº”ç”¨ç¨‹åºå®‰è£…å®Œæˆåï¼Œå¯ä½¿ç”¨ npm å®‰è£… Hexoã€‚</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åæ¥åˆ°æˆ‘ä»¬æƒ³è¦åœ¨ç”µè„‘ä¸Šæ”¾ç½‘ç«™èµ„æºçš„åœ°æ–¹ï¼Œä¸€å®šæ˜¯è¦åœ¨ä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ä¸‹è¿›è¡Œ</p><p>åˆ‡æ¢åˆ°Dç›˜</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">d:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ–°å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ï¼Œåå­—è‡ªé€‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> myblog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿›å…¥åˆ°æ­¤ç©ºæ–‡ä»¶å¤¹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> myblog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰§è¡Œhexoåˆå§‹åŒ–å‘½ä»¤</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx hexo init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li><p>å»ºç«™</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>åœ¨æœ¬åœ°æµ‹è¯•ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx hexo cleannpx hexo gnpx hexo s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><hr><h2 id="ç½‘ç«™å†…å®¹"><a href="#ç½‘ç«™å†…å®¹" class="headerlink" title="ç½‘ç«™å†…å®¹"></a>ç½‘ç«™å†…å®¹</h2><ol><li><p>ä¸»é¢˜</p></li><li><p>æ–°å»ºé¡µé¢</p></li><li><p>è®¤è¯†markdown</p></li></ol><p><a href="https://blog.csdn.net/buzul/article/details/106347215">https://blog.csdn.net/buzul/article/details/106347215</a></p><ol start="4"><li>å›¾ç‰‡é—®é¢˜</li></ol><p>html</p><hr><h2 id="githubéƒ¨ç½²"><a href="#githubéƒ¨ç½²" class="headerlink" title="githubéƒ¨ç½²"></a>githubéƒ¨ç½²</h2><ol><li>å»ºåº“ï¼š</li></ol><p>å»ºç«‹åä¸º &lt;ä½ çš„ GitHub ç”¨æˆ·å&gt;.github.io çš„å‚¨å­˜åº“</p><ol start="2"><li>ç”Ÿæˆtoken</li></ol><p><a href="https://www.nowcoder.com/discuss/353150292587913216">token</a></p><ol start="3"><li>è®¾ç½®hexoçš„_config.yaml</li></ol><p>A. å®‰è£…deploy</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-git <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>B. deployé¡¹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git <span class="token key atrule">repo</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/Oncelane/Oncelane.github.io.git <span class="token key atrule">branch</span> <span class="token punctuation">:</span> main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>C. urlé¡¹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># URL</span><span class="token comment">## Set your site url here. For example, if you use GitHub Page, set url as 'https://username.github.io/project'</span><span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//Oncelane.github.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx hexo d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœéƒ¨ç½²æ—¶å‘ç”Ÿå¦‚å›¾é”™è¯¯</p><p><img src="/2024/03/16/gerendajianbokejiaochengpart2/9.png" alt="å›¾ç‰‡"></p><p>å°è¯•å–æ¶ˆgitä»£ç†æŒ‡ä»¤</p><p>å–æ¶ˆä»£ç†:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> <span class="token parameter variable">--unset</span> http.proxy<span class="token function">git</span> config <span class="token parameter variable">--global</span> <span class="token parameter variable">--unset</span> https.proxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> æ•™ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸ªäººåšå®¢æ­å»ºæ•™ç¨‹</title>
      <link href="/2024/03/13/gerenbokedajianjiaocheng/"/>
      <url>/2024/03/13/gerenbokedajianjiaocheng/</url>
      
        <content type="html"><![CDATA[<h1 id="è¿™ç¯‡æ•™ç¨‹çš„ç›®çš„æ˜¯æå‰å¸®åŠ©åŒå­¦ä»¬è¿›è¡ŒHexoå»ºç«™æ‰€éœ€çš„å·¥å…·å®‰è£…å’Œæ³¨å†ŒGitHubè´¦æˆ·ç­‰å¯èƒ½ä¼šèŠ±è´¹è¾ƒå¤šæ—¶é—´çš„å‡†å¤‡å·¥ä½œã€‚"><a href="#è¿™ç¯‡æ•™ç¨‹çš„ç›®çš„æ˜¯æå‰å¸®åŠ©åŒå­¦ä»¬è¿›è¡ŒHexoå»ºç«™æ‰€éœ€çš„å·¥å…·å®‰è£…å’Œæ³¨å†ŒGitHubè´¦æˆ·ç­‰å¯èƒ½ä¼šèŠ±è´¹è¾ƒå¤šæ—¶é—´çš„å‡†å¤‡å·¥ä½œã€‚" class="headerlink" title="è¿™ç¯‡æ•™ç¨‹çš„ç›®çš„æ˜¯æå‰å¸®åŠ©åŒå­¦ä»¬è¿›è¡ŒHexoå»ºç«™æ‰€éœ€çš„å·¥å…·å®‰è£…å’Œæ³¨å†ŒGitHubè´¦æˆ·ç­‰å¯èƒ½ä¼šèŠ±è´¹è¾ƒå¤šæ—¶é—´çš„å‡†å¤‡å·¥ä½œã€‚"></a>è¿™ç¯‡æ•™ç¨‹çš„ç›®çš„æ˜¯æå‰å¸®åŠ©åŒå­¦ä»¬è¿›è¡ŒHexoå»ºç«™æ‰€éœ€çš„å·¥å…·å®‰è£…å’Œæ³¨å†ŒGitHubè´¦æˆ·ç­‰å¯èƒ½ä¼šèŠ±è´¹è¾ƒå¤šæ—¶é—´çš„å‡†å¤‡å·¥ä½œã€‚</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p> å¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åœ¨å“ˆå·¥ç¨‹ITåä¼šç¾¤ä¸­ç›´æ¥è¯¢é—®ï¼Œæˆ‘ä¼šéšæ—¶åœ¨çº¿ä¸ºå¤§å®¶è§£ç­”ã€‚å¯¹äºæƒ³è¦è´¯å½»ITç²¾ç¥çš„äººï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œåœ¨ç™¾åº¦ä¸Šæœç´¢è§£å†³æ–¹æ¡ˆğŸ˜Šã€‚</p><span id="more"></span><hr><h2 id="è®¿é—®githubå®˜ç½‘ï¼Œæ³¨å†Œè´¦å·"><a href="#è®¿é—®githubå®˜ç½‘ï¼Œæ³¨å†Œè´¦å·" class="headerlink" title="è®¿é—®githubå®˜ç½‘ï¼Œæ³¨å†Œè´¦å·"></a>è®¿é—®githubå®˜ç½‘ï¼Œæ³¨å†Œè´¦å·</h2><p><strong>githubå®˜ç½‘ï¼š</strong><a href="https://github.com/">https://github.com/</a></p><p>å¦‚æœé‡åˆ°githubç™»ä¸ä¸Šçš„æƒ…å†µï¼Œå¯ä»¥ç™¾åº¦â€œgithubâ€+â€œå¦‚ä½•è®¿é—®â€ç­‰å…³é”®è¯ï¼Œæˆ–è‡ªå¤‡ç§‘å­¦ä¸Šç½‘å·¥å…·</p><hr><h2 id="å®‰è£…node-js"><a href="#å®‰è£…node-js" class="headerlink" title="å®‰è£…node.js"></a>å®‰è£…node.js</h2><p><strong>ä¸‹è½½åœ°å€:</strong><br><a href="https://nodejs.org/dist/latest-v16.x/">Index of /dist/latest-v16.x/ (nodejs.org)</a></p><p>å¦‚å›¾ç‚¹å‡»ä¸‹è½½winå¹³å°X64ç‰ˆæœ¬çš„msiå®‰è£…åŒ…</p><p><img src="/2024/03/13/gerenbokedajianjiaocheng/11.png" alt="å›¾ç‰‡"></p><p>ç›´æ¥è¿è¡Œä¸‹è½½å¾—åˆ°çš„çš„msiå®‰è£…åŒ…ï¼Œå®‰è£…è·¯å¾„å»ºè®®ç»Ÿä¸€ä¸ºä¿®æ”¹ä¸ºD:/nodejsï¼Œå…¶ä»–å®‰è£…é€‰é¡¹ä¸éœ€è¦æ”¹åŠ¨ï¼Œä¸€ç›´nextå³å¯</p><p><img src="/2024/03/13/gerenbokedajianjiaocheng/3.png" alt="å›¾ç‰‡"></p><hr><h2 id="node-jsç¯å¢ƒå˜é‡è®¾ç½®"><a href="#node-jsç¯å¢ƒå˜é‡è®¾ç½®" class="headerlink" title="node.jsç¯å¢ƒå˜é‡è®¾ç½®"></a>node.jsç¯å¢ƒå˜é‡è®¾ç½®</h2><p><strong>1.<strong>åœ¨D:\nodejsæ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸¤ä¸ªç©ºæ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«å‘½åä¸º <strong>ã€node_globalã€‘</strong>ï¼Œ</strong>ã€node_cacheã€‘</strong></p><p><img src="/2024/03/13/gerenbokedajianjiaocheng/10.png" alt="å›¾ç‰‡"></p><p>**2.**ä½¿ç”¨win+Ré”®æ‰“å¼€â€œè¿è¡Œâ€çª—å£ï¼Œè¾“å…¥cmdå¹¶å›è½¦æ‰“å¼€å‘½ä»¤è¡Œç»ˆç«¯ <strong>ï¼ˆè¯·è®°ä½è¿™ä¸ªæ“ä½œï¼Œä¹‹åä¼šç»å¸¸æ‰“å¼€è¿™ä¸ªç•Œé¢ï¼‰</strong>ï¼Œåˆ†åˆ«å¤åˆ¶ä»¥ä¸‹ä¸¤æ¡å‘½ä»¤å¹¶å›è½¦æ‰§è¡Œï¼š</p><pre class="line-numbers language-none"><code class="language-none">npm config set prefix "D:\nodejs\node_global"npm config set cache "D:\nodejs\node_cache"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2024/03/13/gerenbokedajianjiaocheng/13.png" alt="å›¾ç‰‡"></p><p>**3.**è®¾ç½®æ·˜å®é•œåƒ</p><pre class="line-numbers language-none"><code class="language-none">npm config set registry https://registry.npmmirror.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>**4.**æ£€æŸ¥æ˜¯å¦æˆåŠŸé…ç½®</p><pre class="line-numbers language-none"><code class="language-none">npm config list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2024/03/13/gerenbokedajianjiaocheng/14.png" alt="å›¾ç‰‡"></p><p><strong>5.<strong>â€œæˆ‘çš„ç”µè„‘â€-å³é”®-â€œå±æ€§â€-â€œé«˜çº§ç³»ç»Ÿè®¾ç½®â€-â€œé«˜çº§â€-â€œç¯å¢ƒå˜é‡â€ï¼Œç‚¹å‡»</strong>ã€ç³»ç»Ÿå˜é‡ã€‘</strong>ä¸‹çš„<strong>ã€æ–°å»ºã€‘</strong></p><p>å˜é‡åè¾“å…¥<strong>ã€NODE_PATHã€‘</strong></p><p>å˜é‡å€¼è¾“å…¥<strong>ã€D:\nodejs\node_global\node_modulesã€‘</strong></p><p><img src="/2024/03/13/gerenbokedajianjiaocheng/2.png" alt="å›¾ç‰‡"></p><p><strong>6.<strong>é€‰ä¸­</strong>ã€ç³»ç»Ÿå˜é‡ã€‘</strong>ä¸‹çš„<strong>ã€Pathã€‘</strong>ï¼Œç‚¹å‡»<strong>ã€ç¼–è¾‘ã€‘</strong> ï¼Œç„¶åæ–°å»ºä¸‰ä¸ªå˜é‡</p><pre class="line-numbers language-none"><code class="language-none">%NODE_PATH%%NODE_PATH%\node_cache%NODE_PATH%\node_global<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/2024/03/13/gerenbokedajianjiaocheng/4.png" alt="å›¾ç‰‡"></p><p>æœ€åç¡®å®šå³å¯ï¼Œå¦‚è‹¥é”™è¯¯ç‚¹å‡»å–æ¶ˆï¼Œè¯·é‡æ–°æ‰§è¡Œä»¥ä¸Šæ­¥éª¤</p><hr><h3 id="æ£€æŸ¥node-jsæ˜¯å¦å®‰è£…æˆåŠŸ"><a href="#æ£€æŸ¥node-jsæ˜¯å¦å®‰è£…æˆåŠŸ" class="headerlink" title="æ£€æŸ¥node.jsæ˜¯å¦å®‰è£…æˆåŠŸ"></a>æ£€æŸ¥node.jsæ˜¯å¦å®‰è£…æˆåŠŸ</h3><p>æ‰“å¼€å‘½ä»¤è¡Œç»ˆç«¯ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤å¹¶å›è½¦æ‰§è¡Œï¼š</p><pre class="line-numbers language-none"><code class="language-none">node -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2024/03/13/gerenbokedajianjiaocheng/5.png" alt="å›¾ç‰‡"></p><p>å¦‚å›¾å‡ºç°ç‰ˆæœ¬å·å°±ç®—æˆåŠŸå®‰è£…ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰ä»»ä½•ä¿¡æ¯å‡ºç°ï¼Œå¯ä»¥ç™¾åº¦â€node.jsâ€œå’Œâ€ç¯å¢ƒé…ç½®â€œå…³é”®è¯å¯»æ‰¾è§£å†³åŠæ³•</p><hr><h2 id="å®‰è£…git"><a href="#å®‰è£…git" class="headerlink" title="å®‰è£…git"></a>å®‰è£…git</h2><p>å®˜ç½‘ç›´æ¥ä¸‹è½½setupå®‰è£…åŒ…ï¼Œè¿è¡Œå®‰è£…</p><p><strong>git for winç½‘å€ï¼š</strong><br><a href="https://git-scm.com/download/win">Git - Downloading Package </a></p><p><img src="/2024/03/13/gerenbokedajianjiaocheng/7.png" alt="å›¾ç‰‡"></p><p>å®‰è£…è¿‡ç¨‹åªéœ€è¦æ”¹åŠ¨å¦‚å›¾çš„ä¸€ä¸ªé…ç½®é€‰é¡¹ï¼Œå…¶ä½™é»˜è®¤</p><p><img src="/2024/03/13/gerenbokedajianjiaocheng/8.png" alt="å›¾ç‰‡"></p><p>å®‰è£…å®ŒæˆååŒæ ·æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ï¼š</p><pre class="line-numbers language-none"><code class="language-none">git -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‡ºç°ç‰ˆæœ¬å·ä¿¡æ¯å³ä»£è¡¨æˆåŠŸ</p><p><img src="/2024/03/13/gerenbokedajianjiaocheng/6.png" alt="å›¾ç‰‡"></p><hr><h2 id="å®‰è£…æ–‡æœ¬ç¼–è¾‘å·¥å…·"><a href="#å®‰è£…æ–‡æœ¬ç¼–è¾‘å·¥å…·" class="headerlink" title="å®‰è£…æ–‡æœ¬ç¼–è¾‘å·¥å…·"></a>å®‰è£…æ–‡æœ¬ç¼–è¾‘å·¥å…·</h2><p><strong>é€‰æ‹©1ï¼š</strong><br>visual studio codeï¼š</p><p><strong>vscodeå®˜ç½‘ï¼š</strong><br><a href="https://code.visualstudio.com/">https://code.visualstudio.com/</a></p><p><strong>é€‰æ‹©2ï¼š</strong><br>subliemï¼šå¯¹äºæ²¡æœ‰ç¼–ç¨‹éœ€æ±‚çš„åŒå­¦å¯ä»¥å®‰è£…æ­¤è½»é‡çº§çš„æ–‡æœ¬ç¼–è¾‘å·¥å…·ï¼š</p><p><strong>subliemå®˜ç½‘ï¼š</strong><br><a href="https://www.sublimetext.com/index2">https://www.sublimetext.com/index2</a></p><p><img src="/2024/03/13/gerenbokedajianjiaocheng/9.png" alt="å›¾ç‰‡"></p><hr><h2 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h2><p>è‡³æ­¤å…¨éƒ¨å‰ç½®å®‰è£…å·¥ä½œå®Œæˆï¼Œåç»­è¿˜å°†æœ‰hexoé…ç½®ï¼Œå»ºç«™ï¼Œgithubç­‰éƒ¨ç½²å·¥ä½œæˆ‘å°†ä¼šåœ¨3/12å‘¨æ—¥ä¸‹åˆä¸¤ç‚¹äºè…¾è®¯ä¼šè®®æ¼”ç¤ºæ•™å­¦ï¼Œæ•¬è¯·æœŸå¾…</p><p>å¦‚æœæœ‰åŠ¨æ‰‹èƒ½åŠ›å¼ºçš„åŒå­¦æƒ³è¦å…ˆè¡Œå°è¯•ï¼Œå¯ä»¥å‰å¾€hexoå®˜ç½‘é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œå­¦ä¹ å»ºç«™ä¸éƒ¨ç½²</p><p><strong>hexoå®˜æ–¹ç½‘å€ï¼š</strong><br><a href="htps://hexo.io/zh-cn/">https://hexo.io/zh-cn/</a></p><hr>]]></content>
      
      
      
        <tags>
            
            <tag> æ•™ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çŸ­æ–‡-çŒ«</title>
      <link href="/2024/02/15/meow/"/>
      <url>/2024/02/15/meow/</url>
      
        <content type="html"><![CDATA[<h1 id="çŒ«"><a href="#çŒ«" class="headerlink" title="çŒ«"></a>çŒ«</h1><span id="more"></span><p>é»„æ˜æ˜¯æˆ‘ä¸€å¤©ä¸­è§†åŠ›æœ€å·®çš„æ—¶å€™ï¼Œè¡—ä¸Šç†™ç†™æ”˜æ”˜çš„äººç¾¤æˆ‘çœ‹ä¸æ¸…é¢å­”ã€‚å½“ç„¶ï¼Œæˆ‘å¹¶ä¸æœŸæœ›åœ¨è¿™åº§æ²¡æœ‰ä½ çš„åŸå¸‚èƒ½å¦‚æ­¤è½»æ˜“å¯»å¾—ä½ çš„èº«å½±ã€‚æ”¶å›äº†çœ‹å‘è¡—é“çš„è§†çº¿ï¼Œä¸€å£é¥®å°½æ‰‹ä¸­çš„å’–å•¡ï¼Œæˆ‘æ»¡å¿ƒæ€…ç„¶åœ°èµ·èº«ç¦»å¼€å’–å•¡é¦†ï¼Œå¼€å§‹äº†ä»Šæ—¥çš„å¾˜å¾Šã€‚</p><p>æ— éæ˜¯ä¸€æ¬¡å¶é‡ã€‚æ”¾å­¦åè·¯è¿‡æŸå¤„åƒ»é™å°å··æ—¶ï¼Œä¸€å£°å˜¤å’›ç¨šå«©çš„çŒ«å«å¸å¼•äº†æˆ‘çš„æ³¨æ„ã€‚æˆ‘å‘å£°éŸ³å¯»å»ï¼Œä¾¿çœ‹åˆ°äº†å®ƒã€‚</p><p>æ©˜é»„çš„æ¯›å‘ï¼Œçªç€æ¹¿æ¼‰æ¼‰çš„çœ¼ç›ï¼Œè¹¦è·³ç€æ— æ¯”å¥½å¥‡åœ°æ‰“é‡ç€å‘¨å›´çš„ç¯å¢ƒã€‚è½»è½»æ‹›æ‰‹å®ƒä¾¿å‘æˆ‘èµ°æ¥ï¼Œæ— ç–‘æ˜¯ä¸€åªåˆšè§ä¸–é¢çš„å¹¼çŒ«ã€‚</p><p>é€‰æ‹©çŒ«æˆ–è®¸æ˜¯å› ä¸ºæˆ‘çš„æ‡¦å¼±ï¼Œåˆæˆ–è®¸æ˜¯è¿™ç§å¯çˆ±çš„ç”Ÿç‰©å¤©ç”Ÿå¸å¼•ç€æˆ‘ï¼Œæˆ‘ä¸çŸ¥é“ã€‚åªæ˜¯å½“æˆ‘çš„æ‰‹è½»è½»åˆ’è¿‡å®ƒæŸ”é¡ºçš„æ¯›çš®æ—¶ï¼Œå®ƒç«Ÿæ²¡æœ‰å¤ªå¤šçš„åæŠ—ï¼Œè¿™ä¸åƒæ˜¯ä¸€åªé‡çŒ«çš„ååº”ã€‚</p><p>ç„¶è€Œæˆ‘å·²ç»æ— æ³•åœæ­¢ã€‚å¬å®Œäº†æœ€åä¸€å£°é¸£å‘œï¼Œæˆ‘æ§èµ·å®ƒä¼¼ä¹å˜å¾—æ›´è½»çš„èº«ä½“ï¼Œå‘å››å‘¨å¯»æ‰¾å®ƒçš„å®‰èº«æ‰€ã€‚</p><p>æ­£æ˜¯åœ¨è¿™æ—¶ï¼Œäº‹æƒ…å‘ç”Ÿäº†ã€‚</p><p>ä½ é™é™çš„ç«™åœ¨æˆ‘åé¢çš„ä¸€å¤„é˜´å½±ã€‚çœ‹ç€ä½ æ‰‹ä¸­æ”¥ç´§çš„çŒ«ç»³ï¼Œæˆ‘ç«‹å³æ˜ç™½äº†ã€‚æˆ‘åååååœ°å¼€å§‹å‘ä½ è§£é‡Šâ€¦â€¦ä½ å´å¹¶ä¸è¨€è¯­ã€‚å¯¹ä¸Šä½ é‚£åŒä¸€å¦‚å¹¼çŒ«èˆ¬æ¹¿æ¼‰æ¼‰çš„çœ¼ç›ï¼Œæˆ‘å€æ„Ÿéº»çƒ¦ã€‚ä½†ç»ˆäºä½ å¼€å£äº†ï¼Œå¹¶éè´¨é—®ä¹ŸéæŒ‡è´£ã€‚æˆ‘è¯§å¼‚äºä½ å£ä¸­åéœ²çš„è¯è¯­ï¼ŒåŠå“æ— æ³•è¨€è¯­ã€‚ä½ è¯´å¸Œæœ›ä»Šåæˆ‘æ¥åšä½ çš„çŒ«ã€‚</p><p>è¿™åªæ˜¯ä¸€åœºç©é—¹çš„æ¸¸æˆå§â€¦â€¦ä½†å½“æˆ‘åœ¨å­¦æ ¡é‡Œè¿œè¿œåœ°çœ‹åˆ°ä½ çš„èº«å½±å‘æˆ‘æ‹›æ‰‹ï¼Œæˆ‘æ‰é€æ¸å¼€å§‹æ„Ÿè§‰åˆ°å¤´ç–¼ã€‚å‡è£…æ²¡æœ‰å‘ç°ä½ ï¼Œæˆ‘å¿«æ­¥èµ°å›è‡ªå·±çš„ç­çº§ã€‚ä½ å¹¶ä¸ç½¢ä¼‘ã€‚å¾ˆå¿«ä½ å°±ç«™åœ¨æ˜¾çœ¼çš„æ•™å®¤é—¨å£ï¼Œè½»è½»å‘æˆ‘æ‹›æ‰‹ï¼Œæˆ‘ä¾¿åªèƒ½å‘ä½ èµ°å»ã€‚ç¬¬ä¸€æ¬¡æ—¶ï¼Œä½ è®©æˆ‘æ”¾å­¦åç•™åœ¨ç­é‡Œç­‰ä½ è¿‡æ¥ã€‚è¢«é—®åˆ°è¦åšä»€ä¹ˆï¼Œä½ ä¹Ÿåªæ˜¯ç‹¡é» ä¸€ç¬‘å¹¶ä¸å›åº”ã€‚</p><p>æ”¾å­¦ååŒå­¦ä»¬æ¸æ¸ç¦»å¼€æ•™å®¤ï¼Œç‹¬å‰©æˆ‘ä¸€äººè¿˜ååœ¨ä½å­ä¸Šã€‚æ˜¯äº†ï¼Œä»»ä½•å¹³æ—¥é‡Œäººæµä¼—å¤šçš„åœºæ‰€ä¸€æ—¦å˜å¾—ç©ºæ—·æ— äººï¼Œææ€–æ„Ÿè‡ªç„¶è€Œç„¶æµ®ç°ï¼Œä½†è¿™åˆæ˜¯ä¸ºä½•å‘¢ã€‚æˆ‘çš„æ€ç»ªåœ¨å¯‚é™ä¸­é€æ¸èµ·èˆã€‚</p><p>ç¯å¿½ç„¶ç­äº†ï¼Œä¸€åŒæ‰‹çŒ›åœ°æŠšä¸Šæˆ‘çš„è„–é¢ˆã€‚</p><p>â€œæ˜¯ä½ å—ï¼Ÿâ€æˆ‘æ— æ³•è½¬å¤´ï¼Œåªå¥½è½»å£°å‘é—®ï¼Œå£°éŸ³æ²‰å…¥é»‘å¯‚ä¸­çš„æ•™å®¤ã€‚</p><p>å¸¦ç€ä½ ä½“æ¸©çš„æ‰‹æŒ‡å¼€å§‹æ‘©æŒ²æˆ‘çš„çš®è‚¤ï¼Œè½»æŸ”ç¯ç»•ç€æˆ‘çš„è„–é¢ˆï¼Œåœ¨èº«ä½“è‡ªç„¶æ³›èµ·ç²Ÿæ —ä¹‹å‰ï¼Œæˆ‘ç«Ÿå…ˆæ„Ÿåˆ°ä¸€é˜µå®½æ…°ã€‚è¿™å¯æ˜¯å¯¹çŒ«çš„çˆ±æŠšï¼Ÿä½ çš„æ‰‹æŒ‡æœ€ç»ˆé”å®šäº†æˆ‘çš„å–‰ç®¡ï¼Œå¼€å§‹ç¦é”¢æˆ‘çš„å‘¼å¸ã€‚è¿™æ ·æ‚„æ— å£°æ¯åœ°æ¥è¿‘æˆ‘ï¼Œåˆ°åº•è°æ‰æ˜¯çŒ«å‘¢ã€‚å¿½ç•¥è„–å­ä¸Šé€æ¸åŠ é‡åŠ›æ°”çš„æŒ‡å°–ï¼Œæˆ‘çš„å¿ƒç¥æ…¢æ…¢è½¬ç§»ä½ æ‰‹ä¸Šè‚Œè‚¤çš„æ¸©æ¶¦ã€‚åœ¨å—æ–¹è¿™æ ·æ²‰é—·çš„æ—¶èŠ‚ï¼Œç•¥å¾®æ•æ„Ÿçš„è„–é¢ˆè¢«ä½ æ‚åœ¨æ‰‹ä¸­ï¼Œè®©æˆ‘å¼€å§‹æ„Ÿåˆ°éš¾è€çš„ç‡¥çƒ­ã€‚</p><p>å¹¶ä¸éœ€è¦æŒ£æ‰ï¼Œçº¢å¤–æ‘„åƒå¤´ä¸‹ä½ æ²¡æœ‰è¿›è¡Œåˆ°æœ€åçš„å¯èƒ½ã€‚åªæ˜¯åƒè¿™æ ·å®‰é™åœ°æ¥å—ä½ çš„æƒ©ç½šï¼Œè®©æˆ‘è§‰å¾—è‡ªå·±åƒæ˜¯é¢å¯¹ç¥æ˜å¿æ‚”çš„ä¿¡å¾’ï¼Œè€Œä¸”å¤ªè¿‡äºè™”è¯šäº†ç‚¹å§ã€‚æ—¶é—´ä¸€ç‚¹ç‚¹æµé€ï¼Œæˆ‘é€æ¸ä½ä¸‹å¤´ï¼Œä¸€å¦‚å©æ‹œï¼Œä¸€å¦‚æ•¬ä»°ã€‚</p><p>ç»ˆäºæ¾å¼€äº†æ‰‹ï¼Œæˆ‘å¤±åŠ›åœ°å€’åœ¨è¯¾æ¡Œä¸Šï¼Œèº«ä½“çš„æœ¬èƒ½è®©æˆ‘å¤§å£å–˜æ¯ç€ã€‚ä½ ä¹Ÿä½“ä¼šåˆ°æ‰¼ä½ç”Ÿå‘½çš„å¿«æ„äº†å—ã€‚æ‰­å¤´çœ‹å‘ä½ ï¼Œé»‘æš—æ¨¡ç³Šäº†ä½ çš„è¡¨æƒ…ï¼Œå”¯æœ‰çœ¼ç›ä¾æ—§å¸¦ç€æ¹¿æ¼‰æ¼‰çš„æ°´è‰²ï¼Œåœ¨æ˜æš—ä¸­æ˜ å‡ºä¸€ç‚¹éš¾å¾—çš„æœˆå…‰ã€‚</p><p>â€œè¦â€¦â€¦è¦æˆ‘é€ä½ å›å®¿èˆå—â€ ç¨å¾®æ­‡æ¯è¿‡åï¼Œæˆ‘æ…¢æ…¢å‘ä½ å¼€å£ã€‚ä½ ç­”åº”çš„ååˆ†å¹²è„†ã€‚æˆ‘çŒœæµ‹ä½ çš„å¿ƒæƒ…å¾ˆä¸é”™ï¼Œæˆ‘æƒ³ï¼Œæˆ‘ä¹Ÿæ˜¯ã€‚</p><p>ä½ å¶å°”å«æˆ‘é™ªä½ ä¸€èµ·é—²èŠï¼Œæˆ–æ˜¯åœ¨é¥­å ‚é‡Œä¸€åŒè¿›é¤ã€‚å¼€å¿ƒæ—¶ä½ ä¼šå‘å‡ºéšç§˜è€Œæ¸…è„†çš„ç¬‘å£°ï¼Œè¢«æ‰“è¶£æ—¶ä¹Ÿä¼šä½¯è£…å—”æ€’ï¼Œåœ¨æ—äººçš„ç›®å…‰é‡Œæˆ‘ä»¬çš„ç›¸å¤„å†æ­£å¸¸ä¸è¿‡ã€‚éšç€åœ¨ä¸€èµ·çš„æ—¶é—´å¢é•¿ï¼Œæˆ‘æ³¨æ„åˆ°ä½ çš„æœ‹å‹æå°‘ã€‚æ¯•ç«Ÿä½ å¾ˆå¥‡æ€ªï¼Œå¥½å§ï¼Œæˆ‘ä¹Ÿä¸€æ ·ï¼Œè¿™ä¼¼ä¹åˆæ²¡ä»€ä¹ˆå¯å¥‡æ€ªçš„ã€‚</p><p>å¹³å¿ƒè€Œè®ºï¼Œä½ å®åœ¨æ˜¯ä¸€ä¸ªå¯çˆ±çš„äººï¼Œå› æ­¤é€‰æ‹©è¿™æ ·è·Ÿä½ ç›¸å¤„æˆ–è®¸å·²å¹¶éæ˜¯æˆ‘çš„è‰¯å¿ƒå¿æ‚”ã€‚æˆ–è®¸æˆ‘åªæ˜¯è¢«ä½ æ¹¿æ¶¦çš„çœ¼ç›æ‰€å¸å¼•ï¼Œæˆ–è®¸åªæ˜¯ä½ éœ€è¦ä¸€åªçŒ«ï¼Œæ€»è€Œè¨€ä¹‹æˆ‘å†ä¸æƒ³ç¦»å¼€ä½ ã€‚å†è¿›ä¸€æ­¥ï¼Œå¦‚æœèƒ½å½»åº•çª’æ¯åœ¨ä½ çš„åŒæ‰‹é‡Œï¼Œæˆ‘æƒ³ï¼Œè¿™æ‰æ˜¯æˆ‘æœ€å¤§çš„æ„¿æœ›ã€‚æˆ‘ç«Ÿå·²å¦‚æ­¤æˆä¸ºä¸€åªçŒ«äº†å—ã€‚å“å‘€ï¼ŒçœŸæ˜¯è®©æˆ‘æ„Ÿåˆ°å®³ç¾ã€‚</p><p>æˆ‘çº¦å¥½ä¸ä½ åœ¨æ ¡è¿ä¼šçš„å‡Œæ™¨ç¿»å‡ºå›´å¢™ï¼Œå»å¾€æ ¡åçš„å±±é¡¶æ¶ˆç£¨æ—¶å…‰ã€‚é‚£å¤©çš„æˆ‘ä»¬æ¯«æ— è®¡åˆ’ï¼Œå°½ç®¡è¿‡é«˜çš„å›´æ ä¸åç¦»å¤§é“çš„å±±è·¯ä½¿æˆ‘ä»¬çœ‹èµ·æ¥è¿‡äºç‹¼ç‹ˆäº†ï¼Œä½†æ˜¯å½“åŒå­¦ä»¬å–§å“—åµé—¹çš„å£°éŸ³é€æ¸è¢«æŠ›åˆ°è„‘åï¼Œä¸€å¤„å¹³æ•´è€Œå……æ»¡ç»¿æ„çš„è‰åœ°å‡ºç°åœ¨çœ¼å‰æ—¶ï¼Œä½ ä¸æˆ‘éƒ½çŸ¥é“è¿™å°±æ˜¯ä»Šå¤©çš„ç›®çš„åœ°ï¼Œä¸¤äººçš„éšç§˜ä¹‹æ‰€ã€‚</p><p>å¹»æƒ³æŠŠæˆ‘æ¨å‘äº†æ€ç»ªçš„äº‘ç«¯ã€‚åœ¨è¿œç¦»å°˜ä¸–çš„ç§˜å¢ƒä¸­ï¼Œæˆ‘ä»¬åŒçœ‹æ—¥å‡ºã€çœ‹æœˆåã€çœ‹è‹èŒ«çš„äº‘æµ·ï¼›æˆ‘ä»¬åŒå¬é¸Ÿè¯­ã€å¬è™«é¸£ã€å¬æ™šé£çš„å‘¼å•¸ã€‚æˆ‘ä»¬å¦‚ç—´å¦‚é†‰ï¼Œå€’åœ¨äº†åŒä¸€é¢—æ ‘ä¸‹ï¼Œåˆç›¸è§†è€Œç¬‘ï¼Œåœ¨ä¸‡èŠ±ä¸›ä¸­å…¥çœ ã€‚</p><p>ä½†äº‹æƒ…åˆåœ¨è¿™æ—¶å€™å‘ç”Ÿäº†ã€‚</p><p>ä½ çš„çœ¼çœ¸çªç„¶çå¼€ï¼Œé‚£åŒç³å­”æˆ–è®¸æ˜¯ç¦»æˆ‘æœ€è¿‘çš„æ˜Ÿã€‚è¢«è¿™æ ·æ½®æ¹¿çš„çœ¼ç›ç›¯ä½ï¼Œè°ä¸ä¼šå¤±å»æ°”åŠ›å‘¢ï¼Ÿæˆ‘æ¾æ‡ˆäº†ï¼Œä½ ä¹ŸæŒ£è„±äº†æ†ä½è„–é¢ˆçš„æ‰‹ï¼ŒæŒ£è„±äº†æˆ‘ã€‚ä»æ­¤å†ä¸æ„¿æ‰­å¤´çœ‹æˆ‘ä¸€çœ¼ã€‚</p><p>ä½ ä¸æˆ‘å†³è£‚ä¸€åœºï¼ŒæŒç»­åˆ°é«˜è€ƒç»“æŸå„èµ°å¤©æ¶¯ä¹Ÿå†æ— è”ç³»ã€‚å¦‚ä»Šé£˜è¡åœ¨è¿™é™Œç”ŸåŸå¸‚çš„è‚‰ä½“æˆ–è®¸æ—©å·²ç»ç¼ºå¤±äº†çµé­‚ã€‚æ˜¯é‚£äº›æ—¥å­çš„è®°å¿†å¤ªè¿‡é²œæ˜ï¼Œè¿˜æ˜¯ä¸ƒå¹´çš„æ—¶é—´å¤ªçŸ­ï¼Œæˆ‘ä»æ²‰æººäºä½ çš„ä¸€åˆ‡ã€‚æœ¬åº”è½®åˆ°äº†ä½ çš„å›åˆï¼Œä½ æ€èƒ½æ”¾å¼ƒï¼Œè¿™å¯¹æˆ‘å¤ªä¸å…¬å¹³ã€‚</p><p>æ‹–æ›³ç€æˆ‘æœ¬åº”äº¤ä»˜ä¸ä½ çš„ç”Ÿå‘½ï¼Œæˆ‘å¼€å§‹å¾˜å¾Šã€‚è¿™ä¸ä¸ºçŒ«ï¼Œä¸ä¸ºè‡ªç”±ï¼Œä¸ä¸ºæ‡¦å¼±çš„å¿«æ„ã€‚æˆ‘æƒ³ï¼Œæˆ‘æ›´éœ€è¦çª’æ¯ï¼Œéœ€è¦ä½ çš„æ³¨è§†ï¼Œéœ€è¦ä½ æ‰‹ä¸­çš„çŒ«ç»³ã€‚</p><p>èµ°å‡ºå’–å•¡é¦†ï¼Œå…¥ç§‹åæ³›é»„çš„å¶ç‰‡å¼€å§‹å æ®è·¯é¢ã€‚æå¹²ä¸Šçš„å¶å­æ”¾å¼ƒäº†å¯¹ç”Ÿå‘½æœ€åçš„æ‰§å¿µï¼Œé‡é‡å ä¸‹ï¼Œåˆè¢«ç§‹é£è½»æŸ”åœ°å¹èµ·ã€‚å…¶ä¸­ä¸€ç‰‡å¶æ²¿ç€ä¼˜ç¾çš„è½¨è¿¹é£˜æ‘‡è€Œè½ï¼Œ</p><p>æ­£è½åœ¨ä½ çš„è‚©ä¸Šã€‚</p><hr><p>å‰å¹´11æœˆä¹‹å‰ä¸€æ¬¡å¶ç„¶çš„æ—¶æœºï¼Œæˆ‘å¼€å§‹ç¬¬ä¸€æ¬¡åˆ›ä½œè¿™ç¯‡çŸ­æ–‡ï¼Œæ„Ÿè°¢ä½ æä¾›çš„æƒ…ç»ªæ¥æºï¼Œæˆ‘ä¹Ÿæ‰èƒ½å¸¦ç€è¿™èˆ¬æ˜æ˜¾çš„æ€¨æ°”å†™å‡ºå¦‚æ­¤å„¿æˆçš„æ–‡ç« </p><p>æ˜çœ¼äººè‚¯å®šèƒ½çœ‹å‡ºå®ƒèåˆäº†è®¸å¤šä½œå“ï¼šä»ä½œå®¶ææ•–çš„ã€Šçº¢ç«ç‘°ã€‹ï¼Œåˆ°ç½‘æ–‡ã€Šå¯‚å¯‚ã€‹ï¼Œå†åˆ°ç”µå½±ã€Šå¤§è±¡å¸­åœ°è€Œåã€‹å’Œæˆå‰§ã€Šæ‹çˆ±çš„çŠ€ç‰›ã€‹ã€‚å®ƒä»¬å¯¹æˆ‘ç•™ä¸‹äº†å¾ˆæ·±åˆ»çš„å°è±¡ï¼Œå› æ­¤æˆ‘ä¸è¦è„¸åœ°å°†å®ƒä»¬ç»Ÿç»Ÿæ‰è¿›äº†åŒä¸€ç¯‡æ–‡å­—ä¸­</p><p>åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™äº›ä½œå“çš„å…±é€šä¹‹å¤„æ˜¯å¯¹æ—¥å¸¸ç”Ÿæ´»çš„é˜´éƒæ‚²è§‚çš„æ°›å›´æ¸²æŸ“ï¼Œä½†æˆ‘åœ¨é˜…è¯»æˆ–è§‚çœ‹çš„è¿‡ç¨‹ä¸­æ›´å¤šæ„Ÿå—åˆ°çš„æ˜¯å®½æ…°ï¼Œé‡Šç„¶å’Œè§£æ”¾ï¼Œåè€Œèƒ½å¤Ÿç»§ç»­å¯¹ç”Ÿæ´»è¿›å‘äº†ï¼ŒåŸå› ä¸ºä½•æˆ‘ä¹Ÿä¸æ‰“ç®—æ·±å…¥æ€è€ƒäº†ã€‚ç°å¦‚ä»Šä¹Ÿæ­£æ˜¯æ­¥å…¥å·¥ä½œå‰åšå‡†å¤‡çš„æœ€åæ—¶æœºï¼Œå˜å¾—å¿™ç¢Œçš„æ—¥å¸¸ä¸ä¼šè®©æˆ‘æœ‰æ—¶é—´å†å›å¤´æ…¢æ…¢ä¿®æ”¹è¿™ç¯‡æ–‡ï¼Œä»¥åŠè¿™ç¯‡æ–‡ç›¸å…³çš„äººå’Œäº‹</p>]]></content>
      
      
      
        <tags>
            
            <tag> çºªå® </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
