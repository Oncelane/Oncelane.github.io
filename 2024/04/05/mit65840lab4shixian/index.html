<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">




<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

  <meta name="author" content="Xiur">


  <meta name="subtitle" content="闲来记事">


  <meta name="description" content="已巷的个人小站">



<title>MIT6.5840 Lab4 Get无日志实现 | Oncelane</title>



<link rel="icon" href="/favicon.png">



<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/nprogress/nprogress.css">



<script src="/lib/jquery.min.js"></script>


<script src="/lib/iconify-icon.min.js"></script>


<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
  };
</script>


<script src="/lib/nprogress/nprogress.js"></script>

<script>
  $(document).ready(() => {
    NProgress.configure({
      showSpinner: false,
    });
    NProgress.start();
    $("#nprogress .bar").css({
      background: "#de7441",
    });
    $("#nprogress .peg").css({
      "box-shadow": "0 0 2px #de7441, 0 0 4px #de7441",
    });
    $("#nprogress .spinner-icon").css({
      "border-top-color": "#de7441",
      "border-left-color": "#de7441",
    });
    setTimeout(function () {
      NProgress.done();
      $(".fade").removeClass("out");
    }, 800);
  });
</script>

<script>
  (function () {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const setting = localStorage.getItem("hexo-color-scheme") || "auto";
    if (setting === "dark" || (prefersDark && setting !== "light"))
      document.documentElement.classList.toggle("dark", true);
    let isDark = document.documentElement.classList.contains("dark");
  })();

  $(document).ready(function () {
    // init icon
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = document.documentElement.classList.contains("dark");
    $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");

    function toggleGiscusTheme() {
      const isDark = document.documentElement.classList.contains("dark");
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          {
            giscus: {
              setConfig: {
                theme: isDark ? "dark" : "light",
              },
            },
          },
          "https://giscus.app"
        );
      }
    }


    // toggle dark mode
    function toggleDark() {
      let isDark = document.documentElement.classList.contains("dark");
      const setting = localStorage.getItem("hexo-color-scheme") || "auto";
      isDark = !isDark;
      document.documentElement.classList.toggle("dark", isDark);
      $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");
      if (prefersDark === isDark) {
        localStorage.setItem("hexo-color-scheme", "auto");
      } else {
        localStorage.setItem("hexo-color-scheme", isDark ? "dark" : "light");
      }
      toggleGiscusTheme();
    }
    $("#toggle-dark").click(toggleDark);

    // listen dark mode change
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        const setting = localStorage.getItem("hexo-color-scheme") || "auto";
        if (setting === "auto") {
          document.documentElement.classList.toggle("dark", e.matches);
          $("#theme-icon").attr(
            "icon",
            e.matches ? "ri:moon-line" : "ri:sun-line"
          );
          toggleGiscusTheme();
        }
      });
  });
</script>




<meta name="generator" content="Hexo 7.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body class="font-sans bg-white dark:bg-zinc-900 text-gray-700 dark:text-gray-200 relative">
  <header class="fixed w-full px-5 py-1 z-10 backdrop-blur-xl backdrop-saturate-150 border-b border-black/5">
  <div class="max-auto">
    <nav class="flex items-center text-base">
      <a href="/" class="group">
        <h2 class="font-medium tracking-tighterp text-l p-2">
          <img class="w-5 mr-2 inline-block transition-transform group-hover:rotate-[30deg]" id="logo" src="/images/logo.svg" alt="Oncelane" />
          Oncelane
        </h2>
      </a>
      <div id="header-title" class="opacity-0 md:ml-2 md:mt-[0.1rem] text-xs font-medium whitespace-nowrap overflow-hidden overflow-ellipsis">
        MIT6.5840 Lab4 Get无日志实现
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3">
        
          <a class="hidden sm:flex" href="/archives">Posts</a>
        
        
          
            <a class="w-5 h-5 hidden sm:flex" title="Github" target="_blank" rel="noopener" href="https://github.com/xbmlz">
              <iconify-icon width="20" icon="ri:github-line"></iconify-icon>
            </a>
          
        
        <a class="w-5 h-5 hidden sm:flex" title="Github" href="rss2.xml">
          <iconify-icon width="20" icon="ri:rss-line"></iconify-icon>
        </a>
        <a class="w-5 h-5" title="toggle theme" id="toggle-dark">
          <iconify-icon width="20" icon="" id="theme-icon"></iconify-icon>
        </a>
      </div>
      <div class="flex items-center justify-center gap-3 ml-3 sm:hidden">
        <span class="w-5 h-5" aria-hidden="true" role="img" id="open-menu">
          <iconify-icon width="20" icon="carbon:menu" ></iconify-icon>
        </span>
        <span class="w-5 h-5 hidden" aria-hidden="true" role="img" id="close-menu">
          <iconify-icon  width="20" icon="carbon:close" ></iconify-icon>
        </span>
      </div>
    </nav>
  </div>
</header>
<div id="menu-panel" class="h-0 overflow-hidden sm:hidden fixed left-0 right-0 top-12 bottom-0 z-10">
  <div id="menu-content" class="relative z-20 bg-white/80 px-6 sm:px-8 py-2 backdrop-blur-xl -translate-y-full transition-transform duration-300">
    <ul class="nav flex flex-col sm:flex-row text-sm font-medium">
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/archives" class="flex h-12 sm:h-auto items-center">Posts</a>
        </li>
      
    </ul>
  </div>
  <div class="mask bg-black/20 absolute inset-0"></div>
</div>

  <main class="pt-14">
    <!-- css -->

<link rel="stylesheet" href="/lib/fancybox/fancybox.min.css">


<link rel="stylesheet" href="/lib/tocbot/tocbot.min.css">

<!-- toc -->

  <!-- tocbot -->
<nav class="post-toc toc text-sm w-48 relative top-32 right-0 opacity-70 hidden lg:block" style="position: fixed !important;"></nav>


<section class="px-6 max-w-prose mx-auto md:px-0">
  <!-- header -->
  <header class="overflow-hidden pt-6 pb-6 md:pt-12">
    <div class="pt-4 md:pt-6">
      <h1 id="article-title" class="text-[2rem] font-bold leading-snug mb-4 md:mb-6 md:text-[2.6rem]">
        MIT6.5840 Lab4 Get无日志实现
      </h1>
      <div>
        <section class="flex items-center gap-3 text-sm">
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="carbon-calendar" ></iconify-icon>
            <time>2024-04-06</time>
          </span>
          <span class="text-gray-400">·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="ic:round-access-alarm" ></iconify-icon>
            <span>20 min</span>
          </span>
          <span class="text-gray-400">·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="icon-park-outline:font-search" ></iconify-icon>
            <span>4.4k words</span>
          </span>
          
        </section>
      </div>
    </div>
  </header>
  <!-- content -->
  <article class="post-content prose m-auto slide-enter-content dark:prose-invert">
    <h4 id="6-5840-Lab-4-Fault-tolerant-Key-Value-Service"><a href="#6-5840-Lab-4-Fault-tolerant-Key-Value-Service" class="headerlink" title="6.5840 Lab 4: Fault-tolerant Key/Value Service"></a>6.5840 Lab 4: Fault-tolerant Key/Value Service</h4><p>Introduction</p>
<blockquote>
<p>In this lab you will build a fault-tolerant key/value storage service using your Raft library from Lab 3. Your key/value service will be a replicated state machine, consisting of several key/value servers that each maintain a database of key/value pairs, as in Lab 2, but additionally use Raft for replication. Your key/value service should continue to process client requests as long as a majority of the servers are alive and can communicate, in spite of other failures or network partitions. After Lab 4, you will have implemented all parts (Clerk, Service, and Raft) shown in the diagram of Raft interactions.</p>
</blockquote>
<p>本次实验需要结合Lab2实现的简易KVserver和Lab3实现的Raft算法，最后实现一个具有容错功能的分布式KVServer集群！</p>
<p>相比于Lab3Raft算法的实现，本次实验的代码量更少，逻辑也相对简单，但是日志量会增长一个数量级，十分不好debug，再加上一些Lab3测试都无法测出来的raft层的bug，可以说完全是debug地狱了。</p>
<p>本次实验需要实现我们实现一个依赖于raft的处于上层的KVserver，它接受来自客户端的Get，Put，Append请求，在客户端看来，KVServer提供的服务是是线性一致性的，也叫强一致性的</p>
<p>这里有一篇明晰各种一致性概念的文章，全面详细易懂，<del>唯一不好的地方就是我事后写博客的时候才发现它😭</del></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022248118">https://segmentfault.com/a/1190000022248118</a></p>
</blockquote>
<p>如果将客户端的Get操作也写入日志，等待Get日志被Raft层提交后再响应客户端，本实验实现起来会简洁很多，实验指导也是这么建议的。</p>
<p>但是我选择不将get请求写入日志（人要有追求，<del>虽然事后debug起来真的后悔死了</del></p>
<p>论文中有提到如何实现这点</p>
<p>1.即leader响应Get请求前先发起一次 check quorum 环节，我通过复用心跳来实现</p>
<p>2.还有就是ReadIndex，记录收到Get请求那一刻的Raft层的CommitIndex值，等待应用层从raft层收到的log的index值等于ReadIndex值的时候，就可以返回此次Get请求了。</p>
<p>那么就可以开始写代码了：</p>
<h3 id="Part-A-Key-value-service-without-snapshots-moderate-hard"><a href="#Part-A-Key-value-service-without-snapshots-moderate-hard" class="headerlink" title="Part A: Key/value service without snapshots (moderate/hard)"></a>Part A: Key/value service without snapshots (moderate/hard)</h3><h4 id="结构体定义"><a href="#结构体定义" class="headerlink" title="结构体定义"></a>结构体定义</h4><p>日志结构体的定义</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Op <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ClientId <span class="token builtin">int64</span> <span class="token comment">//客户端标识，用于应对重复请求</span>
	Offset   <span class="token builtin">int32</span> <span class="token comment">//客户端的请求序列号</span>
	OpType   <span class="token builtin">int</span>   <span class="token comment">//请求/操作类型</span>
	Key      <span class="token builtin">string</span>
	Value    <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	getT <span class="token operator">=</span> <span class="token boolean">iota</span>
	putT
	appendT
	emptyT <span class="token comment">//indicate a empty log only use to update leader commitIndex</span>
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>emptyT是为了帮助leader更新commitIndex的值而使用的</p>
<p>KVServer成员变量：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> KVServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu      sync<span class="token punctuation">.</span>Mutex
	me      <span class="token builtin">int</span>
	rf      <span class="token operator">*</span>raft<span class="token punctuation">.</span>Raft
	applyCh <span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg
	dead    <span class="token builtin">int32</span> <span class="token comment">// set by Kill()</span>

	maxraftstate <span class="token builtin">int</span> <span class="token comment">// snapshot if log grows this big</span>

	persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>Persister

	lastAppliedIndex <span class="token builtin">int</span> <span class="token comment">//最近添加到状态机中的raft层的log的index</span>
	
	lastIncludeIndex <span class="token builtin">int</span> 	<span class="token comment">//lastInclude</span>
	
	kvMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//log state machine</span>

	<span class="token comment">//缓存的log, seq-&gt;index,reply</span>
	duplicateMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType

<span class="token punctuation">}</span>

<span class="token keyword">type</span> duplicateType <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Offset <span class="token builtin">int32</span>
	Reply  <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">StartKVServer</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">,</span> me <span class="token builtin">int</span><span class="token punctuation">,</span> persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>Persister<span class="token punctuation">,</span> maxraftstate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>KVServer <span class="token punctuation">{</span>
	<span class="token comment">// call labgob.Register on structures you want</span>
	<span class="token comment">// Go's RPC library to marshall/unmarshall.</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	kv <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>KVServer<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>me <span class="token operator">=</span> me
	kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">=</span> maxraftstate
	kv<span class="token punctuation">.</span>persister <span class="token operator">=</span> persister
	<span class="token comment">// You may need initialization code here.</span>

	kv<span class="token punctuation">.</span>applyCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>rf <span class="token operator">=</span> raft<span class="token punctuation">.</span><span class="token function">Make</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> me<span class="token punctuation">,</span> persister<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">)</span>

	<span class="token comment">// You may need initialization code here.</span>
	kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">=</span> <span class="token number">0</span>
	kv<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token comment">//state machine</span>
	kv<span class="token punctuation">.</span>kvMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token comment">//log</span>
	kv<span class="token punctuation">.</span>duplicateMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">)</span>

	kv<span class="token punctuation">.</span><span class="token function">readPersist</span><span class="token punctuation">(</span>persister<span class="token punctuation">.</span><span class="token function">ReadSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">HandleApplych</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// go kv.HandleSnapshot()</span>
	<span class="token comment">// go kv.handleGetTask()</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] restart"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
	<span class="token keyword">return</span> kv
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为什么需要emptyT？</p>
<p>回顾commitIndex更新的限制，leader至少在自己任期内达成一条日志的大多数共识，才能够更新自己的commitIndex，其他follower才能根据leader心跳的LeaderCommit更新自己的commitIndex</p>
<p>如果这段时间里客户端狂发Get请求（Get请求不写入日志）没一个客户端发Put和Append请求，那么leader的commmitIndex就完全卡住了，应用层永远收不到新的applylog</p>
<blockquote>
<p>那为啥lab3实验的各种变态测试就表现的好好的，现在又不行了捏？</p>
</blockquote>
<p>因为测试代码检查通过start（）提交日志，当它发现提交的这条log没有在大多数服务器上达到共识的时候，或者说达成共识的这个Index是不是它所提交的log的时候，它会进行5次重试，（当然了如果测试程序保证在网络已经恢复正常一段时间之后再提交日志，这时候测试程序检查到Index上不是它所提交的日志，那直接就Fail Test了）保证leader一直有log可以添加，leader可以在这五次重试时间内更新好自己的commitIndex，从而将应用层想要的</p>
<p>既然在Lab4没有测试程序帮我们做添加log这件事，我们就自己来，</p>
<p>在raft层多设置两个标志，IisBack如果为true：表明leader在当前任期内达成commitIndex的更新，并且将这条属于当前任期的日志通过applyCh发送给了server层</p>
<p>IisBackIndex辅助IisBack更新</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Raft <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">//Man,what can i say?</span>
	IisBack      <span class="token builtin">bool</span>
	IisBackIndex <span class="token builtin">int</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>leader每次刚刚当选的时候设置IisBack为false，更新commitIndex的时候设置IisBackIndex = commitIndex，当applyIndex大于等于IisBackIndex时，就可以设置IisBack为true了</p>
<p>leader每次响应读请求前需要检查Iisback是否为True，若为false，则需要通过start（）向raft层提交一个OpType = emptyT 的空日志，通知client过一会再来尝试，等待当前leader完成同步</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//判断自己有没有从重启中恢复完毕状态机</span>
<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span>IisBack <span class="token punctuation">{</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [recovering] reject a [Get]🔰 args[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span>
		OpType<span class="token punctuation">:</span> emptyT<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h4><p>客户端结构体定义：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Clerk <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd
	<span class="token comment">// You will have to modify this struct.</span>
	nextSendLocalId <span class="token builtin">int</span>
	LatestOffset    <span class="token builtin">int32</span>
	clientId        <span class="token builtin">int64</span>
	cTos            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	sToc            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>客户端发送请求逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	max <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">62</span><span class="token punctuation">)</span>
	bigx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> max<span class="token punctuation">)</span>
	x <span class="token operator">:=</span> bigx<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">MakeClerk</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">)</span> <span class="token operator">*</span>Clerk <span class="token punctuation">{</span>
	ck <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Clerk<span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>servers <span class="token operator">=</span> servers
	<span class="token comment">// You'll have to add code here.</span>
	ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>LatestOffset <span class="token operator">=</span> <span class="token number">1</span>
	ck<span class="token punctuation">.</span>clientId <span class="token operator">=</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>cTos <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>sToc <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ck<span class="token punctuation">.</span>cTos <span class="token punctuation">{</span>
		ck<span class="token punctuation">.</span>cTos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> ck
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token comment">// You will have to modify this function.</span>

	args <span class="token operator">:=</span> GetArgs<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>
		ClientId<span class="token punctuation">:</span>     ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>
		LatestOffset<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	count <span class="token operator">:=</span> <span class="token number">0</span>
	lastSendLocalId <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">==</span> lastSendLocalId <span class="token punctuation">{</span>
			count<span class="token operator">++</span>
			<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
				count <span class="token operator">=</span> <span class="token number">0</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		reply <span class="token operator">:=</span> GetReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token comment">// DPrintf("clinet [%d] [Get]:send[%d] args[%v]", ck.clientId, ck.nextSendLocalId, args)</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>nextSendLocalId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.Get"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>

		<span class="token comment">//根据reply初始化一下本地server表</span>

		lastSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[lost] args[%v]", ck.clientId, args)</span>
			<span class="token comment">//对面失联，那就换下一个继续发</span>
			ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>ServerId<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId

		<span class="token keyword">switch</span> reply<span class="token punctuation">.</span>Err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> OK<span class="token punctuation">:</span>
			ck<span class="token punctuation">.</span>LatestOffset<span class="token operator">++</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[OK] get args[%v] reply[%v]", ck.clientId, args, reply)</span>
			<span class="token keyword">return</span> reply<span class="token punctuation">.</span>Value
		<span class="token keyword">case</span> ErrNoKey<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[ErrNo key] get args[%v]", ck.clientId, args)</span>
			<span class="token keyword">return</span> <span class="token string">""</span>
		<span class="token keyword">case</span> ErrWrongLeader<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[ErrWrong LeaderId][%d] get args[%v] reply[%v]", ck.clientId, ck.nextSendLocalId, args, reply)</span>
			<span class="token comment">//对方也不知道leader</span>
			<span class="token keyword">if</span> reply<span class="token punctuation">.</span>LeaderId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token comment">//寻找下一个</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">//记录对方返回的不可靠leaderId</span>
				<span class="token keyword">if</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//但是本地还没初始化呢，那就往下一个发</span>
					ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//本地还真知道，那下一个就发它所指定的localServerAddress</span>
					ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span>
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> ErrWaitForRecover<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("client [%d] [Get]:[Wait for leader recover]", ck.clientId)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Client [%d] Get reply unknown err [%s](probaly not init)"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">,</span> op <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// You will have to modify this function.</span>
	args <span class="token operator">:=</span> PutAppendArgs<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>        value<span class="token punctuation">,</span>
		Op<span class="token punctuation">:</span>           op<span class="token punctuation">,</span>
		ClientId<span class="token punctuation">:</span>     ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>
		LatestOffset<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	lastSendLocalId <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">==</span> lastSendLocalId <span class="token punctuation">{</span>
			count<span class="token operator">++</span>
			<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
				count <span class="token operator">=</span> <span class="token number">0</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:send[%d] args[%v]", ck.clientId, ck.nextSendLocalId, args)</span>
		reply <span class="token operator">:=</span> PutAppendReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>nextSendLocalId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.PutAppend"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>

		<span class="token comment">//根据reply初始化一下本地server表</span>

		lastSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[lost] args[%v]", ck.clientId, args)</span>
			<span class="token comment">//对面失联，那就换下一个继续发</span>
			ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>ServerId<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId

		<span class="token keyword">switch</span> reply<span class="token punctuation">.</span>Err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> OK<span class="token punctuation">:</span>
			ck<span class="token punctuation">.</span>LatestOffset<span class="token operator">++</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[OK] args[%v] reply[%v]", ck.clientId, args, reply)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> ErrNoKey<span class="token punctuation">:</span>
			<span class="token comment">// log.Fatalf("Client [%d] [PutAppend]:reply ErrNokey, but should not happend to putAndAppend args", ck.clientId)</span>
		<span class="token keyword">case</span> ErrWrongLeader<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[ErrWrong LeaderId][%d] get args[%v] reply[%v]", ck.clientId, ck.nextSendLocalId, args, reply)</span>
			<span class="token comment">//对方也不知道leader</span>
			<span class="token keyword">if</span> reply<span class="token punctuation">.</span>LeaderId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token comment">//寻找下一个</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">//记录对方返回的不可靠leaderId</span>
				<span class="token keyword">if</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//但是本地还没初始化呢，那就往下一个发</span>
					ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//本地还真知道，那下一个就发它所指定的localServerAddress</span>
					ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span>
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Client [%d] [PutAppend]:reply unknown err [%s](probaly not init)"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> <span class="token punctuation">(</span>ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span>servers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span><span class="token function">PutAppend</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"Put"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Append</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span><span class="token function">PutAppend</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"Append"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>客户端实现的难点只有一个：实现快速定位leader</p>
<p>客户端所知道的服务器ID servers []*labrpc.ClientEnd 与服务器自己认知体系里的服务器ID完全没有关系  </p>
<p>客户端想要解析服务端发送回来的LeaderId究竟对应自己本地server数组里的哪个下标，就需要建立一个映射表（地址变换表）</p>
<p>我也是用一个笨方法来实现，服务器每次响应都同时带上自己的index和它所知道的leaderId，客户端根据index更新映射表，然后检查leaderId在映射表里有没有被更新过，没有就向下一个服务器继续发，有就好办了，下次发请求直达leader</p>
<p>当然，服务器返回的leaderId并非是那么的有参考价值，考虑到网络分区的情况，在一个小分区中follower们跟定了一个小leader，导致客户端得到了假leaderId，后续怎么发送请求都得不到回应</p>
<p>我的处理方法是只对同一个leader重试5次，再有下次就换人！惯不了一点</p>
<h4 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h4><p>线性一致的读请求处理：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>args <span class="token operator">*</span>GetArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>GetReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your code here.</span>
	reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">"i should not with ok symble"</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
	reply<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetleaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>ServerId <span class="token operator">=</span> kv<span class="token punctuation">.</span>me

	<span class="token comment">//判断自己是不是leader</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am leader", kv.me)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am not leader ,leader is [%d]", kv.me, reply.LeaderId)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//判断自己有没有从重启中恢复完毕状态机</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span>IisBack <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [recovering] reject a [Get]🔰 args[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
		kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span>
			OpType<span class="token punctuation">:</span> emptyT<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	readLastIndex <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	term <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//需要发送一轮心跳获得大多数回复，只是为了确定没有一个任期更加新的leader，保证自己的数据不是脏的</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">CheckIfDepose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//return false表明自己是合法leader</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//跟raft层之间的同步问题，raft刚当选leader的时候，还没有</span>

	<span class="token comment">//直接返回</span>
	value<span class="token punctuation">,</span> find <span class="token operator">:=</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> find <span class="token punctuation">{</span>
		<span class="token keyword">if</span> kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">&gt;=</span> readLastIndex <span class="token operator">&amp;&amp;</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> term <span class="token operator">==</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
			reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> value
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [ok] lastAppliedIndex[%d] readLastIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> readLastIndex<span class="token punctuation">)</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [Ok] the get args[%v] reply[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
			<span class="token comment">// DPrintf("server [%d] [Get] [ErrWaitForRecover] kv.lastAppliedIndex &lt; readLastIndex args[%v] reply[%v]", kv.me, *args, *reply)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [NoKey] the get args[%v] reply[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [map] -&gt; %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>kv.lastAppliedIndex &gt;= readLastIndex &amp;&amp; kv.rf.GetLeader() &amp;&amp; term == kv.rf.GetTerm()</p>
<p>实现好这个判断基本就能解决读操作线性一致了</p>
<p>Put和Append操作的线性一致性实现：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>args <span class="token operator">*</span>PutAppendArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>PutAppendReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Your code here.</span>
	reply<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetleaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
	reply<span class="token punctuation">.</span>ServerId <span class="token operator">=</span> kv<span class="token punctuation">.</span>me
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am leader", kv.me)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am not leader ,leader is [%d]", kv.me, reply.LeaderId)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	op <span class="token operator">:=</span> Op<span class="token punctuation">{</span>
		ClientId<span class="token punctuation">:</span> args<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>
		Offset<span class="token punctuation">:</span>   args<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
		Key<span class="token punctuation">:</span>      args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>    args<span class="token punctuation">.</span>Value<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> args<span class="token punctuation">.</span>Op <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token string">"Put"</span><span class="token punctuation">:</span>
		op<span class="token punctuation">.</span>OpType <span class="token operator">=</span> putT
	<span class="token keyword">case</span> <span class="token string">"Append"</span><span class="token punctuation">:</span>
		op<span class="token punctuation">.</span>OpType <span class="token operator">=</span> appendT
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unreconize put append args.Op:%s"</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>Op<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// DPrintf("server [%d] [PutAppend] 📨receive a args[%v]", kv.me, *args)</span>
	<span class="token comment">// defer DPrintf("server [%d] [PutAppend] 📨complete a args[%v]", kv.me, *args)</span>
	<span class="token comment">//start前需要查看本地log缓存是否有seq</span>

	<span class="token comment">//这里通过缓存提交，一方面提高了kvserver应对网络错误的回复速度，另一方面进行了第一层的重复检测</span>
	<span class="token comment">//但是注意可能同时有两个相同的getDuplicateMap通过这里</span>

	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">&lt;</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//没有在本地缓存发现过seq</span>
	<span class="token comment">//向raft提交操作</span>
	index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">SendAppendEntriesToAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] submit to raft key[%v] value[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token comment">//提交后阻塞等待</span>
	<span class="token comment">//等待applyCh拿到对应的index，比对seq是否正确</span>
	startWait <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> index <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token punctuation">{</span>
			<span class="token comment">//双重防重复</span>
			<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">&lt;</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
				reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// DPrintf("server [%d] [PutAppend] appliedIndex available :PutAppend index[%d] lastAppliedIndex[%d]", kv.me, index, kv.lastAppliedIndex)</span>
			<span class="token keyword">if</span> term <span class="token operator">!=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">//term不匹配了，说明本次提交失效</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span> <span class="token comment">//term匹配，说明本次提交一定是有效的</span>

			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
			<span class="token comment">// DPrintf("server [%d] [PutAppend] success args.index[%d], args[%v] reply[%v]", kv.me, index, *args, *reply)</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span>
				reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">//超过2s没等到applych，那就返回wrong</span>
		<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startWait<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">500</span> <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [PutAppend] fail [time out] args.index[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不要幻想像在Lab2里实现的那样，在server响应client的时候通过简单的ClientId和Offset比较就能搞定重复的非安全非幂等请求</p>
<p>多服务端的情况下，对于新leader的duplicateMap，这项值只保障最终一致性，并不一保障任何时刻都是最新的强一致性，所以这项判断放在client和server之间是不能百分百保证数据库安全的，还需要在server层和raft层之间实现去重。</p>
<p>不过这段代码放在这里确实有意义的，网络混乱的情况下它确实不能百分百解决问题，但在网络一切正常的时候它还是能起到作用的</p>
<p>如何实现server层和raft层之间的去重？根据log中保存的clientIndex和Offer。</p>
<p>这两项值经过raft转手后再次回到server，那意义可就大了，因为它借助raft层实现了强一致性，即大多数服务器上，log是线性一致的，所有服务器的log顺序都一模一样</p>
<p>处理raft层提交log的代码：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">/</span> state machine
<span class="token comment">// 将value重新转换为 Op，添加到本地kvMap中</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">HandleApplych</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> raft_type <span class="token operator">:=</span> <span class="token operator">&lt;-</span>kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> raft_type<span class="token punctuation">.</span>CommandValid <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span><span class="token function">HandleApplychCommand</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span><span class="token function">checkIfExcExccdLog</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">=</span> raft_type<span class="token punctuation">.</span>CommandIndex
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> raft_type<span class="token punctuation">.</span>SnapshotValid <span class="token punctuation">{</span>
				<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"📷 server [%d] receive raftSnapshotIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> raft_type<span class="token punctuation">.</span>SnapshotIndex<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span><span class="token function">HandleApplychSnapshot</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Unrecordnized applyArgs type"</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">HandleApplychCommand</span><span class="token punctuation">(</span>raft_type raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	op_type<span class="token punctuation">,</span> ok <span class="token operator">:=</span> raft_type<span class="token punctuation">.</span>Command<span class="token punctuation">.</span><span class="token punctuation">(</span>Op<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"raft applyArgs.command -&gt; Op 失败,raft_type.Command = %v"</span><span class="token punctuation">,</span> raft_type<span class="token punctuation">.</span>Command<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>OpType <span class="token operator">==</span> emptyT <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> op_type<span class="token punctuation">.</span>OpType <span class="token punctuation">{</span>
	<span class="token keyword">case</span> putT<span class="token punctuation">:</span>
		<span class="token comment">//更新状态机</span>
		<span class="token comment">//有可能有多个start重复执行，所以这一步要检验重复</span>
		<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"⛔server [%d] [Put] [%v] lastapplied[%v]find in the cache and discard %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
			Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
			Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> op_type<span class="token punctuation">.</span>Value
		<span class="token comment">// DPrintf("server [%d] [Update] [Put]-&gt;[%s,%s] [map] -&gt; %v", kv.me, op_type.Key, op_type.Value, kv.kvMap)</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Update] [Put]-&gt;[%s : %s] "</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token keyword">case</span> appendT<span class="token punctuation">:</span>
		<span class="token comment">//更新状态机</span>
		<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"⛔server [%d] [Append] [%v] lastapplied[%v]find in the cache and discard %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
			Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
			Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">+=</span> op_type<span class="token punctuation">.</span>Value
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Update] [Append]-&gt;[%s : %s]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token keyword">case</span> getT<span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"日志中不应该出现getType"</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"日志中出现未知optype = [%d]"</span><span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>OpType<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>去重代码的原理跟Lab2中实现的去重原理是一致的</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
	Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
	Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Part-B-Key-value-service-with-snapshots-hard"><a href="#Part-B-Key-value-service-with-snapshots-hard" class="headerlink" title="Part B: Key/value service with snapshots (hard)"></a>Part B: Key/value service with snapshots (hard)</h4><p>本次实验增加了对raftState大小的限制，当raft层的log数量接近限制的时候，server层就向raft发出snapshot命令，然后将server层的	kvMap duplicateMap这两项放入snapshotDate里让raft帮忙持久化。</p>
<p>由于snapshot截断日志的效果，duplicateMap如果不同步进行持久化，很有可能因为缺少log而无法正确去重</p>
<blockquote>
<p>为什么这么说？很简单，两个重读的Put请求，一个在因为snapshot而截断丢弃的log中，另一个在snpashotIndex之后</p>
<p>server层和raft层之间去重的时候，duplicateMap无法缓存到前一个Put请求，从而允许下一个重复的put请求被应用到数据库中</p>
</blockquote>
<p>代码实现：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 主动快照,每一个服务器都在自己log超标的时候启动快照</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">checkIfNeedSnapshot</span><span class="token punctuation">(</span>spanshotindex <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">IfNeedExceedLog</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>maxraftstate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span> <span class="token comment">//需要进行快照了</span>

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] need snapshot limit[%d] curRaftStatesize[%d] snapshotIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>maxraftstate<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>persister<span class="token punctuation">.</span><span class="token function">RaftStateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanshotindex<span class="token punctuation">)</span>
	<span class="token comment">//首先查看一下自己的状态机应用到了那一步</span>

	<span class="token keyword">var</span> buf bytes<span class="token punctuation">.</span>Buffer
	enc <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"snapshot duplicateMap encoder fail:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"snapshot kvMap encoder fail:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//将状态机传了进去</span>
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Snapshot</span><span class="token punctuation">(</span>spanshotindex<span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token comment">// 被动快照</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">readPersist</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] passive 📷 len of snapshotdate[%d] "</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] before map[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
	r <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	d <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>

	kvMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	duplicateMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>duplicateMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"decode err:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"decode err:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>kvMap <span class="token operator">=</span> kvMap
	kv<span class="token punctuation">.</span>duplicateMap <span class="token operator">=</span> duplicateMap

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] after map[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>主动快照是为了保障raftState的大小不要太大，由server主观调用</p>
<p>被动快照是raft层为了解决主动快照带来的日志复制问题而进行的，两者意义不同</p>
</blockquote>
<p>实验过程还有一些细节</p>
<p>想起来再写</p>

  </article>
  <!-- tag -->
  <div class="mt-12 pt-6 border-t border-gray-200">
    
      
        <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 m-1 text-sm rounded-md transition-colors hover:bg-gray-200">
          <a href="/tags/MIT6-5840/">MIT6.5840</a>
        </span>
      
    
  </div>
  <!-- prev and next -->
  <div class="flex justify-between mt-12 pt-6 border-t border-gray-200">
    <div>
      
    </div>
    <div>
      
        <a href="/2024/04/04/mit65840lab3shixian/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          MIT6.5840 Lab3 实现
          <iconify-icon width="20" icon="ri:arrow-right-s-line" data-inline="false"></iconify-icon>
        </a>
      
    </div>
  </div>
  <!-- comment -->
  <div class="article-comments mt-12">
    

  </div>
</section>
<!-- js inspect -->

<script src="/lib/clipboard.min.js"></script>


<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>



<script src="/lib/fancybox/fancybox.umd.min.js"></script>

<script>
  $(document).ready(() => {
    $('.post-content').each(function(i){
      $(this).find('img').each(function(){
        if ($(this).parent().hasClass('fancybox') || $(this).parent().is('a')) return;
        var alt = this.alt;
        if (alt) $(this).after('<span class="fancybox-alt">' + alt + '</span>');
        $(this).wrap('<a class="fancybox-img" href="' + this.src + '" data-fancybox=\"gallery\" data-caption="' + alt + '"></a>')
      });
      $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article' + i);
      });
    });

    Fancybox.bind('[data-fancybox="gallery"]', {
        // options
    })
  })
</script>

<!-- tocbot begin -->

<script src="/lib/tocbot/tocbot.min.js"></script>

<script>
  $(document).ready(() => {
      tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.post-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });
  })
</script>
<!-- tocbot end -->


  </main>
  <footer class="flex flex-col h-40 items-center justify-center text-gray-400 text-sm">
  <!-- busuanzi -->
  
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- Busuanzi Analytics -->
<div class="flex items-center gap-2">
  <span>Visitors</span>
  <span id="busuanzi_value_site_uv"></span>
  <span>Page Views</span>
  <span id="busuanzi_value_site_pv"></span>
</div>
<!-- End Busuanzi Analytics -->


  <!-- copyright -->
  <div class="flex items-center gap-2">
    <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: inherit;">CC BY-NC-SA 4.0</a>
    <span>© 2022</span>
    <iconify-icon width="18" icon="emojione-monotone:maple-leaf" ></iconify-icon>
    <a href="https://github.com/xbmlz" target="_blank" rel="noopener noreferrer">xbmlz</a>
  </div>
  <!-- powered by -->
  <div class="flex items-center gap-2">
    <span>Powered by</span>
    <a href="https://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a>
    <span>&</span>
    <a href="https://github.com/xbmlz/hexo-theme-maple" target="_blank" rel="noopener noreferrer">Maple</a>
  </div>

</footer>

  <div class="back-to-top box-border fixed right-6 z-1024 -bottom-20 rounded py-1 px-1 bg-slate-900 opacity-60 text-white cursor-pointer text-center dark:bg-slate-600">
    <span class="flex justify-center items-center text-sm">
      <iconify-icon width="18" icon="ion:arrow-up-c" id="go-top"></iconify-icon>
      <span id="scrollpercent"><span>0</span> %</span>
    </span>
  </div>
  
<script src="/js/main.js"></script>


  <script>
    $(document).ready(function () {
      const mapleCount = "10";
      const speed = "0.5";
      const mapleEl = document.getElementById("maple");
      const maples = Array.from({ length: mapleCount }).map(() => {
        const maple = document.createElement("div");
        const scale = Math.random() * 0.5 + 0.5;
        const offset = Math.random() * 2 - 1;
        const x = Math.random() * mapleEl.clientWidth;
        const y = -Math.random() * mapleEl.clientHeight;
        const duration = 10 / speed;
        const delay = -duration;
        maple.className = "maple";
        maple.style.width = `${24 * scale}px`;
        maple.style.height = `${24 * scale}px`;
        maple.style.left = `${x}px`;
        maple.style.top = `${y}px`;
        maple.style.setProperty("--maple-fall-offset", offset);
        maple.style.setProperty("--maple-fall-height", `${Math.abs(y) + mapleEl.clientHeight}px`);
        maple.style.animation = `fall ${duration}s linear infinite`;
        maple.style.animationDelay = `${delay}s`;
        mapleEl.appendChild(maple)
        return maple
      })
    });
  </script>
  


  <div class="fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden" id="maple"></div>
</body>

</html>
