<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">




<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

  <meta name="author" content="Xiur">


  <meta name="subtitle" content="é—²æ¥è®°äº‹">


  <meta name="description" content="å·²å··çš„ä¸ªäººå°ç«™">



<title>MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç° | Oncelane</title>



<link rel="icon" href="/favicon.png">



<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/nprogress/nprogress.css">



<script src="/lib/jquery.min.js"></script>


<script src="/lib/iconify-icon.min.js"></script>


<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
  };
</script>


<script src="/lib/nprogress/nprogress.js"></script>

<script>
  $(document).ready(() => {
    NProgress.configure({
      showSpinner: false,
    });
    NProgress.start();
    $("#nprogress .bar").css({
      background: "#de7441",
    });
    $("#nprogress .peg").css({
      "box-shadow": "0 0 2px #de7441, 0 0 4px #de7441",
    });
    $("#nprogress .spinner-icon").css({
      "border-top-color": "#de7441",
      "border-left-color": "#de7441",
    });
    setTimeout(function () {
      NProgress.done();
      $(".fade").removeClass("out");
    }, 800);
  });
</script>

<script>
  (function () {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const setting = localStorage.getItem("hexo-color-scheme") || "auto";
    if (setting === "dark" || (prefersDark && setting !== "light"))
      document.documentElement.classList.toggle("dark", true);
    let isDark = document.documentElement.classList.contains("dark");
  })();

  $(document).ready(function () {
    // init icon
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = document.documentElement.classList.contains("dark");
    $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");

    function toggleGiscusTheme() {
      const isDark = document.documentElement.classList.contains("dark");
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          {
            giscus: {
              setConfig: {
                theme: isDark ? "dark" : "light",
              },
            },
          },
          "https://giscus.app"
        );
      }
    }


    // toggle dark mode
    function toggleDark() {
      let isDark = document.documentElement.classList.contains("dark");
      const setting = localStorage.getItem("hexo-color-scheme") || "auto";
      isDark = !isDark;
      document.documentElement.classList.toggle("dark", isDark);
      $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");
      if (prefersDark === isDark) {
        localStorage.setItem("hexo-color-scheme", "auto");
      } else {
        localStorage.setItem("hexo-color-scheme", isDark ? "dark" : "light");
      }
      toggleGiscusTheme();
    }
    $("#toggle-dark").click(toggleDark);

    // listen dark mode change
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        const setting = localStorage.getItem("hexo-color-scheme") || "auto";
        if (setting === "auto") {
          document.documentElement.classList.toggle("dark", e.matches);
          $("#theme-icon").attr(
            "icon",
            e.matches ? "ri:moon-line" : "ri:sun-line"
          );
          toggleGiscusTheme();
        }
      });
  });
</script>




<meta name="generator" content="Hexo 7.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body class="font-sans bg-white dark:bg-zinc-900 text-gray-700 dark:text-gray-200 relative">
  <header class="fixed w-full px-5 py-1 z-10 backdrop-blur-xl backdrop-saturate-150 border-b border-black/5">
  <div class="max-auto">
    <nav class="flex items-center text-base">
      <a href="/" class="group">
        <h2 class="font-medium tracking-tighterp text-l p-2">
          <img class="w-5 mr-2 inline-block transition-transform group-hover:rotate-[30deg]" id="logo" src="/images/logo.svg" alt="Oncelane" />
          Oncelane
        </h2>
      </a>
      <div id="header-title" class="opacity-0 md:ml-2 md:mt-[0.1rem] text-xs font-medium whitespace-nowrap overflow-hidden overflow-ellipsis">
        MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç°
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3">
        
          <a class="hidden sm:flex" href="/archives">Posts</a>
        
        
          
            <a class="w-5 h-5 hidden sm:flex" title="Github" target="_blank" rel="noopener" href="https://github.com/xbmlz">
              <iconify-icon width="20" icon="ri:github-line"></iconify-icon>
            </a>
          
        
        <a class="w-5 h-5 hidden sm:flex" title="Github" href="rss2.xml">
          <iconify-icon width="20" icon="ri:rss-line"></iconify-icon>
        </a>
        <a class="w-5 h-5" title="toggle theme" id="toggle-dark">
          <iconify-icon width="20" icon="" id="theme-icon"></iconify-icon>
        </a>
      </div>
      <div class="flex items-center justify-center gap-3 ml-3 sm:hidden">
        <span class="w-5 h-5" aria-hidden="true" role="img" id="open-menu">
          <iconify-icon width="20" icon="carbon:menu" ></iconify-icon>
        </span>
        <span class="w-5 h-5 hidden" aria-hidden="true" role="img" id="close-menu">
          <iconify-icon  width="20" icon="carbon:close" ></iconify-icon>
        </span>
      </div>
    </nav>
  </div>
</header>
<div id="menu-panel" class="h-0 overflow-hidden sm:hidden fixed left-0 right-0 top-12 bottom-0 z-10">
  <div id="menu-content" class="relative z-20 bg-white/80 px-6 sm:px-8 py-2 backdrop-blur-xl -translate-y-full transition-transform duration-300">
    <ul class="nav flex flex-col sm:flex-row text-sm font-medium">
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/archives" class="flex h-12 sm:h-auto items-center">Posts</a>
        </li>
      
    </ul>
  </div>
  <div class="mask bg-black/20 absolute inset-0"></div>
</div>

  <main class="pt-14">
    <!-- css -->

<link rel="stylesheet" href="/lib/fancybox/fancybox.min.css">


<link rel="stylesheet" href="/lib/tocbot/tocbot.min.css">

<!-- toc -->

  <!-- tocbot -->
<nav class="post-toc toc text-sm w-48 relative top-32 right-0 opacity-70 hidden lg:block" style="position: fixed !important;"></nav>


<section class="px-6 max-w-prose mx-auto md:px-0">
  <!-- header -->
  <header class="overflow-hidden pt-6 pb-6 md:pt-12">
    <div class="pt-4 md:pt-6">
      <h1 id="article-title" class="text-[2rem] font-bold leading-snug mb-4 md:mb-6 md:text-[2.6rem]">
        MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç°
      </h1>
      <div>
        <section class="flex items-center gap-3 text-sm">
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="carbon-calendar" ></iconify-icon>
            <time>2024-04-06</time>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="ic:round-access-alarm" ></iconify-icon>
            <span>20 min</span>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="icon-park-outline:font-search" ></iconify-icon>
            <span>4.4k words</span>
          </span>
          
        </section>
      </div>
    </div>
  </header>
  <!-- content -->
  <article class="post-content prose m-auto slide-enter-content dark:prose-invert">
    <h4 id="6-5840-Lab-4-Fault-tolerant-Key-Value-Service"><a href="#6-5840-Lab-4-Fault-tolerant-Key-Value-Service" class="headerlink" title="6.5840 Lab 4: Fault-tolerant Key/Value Service"></a>6.5840 Lab 4: Fault-tolerant Key/Value Service</h4><p>Introduction</p>
<blockquote>
<p>In this lab you will build a fault-tolerant key/value storage service using your Raft library from Lab 3. Your key/value service will be a replicated state machine, consisting of several key/value servers that each maintain a database of key/value pairs, as in Lab 2, but additionally use Raft for replication. Your key/value service should continue to process client requests as long as a majority of the servers are alive and can communicate, in spite of other failures or network partitions. After Lab 4, you will have implemented all parts (Clerk, Service, and Raft) shown in the diagram of Raft interactions.</p>
</blockquote>
<p>æœ¬æ¬¡å®éªŒéœ€è¦ç»“åˆLab2å®ç°çš„ç®€æ˜“KVserverå’ŒLab3å®ç°çš„Raftç®—æ³•ï¼Œæœ€åå®ç°ä¸€ä¸ªå…·æœ‰å®¹é”™åŠŸèƒ½çš„åˆ†å¸ƒå¼KVServeré›†ç¾¤ï¼</p>
<p>ç›¸æ¯”äºLab3Raftç®—æ³•çš„å®ç°ï¼Œæœ¬æ¬¡å®éªŒçš„ä»£ç é‡æ›´å°‘ï¼Œé€»è¾‘ä¹Ÿç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯æ—¥å¿—é‡ä¼šå¢é•¿ä¸€ä¸ªæ•°é‡çº§ï¼Œååˆ†ä¸å¥½debugï¼Œå†åŠ ä¸Šä¸€äº›Lab3æµ‹è¯•éƒ½æ— æ³•æµ‹å‡ºæ¥çš„raftå±‚çš„bugï¼Œå¯ä»¥è¯´å®Œå…¨æ˜¯debugåœ°ç‹±äº†ã€‚</p>
<p>æœ¬æ¬¡å®éªŒéœ€è¦å®ç°æˆ‘ä»¬å®ç°ä¸€ä¸ªä¾èµ–äºraftçš„å¤„äºä¸Šå±‚çš„KVserverï¼Œå®ƒæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„Getï¼ŒPutï¼ŒAppendè¯·æ±‚ï¼Œåœ¨å®¢æˆ·ç«¯çœ‹æ¥ï¼ŒKVServeræä¾›çš„æœåŠ¡æ˜¯æ˜¯çº¿æ€§ä¸€è‡´æ€§çš„ï¼Œä¹Ÿå«å¼ºä¸€è‡´æ€§çš„</p>
<p>è¿™é‡Œæœ‰ä¸€ç¯‡æ˜æ™°å„ç§ä¸€è‡´æ€§æ¦‚å¿µçš„æ–‡ç« ï¼Œå…¨é¢è¯¦ç»†æ˜“æ‡‚ï¼Œ<del>å”¯ä¸€ä¸å¥½çš„åœ°æ–¹å°±æ˜¯æˆ‘äº‹åå†™åšå®¢çš„æ—¶å€™æ‰å‘ç°å®ƒğŸ˜­</del></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022248118">https://segmentfault.com/a/1190000022248118</a></p>
</blockquote>
<p>å¦‚æœå°†å®¢æˆ·ç«¯çš„Getæ“ä½œä¹Ÿå†™å…¥æ—¥å¿—ï¼Œç­‰å¾…Getæ—¥å¿—è¢«Raftå±‚æäº¤åå†å“åº”å®¢æˆ·ç«¯ï¼Œæœ¬å®éªŒå®ç°èµ·æ¥ä¼šç®€æ´å¾ˆå¤šï¼Œå®éªŒæŒ‡å¯¼ä¹Ÿæ˜¯è¿™ä¹ˆå»ºè®®çš„ã€‚</p>
<p>ä½†æ˜¯æˆ‘é€‰æ‹©ä¸å°†getè¯·æ±‚å†™å…¥æ—¥å¿—ï¼ˆäººè¦æœ‰è¿½æ±‚ï¼Œ<del>è™½ç„¶äº‹ådebugèµ·æ¥çœŸçš„åæ‚”æ­»äº†</del></p>
<p>è®ºæ–‡ä¸­æœ‰æåˆ°å¦‚ä½•å®ç°è¿™ç‚¹</p>
<p>1.å³leaderå“åº”Getè¯·æ±‚å‰å…ˆå‘èµ·ä¸€æ¬¡ check quorum ç¯èŠ‚ï¼Œæˆ‘é€šè¿‡å¤ç”¨å¿ƒè·³æ¥å®ç°</p>
<p>2.è¿˜æœ‰å°±æ˜¯ReadIndexï¼Œè®°å½•æ”¶åˆ°Getè¯·æ±‚é‚£ä¸€åˆ»çš„Raftå±‚çš„CommitIndexå€¼ï¼Œç­‰å¾…åº”ç”¨å±‚ä»raftå±‚æ”¶åˆ°çš„logçš„indexå€¼ç­‰äºReadIndexå€¼çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¿”å›æ­¤æ¬¡Getè¯·æ±‚äº†ã€‚</p>
<p>é‚£ä¹ˆå°±å¯ä»¥å¼€å§‹å†™ä»£ç äº†ï¼š</p>
<h3 id="Part-A-Key-value-service-without-snapshots-moderate-hard"><a href="#Part-A-Key-value-service-without-snapshots-moderate-hard" class="headerlink" title="Part A: Key/value service without snapshots (moderate/hard)"></a>Part A: Key/value service without snapshots (moderate/hard)</h3><h4 id="ç»“æ„ä½“å®šä¹‰"><a href="#ç»“æ„ä½“å®šä¹‰" class="headerlink" title="ç»“æ„ä½“å®šä¹‰"></a>ç»“æ„ä½“å®šä¹‰</h4><p>æ—¥å¿—ç»“æ„ä½“çš„å®šä¹‰</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Op <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ClientId <span class="token builtin">int64</span> <span class="token comment">//å®¢æˆ·ç«¯æ ‡è¯†ï¼Œç”¨äºåº”å¯¹é‡å¤è¯·æ±‚</span>
	Offset   <span class="token builtin">int32</span> <span class="token comment">//å®¢æˆ·ç«¯çš„è¯·æ±‚åºåˆ—å·</span>
	OpType   <span class="token builtin">int</span>   <span class="token comment">//è¯·æ±‚/æ“ä½œç±»å‹</span>
	Key      <span class="token builtin">string</span>
	Value    <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	getT <span class="token operator">=</span> <span class="token boolean">iota</span>
	putT
	appendT
	emptyT <span class="token comment">//indicate a empty log only use to update leader commitIndex</span>
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>emptyTæ˜¯ä¸ºäº†å¸®åŠ©leaderæ›´æ–°commitIndexçš„å€¼è€Œä½¿ç”¨çš„</p>
<p>KVServeræˆå‘˜å˜é‡ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> KVServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu      sync<span class="token punctuation">.</span>Mutex
	me      <span class="token builtin">int</span>
	rf      <span class="token operator">*</span>raft<span class="token punctuation">.</span>Raft
	applyCh <span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg
	dead    <span class="token builtin">int32</span> <span class="token comment">// set by Kill()</span>

	maxraftstate <span class="token builtin">int</span> <span class="token comment">// snapshot if log grows this big</span>

	persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>Persister

	lastAppliedIndex <span class="token builtin">int</span> <span class="token comment">//æœ€è¿‘æ·»åŠ åˆ°çŠ¶æ€æœºä¸­çš„raftå±‚çš„logçš„index</span>
	
	lastIncludeIndex <span class="token builtin">int</span> 	<span class="token comment">//lastInclude</span>
	
	kvMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//log state machine</span>

	<span class="token comment">//ç¼“å­˜çš„log, seq-&gt;index,reply</span>
	duplicateMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType

<span class="token punctuation">}</span>

<span class="token keyword">type</span> duplicateType <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Offset <span class="token builtin">int32</span>
	Reply  <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">StartKVServer</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">,</span> me <span class="token builtin">int</span><span class="token punctuation">,</span> persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>Persister<span class="token punctuation">,</span> maxraftstate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>KVServer <span class="token punctuation">{</span>
	<span class="token comment">// call labgob.Register on structures you want</span>
	<span class="token comment">// Go's RPC library to marshall/unmarshall.</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	kv <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>KVServer<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>me <span class="token operator">=</span> me
	kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">=</span> maxraftstate
	kv<span class="token punctuation">.</span>persister <span class="token operator">=</span> persister
	<span class="token comment">// You may need initialization code here.</span>

	kv<span class="token punctuation">.</span>applyCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>rf <span class="token operator">=</span> raft<span class="token punctuation">.</span><span class="token function">Make</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> me<span class="token punctuation">,</span> persister<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">)</span>

	<span class="token comment">// You may need initialization code here.</span>
	kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">=</span> <span class="token number">0</span>
	kv<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token comment">//state machine</span>
	kv<span class="token punctuation">.</span>kvMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token comment">//log</span>
	kv<span class="token punctuation">.</span>duplicateMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">)</span>

	kv<span class="token punctuation">.</span><span class="token function">readPersist</span><span class="token punctuation">(</span>persister<span class="token punctuation">.</span><span class="token function">ReadSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">HandleApplych</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// go kv.HandleSnapshot()</span>
	<span class="token comment">// go kv.handleGetTask()</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] restart"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
	<span class="token keyword">return</span> kv
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºä»€ä¹ˆéœ€è¦emptyTï¼Ÿ</p>
<p>å›é¡¾commitIndexæ›´æ–°çš„é™åˆ¶ï¼Œleaderè‡³å°‘åœ¨è‡ªå·±ä»»æœŸå†…è¾¾æˆä¸€æ¡æ—¥å¿—çš„å¤§å¤šæ•°å…±è¯†ï¼Œæ‰èƒ½å¤Ÿæ›´æ–°è‡ªå·±çš„commitIndexï¼Œå…¶ä»–followeræ‰èƒ½æ ¹æ®leaderå¿ƒè·³çš„LeaderCommitæ›´æ–°è‡ªå·±çš„commitIndex</p>
<p>å¦‚æœè¿™æ®µæ—¶é—´é‡Œå®¢æˆ·ç«¯ç‹‚å‘Getè¯·æ±‚ï¼ˆGetè¯·æ±‚ä¸å†™å…¥æ—¥å¿—ï¼‰æ²¡ä¸€ä¸ªå®¢æˆ·ç«¯å‘Putå’ŒAppendè¯·æ±‚ï¼Œé‚£ä¹ˆleaderçš„commmitIndexå°±å®Œå…¨å¡ä½äº†ï¼Œåº”ç”¨å±‚æ°¸è¿œæ”¶ä¸åˆ°æ–°çš„applylog</p>
<blockquote>
<p>é‚£ä¸ºå•¥lab3å®éªŒçš„å„ç§å˜æ€æµ‹è¯•å°±è¡¨ç°çš„å¥½å¥½çš„ï¼Œç°åœ¨åˆä¸è¡Œäº†æï¼Ÿ</p>
</blockquote>
<p>å› ä¸ºæµ‹è¯•ä»£ç æ£€æŸ¥é€šè¿‡startï¼ˆï¼‰æäº¤æ—¥å¿—ï¼Œå½“å®ƒå‘ç°æäº¤çš„è¿™æ¡logæ²¡æœ‰åœ¨å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šè¾¾åˆ°å…±è¯†çš„æ—¶å€™ï¼Œæˆ–è€…è¯´è¾¾æˆå…±è¯†çš„è¿™ä¸ªIndexæ˜¯ä¸æ˜¯å®ƒæ‰€æäº¤çš„logçš„æ—¶å€™ï¼Œå®ƒä¼šè¿›è¡Œ5æ¬¡é‡è¯•ï¼Œï¼ˆå½“ç„¶äº†å¦‚æœæµ‹è¯•ç¨‹åºä¿è¯åœ¨ç½‘ç»œå·²ç»æ¢å¤æ­£å¸¸ä¸€æ®µæ—¶é—´ä¹‹åå†æäº¤æ—¥å¿—ï¼Œè¿™æ—¶å€™æµ‹è¯•ç¨‹åºæ£€æŸ¥åˆ°Indexä¸Šä¸æ˜¯å®ƒæ‰€æäº¤çš„æ—¥å¿—ï¼Œé‚£ç›´æ¥å°±Fail Testäº†ï¼‰ä¿è¯leaderä¸€ç›´æœ‰logå¯ä»¥æ·»åŠ ï¼Œleaderå¯ä»¥åœ¨è¿™äº”æ¬¡é‡è¯•æ—¶é—´å†…æ›´æ–°å¥½è‡ªå·±çš„commitIndexï¼Œä»è€Œå°†åº”ç”¨å±‚æƒ³è¦çš„</p>
<p>æ—¢ç„¶åœ¨Lab4æ²¡æœ‰æµ‹è¯•ç¨‹åºå¸®æˆ‘ä»¬åšæ·»åŠ logè¿™ä»¶äº‹ï¼Œæˆ‘ä»¬å°±è‡ªå·±æ¥ï¼Œ</p>
<p>åœ¨raftå±‚å¤šè®¾ç½®ä¸¤ä¸ªæ ‡å¿—ï¼ŒIisBackå¦‚æœä¸ºtrueï¼šè¡¨æ˜leaderåœ¨å½“å‰ä»»æœŸå†…è¾¾æˆcommitIndexçš„æ›´æ–°ï¼Œå¹¶ä¸”å°†è¿™æ¡å±äºå½“å‰ä»»æœŸçš„æ—¥å¿—é€šè¿‡applyChå‘é€ç»™äº†serverå±‚</p>
<p>IisBackIndexè¾…åŠ©IisBackæ›´æ–°</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Raft <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">//Man,what can i say?</span>
	IisBack      <span class="token builtin">bool</span>
	IisBackIndex <span class="token builtin">int</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>leaderæ¯æ¬¡åˆšåˆšå½“é€‰çš„æ—¶å€™è®¾ç½®IisBackä¸ºfalseï¼Œæ›´æ–°commitIndexçš„æ—¶å€™è®¾ç½®IisBackIndex = commitIndexï¼Œå½“applyIndexå¤§äºç­‰äºIisBackIndexæ—¶ï¼Œå°±å¯ä»¥è®¾ç½®IisBackä¸ºtrueäº†</p>
<p>leaderæ¯æ¬¡å“åº”è¯»è¯·æ±‚å‰éœ€è¦æ£€æŸ¥Iisbackæ˜¯å¦ä¸ºTrueï¼Œè‹¥ä¸ºfalseï¼Œåˆ™éœ€è¦é€šè¿‡startï¼ˆï¼‰å‘raftå±‚æäº¤ä¸€ä¸ªOpType = emptyT çš„ç©ºæ—¥å¿—ï¼Œé€šçŸ¥clientè¿‡ä¸€ä¼šå†æ¥å°è¯•ï¼Œç­‰å¾…å½“å‰leaderå®ŒæˆåŒæ­¥</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//åˆ¤æ–­è‡ªå·±æœ‰æ²¡æœ‰ä»é‡å¯ä¸­æ¢å¤å®Œæ¯•çŠ¶æ€æœº</span>
<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span>IisBack <span class="token punctuation">{</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [recovering] reject a [Get]ğŸ”° args[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span>
		OpType<span class="token punctuation">:</span> emptyT<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="å®¢æˆ·ç«¯ä»£ç "><a href="#å®¢æˆ·ç«¯ä»£ç " class="headerlink" title="å®¢æˆ·ç«¯ä»£ç "></a>å®¢æˆ·ç«¯ä»£ç </h4><p>å®¢æˆ·ç«¯ç»“æ„ä½“å®šä¹‰ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Clerk <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd
	<span class="token comment">// You will have to modify this struct.</span>
	nextSendLocalId <span class="token builtin">int</span>
	LatestOffset    <span class="token builtin">int32</span>
	clientId        <span class="token builtin">int64</span>
	cTos            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	sToc            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®¢æˆ·ç«¯å‘é€è¯·æ±‚é€»è¾‘ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	max <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">62</span><span class="token punctuation">)</span>
	bigx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> max<span class="token punctuation">)</span>
	x <span class="token operator">:=</span> bigx<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">MakeClerk</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">)</span> <span class="token operator">*</span>Clerk <span class="token punctuation">{</span>
	ck <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Clerk<span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>servers <span class="token operator">=</span> servers
	<span class="token comment">// You'll have to add code here.</span>
	ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>LatestOffset <span class="token operator">=</span> <span class="token number">1</span>
	ck<span class="token punctuation">.</span>clientId <span class="token operator">=</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>cTos <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>sToc <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ck<span class="token punctuation">.</span>cTos <span class="token punctuation">{</span>
		ck<span class="token punctuation">.</span>cTos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> ck
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token comment">// You will have to modify this function.</span>

	args <span class="token operator">:=</span> GetArgs<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>
		ClientId<span class="token punctuation">:</span>     ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>
		LatestOffset<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	count <span class="token operator">:=</span> <span class="token number">0</span>
	lastSendLocalId <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">==</span> lastSendLocalId <span class="token punctuation">{</span>
			count<span class="token operator">++</span>
			<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
				count <span class="token operator">=</span> <span class="token number">0</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		reply <span class="token operator">:=</span> GetReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token comment">// DPrintf("clinet [%d] [Get]:send[%d] args[%v]", ck.clientId, ck.nextSendLocalId, args)</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>nextSendLocalId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.Get"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>

		<span class="token comment">//æ ¹æ®replyåˆå§‹åŒ–ä¸€ä¸‹æœ¬åœ°serverè¡¨</span>

		lastSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[lost] args[%v]", ck.clientId, args)</span>
			<span class="token comment">//å¯¹é¢å¤±è”ï¼Œé‚£å°±æ¢ä¸‹ä¸€ä¸ªç»§ç»­å‘</span>
			ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>ServerId<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId

		<span class="token keyword">switch</span> reply<span class="token punctuation">.</span>Err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> OK<span class="token punctuation">:</span>
			ck<span class="token punctuation">.</span>LatestOffset<span class="token operator">++</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[OK] get args[%v] reply[%v]", ck.clientId, args, reply)</span>
			<span class="token keyword">return</span> reply<span class="token punctuation">.</span>Value
		<span class="token keyword">case</span> ErrNoKey<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[ErrNo key] get args[%v]", ck.clientId, args)</span>
			<span class="token keyword">return</span> <span class="token string">""</span>
		<span class="token keyword">case</span> ErrWrongLeader<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[ErrWrong LeaderId][%d] get args[%v] reply[%v]", ck.clientId, ck.nextSendLocalId, args, reply)</span>
			<span class="token comment">//å¯¹æ–¹ä¹Ÿä¸çŸ¥é“leader</span>
			<span class="token keyword">if</span> reply<span class="token punctuation">.</span>LeaderId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token comment">//å¯»æ‰¾ä¸‹ä¸€ä¸ª</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">//è®°å½•å¯¹æ–¹è¿”å›çš„ä¸å¯é leaderId</span>
				<span class="token keyword">if</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//ä½†æ˜¯æœ¬åœ°è¿˜æ²¡åˆå§‹åŒ–å‘¢ï¼Œé‚£å°±å¾€ä¸‹ä¸€ä¸ªå‘</span>
					ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//æœ¬åœ°è¿˜çœŸçŸ¥é“ï¼Œé‚£ä¸‹ä¸€ä¸ªå°±å‘å®ƒæ‰€æŒ‡å®šçš„localServerAddress</span>
					ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span>
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> ErrWaitForRecover<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("client [%d] [Get]:[Wait for leader recover]", ck.clientId)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Client [%d] Get reply unknown err [%s](probaly not init)"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">,</span> op <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// You will have to modify this function.</span>
	args <span class="token operator">:=</span> PutAppendArgs<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>        value<span class="token punctuation">,</span>
		Op<span class="token punctuation">:</span>           op<span class="token punctuation">,</span>
		ClientId<span class="token punctuation">:</span>     ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>
		LatestOffset<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	lastSendLocalId <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">==</span> lastSendLocalId <span class="token punctuation">{</span>
			count<span class="token operator">++</span>
			<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
				count <span class="token operator">=</span> <span class="token number">0</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:send[%d] args[%v]", ck.clientId, ck.nextSendLocalId, args)</span>
		reply <span class="token operator">:=</span> PutAppendReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>nextSendLocalId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.PutAppend"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>

		<span class="token comment">//æ ¹æ®replyåˆå§‹åŒ–ä¸€ä¸‹æœ¬åœ°serverè¡¨</span>

		lastSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[lost] args[%v]", ck.clientId, args)</span>
			<span class="token comment">//å¯¹é¢å¤±è”ï¼Œé‚£å°±æ¢ä¸‹ä¸€ä¸ªç»§ç»­å‘</span>
			ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>ServerId<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId

		<span class="token keyword">switch</span> reply<span class="token punctuation">.</span>Err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> OK<span class="token punctuation">:</span>
			ck<span class="token punctuation">.</span>LatestOffset<span class="token operator">++</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[OK] args[%v] reply[%v]", ck.clientId, args, reply)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> ErrNoKey<span class="token punctuation">:</span>
			<span class="token comment">// log.Fatalf("Client [%d] [PutAppend]:reply ErrNokey, but should not happend to putAndAppend args", ck.clientId)</span>
		<span class="token keyword">case</span> ErrWrongLeader<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[ErrWrong LeaderId][%d] get args[%v] reply[%v]", ck.clientId, ck.nextSendLocalId, args, reply)</span>
			<span class="token comment">//å¯¹æ–¹ä¹Ÿä¸çŸ¥é“leader</span>
			<span class="token keyword">if</span> reply<span class="token punctuation">.</span>LeaderId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token comment">//å¯»æ‰¾ä¸‹ä¸€ä¸ª</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">//è®°å½•å¯¹æ–¹è¿”å›çš„ä¸å¯é leaderId</span>
				<span class="token keyword">if</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//ä½†æ˜¯æœ¬åœ°è¿˜æ²¡åˆå§‹åŒ–å‘¢ï¼Œé‚£å°±å¾€ä¸‹ä¸€ä¸ªå‘</span>
					ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//æœ¬åœ°è¿˜çœŸçŸ¥é“ï¼Œé‚£ä¸‹ä¸€ä¸ªå°±å‘å®ƒæ‰€æŒ‡å®šçš„localServerAddress</span>
					ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span>
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Client [%d] [PutAppend]:reply unknown err [%s](probaly not init)"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> <span class="token punctuation">(</span>ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span>servers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span><span class="token function">PutAppend</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"Put"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Append</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span><span class="token function">PutAppend</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"Append"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®¢æˆ·ç«¯å®ç°çš„éš¾ç‚¹åªæœ‰ä¸€ä¸ªï¼šå®ç°å¿«é€Ÿå®šä½leader</p>
<p>å®¢æˆ·ç«¯æ‰€çŸ¥é“çš„æœåŠ¡å™¨ID servers []*labrpc.ClientEnd ä¸æœåŠ¡å™¨è‡ªå·±è®¤çŸ¥ä½“ç³»é‡Œçš„æœåŠ¡å™¨IDå®Œå…¨æ²¡æœ‰å…³ç³»  </p>
<p>å®¢æˆ·ç«¯æƒ³è¦è§£ææœåŠ¡ç«¯å‘é€å›æ¥çš„LeaderIdç©¶ç«Ÿå¯¹åº”è‡ªå·±æœ¬åœ°serveræ•°ç»„é‡Œçš„å“ªä¸ªä¸‹æ ‡ï¼Œå°±éœ€è¦å»ºç«‹ä¸€ä¸ªæ˜ å°„è¡¨ï¼ˆåœ°å€å˜æ¢è¡¨ï¼‰</p>
<p>æˆ‘ä¹Ÿæ˜¯ç”¨ä¸€ä¸ªç¬¨æ–¹æ³•æ¥å®ç°ï¼ŒæœåŠ¡å™¨æ¯æ¬¡å“åº”éƒ½åŒæ—¶å¸¦ä¸Šè‡ªå·±çš„indexå’Œå®ƒæ‰€çŸ¥é“çš„leaderIdï¼Œå®¢æˆ·ç«¯æ ¹æ®indexæ›´æ–°æ˜ å°„è¡¨ï¼Œç„¶åæ£€æŸ¥leaderIdåœ¨æ˜ å°„è¡¨é‡Œæœ‰æ²¡æœ‰è¢«æ›´æ–°è¿‡ï¼Œæ²¡æœ‰å°±å‘ä¸‹ä¸€ä¸ªæœåŠ¡å™¨ç»§ç»­å‘ï¼Œæœ‰å°±å¥½åŠäº†ï¼Œä¸‹æ¬¡å‘è¯·æ±‚ç›´è¾¾leader</p>
<p>å½“ç„¶ï¼ŒæœåŠ¡å™¨è¿”å›çš„leaderIdå¹¶éæ˜¯é‚£ä¹ˆçš„æœ‰å‚è€ƒä»·å€¼ï¼Œè€ƒè™‘åˆ°ç½‘ç»œåˆ†åŒºçš„æƒ…å†µï¼Œåœ¨ä¸€ä¸ªå°åˆ†åŒºä¸­followerä»¬è·Ÿå®šäº†ä¸€ä¸ªå°leaderï¼Œå¯¼è‡´å®¢æˆ·ç«¯å¾—åˆ°äº†å‡leaderIdï¼Œåç»­æ€ä¹ˆå‘é€è¯·æ±‚éƒ½å¾—ä¸åˆ°å›åº”</p>
<p>æˆ‘çš„å¤„ç†æ–¹æ³•æ˜¯åªå¯¹åŒä¸€ä¸ªleaderé‡è¯•5æ¬¡ï¼Œå†æœ‰ä¸‹æ¬¡å°±æ¢äººï¼æƒ¯ä¸äº†ä¸€ç‚¹</p>
<h4 id="æœåŠ¡ç«¯ä»£ç "><a href="#æœåŠ¡ç«¯ä»£ç " class="headerlink" title="æœåŠ¡ç«¯ä»£ç "></a>æœåŠ¡ç«¯ä»£ç </h4><p>çº¿æ€§ä¸€è‡´çš„è¯»è¯·æ±‚å¤„ç†ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>args <span class="token operator">*</span>GetArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>GetReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your code here.</span>
	reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">"i should not with ok symble"</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
	reply<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetleaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>ServerId <span class="token operator">=</span> kv<span class="token punctuation">.</span>me

	<span class="token comment">//åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯leader</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am leader", kv.me)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am not leader ,leader is [%d]", kv.me, reply.LeaderId)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//åˆ¤æ–­è‡ªå·±æœ‰æ²¡æœ‰ä»é‡å¯ä¸­æ¢å¤å®Œæ¯•çŠ¶æ€æœº</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span>IisBack <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [recovering] reject a [Get]ğŸ”° args[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
		kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span>
			OpType<span class="token punctuation">:</span> emptyT<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	readLastIndex <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	term <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//éœ€è¦å‘é€ä¸€è½®å¿ƒè·³è·å¾—å¤§å¤šæ•°å›å¤ï¼Œåªæ˜¯ä¸ºäº†ç¡®å®šæ²¡æœ‰ä¸€ä¸ªä»»æœŸæ›´åŠ æ–°çš„leaderï¼Œä¿è¯è‡ªå·±çš„æ•°æ®ä¸æ˜¯è„çš„</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">CheckIfDepose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//return falseè¡¨æ˜è‡ªå·±æ˜¯åˆæ³•leader</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//è·Ÿraftå±‚ä¹‹é—´çš„åŒæ­¥é—®é¢˜ï¼Œraftåˆšå½“é€‰leaderçš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰</span>

	<span class="token comment">//ç›´æ¥è¿”å›</span>
	value<span class="token punctuation">,</span> find <span class="token operator">:=</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> find <span class="token punctuation">{</span>
		<span class="token keyword">if</span> kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">&gt;=</span> readLastIndex <span class="token operator">&amp;&amp;</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> term <span class="token operator">==</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
			reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> value
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [ok] lastAppliedIndex[%d] readLastIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> readLastIndex<span class="token punctuation">)</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [Ok] the get args[%v] reply[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
			<span class="token comment">// DPrintf("server [%d] [Get] [ErrWaitForRecover] kv.lastAppliedIndex &lt; readLastIndex args[%v] reply[%v]", kv.me, *args, *reply)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [NoKey] the get args[%v] reply[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [map] -&gt; %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>kv.lastAppliedIndex &gt;= readLastIndex &amp;&amp; kv.rf.GetLeader() &amp;&amp; term == kv.rf.GetTerm()</p>
<p>å®ç°å¥½è¿™ä¸ªåˆ¤æ–­åŸºæœ¬å°±èƒ½è§£å†³è¯»æ“ä½œçº¿æ€§ä¸€è‡´äº†</p>
<p>Putå’ŒAppendæ“ä½œçš„çº¿æ€§ä¸€è‡´æ€§å®ç°ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>args <span class="token operator">*</span>PutAppendArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>PutAppendReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Your code here.</span>
	reply<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetleaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
	reply<span class="token punctuation">.</span>ServerId <span class="token operator">=</span> kv<span class="token punctuation">.</span>me
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am leader", kv.me)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am not leader ,leader is [%d]", kv.me, reply.LeaderId)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	op <span class="token operator">:=</span> Op<span class="token punctuation">{</span>
		ClientId<span class="token punctuation">:</span> args<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>
		Offset<span class="token punctuation">:</span>   args<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
		Key<span class="token punctuation">:</span>      args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>    args<span class="token punctuation">.</span>Value<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> args<span class="token punctuation">.</span>Op <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token string">"Put"</span><span class="token punctuation">:</span>
		op<span class="token punctuation">.</span>OpType <span class="token operator">=</span> putT
	<span class="token keyword">case</span> <span class="token string">"Append"</span><span class="token punctuation">:</span>
		op<span class="token punctuation">.</span>OpType <span class="token operator">=</span> appendT
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unreconize put append args.Op:%s"</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>Op<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// DPrintf("server [%d] [PutAppend] ğŸ“¨receive a args[%v]", kv.me, *args)</span>
	<span class="token comment">// defer DPrintf("server [%d] [PutAppend] ğŸ“¨complete a args[%v]", kv.me, *args)</span>
	<span class="token comment">//startå‰éœ€è¦æŸ¥çœ‹æœ¬åœ°logç¼“å­˜æ˜¯å¦æœ‰seq</span>

	<span class="token comment">//è¿™é‡Œé€šè¿‡ç¼“å­˜æäº¤ï¼Œä¸€æ–¹é¢æé«˜äº†kvserveråº”å¯¹ç½‘ç»œé”™è¯¯çš„å›å¤é€Ÿåº¦ï¼Œå¦ä¸€æ–¹é¢è¿›è¡Œäº†ç¬¬ä¸€å±‚çš„é‡å¤æ£€æµ‹</span>
	<span class="token comment">//ä½†æ˜¯æ³¨æ„å¯èƒ½åŒæ—¶æœ‰ä¸¤ä¸ªç›¸åŒçš„getDuplicateMapé€šè¿‡è¿™é‡Œ</span>

	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">&lt;</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//æ²¡æœ‰åœ¨æœ¬åœ°ç¼“å­˜å‘ç°è¿‡seq</span>
	<span class="token comment">//å‘raftæäº¤æ“ä½œ</span>
	index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">SendAppendEntriesToAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] submit to raft key[%v] value[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token comment">//æäº¤åé˜»å¡ç­‰å¾…</span>
	<span class="token comment">//ç­‰å¾…applyChæ‹¿åˆ°å¯¹åº”çš„indexï¼Œæ¯”å¯¹seqæ˜¯å¦æ­£ç¡®</span>
	startWait <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> index <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token punctuation">{</span>
			<span class="token comment">//åŒé‡é˜²é‡å¤</span>
			<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">&lt;</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
				reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// DPrintf("server [%d] [PutAppend] appliedIndex available :PutAppend index[%d] lastAppliedIndex[%d]", kv.me, index, kv.lastAppliedIndex)</span>
			<span class="token keyword">if</span> term <span class="token operator">!=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">//termä¸åŒ¹é…äº†ï¼Œè¯´æ˜æœ¬æ¬¡æäº¤å¤±æ•ˆ</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span> <span class="token comment">//termåŒ¹é…ï¼Œè¯´æ˜æœ¬æ¬¡æäº¤ä¸€å®šæ˜¯æœ‰æ•ˆçš„</span>

			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
			<span class="token comment">// DPrintf("server [%d] [PutAppend] success args.index[%d], args[%v] reply[%v]", kv.me, index, *args, *reply)</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span>
				reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">//è¶…è¿‡2sæ²¡ç­‰åˆ°applychï¼Œé‚£å°±è¿”å›wrong</span>
		<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startWait<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">500</span> <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [PutAppend] fail [time out] args.index[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸è¦å¹»æƒ³åƒåœ¨Lab2é‡Œå®ç°çš„é‚£æ ·ï¼Œåœ¨serverå“åº”clientçš„æ—¶å€™é€šè¿‡ç®€å•çš„ClientIdå’ŒOffsetæ¯”è¾ƒå°±èƒ½æå®šé‡å¤çš„éå®‰å…¨éå¹‚ç­‰è¯·æ±‚</p>
<p>å¤šæœåŠ¡ç«¯çš„æƒ…å†µä¸‹ï¼Œå¯¹äºæ–°leaderçš„duplicateMapï¼Œè¿™é¡¹å€¼åªä¿éšœæœ€ç»ˆä¸€è‡´æ€§ï¼Œå¹¶ä¸ä¸€ä¿éšœä»»ä½•æ—¶åˆ»éƒ½æ˜¯æœ€æ–°çš„å¼ºä¸€è‡´æ€§ï¼Œæ‰€ä»¥è¿™é¡¹åˆ¤æ–­æ”¾åœ¨clientå’Œserverä¹‹é—´æ˜¯ä¸èƒ½ç™¾åˆ†ç™¾ä¿è¯æ•°æ®åº“å®‰å…¨çš„ï¼Œè¿˜éœ€è¦åœ¨serverå±‚å’Œraftå±‚ä¹‹é—´å®ç°å»é‡ã€‚</p>
<p>ä¸è¿‡è¿™æ®µä»£ç æ”¾åœ¨è¿™é‡Œç¡®å®æœ‰æ„ä¹‰çš„ï¼Œç½‘ç»œæ··ä¹±çš„æƒ…å†µä¸‹å®ƒç¡®å®ä¸èƒ½ç™¾åˆ†ç™¾è§£å†³é—®é¢˜ï¼Œä½†åœ¨ç½‘ç»œä¸€åˆ‡æ­£å¸¸çš„æ—¶å€™å®ƒè¿˜æ˜¯èƒ½èµ·åˆ°ä½œç”¨çš„</p>
<p>å¦‚ä½•å®ç°serverå±‚å’Œraftå±‚ä¹‹é—´çš„å»é‡ï¼Ÿæ ¹æ®logä¸­ä¿å­˜çš„clientIndexå’ŒOfferã€‚</p>
<p>è¿™ä¸¤é¡¹å€¼ç»è¿‡raftè½¬æ‰‹åå†æ¬¡å›åˆ°serverï¼Œé‚£æ„ä¹‰å¯å°±å¤§äº†ï¼Œå› ä¸ºå®ƒå€ŸåŠ©raftå±‚å®ç°äº†å¼ºä¸€è‡´æ€§ï¼Œå³å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šï¼Œlogæ˜¯çº¿æ€§ä¸€è‡´çš„ï¼Œæ‰€æœ‰æœåŠ¡å™¨çš„logé¡ºåºéƒ½ä¸€æ¨¡ä¸€æ ·</p>
<p>å¤„ç†raftå±‚æäº¤logçš„ä»£ç ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">/</span> state machine
<span class="token comment">// å°†valueé‡æ–°è½¬æ¢ä¸º Opï¼Œæ·»åŠ åˆ°æœ¬åœ°kvMapä¸­</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">HandleApplych</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> raft_type <span class="token operator">:=</span> <span class="token operator">&lt;-</span>kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> raft_type<span class="token punctuation">.</span>CommandValid <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span><span class="token function">HandleApplychCommand</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span><span class="token function">checkIfExcExccdLog</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">=</span> raft_type<span class="token punctuation">.</span>CommandIndex
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> raft_type<span class="token punctuation">.</span>SnapshotValid <span class="token punctuation">{</span>
				<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“· server [%d] receive raftSnapshotIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> raft_type<span class="token punctuation">.</span>SnapshotIndex<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span><span class="token function">HandleApplychSnapshot</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Unrecordnized applyArgs type"</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">HandleApplychCommand</span><span class="token punctuation">(</span>raft_type raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	op_type<span class="token punctuation">,</span> ok <span class="token operator">:=</span> raft_type<span class="token punctuation">.</span>Command<span class="token punctuation">.</span><span class="token punctuation">(</span>Op<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"raft applyArgs.command -&gt; Op å¤±è´¥,raft_type.Command = %v"</span><span class="token punctuation">,</span> raft_type<span class="token punctuation">.</span>Command<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>OpType <span class="token operator">==</span> emptyT <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> op_type<span class="token punctuation">.</span>OpType <span class="token punctuation">{</span>
	<span class="token keyword">case</span> putT<span class="token punctuation">:</span>
		<span class="token comment">//æ›´æ–°çŠ¶æ€æœº</span>
		<span class="token comment">//æœ‰å¯èƒ½æœ‰å¤šä¸ªstarté‡å¤æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸€æ­¥è¦æ£€éªŒé‡å¤</span>
		<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"â›”server [%d] [Put] [%v] lastapplied[%v]find in the cache and discard %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
			Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
			Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> op_type<span class="token punctuation">.</span>Value
		<span class="token comment">// DPrintf("server [%d] [Update] [Put]-&gt;[%s,%s] [map] -&gt; %v", kv.me, op_type.Key, op_type.Value, kv.kvMap)</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Update] [Put]-&gt;[%s : %s] "</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token keyword">case</span> appendT<span class="token punctuation">:</span>
		<span class="token comment">//æ›´æ–°çŠ¶æ€æœº</span>
		<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"â›”server [%d] [Append] [%v] lastapplied[%v]find in the cache and discard %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
			Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
			Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">+=</span> op_type<span class="token punctuation">.</span>Value
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Update] [Append]-&gt;[%s : %s]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token keyword">case</span> getT<span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æ—¥å¿—ä¸­ä¸åº”è¯¥å‡ºç°getType"</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æ—¥å¿—ä¸­å‡ºç°æœªçŸ¥optype = [%d]"</span><span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>OpType<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å»é‡ä»£ç çš„åŸç†è·ŸLab2ä¸­å®ç°çš„å»é‡åŸç†æ˜¯ä¸€è‡´çš„</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
	Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
	Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Part-B-Key-value-service-with-snapshots-hard"><a href="#Part-B-Key-value-service-with-snapshots-hard" class="headerlink" title="Part B: Key/value service with snapshots (hard)"></a>Part B: Key/value service with snapshots (hard)</h4><p>æœ¬æ¬¡å®éªŒå¢åŠ äº†å¯¹raftStateå¤§å°çš„é™åˆ¶ï¼Œå½“raftå±‚çš„logæ•°é‡æ¥è¿‘é™åˆ¶çš„æ—¶å€™ï¼Œserverå±‚å°±å‘raftå‘å‡ºsnapshotå‘½ä»¤ï¼Œç„¶åå°†serverå±‚çš„	kvMap duplicateMapè¿™ä¸¤é¡¹æ”¾å…¥snapshotDateé‡Œè®©raftå¸®å¿™æŒä¹…åŒ–ã€‚</p>
<p>ç”±äºsnapshotæˆªæ–­æ—¥å¿—çš„æ•ˆæœï¼ŒduplicateMapå¦‚æœä¸åŒæ­¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œå¾ˆæœ‰å¯èƒ½å› ä¸ºç¼ºå°‘logè€Œæ— æ³•æ­£ç¡®å»é‡</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿå¾ˆç®€å•ï¼Œä¸¤ä¸ªé‡è¯»çš„Putè¯·æ±‚ï¼Œä¸€ä¸ªåœ¨å› ä¸ºsnapshotè€Œæˆªæ–­ä¸¢å¼ƒçš„logä¸­ï¼Œå¦ä¸€ä¸ªåœ¨snpashotIndexä¹‹å</p>
<p>serverå±‚å’Œraftå±‚ä¹‹é—´å»é‡çš„æ—¶å€™ï¼ŒduplicateMapæ— æ³•ç¼“å­˜åˆ°å‰ä¸€ä¸ªPutè¯·æ±‚ï¼Œä»è€Œå…è®¸ä¸‹ä¸€ä¸ªé‡å¤çš„putè¯·æ±‚è¢«åº”ç”¨åˆ°æ•°æ®åº“ä¸­</p>
</blockquote>
<p>ä»£ç å®ç°ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ä¸»åŠ¨å¿«ç…§,æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½åœ¨è‡ªå·±logè¶…æ ‡çš„æ—¶å€™å¯åŠ¨å¿«ç…§</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">checkIfNeedSnapshot</span><span class="token punctuation">(</span>spanshotindex <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">IfNeedExceedLog</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>maxraftstate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span> <span class="token comment">//éœ€è¦è¿›è¡Œå¿«ç…§äº†</span>

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] need snapshot limit[%d] curRaftStatesize[%d] snapshotIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>maxraftstate<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>persister<span class="token punctuation">.</span><span class="token function">RaftStateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanshotindex<span class="token punctuation">)</span>
	<span class="token comment">//é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹è‡ªå·±çš„çŠ¶æ€æœºåº”ç”¨åˆ°äº†é‚£ä¸€æ­¥</span>

	<span class="token keyword">var</span> buf bytes<span class="token punctuation">.</span>Buffer
	enc <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"snapshot duplicateMap encoder fail:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"snapshot kvMap encoder fail:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//å°†çŠ¶æ€æœºä¼ äº†è¿›å»</span>
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Snapshot</span><span class="token punctuation">(</span>spanshotindex<span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token comment">// è¢«åŠ¨å¿«ç…§</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">readPersist</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] passive ğŸ“· len of snapshotdate[%d] "</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] before map[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
	r <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	d <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>

	kvMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	duplicateMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>duplicateMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"decode err:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"decode err:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>kvMap <span class="token operator">=</span> kvMap
	kv<span class="token punctuation">.</span>duplicateMap <span class="token operator">=</span> duplicateMap

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] after map[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>ä¸»åŠ¨å¿«ç…§æ˜¯ä¸ºäº†ä¿éšœraftStateçš„å¤§å°ä¸è¦å¤ªå¤§ï¼Œç”±serverä¸»è§‚è°ƒç”¨</p>
<p>è¢«åŠ¨å¿«ç…§æ˜¯raftå±‚ä¸ºäº†è§£å†³ä¸»åŠ¨å¿«ç…§å¸¦æ¥çš„æ—¥å¿—å¤åˆ¶é—®é¢˜è€Œè¿›è¡Œçš„ï¼Œä¸¤è€…æ„ä¹‰ä¸åŒ</p>
</blockquote>
<p>å®éªŒè¿‡ç¨‹è¿˜æœ‰ä¸€äº›ç»†èŠ‚</p>
<p>æƒ³èµ·æ¥å†å†™</p>

  </article>
  <!-- tag -->
  <div class="mt-12 pt-6 border-t border-gray-200">
    
      
        <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 m-1 text-sm rounded-md transition-colors hover:bg-gray-200">
          <a href="/tags/MIT6-5840/">MIT6.5840</a>
        </span>
      
    
  </div>
  <!-- prev and next -->
  <div class="flex justify-between mt-12 pt-6 border-t border-gray-200">
    <div>
      
    </div>
    <div>
      
        <a href="/2024/04/04/mit65840lab3shixian/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          MIT6.5840 Lab3 å®ç°
          <iconify-icon width="20" icon="ri:arrow-right-s-line" data-inline="false"></iconify-icon>
        </a>
      
    </div>
  </div>
  <!-- comment -->
  <div class="article-comments mt-12">
    

  </div>
</section>
<!-- js inspect -->

<script src="/lib/clipboard.min.js"></script>


<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>



<script src="/lib/fancybox/fancybox.umd.min.js"></script>

<script>
  $(document).ready(() => {
    $('.post-content').each(function(i){
      $(this).find('img').each(function(){
        if ($(this).parent().hasClass('fancybox') || $(this).parent().is('a')) return;
        var alt = this.alt;
        if (alt) $(this).after('<span class="fancybox-alt">' + alt + '</span>');
        $(this).wrap('<a class="fancybox-img" href="' + this.src + '" data-fancybox=\"gallery\" data-caption="' + alt + '"></a>')
      });
      $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article' + i);
      });
    });

    Fancybox.bind('[data-fancybox="gallery"]', {
        // options
    })
  })
</script>

<!-- tocbot begin -->

<script src="/lib/tocbot/tocbot.min.js"></script>

<script>
  $(document).ready(() => {
      tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.post-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });
  })
</script>
<!-- tocbot end -->


  </main>
  <footer class="flex flex-col h-40 items-center justify-center text-gray-400 text-sm">
  <!-- busuanzi -->
  
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- Busuanzi Analytics -->
<div class="flex items-center gap-2">
  <span>Visitors</span>
  <span id="busuanzi_value_site_uv"></span>
  <span>Page Views</span>
  <span id="busuanzi_value_site_pv"></span>
</div>
<!-- End Busuanzi Analytics -->


  <!-- copyright -->
  <div class="flex items-center gap-2">
    <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: inherit;">CC BY-NC-SA 4.0</a>
    <span>Â© 2022</span>
    <iconify-icon width="18" icon="emojione-monotone:maple-leaf" ></iconify-icon>
    <a href="https://github.com/xbmlz" target="_blank" rel="noopener noreferrer">xbmlz</a>
  </div>
  <!-- powered by -->
  <div class="flex items-center gap-2">
    <span>Powered by</span>
    <a href="https://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a>
    <span>&</span>
    <a href="https://github.com/xbmlz/hexo-theme-maple" target="_blank" rel="noopener noreferrer">Maple</a>
  </div>

</footer>

  <div class="back-to-top box-border fixed right-6 z-1024 -bottom-20 rounded py-1 px-1 bg-slate-900 opacity-60 text-white cursor-pointer text-center dark:bg-slate-600">
    <span class="flex justify-center items-center text-sm">
      <iconify-icon width="18" icon="ion:arrow-up-c" id="go-top"></iconify-icon>
      <span id="scrollpercent"><span>0</span> %</span>
    </span>
  </div>
  
<script src="/js/main.js"></script>


  <script>
    $(document).ready(function () {
      const mapleCount = "10";
      const speed = "0.5";
      const mapleEl = document.getElementById("maple");
      const maples = Array.from({ length: mapleCount }).map(() => {
        const maple = document.createElement("div");
        const scale = Math.random() * 0.5 + 0.5;
        const offset = Math.random() * 2 - 1;
        const x = Math.random() * mapleEl.clientWidth;
        const y = -Math.random() * mapleEl.clientHeight;
        const duration = 10 / speed;
        const delay = -duration;
        maple.className = "maple";
        maple.style.width = `${24 * scale}px`;
        maple.style.height = `${24 * scale}px`;
        maple.style.left = `${x}px`;
        maple.style.top = `${y}px`;
        maple.style.setProperty("--maple-fall-offset", offset);
        maple.style.setProperty("--maple-fall-height", `${Math.abs(y) + mapleEl.clientHeight}px`);
        maple.style.animation = `fall ${duration}s linear infinite`;
        maple.style.animationDelay = `${delay}s`;
        mapleEl.appendChild(maple)
        return maple
      })
    });
  </script>
  


  <div class="fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden" id="maple"></div>
</body>

</html>
