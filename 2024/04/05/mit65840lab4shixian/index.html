<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"oncelane.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="6.5840 Lab 4: Fault-tolerant Key&#x2F;Value Serviceæœ¬æ¬¡å®éªŒéœ€è¦ç»“åˆLab2å®ç°çš„ç®€æ˜“KVserverå’ŒLab3å®ç°çš„Raftç®—æ³•ï¼Œæœ€åå®ç°ä¸€ä¸ªå…·æœ‰å®¹é”™åŠŸèƒ½çš„åˆ†å¸ƒå¼KVServeré›†ç¾¤ï¼Œéš¾åº¦è¾ƒé«˜">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç°">
<meta property="og:url" content="https://oncelane.github.io/2024/04/05/mit65840lab4shixian/index.html">
<meta property="og:site_name" content="Oncelane">
<meta property="og:description" content="6.5840 Lab 4: Fault-tolerant Key&#x2F;Value Serviceæœ¬æ¬¡å®éªŒéœ€è¦ç»“åˆLab2å®ç°çš„ç®€æ˜“KVserverå’ŒLab3å®ç°çš„Raftç®—æ³•ï¼Œæœ€åå®ç°ä¸€ä¸ªå…·æœ‰å®¹é”™åŠŸèƒ½çš„åˆ†å¸ƒå¼KVServeré›†ç¾¤ï¼Œéš¾åº¦è¾ƒé«˜">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oncelane.github.io/2024/04/05/mit65840lab4shixian/11.png">
<meta property="og:image" content="https://oncelane.github.io/2024/04/05/mit65840lab4shixian/10.png">
<meta property="article:published_time" content="2024-04-05T14:05:54.000Z">
<meta property="article:modified_time" content="2024-04-06T15:49:05.547Z">
<meta property="article:author" content="Xiur">
<meta property="article:tag" content="MIT6.5840">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oncelane.github.io/2024/04/05/mit65840lab4shixian/11.png">


<link rel="canonical" href="https://oncelane.github.io/2024/04/05/mit65840lab4shixian/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://oncelane.github.io/2024/04/05/mit65840lab4shixian/","path":"2024/04/05/mit65840lab4shixian/","title":"MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç°"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç° | Oncelane</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Oncelane</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">é—²æ¥è®°äº‹</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#6-5840-Lab-4-Fault-tolerant-Key-Value-Service"><span class="nav-number">1.</span> <span class="nav-text">6.5840 Lab 4: Fault-tolerant Key&#x2F;Value Service</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Part-A-Key-value-service-without-snapshots-moderate-hard"><span class="nav-number">1.1.</span> <span class="nav-text">Part A: Key&#x2F;value service without snapshots (moderate&#x2F;hard)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89"><span class="nav-number">1.1.1.</span> <span class="nav-text">ç»“æ„ä½“å®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-number">1.1.2.</span> <span class="nav-text">å®¢æˆ·ç«¯ä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-number">1.1.3.</span> <span class="nav-text">æœåŠ¡ç«¯ä»£ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Part-B-Key-value-service-with-snapshots-hard"><span class="nav-number">1.2.</span> <span class="nav-text">Part B: Key&#x2F;value service with snapshots (hard)</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xiur</p>
  <div class="site-description" itemprop="description">å·²å··çš„ä¸ªäººå°ç«™</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://oncelane.github.io/2024/04/05/mit65840lab4shixian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiur">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oncelane">
      <meta itemprop="description" content="å·²å··çš„ä¸ªäººå°ç«™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç° | Oncelane">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç°
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-04-05 22:05:54" itemprop="dateCreated datePublished" datetime="2024-04-05T22:05:54+08:00">2024-04-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-04-06 23:49:05" itemprop="dateModified" datetime="2024-04-06T23:49:05+08:00">2024-04-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="6-5840-Lab-4-Fault-tolerant-Key-Value-Service"><a href="#6-5840-Lab-4-Fault-tolerant-Key-Value-Service" class="headerlink" title="6.5840 Lab 4: Fault-tolerant Key/Value Service"></a>6.5840 Lab 4: Fault-tolerant Key/Value Service</h1><p>æœ¬æ¬¡å®éªŒéœ€è¦ç»“åˆLab2å®ç°çš„ç®€æ˜“KVserverå’ŒLab3å®ç°çš„Raftç®—æ³•ï¼Œæœ€åå®ç°ä¸€ä¸ªå…·æœ‰å®¹é”™åŠŸèƒ½çš„åˆ†å¸ƒå¼KVServeré›†ç¾¤ï¼Œéš¾åº¦è¾ƒé«˜</p>
<span id="more"></span>

<p>Introduction</p>
<blockquote>
<p>In this lab you will build a fault-tolerant key/value storage service using your Raft library from Lab 3. Your key/value service will be a replicated state machine, consisting of several key/value servers that each maintain a database of key/value pairs, as in Lab 2, but additionally use Raft for replication. Your key/value service should continue to process client requests as long as a majority of the servers are alive and can communicate, in spite of other failures or network partitions. After Lab 4, you will have implemented all parts (Clerk, Service, and Raft) shown in the diagram of Raft interactions.</p>
</blockquote>
<p>ç›¸æ¯”äºLab3Raftç®—æ³•çš„å®ç°ï¼Œæœ¬æ¬¡å®éªŒçš„ä»£ç é‡æ›´å°‘ï¼Œé€»è¾‘ä¹Ÿç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯æ—¥å¿—é‡ä¼šå¢é•¿ä¸€ä¸ªæ•°é‡çº§ï¼Œååˆ†ä¸å¥½debugï¼Œå†åŠ ä¸Šä¸€äº›Lab3æµ‹è¯•éƒ½æ— æ³•æµ‹å‡ºæ¥çš„raftå±‚çš„bugï¼Œå¯ä»¥è¯´å®Œå…¨æ˜¯debugåœ°ç‹±äº†ã€‚</p>
<p>æœ¬æ¬¡å®éªŒéœ€è¦å®ç°æˆ‘ä»¬å®ç°ä¸€ä¸ªä¾èµ–äºraftçš„å¤„äºä¸Šå±‚çš„KVserverï¼Œå®ƒæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„Getï¼ŒPutï¼ŒAppendè¯·æ±‚ï¼Œåœ¨å®¢æˆ·ç«¯çœ‹æ¥ï¼ŒKVServeræä¾›çš„æœåŠ¡æ˜¯æ˜¯çº¿æ€§ä¸€è‡´æ€§çš„ï¼Œä¹Ÿå«å¼ºä¸€è‡´æ€§çš„</p>
<p>è¿™é‡Œæœ‰ä¸€ç¯‡æ˜æ™°å„ç§ä¸€è‡´æ€§æ¦‚å¿µçš„æ–‡ç« ï¼Œå…¨é¢è¯¦ç»†æ˜“æ‡‚ï¼Œ<del>å”¯ä¸€ä¸å¥½çš„åœ°æ–¹å°±æ˜¯æˆ‘äº‹åå†™åšå®¢çš„æ—¶å€™æ‰å‘ç°å®ƒğŸ˜­</del></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022248118">https://segmentfault.com/a/1190000022248118</a></p>
</blockquote>
<p>å¦‚æœå°†å®¢æˆ·ç«¯çš„Getæ“ä½œä¹Ÿå†™å…¥æ—¥å¿—ï¼Œç­‰å¾…Getæ—¥å¿—è¢«Raftå±‚æäº¤åå†å“åº”å®¢æˆ·ç«¯ï¼Œæœ¬å®éªŒå®ç°èµ·æ¥ä¼šç®€æ´å¾ˆå¤šï¼Œå®éªŒæŒ‡å¯¼ä¹Ÿæ˜¯è¿™ä¹ˆå»ºè®®çš„ã€‚</p>
<p>ä½†æ˜¯æˆ‘é€‰æ‹©ä¸å°†getè¯·æ±‚å†™å…¥æ—¥å¿—ï¼ˆäººè¦æœ‰è¿½æ±‚</p>
<p>è®ºæ–‡ä¸­æœ‰æåˆ°å¦‚ä½•å®ç°è¿™ç‚¹</p>
<p>1.å³leaderå“åº”Getè¯·æ±‚å‰å…ˆå‘èµ·ä¸€æ¬¡ check quorum ç¯èŠ‚ç¡®ä¿è‡ªå·±æ˜¯åˆæ³•çš„leaderï¼Œæˆ‘é€šè¿‡å¤ç”¨å¿ƒè·³æ¥å®ç°ï¼Œä¸‹é¢ä¼šä»‹ç»</p>
<p>2.è¿˜æœ‰å°±æ˜¯ReadIndexï¼Œè®°å½•æ”¶åˆ°Getè¯·æ±‚é‚£ä¸€åˆ»çš„Raftå±‚çš„CommitIndexå€¼ï¼Œç­‰å¾…åº”ç”¨å±‚ä»raftå±‚æ”¶åˆ°çš„logçš„indexå€¼ç­‰äºReadIndexå€¼çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¿”å›æ­¤æ¬¡Getè¯·æ±‚äº†ã€‚</p>
<p>é‚£ä¹ˆå°±å¯ä»¥å¼€å§‹å†™ä»£ç äº†ï¼š</p>
<h2 id="Part-A-Key-value-service-without-snapshots-moderate-hard"><a href="#Part-A-Key-value-service-without-snapshots-moderate-hard" class="headerlink" title="Part A: Key/value service without snapshots (moderate/hard)"></a>Part A: Key/value service without snapshots (moderate/hard)</h2><h3 id="ç»“æ„ä½“å®šä¹‰"><a href="#ç»“æ„ä½“å®šä¹‰" class="headerlink" title="ç»“æ„ä½“å®šä¹‰"></a>ç»“æ„ä½“å®šä¹‰</h3><p>æ—¥å¿—ç»“æ„ä½“çš„å®šä¹‰</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Op <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ClientId <span class="token builtin">int64</span> <span class="token comment">//å®¢æˆ·ç«¯æ ‡è¯†ï¼Œç”¨äºåº”å¯¹é‡å¤è¯·æ±‚</span>
	Offset   <span class="token builtin">int32</span> <span class="token comment">//å®¢æˆ·ç«¯çš„è¯·æ±‚åºåˆ—å·</span>
	OpType   <span class="token builtin">int</span>   <span class="token comment">//è¯·æ±‚/æ“ä½œç±»å‹</span>
	Key      <span class="token builtin">string</span>
	Value    <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	getT <span class="token operator">=</span> <span class="token boolean">iota</span>
	putT
	appendT
	emptyT <span class="token comment">//indicate a empty log only use to update leader commitIndex</span>
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>emptyTæ˜¯ä¸ºäº†å¸®åŠ©leaderæ›´æ–°commitIndexçš„å€¼è€Œä½¿ç”¨çš„</p>
<p>KVServeræˆå‘˜å˜é‡ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> KVServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu      sync<span class="token punctuation">.</span>Mutex
	me      <span class="token builtin">int</span>
	rf      <span class="token operator">*</span>raft<span class="token punctuation">.</span>Raft
	applyCh <span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg
	dead    <span class="token builtin">int32</span> <span class="token comment">// set by Kill()</span>

	maxraftstate <span class="token builtin">int</span> <span class="token comment">// snapshot if log grows this big</span>

	persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>Persister

	lastAppliedIndex <span class="token builtin">int</span> <span class="token comment">//æœ€è¿‘æ·»åŠ åˆ°çŠ¶æ€æœºä¸­çš„raftå±‚çš„logçš„index</span>
	
	lastIncludeIndex <span class="token builtin">int</span> 	<span class="token comment">//lastInclude</span>
	
	kvMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//log state machine</span>

	<span class="token comment">//ç¼“å­˜çš„log, seq-&gt;index,reply</span>
	duplicateMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType

<span class="token punctuation">}</span>

<span class="token keyword">type</span> duplicateType <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Offset <span class="token builtin">int32</span>
	Reply  <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">StartKVServer</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">,</span> me <span class="token builtin">int</span><span class="token punctuation">,</span> persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>Persister<span class="token punctuation">,</span> maxraftstate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>KVServer <span class="token punctuation">{</span>
	<span class="token comment">// call labgob.Register on structures you want</span>
	<span class="token comment">// Go's RPC library to marshall/unmarshall.</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	kv <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>KVServer<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>me <span class="token operator">=</span> me
	kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">=</span> maxraftstate
	kv<span class="token punctuation">.</span>persister <span class="token operator">=</span> persister
	<span class="token comment">// You may need initialization code here.</span>

	kv<span class="token punctuation">.</span>applyCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>rf <span class="token operator">=</span> raft<span class="token punctuation">.</span><span class="token function">Make</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> me<span class="token punctuation">,</span> persister<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">)</span>

	<span class="token comment">// You may need initialization code here.</span>
	kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">=</span> <span class="token number">0</span>
	kv<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token comment">//state machine</span>
	kv<span class="token punctuation">.</span>kvMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token comment">//log</span>
	kv<span class="token punctuation">.</span>duplicateMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">)</span>

	kv<span class="token punctuation">.</span><span class="token function">readPersist</span><span class="token punctuation">(</span>persister<span class="token punctuation">.</span><span class="token function">ReadSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">HandleApplych</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// go kv.HandleSnapshot()</span>
	<span class="token comment">// go kv.handleGetTask()</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] restart"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
	<span class="token keyword">return</span> kv
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºä»€ä¹ˆéœ€è¦emptyTï¼Ÿ</p>
<p>å›é¡¾commitIndexæ›´æ–°çš„é™åˆ¶ï¼Œleaderè‡³å°‘åœ¨è‡ªå·±ä»»æœŸå†…è¾¾æˆä¸€æ¡æ—¥å¿—çš„å¤§å¤šæ•°å…±è¯†ï¼Œæ‰èƒ½å¤Ÿæ›´æ–°è‡ªå·±çš„commitIndexï¼Œå…¶ä»–followeræ‰èƒ½æ ¹æ®leaderå¿ƒè·³çš„LeaderCommitæ›´æ–°è‡ªå·±çš„commitIndex</p>
<p>å¦‚æœè¿™æ®µæ—¶é—´é‡Œå®¢æˆ·ç«¯ç‹‚å‘Getè¯·æ±‚ï¼ˆGetè¯·æ±‚ä¸å†™å…¥æ—¥å¿—ï¼‰æ²¡ä¸€ä¸ªå®¢æˆ·ç«¯å‘Putå’ŒAppendè¯·æ±‚ï¼Œé‚£ä¹ˆleaderçš„commmitIndexå°±å®Œå…¨å¡ä½äº†ï¼Œåº”ç”¨å±‚æ°¸è¿œæ”¶ä¸åˆ°æ–°çš„applylog</p>
<blockquote>
<p>é‚£ä¸ºå•¥lab3å®éªŒçš„å„ç§å˜æ€æµ‹è¯•å°±è¡¨ç°çš„å¥½å¥½çš„ï¼Œç°åœ¨åˆä¸è¡Œäº†æï¼Ÿ</p>
</blockquote>
<p>å› ä¸ºæµ‹è¯•ä»£ç æ£€æŸ¥é€šè¿‡startï¼ˆï¼‰æäº¤æ—¥å¿—ï¼Œå½“å®ƒå‘ç°æäº¤çš„è¿™æ¡logæ²¡æœ‰åœ¨å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šè¾¾åˆ°å…±è¯†çš„æ—¶å€™ï¼Œæˆ–è€…è¯´è¾¾æˆå…±è¯†çš„è¿™ä¸ªIndexæ˜¯ä¸æ˜¯å®ƒæ‰€æäº¤çš„logçš„æ—¶å€™ï¼Œå®ƒä¼šè¿›è¡Œ5æ¬¡é‡è¯•ï¼Œï¼ˆå½“ç„¶äº†å¦‚æœæµ‹è¯•ç¨‹åºä¿è¯åœ¨ç½‘ç»œå·²ç»æ¢å¤æ­£å¸¸ä¸€æ®µæ—¶é—´ä¹‹åå†æäº¤æ—¥å¿—ï¼Œè¿™æ—¶å€™æµ‹è¯•ç¨‹åºæ£€æŸ¥åˆ°Indexä¸Šä¸æ˜¯å®ƒæ‰€æäº¤çš„æ—¥å¿—ï¼Œé‚£ç›´æ¥å°±Fail Testäº†ï¼‰ä¿è¯leaderä¸€ç›´æœ‰logå¯ä»¥æ·»åŠ ï¼Œleaderå¯ä»¥åœ¨è¿™äº”æ¬¡é‡è¯•æ—¶é—´å†…æ›´æ–°å¥½è‡ªå·±çš„commitIndexï¼Œä»è€Œå°†åº”ç”¨å±‚æƒ³è¦çš„</p>
<p>æ—¢ç„¶åœ¨Lab4æ²¡æœ‰æµ‹è¯•ç¨‹åºå¸®æˆ‘ä»¬åšæ·»åŠ logè¿™ä»¶äº‹ï¼Œæˆ‘ä»¬å°±è‡ªå·±æ¥ï¼Œ</p>
<p>åœ¨raftå±‚å¤šè®¾ç½®ä¸¤ä¸ªæ ‡å¿—ï¼ŒIisBackå¦‚æœä¸ºtrueï¼šè¡¨æ˜leaderåœ¨å½“å‰ä»»æœŸå†…è¾¾æˆcommitIndexçš„æ›´æ–°ï¼Œå¹¶ä¸”å°†è¿™æ¡å±äºå½“å‰ä»»æœŸçš„æ—¥å¿—é€šè¿‡applyChå‘é€ç»™äº†serverå±‚</p>
<p>IisBackIndexè¾…åŠ©IisBackæ›´æ–°</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Raft <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">//Man,what can i say?</span>
	IisBack      <span class="token builtin">bool</span>
	IisBackIndex <span class="token builtin">int</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>leaderæ¯æ¬¡åˆšåˆšå½“é€‰çš„æ—¶å€™è®¾ç½®IisBackä¸ºfalseï¼Œæ›´æ–°commitIndexçš„æ—¶å€™è®¾ç½®IisBackIndex = commitIndexï¼Œå½“applyIndexå¤§äºç­‰äºIisBackIndexæ—¶ï¼Œå°±å¯ä»¥è®¾ç½®IisBackä¸ºtrueäº†</p>
<p>leaderæ¯æ¬¡å“åº”è¯»è¯·æ±‚å‰éœ€è¦æ£€æŸ¥Iisbackæ˜¯å¦ä¸ºTrueï¼Œè‹¥ä¸ºfalseï¼Œåˆ™éœ€è¦é€šè¿‡startï¼ˆï¼‰å‘raftå±‚æäº¤ä¸€ä¸ªOpType = emptyT çš„ç©ºæ—¥å¿—ï¼Œé€šçŸ¥clientè¿‡ä¸€ä¼šå†æ¥å°è¯•ï¼Œç­‰å¾…å½“å‰leaderå®ŒæˆåŒæ­¥</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//åˆ¤æ–­è‡ªå·±æœ‰æ²¡æœ‰ä»é‡å¯ä¸­æ¢å¤å®Œæ¯•çŠ¶æ€æœº</span>
<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span>IisBack <span class="token punctuation">{</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [recovering] reject a [Get]ğŸ”° args[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span>
		OpType<span class="token punctuation">:</span> emptyT<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="å®¢æˆ·ç«¯ä»£ç "><a href="#å®¢æˆ·ç«¯ä»£ç " class="headerlink" title="å®¢æˆ·ç«¯ä»£ç "></a>å®¢æˆ·ç«¯ä»£ç </h3><p>å®¢æˆ·ç«¯ç»“æ„ä½“å®šä¹‰ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Clerk <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd
	<span class="token comment">// You will have to modify this struct.</span>
	nextSendLocalId <span class="token builtin">int</span>
	LatestOffset    <span class="token builtin">int32</span>
	clientId        <span class="token builtin">int64</span>
	cTos            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	sToc            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®¢æˆ·ç«¯å‘é€è¯·æ±‚é€»è¾‘ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	max <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">62</span><span class="token punctuation">)</span>
	bigx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> max<span class="token punctuation">)</span>
	x <span class="token operator">:=</span> bigx<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">MakeClerk</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">)</span> <span class="token operator">*</span>Clerk <span class="token punctuation">{</span>
	ck <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Clerk<span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>servers <span class="token operator">=</span> servers
	<span class="token comment">// You'll have to add code here.</span>
	ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>LatestOffset <span class="token operator">=</span> <span class="token number">1</span>
	ck<span class="token punctuation">.</span>clientId <span class="token operator">=</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>cTos <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>sToc <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ck<span class="token punctuation">.</span>cTos <span class="token punctuation">{</span>
		ck<span class="token punctuation">.</span>cTos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> ck
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token comment">// You will have to modify this function.</span>

	args <span class="token operator">:=</span> GetArgs<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>
		ClientId<span class="token punctuation">:</span>     ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>
		LatestOffset<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	count <span class="token operator">:=</span> <span class="token number">0</span>
	lastSendLocalId <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">==</span> lastSendLocalId <span class="token punctuation">{</span>
			count<span class="token operator">++</span>
			<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
				count <span class="token operator">=</span> <span class="token number">0</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		reply <span class="token operator">:=</span> GetReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token comment">// DPrintf("clinet [%d] [Get]:send[%d] args[%v]", ck.clientId, ck.nextSendLocalId, args)</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>nextSendLocalId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.Get"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>

		<span class="token comment">//æ ¹æ®replyåˆå§‹åŒ–ä¸€ä¸‹æœ¬åœ°serverè¡¨</span>

		lastSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[lost] args[%v]", ck.clientId, args)</span>
			<span class="token comment">//å¯¹é¢å¤±è”ï¼Œé‚£å°±æ¢ä¸‹ä¸€ä¸ªç»§ç»­å‘</span>
			ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>ServerId<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId

		<span class="token keyword">switch</span> reply<span class="token punctuation">.</span>Err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> OK<span class="token punctuation">:</span>
			ck<span class="token punctuation">.</span>LatestOffset<span class="token operator">++</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[OK] get args[%v] reply[%v]", ck.clientId, args, reply)</span>
			<span class="token keyword">return</span> reply<span class="token punctuation">.</span>Value
		<span class="token keyword">case</span> ErrNoKey<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[ErrNo key] get args[%v]", ck.clientId, args)</span>
			<span class="token keyword">return</span> <span class="token string">""</span>
		<span class="token keyword">case</span> ErrWrongLeader<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [Get]:[ErrWrong LeaderId][%d] get args[%v] reply[%v]", ck.clientId, ck.nextSendLocalId, args, reply)</span>
			<span class="token comment">//å¯¹æ–¹ä¹Ÿä¸çŸ¥é“leader</span>
			<span class="token keyword">if</span> reply<span class="token punctuation">.</span>LeaderId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token comment">//å¯»æ‰¾ä¸‹ä¸€ä¸ª</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">//è®°å½•å¯¹æ–¹è¿”å›çš„ä¸å¯é leaderId</span>
				<span class="token keyword">if</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//ä½†æ˜¯æœ¬åœ°è¿˜æ²¡åˆå§‹åŒ–å‘¢ï¼Œé‚£å°±å¾€ä¸‹ä¸€ä¸ªå‘</span>
					ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//æœ¬åœ°è¿˜çœŸçŸ¥é“ï¼Œé‚£ä¸‹ä¸€ä¸ªå°±å‘å®ƒæ‰€æŒ‡å®šçš„localServerAddress</span>
					ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span>
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> ErrWaitForRecover<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("client [%d] [Get]:[Wait for leader recover]", ck.clientId)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Client [%d] Get reply unknown err [%s](probaly not init)"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">,</span> op <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// You will have to modify this function.</span>
	args <span class="token operator">:=</span> PutAppendArgs<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>        value<span class="token punctuation">,</span>
		Op<span class="token punctuation">:</span>           op<span class="token punctuation">,</span>
		ClientId<span class="token punctuation">:</span>     ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>
		LatestOffset<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	lastSendLocalId <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">==</span> lastSendLocalId <span class="token punctuation">{</span>
			count<span class="token operator">++</span>
			<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
				count <span class="token operator">=</span> <span class="token number">0</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:send[%d] args[%v]", ck.clientId, ck.nextSendLocalId, args)</span>
		reply <span class="token operator">:=</span> PutAppendReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>nextSendLocalId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.PutAppend"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>

		<span class="token comment">//æ ¹æ®replyåˆå§‹åŒ–ä¸€ä¸‹æœ¬åœ°serverè¡¨</span>

		lastSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[lost] args[%v]", ck.clientId, args)</span>
			<span class="token comment">//å¯¹é¢å¤±è”ï¼Œé‚£å°±æ¢ä¸‹ä¸€ä¸ªç»§ç»­å‘</span>
			ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>ServerId<span class="token punctuation">]</span> <span class="token operator">=</span> ck<span class="token punctuation">.</span>nextSendLocalId

		<span class="token keyword">switch</span> reply<span class="token punctuation">.</span>Err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> OK<span class="token punctuation">:</span>
			ck<span class="token punctuation">.</span>LatestOffset<span class="token operator">++</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[OK] args[%v] reply[%v]", ck.clientId, args, reply)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> ErrNoKey<span class="token punctuation">:</span>
			<span class="token comment">// log.Fatalf("Client [%d] [PutAppend]:reply ErrNokey, but should not happend to putAndAppend args", ck.clientId)</span>
		<span class="token keyword">case</span> ErrWrongLeader<span class="token punctuation">:</span>
			<span class="token comment">// DPrintf("clinet [%d] [PutAppend]:[ErrWrong LeaderId][%d] get args[%v] reply[%v]", ck.clientId, ck.nextSendLocalId, args, reply)</span>
			<span class="token comment">//å¯¹æ–¹ä¹Ÿä¸çŸ¥é“leader</span>
			<span class="token keyword">if</span> reply<span class="token punctuation">.</span>LeaderId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token comment">//å¯»æ‰¾ä¸‹ä¸€ä¸ª</span>
				ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">//è®°å½•å¯¹æ–¹è¿”å›çš„ä¸å¯é leaderId</span>
				<span class="token keyword">if</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//ä½†æ˜¯æœ¬åœ°è¿˜æ²¡åˆå§‹åŒ–å‘¢ï¼Œé‚£å°±å¾€ä¸‹ä¸€ä¸ªå‘</span>
					ck<span class="token punctuation">.</span><span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//æœ¬åœ°è¿˜çœŸçŸ¥é“ï¼Œé‚£ä¸‹ä¸€ä¸ªå°±å‘å®ƒæ‰€æŒ‡å®šçš„localServerAddress</span>
					ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> ck<span class="token punctuation">.</span>sToc<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>LeaderId<span class="token punctuation">]</span>
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Client [%d] [PutAppend]:reply unknown err [%s](probaly not init)"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">changeNextSendId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">=</span> <span class="token punctuation">(</span>ck<span class="token punctuation">.</span>nextSendLocalId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span>servers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span><span class="token function">PutAppend</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"Put"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Append</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span><span class="token function">PutAppend</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"Append"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®¢æˆ·ç«¯å®ç°çš„éš¾ç‚¹åªæœ‰ä¸€ä¸ªï¼šå®ç°å¿«é€Ÿå®šä½leader</p>
<p>å®¢æˆ·ç«¯æ‰€çŸ¥é“çš„æœåŠ¡å™¨ID servers []*labrpc.ClientEnd ä¸æœåŠ¡å™¨è‡ªå·±è®¤çŸ¥ä½“ç³»é‡Œçš„æœåŠ¡å™¨IDå®Œå…¨æ²¡æœ‰å…³ç³»  </p>
<p>å®¢æˆ·ç«¯æƒ³è¦è§£ææœåŠ¡ç«¯å‘é€å›æ¥çš„LeaderIdç©¶ç«Ÿå¯¹åº”è‡ªå·±æœ¬åœ°serveræ•°ç»„é‡Œçš„å“ªä¸ªä¸‹æ ‡ï¼Œå°±éœ€è¦å»ºç«‹ä¸€ä¸ªæ˜ å°„è¡¨ï¼ˆåœ°å€å˜æ¢è¡¨ï¼‰</p>
<p>æˆ‘ä¹Ÿæ˜¯ç”¨ä¸€ä¸ªç¬¨æ–¹æ³•æ¥å®ç°ï¼ŒæœåŠ¡å™¨æ¯æ¬¡å“åº”éƒ½åŒæ—¶å¸¦ä¸Šè‡ªå·±çš„indexå’Œå®ƒæ‰€çŸ¥é“çš„leaderIdï¼Œå®¢æˆ·ç«¯æ ¹æ®indexæ›´æ–°æ˜ å°„è¡¨ï¼Œç„¶åæ£€æŸ¥leaderIdåœ¨æ˜ å°„è¡¨é‡Œæœ‰æ²¡æœ‰è¢«æ›´æ–°è¿‡ï¼Œæ²¡æœ‰å°±å‘ä¸‹ä¸€ä¸ªæœåŠ¡å™¨ç»§ç»­å‘ï¼Œæœ‰å°±å¥½åŠäº†ï¼Œä¸‹æ¬¡å‘è¯·æ±‚ç›´è¾¾leader</p>
<p>å½“ç„¶ï¼ŒæœåŠ¡å™¨è¿”å›çš„leaderIdå¹¶éæ˜¯é‚£ä¹ˆçš„æœ‰å‚è€ƒä»·å€¼ï¼Œè€ƒè™‘åˆ°ç½‘ç»œåˆ†åŒºçš„æƒ…å†µï¼Œåœ¨ä¸€ä¸ªå°åˆ†åŒºä¸­followerä»¬è·Ÿå®šäº†ä¸€ä¸ªå°leaderï¼Œå¯¼è‡´å®¢æˆ·ç«¯å¾—åˆ°äº†å‡leaderIdï¼Œåç»­æ€ä¹ˆå‘é€è¯·æ±‚éƒ½å¾—ä¸åˆ°å›åº”</p>
<p>æˆ‘çš„å¤„ç†æ–¹æ³•æ˜¯åªå¯¹åŒä¸€ä¸ªleaderé‡è¯•5æ¬¡ï¼Œå†æœ‰ä¸‹æ¬¡å°±æ¢äººï¼æƒ¯ä¸äº†ä¸€ç‚¹</p>
<h3 id="æœåŠ¡ç«¯ä»£ç "><a href="#æœåŠ¡ç«¯ä»£ç " class="headerlink" title="æœåŠ¡ç«¯ä»£ç "></a>æœåŠ¡ç«¯ä»£ç </h3><p>çº¿æ€§ä¸€è‡´çš„è¯»è¯·æ±‚å¤„ç†ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>args <span class="token operator">*</span>GetArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>GetReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your code here.</span>
	reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">"i should not with ok symble"</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
	reply<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetleaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>ServerId <span class="token operator">=</span> kv<span class="token punctuation">.</span>me

	<span class="token comment">//åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯leader</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am leader", kv.me)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am not leader ,leader is [%d]", kv.me, reply.LeaderId)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//åˆ¤æ–­è‡ªå·±æœ‰æ²¡æœ‰ä»é‡å¯ä¸­æ¢å¤å®Œæ¯•çŠ¶æ€æœº</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span>IisBack <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [recovering] reject a [Get]ğŸ”° args[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
		kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Op<span class="token punctuation">{</span>
			OpType<span class="token punctuation">:</span> emptyT<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	readLastIndex <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	term <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//éœ€è¦å‘é€ä¸€è½®å¿ƒè·³è·å¾—å¤§å¤šæ•°å›å¤ï¼Œåªæ˜¯ä¸ºäº†ç¡®å®šæ²¡æœ‰ä¸€ä¸ªä»»æœŸæ›´åŠ æ–°çš„leaderï¼Œä¿è¯è‡ªå·±çš„æ•°æ®ä¸æ˜¯è„çš„</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">CheckIfDepose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//return falseè¡¨æ˜è‡ªå·±æ˜¯åˆæ³•leader</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//è·Ÿraftå±‚ä¹‹é—´çš„åŒæ­¥é—®é¢˜ï¼Œraftåˆšå½“é€‰leaderçš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰</span>

	<span class="token comment">//ç›´æ¥è¿”å›</span>
	value<span class="token punctuation">,</span> find <span class="token operator">:=</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> find <span class="token punctuation">{</span>
		<span class="token keyword">if</span> kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">&gt;=</span> readLastIndex <span class="token operator">&amp;&amp;</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> term <span class="token operator">==</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
			reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> value
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [ok] lastAppliedIndex[%d] readLastIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> readLastIndex<span class="token punctuation">)</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [Ok] the get args[%v] reply[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWaitForRecover
			<span class="token comment">// DPrintf("server [%d] [Get] [ErrWaitForRecover] kv.lastAppliedIndex &lt; readLastIndex args[%v] reply[%v]", kv.me, *args, *reply)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Get] [NoKey] the get args[%v] reply[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [map] -&gt; %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>kv.lastAppliedIndex &gt;= readLastIndex &amp;&amp; kv.rf.GetLeader() &amp;&amp; term == kv.rf.GetTerm()</p>
<p>å®ç°å¥½è¿™ä¸ªåˆ¤æ–­åŸºæœ¬å°±èƒ½è§£å†³è¯»æ“ä½œçº¿æ€§ä¸€è‡´äº†</p>
<p>Putå’ŒAppendæ“ä½œçš„çº¿æ€§ä¸€è‡´æ€§å®ç°ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>args <span class="token operator">*</span>PutAppendArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>PutAppendReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Your code here.</span>
	reply<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetleaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
	reply<span class="token punctuation">.</span>ServerId <span class="token operator">=</span> kv<span class="token punctuation">.</span>me
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am leader", kv.me)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// DPrintf("server [%d] [info] i am not leader ,leader is [%d]", kv.me, reply.LeaderId)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	op <span class="token operator">:=</span> Op<span class="token punctuation">{</span>
		ClientId<span class="token punctuation">:</span> args<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>
		Offset<span class="token punctuation">:</span>   args<span class="token punctuation">.</span>LatestOffset<span class="token punctuation">,</span>
		Key<span class="token punctuation">:</span>      args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>    args<span class="token punctuation">.</span>Value<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> args<span class="token punctuation">.</span>Op <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token string">"Put"</span><span class="token punctuation">:</span>
		op<span class="token punctuation">.</span>OpType <span class="token operator">=</span> putT
	<span class="token keyword">case</span> <span class="token string">"Append"</span><span class="token punctuation">:</span>
		op<span class="token punctuation">.</span>OpType <span class="token operator">=</span> appendT
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unreconize put append args.Op:%s"</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>Op<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// DPrintf("server [%d] [PutAppend] ğŸ“¨receive a args[%v]", kv.me, *args)</span>
	<span class="token comment">// defer DPrintf("server [%d] [PutAppend] ğŸ“¨complete a args[%v]", kv.me, *args)</span>
	<span class="token comment">//startå‰éœ€è¦æŸ¥çœ‹æœ¬åœ°logç¼“å­˜æ˜¯å¦æœ‰seq</span>

	<span class="token comment">//è¿™é‡Œé€šè¿‡ç¼“å­˜æäº¤ï¼Œä¸€æ–¹é¢æé«˜äº†kvserveråº”å¯¹ç½‘ç»œé”™è¯¯çš„å›å¤é€Ÿåº¦ï¼Œå¦ä¸€æ–¹é¢è¿›è¡Œäº†ç¬¬ä¸€å±‚çš„é‡å¤æ£€æµ‹</span>
	<span class="token comment">//ä½†æ˜¯æ³¨æ„å¯èƒ½åŒæ—¶æœ‰ä¸¤ä¸ªç›¸åŒçš„getDuplicateMapé€šè¿‡è¿™é‡Œ</span>

	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">&lt;</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//æ²¡æœ‰åœ¨æœ¬åœ°ç¼“å­˜å‘ç°è¿‡seq</span>
	<span class="token comment">//å‘raftæäº¤æ“ä½œ</span>
	index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">SendAppendEntriesToAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] submit to raft key[%v] value[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token comment">//æäº¤åé˜»å¡ç­‰å¾…</span>
	<span class="token comment">//ç­‰å¾…applyChæ‹¿åˆ°å¯¹åº”çš„indexï¼Œæ¯”å¯¹seqæ˜¯å¦æ­£ç¡®</span>
	startWait <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> index <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token punctuation">{</span>
			<span class="token comment">//åŒé‡é˜²é‡å¤</span>
			<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">&lt;</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> args<span class="token punctuation">.</span>LatestOffset <span class="token operator">==</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
				reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// DPrintf("server [%d] [PutAppend] appliedIndex available :PutAppend index[%d] lastAppliedIndex[%d]", kv.me, index, kv.lastAppliedIndex)</span>
			<span class="token keyword">if</span> term <span class="token operator">!=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">//termä¸åŒ¹é…äº†ï¼Œè¯´æ˜æœ¬æ¬¡æäº¤å¤±æ•ˆ</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span> <span class="token comment">//termåŒ¹é…ï¼Œè¯´æ˜æœ¬æ¬¡æäº¤ä¸€å®šæ˜¯æœ‰æ•ˆçš„</span>

			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
			<span class="token comment">// DPrintf("server [%d] [PutAppend] success args.index[%d], args[%v] reply[%v]", kv.me, index, *args, *reply)</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span>
				reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">//è¶…è¿‡2sæ²¡ç­‰åˆ°applychï¼Œé‚£å°±è¿”å›wrong</span>
		<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startWait<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">500</span> <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [PutAppend] fail [time out] args.index[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸è¦å¹»æƒ³åƒåœ¨Lab2é‡Œå®ç°çš„é‚£æ ·ï¼Œåœ¨serverå“åº”clientçš„æ—¶å€™é€šè¿‡ç®€å•çš„ClientIdå’ŒOffsetæ¯”è¾ƒå°±èƒ½æå®šé‡å¤çš„éå®‰å…¨éå¹‚ç­‰è¯·æ±‚</p>
<p>å¤šæœåŠ¡ç«¯çš„æƒ…å†µä¸‹ï¼Œå¯¹äºæ–°leaderçš„duplicateMapï¼Œè¿™é¡¹å€¼åªä¿éšœæœ€ç»ˆä¸€è‡´æ€§ï¼Œå¹¶ä¸ä¸€ä¿éšœä»»ä½•æ—¶åˆ»éƒ½æ˜¯æœ€æ–°çš„å¼ºä¸€è‡´æ€§ï¼Œæ‰€ä»¥è¿™é¡¹åˆ¤æ–­æ”¾åœ¨clientå’Œserverä¹‹é—´æ˜¯ä¸èƒ½ç™¾åˆ†ç™¾ä¿è¯æ•°æ®åº“å®‰å…¨çš„ï¼Œè¿˜éœ€è¦åœ¨serverå±‚å’Œraftå±‚ä¹‹é—´å®ç°å»é‡ã€‚</p>
<p>ä¸è¿‡è¿™æ®µä»£ç æ”¾åœ¨è¿™é‡Œç¡®å®æœ‰æ„ä¹‰çš„ï¼Œç½‘ç»œæ··ä¹±çš„æƒ…å†µä¸‹å®ƒç¡®å®ä¸èƒ½ç™¾åˆ†ç™¾è§£å†³é—®é¢˜ï¼Œä½†åœ¨ç½‘ç»œä¸€åˆ‡æ­£å¸¸çš„æ—¶å€™å®ƒè¿˜æ˜¯èƒ½èµ·åˆ°ä½œç”¨çš„</p>
<p>å¦‚ä½•å®ç°serverå±‚å’Œraftå±‚ä¹‹é—´çš„å»é‡ï¼Ÿæ ¹æ®logä¸­ä¿å­˜çš„clientIndexå’ŒOfferã€‚</p>
<p>è¿™ä¸¤é¡¹å€¼ç»è¿‡raftè½¬æ‰‹åå†æ¬¡å›åˆ°serverï¼Œé‚£æ„ä¹‰å¯å°±å¤§äº†ï¼Œå› ä¸ºå®ƒå€ŸåŠ©raftå±‚å®ç°äº†å¼ºä¸€è‡´æ€§ï¼Œå³å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šï¼Œlogæ˜¯çº¿æ€§ä¸€è‡´çš„ï¼Œæ‰€æœ‰æœåŠ¡å™¨çš„logé¡ºåºéƒ½ä¸€æ¨¡ä¸€æ ·</p>
<p>å¤„ç†raftå±‚æäº¤logçš„ä»£ç ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">/</span> state machine
<span class="token comment">// å°†valueé‡æ–°è½¬æ¢ä¸º Opï¼Œæ·»åŠ åˆ°æœ¬åœ°kvMapä¸­</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">HandleApplych</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> raft_type <span class="token operator">:=</span> <span class="token operator">&lt;-</span>kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> raft_type<span class="token punctuation">.</span>CommandValid <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span><span class="token function">HandleApplychCommand</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span><span class="token function">checkIfExcExccdLog</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span>lastAppliedIndex <span class="token operator">=</span> raft_type<span class="token punctuation">.</span>CommandIndex
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> raft_type<span class="token punctuation">.</span>SnapshotValid <span class="token punctuation">{</span>
				<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“· server [%d] receive raftSnapshotIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> raft_type<span class="token punctuation">.</span>SnapshotIndex<span class="token punctuation">)</span>
				kv<span class="token punctuation">.</span><span class="token function">HandleApplychSnapshot</span><span class="token punctuation">(</span>raft_type<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Unrecordnized applyArgs type"</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">HandleApplychCommand</span><span class="token punctuation">(</span>raft_type raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	op_type<span class="token punctuation">,</span> ok <span class="token operator">:=</span> raft_type<span class="token punctuation">.</span>Command<span class="token punctuation">.</span><span class="token punctuation">(</span>Op<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"raft applyArgs.command -&gt; Op å¤±è´¥,raft_type.Command = %v"</span><span class="token punctuation">,</span> raft_type<span class="token punctuation">.</span>Command<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>OpType <span class="token operator">==</span> emptyT <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> op_type<span class="token punctuation">.</span>OpType <span class="token punctuation">{</span>
	<span class="token keyword">case</span> putT<span class="token punctuation">:</span>
		<span class="token comment">//æ›´æ–°çŠ¶æ€æœº</span>
		<span class="token comment">//æœ‰å¯èƒ½æœ‰å¤šä¸ªstarté‡å¤æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸€æ­¥è¦æ£€éªŒé‡å¤</span>
		<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"â›”server [%d] [Put] [%v] lastapplied[%v]find in the cache and discard %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
			Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
			Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> op_type<span class="token punctuation">.</span>Value
		<span class="token comment">// DPrintf("server [%d] [Update] [Put]-&gt;[%s,%s] [map] -&gt; %v", kv.me, op_type.Key, op_type.Value, kv.kvMap)</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Update] [Put]-&gt;[%s : %s] "</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token keyword">case</span> appendT<span class="token punctuation">:</span>
		<span class="token comment">//æ›´æ–°çŠ¶æ€æœº</span>
		<span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"â›”server [%d] [Append] [%v] lastapplied[%v]find in the cache and discard %v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
			Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
			Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">+=</span> op_type<span class="token punctuation">.</span>Value
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] [Update] [Append]-&gt;[%s : %s]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token keyword">case</span> getT<span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æ—¥å¿—ä¸­ä¸åº”è¯¥å‡ºç°getType"</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æ—¥å¿—ä¸­å‡ºç°æœªçŸ¥optype = [%d]"</span><span class="token punctuation">,</span> op_type<span class="token punctuation">.</span>OpType<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å»é‡ä»£ç çš„åŸç†è·ŸLab2ä¸­å®ç°çš„å»é‡åŸç†æ˜¯ä¸€è‡´çš„</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> op_type<span class="token punctuation">.</span>Offset <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>Offset <span class="token punctuation">{</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">[</span>op_type<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> duplicateType<span class="token punctuation">{</span>
	Offset<span class="token punctuation">:</span> op_type<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
	Reply<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Part-B-Key-value-service-with-snapshots-hard"><a href="#Part-B-Key-value-service-with-snapshots-hard" class="headerlink" title="Part B: Key/value service with snapshots (hard)"></a>Part B: Key/value service with snapshots (hard)</h2><p>æœ¬æ¬¡å®éªŒå¢åŠ äº†å¯¹raftStateå¤§å°çš„é™åˆ¶ï¼Œå½“raftå±‚çš„logæ•°é‡æ¥è¿‘é™åˆ¶çš„æ—¶å€™ï¼Œserverå±‚å°±å‘raftå‘å‡ºsnapshotå‘½ä»¤ï¼Œç„¶åå°†serverå±‚çš„	kvMap duplicateMapè¿™ä¸¤é¡¹æ”¾å…¥snapshotDateé‡Œè®©raftå¸®å¿™æŒä¹…åŒ–ã€‚</p>
<p>ç”±äºsnapshotæˆªæ–­æ—¥å¿—çš„æ•ˆæœï¼ŒduplicateMapå¦‚æœä¸åŒæ­¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œå¾ˆæœ‰å¯èƒ½å› ä¸ºç¼ºå°‘logè€Œæ— æ³•æ­£ç¡®å»é‡</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿå¾ˆç®€å•ï¼Œä¸¤ä¸ªé‡è¯»çš„Putè¯·æ±‚ï¼Œä¸€ä¸ªåœ¨å› ä¸ºsnapshotè€Œæˆªæ–­ä¸¢å¼ƒçš„logä¸­ï¼Œå¦ä¸€ä¸ªåœ¨snpashotIndexä¹‹å</p>
<p>serverå±‚å’Œraftå±‚ä¹‹é—´å»é‡çš„æ—¶å€™ï¼ŒduplicateMapæ— æ³•ç¼“å­˜åˆ°å‰ä¸€ä¸ªPutè¯·æ±‚ï¼Œä»è€Œå…è®¸ä¸‹ä¸€ä¸ªé‡å¤çš„putè¯·æ±‚è¢«åº”ç”¨åˆ°æ•°æ®åº“ä¸­</p>
</blockquote>
<p>ä»£ç å®ç°ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ä¸»åŠ¨å¿«ç…§,æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½åœ¨è‡ªå·±logè¶…æ ‡çš„æ—¶å€™å¯åŠ¨å¿«ç…§</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">checkIfNeedSnapshot</span><span class="token punctuation">(</span>spanshotindex <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">IfNeedExceedLog</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>maxraftstate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span> <span class="token comment">//éœ€è¦è¿›è¡Œå¿«ç…§äº†</span>

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] need snapshot limit[%d] curRaftStatesize[%d] snapshotIndex[%d]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>maxraftstate<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>persister<span class="token punctuation">.</span><span class="token function">RaftStateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanshotindex<span class="token punctuation">)</span>
	<span class="token comment">//é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹è‡ªå·±çš„çŠ¶æ€æœºåº”ç”¨åˆ°äº†é‚£ä¸€æ­¥</span>

	<span class="token keyword">var</span> buf bytes<span class="token punctuation">.</span>Buffer
	enc <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>duplicateMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"snapshot duplicateMap encoder fail:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"snapshot kvMap encoder fail:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//å°†çŠ¶æ€æœºä¼ äº†è¿›å»</span>
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Snapshot</span><span class="token punctuation">(</span>spanshotindex<span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token comment">// è¢«åŠ¨å¿«ç…§</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">readPersist</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] passive ğŸ“· len of snapshotdate[%d] "</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] before map[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
	r <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	d <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>

	kvMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	duplicateMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>duplicateType<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>duplicateMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"decode err:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kvMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"decode err:%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>kvMap <span class="token operator">=</span> kvMap
	kv<span class="token punctuation">.</span>duplicateMap <span class="token operator">=</span> duplicateMap

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"server [%d] after map[%v]"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>ä¸»åŠ¨å¿«ç…§æ˜¯ä¸ºäº†ä¿éšœraftStateçš„å¤§å°ä¸è¦å¤ªå¤§ï¼Œç”±serverä¸»è§‚è°ƒç”¨</p>
<p>è¢«åŠ¨å¿«ç…§æ˜¯raftå±‚ä¸ºäº†è§£å†³ä¸»åŠ¨å¿«ç…§å¸¦æ¥çš„æ—¥å¿—å¤åˆ¶é—®é¢˜è€Œè¿›è¡Œçš„ï¼Œä¸¤è€…æ„ä¹‰ä¸åŒ</p>
</blockquote>
<p><img src="/2024/04/05/mit65840lab4shixian/11.png" alt="æµ‹è¯•"></p>
<p><img src="/2024/04/05/mit65840lab4shixian/10.png" alt="å¤šæ¬¡æµ‹è¯•"></p>
<p>å®éªŒè¿‡ç¨‹è¿˜æœ‰ä¸€äº›ç»†èŠ‚</p>
<p>æƒ³èµ·æ¥å†å†™</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MIT6-5840/" rel="tag"># MIT6.5840</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/04/04/mit65840lab3shixian/" rel="prev" title="MIT6.5840 Lab3 å®ç°">
                  <i class="fa fa-angle-left"></i> MIT6.5840 Lab3 å®ç°
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/08/17/xiechengkufcontextxiechengqiehuan/" rel="next" title="åç¨‹åº“-fcontextåç¨‹åˆ‡æ¢">
                  åç¨‹åº“-fcontextåç¨‹åˆ‡æ¢ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Xiur</span>
  </div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
