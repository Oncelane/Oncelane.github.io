<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">




<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

  <meta name="author" content="Xiur">


  <meta name="subtitle" content="é—²æ¥è®°äº‹">


  <meta name="description" content="å·²å··çš„ä¸ªäººå°ç«™">



<title>MIT6.5840 Lab3 å®ç° | Oncelane</title>



<link rel="icon" href="/favicon.png">



<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/nprogress/nprogress.css">



<script src="/lib/jquery.min.js"></script>


<script src="/lib/iconify-icon.min.js"></script>


<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
  };
</script>


<script src="/lib/nprogress/nprogress.js"></script>

<script>
  $(document).ready(() => {
    NProgress.configure({
      showSpinner: false,
    });
    NProgress.start();
    $("#nprogress .bar").css({
      background: "#de7441",
    });
    $("#nprogress .peg").css({
      "box-shadow": "0 0 2px #de7441, 0 0 4px #de7441",
    });
    $("#nprogress .spinner-icon").css({
      "border-top-color": "#de7441",
      "border-left-color": "#de7441",
    });
    setTimeout(function () {
      NProgress.done();
      $(".fade").removeClass("out");
    }, 800);
  });
</script>

<script>
  (function () {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const setting = localStorage.getItem("hexo-color-scheme") || "auto";
    if (setting === "dark" || (prefersDark && setting !== "light"))
      document.documentElement.classList.toggle("dark", true);
    let isDark = document.documentElement.classList.contains("dark");
  })();

  $(document).ready(function () {
    // init icon
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = document.documentElement.classList.contains("dark");
    $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");

    function toggleGiscusTheme() {
      const isDark = document.documentElement.classList.contains("dark");
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          {
            giscus: {
              setConfig: {
                theme: isDark ? "dark" : "light",
              },
            },
          },
          "https://giscus.app"
        );
      }
    }


    // toggle dark mode
    function toggleDark() {
      let isDark = document.documentElement.classList.contains("dark");
      const setting = localStorage.getItem("hexo-color-scheme") || "auto";
      isDark = !isDark;
      document.documentElement.classList.toggle("dark", isDark);
      $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");
      if (prefersDark === isDark) {
        localStorage.setItem("hexo-color-scheme", "auto");
      } else {
        localStorage.setItem("hexo-color-scheme", isDark ? "dark" : "light");
      }
      toggleGiscusTheme();
    }
    $("#toggle-dark").click(toggleDark);

    // listen dark mode change
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        const setting = localStorage.getItem("hexo-color-scheme") || "auto";
        if (setting === "auto") {
          document.documentElement.classList.toggle("dark", e.matches);
          $("#theme-icon").attr(
            "icon",
            e.matches ? "ri:moon-line" : "ri:sun-line"
          );
          toggleGiscusTheme();
        }
      });
  });
</script>




<meta name="generator" content="Hexo 7.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body class="font-sans bg-white dark:bg-zinc-900 text-gray-700 dark:text-gray-200 relative">
  <header class="fixed w-full px-5 py-1 z-10 backdrop-blur-xl backdrop-saturate-150 border-b border-black/5">
  <div class="max-auto">
    <nav class="flex items-center text-base">
      <a href="/" class="group">
        <h2 class="font-medium tracking-tighterp text-l p-2">
          <img class="w-5 mr-2 inline-block transition-transform group-hover:rotate-[30deg]" id="logo" src="/images/logo.svg" alt="Oncelane" />
          Oncelane
        </h2>
      </a>
      <div id="header-title" class="opacity-0 md:ml-2 md:mt-[0.1rem] text-xs font-medium whitespace-nowrap overflow-hidden overflow-ellipsis">
        MIT6.5840 Lab3 å®ç°
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3">
        
          <a class="hidden sm:flex" href="/archives">Posts</a>
        
        
          
            <a class="w-5 h-5 hidden sm:flex" title="Github" target="_blank" rel="noopener" href="https://github.com/xbmlz">
              <iconify-icon width="20" icon="ri:github-line"></iconify-icon>
            </a>
          
        
        <a class="w-5 h-5 hidden sm:flex" title="Github" href="rss2.xml">
          <iconify-icon width="20" icon="ri:rss-line"></iconify-icon>
        </a>
        <a class="w-5 h-5" title="toggle theme" id="toggle-dark">
          <iconify-icon width="20" icon="" id="theme-icon"></iconify-icon>
        </a>
      </div>
      <div class="flex items-center justify-center gap-3 ml-3 sm:hidden">
        <span class="w-5 h-5" aria-hidden="true" role="img" id="open-menu">
          <iconify-icon width="20" icon="carbon:menu" ></iconify-icon>
        </span>
        <span class="w-5 h-5 hidden" aria-hidden="true" role="img" id="close-menu">
          <iconify-icon  width="20" icon="carbon:close" ></iconify-icon>
        </span>
      </div>
    </nav>
  </div>
</header>
<div id="menu-panel" class="h-0 overflow-hidden sm:hidden fixed left-0 right-0 top-12 bottom-0 z-10">
  <div id="menu-content" class="relative z-20 bg-white/80 px-6 sm:px-8 py-2 backdrop-blur-xl -translate-y-full transition-transform duration-300">
    <ul class="nav flex flex-col sm:flex-row text-sm font-medium">
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/archives" class="flex h-12 sm:h-auto items-center">Posts</a>
        </li>
      
    </ul>
  </div>
  <div class="mask bg-black/20 absolute inset-0"></div>
</div>

  <main class="pt-14">
    <!-- css -->

<link rel="stylesheet" href="/lib/fancybox/fancybox.min.css">


<link rel="stylesheet" href="/lib/tocbot/tocbot.min.css">

<!-- toc -->

  <!-- tocbot -->
<nav class="post-toc toc text-sm w-48 relative top-32 right-0 opacity-70 hidden lg:block" style="position: fixed !important;"></nav>


<section class="px-6 max-w-prose mx-auto md:px-0">
  <!-- header -->
  <header class="overflow-hidden pt-6 pb-6 md:pt-12">
    <div class="pt-4 md:pt-6">
      <h1 id="article-title" class="text-[2rem] font-bold leading-snug mb-4 md:mb-6 md:text-[2.6rem]">
        MIT6.5840 Lab3 å®ç°
      </h1>
      <div>
        <section class="flex items-center gap-3 text-sm">
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="carbon-calendar" ></iconify-icon>
            <time>2024-04-05</time>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="ic:round-access-alarm" ></iconify-icon>
            <span>40 min</span>
          </span>
          <span class="text-gray-400">Â·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="icon-park-outline:font-search" ></iconify-icon>
            <span>9.6k words</span>
          </span>
          
        </section>
      </div>
    </div>
  </header>
  <!-- content -->
  <article class="post-content prose m-auto slide-enter-content dark:prose-invert">
    <h1 id="6-5840-Lab-3-Raft"><a href="#6-5840-Lab-3-Raft" class="headerlink" title="6.5840 Lab 3: Raft"></a>6.5840 Lab 3: Raft</h1><p>æœ¬èŠ‚å®éªŒçš„ç›®æ ‡æ˜¯å®ç°Raftåˆ†å¸ƒä¸€è‡´æ€§ç®—æ³•ï¼Œä¸å¿…å¤šè¯´ï¼Œæ­¤èŠ‚ä¸ºæ‰€æœ‰å®éªŒä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ€èƒ½åŠé€€å®éªŒè€…çš„ä¸€èŠ‚</p>
<p>åœ¨å®éªŒå¼€å§‹å‰ä¸€å®šè¦ä»”ç»†é˜…è¯»raftè®ºæ–‡ï¼Œç¼–å†™ä»£ç ä¸­ä¹Ÿè¦åå¤ç¡®è®¤æœ‰æ²¡æœ‰æ­£ç¡®å®ç°è®ºæ–‡ä¸­çš„è§„åˆ™</p>
<p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">extended Raft paper</a></p>
<p>è®ºæ–‡æœ€é‡è¦çš„å›¾</p>
<p><img src="/7.png"></p>
<h3 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h3><p>raftç®—æ³•å°±ä¸åœ¨è¿™è¯¦ç»†ä»‹ç»äº†ï¼Œç›´æ¥é˜…è¯»èµ„æ–™å³å¯</p>
<p>ç”±äºæœ¬äººä¸€å¼€å§‹æ²¡æœ‰ä½¿ç”¨gitè¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œå› æ­¤åˆæ¬¡é€šè¿‡Aã€Bã€Céƒ¨åˆ†çš„ä»£ç éƒ½æ²¡æœ‰å¾—åˆ°ä¿ç•™ï¼Œåªç•™ä¸‹äº†æœ€ç»ˆé€šè¿‡Déƒ¨åˆ†çš„ä»£ç ã€‚</p>
<p>ç”±äºABCDå››ä¸ªpartçš„å®éªŒæ˜¯å¢é‡çš„å…³ç³»ï¼Œåç»­çš„æµ‹è¯•è¿˜ä¼šé—´æ¥åœ°åŠ å¼ºæµ‹è¯•å‰é¢å®ç°çš„å†…å®¹ï¼Œåˆæ¬¡é€šè¿‡æµ‹è¯•é€šè¿‡çš„ä»£ç æ®µå¹¶ä¸ä¸€å®šå°±æ˜¯æ­£ç¡®çš„ï¼Œä¼šåœ¨åç»­çš„ä¸¥æ ¼æµ‹è¯•ä¸­æš´éœ²å‡ºé—®é¢˜ã€‚</p>
<p>æ‰€ä»¥ABCä¸‰éƒ¨åˆ†å°±ä¸æ”¾å…·ä½“ä»£ç äº†ï¼Œä¸»è¦ä»¥ä»‹ç»æˆ‘åœ¨å®éªŒä¸­çš„æ€è·¯ï¼Œé‡åˆ°çš„å‘ä¸ºä¸»ã€‚</p>
<p>å†æ¬¡å¼ºè°ƒçš„æ˜¯ï¼Œå‰æœŸå®ç°çš„raftç®—æ³•å¿…é¡»åšå›ºå¯é ï¼Œå¦åˆ™åé¢å›è¿‡å¤´æ¥ä¿®æ”¹ä¼šéå¸¸çš„ç—›è‹¦ã€‚å»ºè®®ä½¿ç”¨ç¬¬ä¸‰æ–¹æµ‹è¯•è„šæœ¬å¹¶è¡Œè·‘å®éªŒæµ‹è¯•ï¼Œè‡³å°‘ä¹Ÿè¦ä¿è¯èƒ½å¤Ÿè¿ç»­100æ¬¡é€šè¿‡å®éªŒï¼Œç†æƒ³çš„é€šè¿‡æ¬¡æ•°åº”è¯¥æ˜¯åƒæ¬¡å§â€¦é‰´äºæœ¬äººç”µè„‘CPUæ¯”è¾ƒåƒåœ¾ï¼Œä¹Ÿå°±è·‘è·‘ç™¾æ¬¡çº§åˆ«çš„å®éªŒã€‚ï¼ˆåœ¨æ”¥å†™åšå®¢æœŸé—´è¿›è¡Œè¿‡å‡ æ¬¡é«˜å¹¶è¡Œæµ‹è¯•ï¼Œä¹Ÿæ˜¯ç›´æ¥æŠŠè™šæ‹Ÿæœºå¹²å´©æºƒäº†</p>
<h3 id="Part-3A-leader-election-moderate"><a href="#Part-3A-leader-election-moderate" class="headerlink" title="Part 3A: leader election (moderate)"></a>Part 3A: leader election (moderate)</h3><p>ç®€ä»‹ï¼š</p>
<blockquote>
<p>Implement Raft <strong>leader election</strong> and <strong>heartbeats</strong> (AppendEntries RPCs with no log entries). The goal for Part 3A is for a single leader to be elected, for the leader to remain the leader if there are no failures, and for a new leader to take over if the old leader fails or if packets to/from the old leader are lost. Run go test -run 3A to test your 3A code.</p>
</blockquote>
<p>partAéœ€è¦å®ç°<strong>é¢†å¯¼äººé€‰ä¸¾æœºåˆ¶</strong>å’Œ<strong>å¿ƒè·³æœºåˆ¶</strong></p>
<p>åˆ—ä¸¾ä¸€ä¸‹å®éªŒä¸­æ¯”è¾ƒé‡è¦çš„Hintï¼š</p>
<blockquote>
<p>The tester requires that the leader send heartbeat RPCs no more than ten times per second.</p>
</blockquote>
<p>è¿™é¡¹é™åˆ¶å¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆä¸¥æ ¼ï¼Œæ˜¯å¯ä»¥ç›´æ¥è®©leaderå‘é€AEçš„é—´éš”ä¸º90~100msçš„ï¼Œå¿ƒè·³åŒ…æ£€æµ‹æµ‹è¯•åªç»Ÿè®¡æœ€åçš„æ€»RPCæ•°ç›®</p>
<blockquote>
<p>The tester requires your Raft to elect a new leader within five seconds of the failure of the old leader (if a majority of peers can still communicate).</p>
</blockquote>
<p>å¦‚æœå½“å‰ç½‘ç»œç¯å¢ƒæ˜¯å¯ä»¥äº§ç”Ÿé¢†å¯¼äººçš„ï¼ˆå³ä½¿ç½‘ç»œæ•…éšœåˆ†åŒºäº†ï¼Œå¦‚æœæŸä¸ªåˆ†åŒºåŒ…å«äº†åŠæ•°ä»¥ä¸Šçš„æœåŠ¡å™¨ï¼‰ï¼Œè¿™æ˜¯ä¸ªéå¸¸é‡è¦çš„é™åˆ¶ï¼Œåˆæ¬¡å®éªŒå¤§å¤šæ•°çš„é”™è¯¯éƒ½å¯ä»¥è¢«è¿™æ¡è§„åˆ™æ£€æµ‹å‡ºæ¥ï¼ŒåŒæ—¶ï¼Œåœ¨åé¢çš„å®éªŒä¸­ï¼Œè¿™æ¡è§„åˆ™ä¹Ÿè®¸ä¼šæˆä¸ºæœ€éš¾é€¾è¶Šçš„ä¸€é“éš¾å…³</p>
<blockquote>
<p>The paperâ€™s Section 5.2 mentions election timeouts in the range of 150 to 300 milliseconds. Such a range only makes sense if the leader sends heartbeats considerably more often than once per 150 milliseconds (e.g., once per 10 milliseconds). Because the tester limits you tens of heartbeats per second, you will have to use an election timeout larger than the paperâ€™s 150 to 300 milliseconds, but not too large, because then you may fail to elect a leader within five seconds.</p>
</blockquote>
<p>åˆç†è®¾è®¡Election Timeout Intervalï¼Œå®ƒå¿…é¡»æ˜¯ä¸ªéšæœºå€¼ï¼Œä¸‹é™åº”å½“èƒ½å¤Ÿå®¹çº³ä¸‰å››æ¬¡å¿ƒè·³åŒ…çš„æ­£å¸¸å‘é€ï¼Œéšæœºå–å€¼èŒƒå›´ä¸èƒ½å¤ªå°ï¼Œå¦åˆ™é€‰ä¸¾è¿‡ç¨‹å¾ˆéš¾æˆåŠŸã€‚å¤ªå¤§åˆ™å½±å“æ•ˆç‡</p>
<blockquote>
<p><strong>Youâ€™ll need to write code that takes actions periodically or after delays in time. The easiest way to do this is to create a goroutine with a loop that calls time.Sleep(); see the ticker() goroutine that Make() creates for this purpose. Donâ€™t use Goâ€™s time.Timer or time.Ticker, which are difficult to use correctly.</strong></p>
</blockquote>
<p>è¿™æ˜¯ç›¸å½“æœ‰ä»·å€¼çš„å¿ å‘Šï¼Œå»ºè®®ç”¨sleepçš„æ–¹å¼å®ç°è¶…æ—¶æœºåˆ¶ï¼Œæ…ç”¨timerå’Œtickerï¼Œå®ƒä»¬éå¸¸è¢«éš¾ä»¥æ­£ç¡®ä½¿ç”¨ã€‚</p>
<p>æœ¬äººä¹Ÿæ˜¯å°è¯•è¿‡ä½¿ç”¨timerå’Œtickeré‡æ„ä»£ç ï¼Œå±äºæ˜¯æŠŠè„‘å­æ¦¨å¹²äº†éƒ½æ²¡æå®šã€‚</p>
<blockquote>
<p>The tester calls your Raftâ€™s rf.Kill() when it is permanently shutting down an instance. You can check whether Kill() has been called using rf.killed(). You may want to do this in all loops, to avoid having dead Raft instances print confusing messages.</p>
</blockquote>
<p>è¿™ä¸ªæ˜¯è·Ÿæµ‹è¯•ç¯å¢ƒæœ‰å…³çš„å¿ å‘Šï¼Œä»»ä½•ä½¿ç”¨äº†foræ­»å¾ªç¯çš„åœ°æ–¹éƒ½è¦åŠ ä¸Š!rf.killed()ä»£ç æä¾›ä¸­æ­¢ï¼Œä¸»è¦æ˜¯ç»™æµ‹è¯•æ¡†æ¶ä½¿ç”¨çš„ï¼Œå¦‚æœè¿™é‡Œæ²¡å®ç°å¥½ï¼Œåé¢ä¼šå‡ºç°åŠå…¶ç„å­¦ä¸”æ— æ³•æ’æŸ¥çš„bugã€‚å…·ä½“è¡¨ç°ä¸ºå•ä¸ªæµ‹è¯•èƒ½å¤Ÿå¤šæ¬¡é€šè¿‡ï¼Œä½†æ˜¯è¿èµ·æ¥æµ‹è¯•å°±ç–¯ç‹‚å‡ºé”™â€¦</p>
<blockquote>
<p>Go RPC sends only struct fields whose names start with capital letters. Sub-structures must also have capitalized field names (e.g. fields of log records in an array). The labgob package will warn you about this; donâ€™t ignore the warnings.</p>
</blockquote>
<p>RPCè°ƒç”¨å‡½æ•°å’Œå…¶å‚æ•°ï¼šargså’Œreplysç»“æ„ä½“ä¸­çš„åå­—éƒ½å¿…é¡»ä»¥å¤§å†™å¼€å¤´ï¼Œè¿™æ˜¯goè¯­è¨€çš„ç‰¹æ€§ï¼Œæ— è®ºæ˜¯æ–¹æ³•åã€å¸¸é‡ã€å˜é‡åè¿˜æ˜¯ç»“æ„ä½“çš„åç§°ï¼Œå¦‚æœé¦–å­—æ¯å¤§å†™ï¼Œåˆ™å¯ä»¥è¢«å…¶ä»–çš„åŒ…è®¿é—®ï¼›å¦‚æœé¦–å­—æ¯å°å†™ï¼Œåˆ™åªèƒ½åœ¨æœ¬åŒ…ä¸­ä½¿ç”¨ã€‚å¯ä»¥ç²—æš´çš„ç†è§£ä¸ºé¦–å­—æ¯å¤§å†™æ˜¯å…¬æœ‰çš„ï¼Œé¦–å­—æ¯å°å†™æ˜¯ç§æœ‰çš„ã€‚</p>
<blockquote>
<p>The most challenging part of this lab may be the debugging. Spend some time making your implementation easy to debug. Refer to the Guidance page for debugging tips.</p>
</blockquote>
<p><strong>DEBUGï¼ï¼ï¼</strong><br>æ‰“logçš„æ—¶å€™ä¸€å®šè¦è§„èŒƒåŒ–ï¼Œä¸è¦è‡ªå·±å†™ä¸€å¤§å¨æ–‡å­—ä¸Šå­—ä¸Šå»ï¼Œè¿å¯¹é½éƒ½åšä¸åˆ°ï¼Œåç»­æˆ‘ä»¬è¦é¢ä¸´çš„logæ•°é‡æ˜¯ä»¥æ•°åä¸‡æ¥è®¡ç®—çš„ï¼Œä¸ºäº†ä¿æŠ¤çœ¼ç›ï¼Œä½ ä¹Ÿå¯ä»¥è·Ÿæˆ‘ä¸€æ ·ä¸ºlogåŠ ä¸€äº›äº®çœ¼çš„é¢œè¡¨æƒ…ï¼Œä¸ºæ¼«é•¿çš„debugä¹‹æ—…å¢æ·»ä¸€ç‚¹ç‚¹ä¹è¶£</p>
<p>æ€»ä¹‹debugæ˜¯éå¸¸æŠ˜ç£¨çš„ï¼Œæœ¬äººå®ç°raftç®—æ³•ä¹Ÿæ˜¯èŠ±äº†ä¸¤ä¸‰ç™¾å°æ—¶ï¼Œç»å¯¹æœ‰å››äº”æˆçš„æ—¶é—´éƒ½æ¯ååœ¨ç”µè„‘å‰åå¤æŸ¥çœ‹logï¼Œä¿®æ”¹logçš„æ˜¾ç¤ºï¼Œå‰©ä¸‹ä¸‰å››æˆæ—¶é—´æ˜¯åå¤ç”¨çªçœ¼æ³•æŸ¥çœ‹è‡ªå·±å†™çš„ä»£ç ï¼Œä¸æ–­åœ¨è„‘æµ·é‡Œå’Œraftç®—æ³•çš„å„ç§è§„åˆ™è¿›è¡Œæ ¡éªŒã€‚å¯ä»¥è¯´å¯¹raftç®—æ³•çš„ç†è§£æœ‰å¤šæ·±ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºdebugçš„æ—¶é—´æœ‰å¤šé•¿</p>
<hr>
<p>é‚£ä¹ˆå¼€å§‹æ­£é¢˜å§</p>
<p>PartAéœ€è¦æˆ‘ä»¬å®ç°leaderé€‰ä¸¾æœºåˆ¶ï¼Œ</p>
<p>ç®€å•åœ°è¯´leaderè¦ä¸€ç›´å‘é€å¿ƒè·³åŒ…ï¼Œä¿è¯followerèƒ½å¤Ÿåœ¨ElecltionTimeoutå‰èƒ½è‡³å°‘æ”¶åˆ°ä¸€æ¬¡å¿ƒè·³ï¼Œå¹¶é‡ç½®ElecltionTimeoutã€‚</p>
<p>å¦‚æœå› ä¸ºç½‘ç»œé—®é¢˜ï¼Œæˆ–è€…å¹²è„†æ˜¯leaderæŒ‚æ‰äº†ï¼Œfollowerç›´åˆ°è¶…æ—¶éƒ½æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œé‚£å®ƒå¯ä»¥åˆæ³•è®¤ä¸ºleaderçœŸçš„æŒ‚äº†ï¼Œfollowerå°±ä¼šè½¬å˜ä¸ºcandidataå¼€å§‹é€‰ä¸¾æµç¨‹ï¼Œé€‰ä¸¾å‡ºæ–°çš„leaderåé‡å¤ä»¥ä¸Šæ­¥éª¤ã€‚</p>
<p>è¯´èµ·æ¥ç®€å•ï¼Œé‡Œé¢çš„ç»†èŠ‚å¯æ˜¯ç›¸å½“çš„å¤šï¼Œä¸æ€¥ï¼Œåœ¨ä¸‹é¢è¯¦ç»†ä»‹ç»</p>
<p>PartAæˆ‘ä»¬éœ€è¦å®ç°çš„ç‚¹æœ‰</p>
<ol>
<li>å®Œæˆserverç»“æ„ä½“ï¼Œå¿ƒè·³åŒ…ç»“æ„ä½“çš„å®šä¹‰</li>
<li>leaderå¿ƒè·³æœºåˆ¶</li>
<li>é€‰ä¸¾æœºåˆ¶</li>
</ol>
<h5 id="1-ç»“æ„ä½“å®šä¹‰"><a href="#1-ç»“æ„ä½“å®šä¹‰" class="headerlink" title="1.ç»“æ„ä½“å®šä¹‰"></a>1.ç»“æ„ä½“å®šä¹‰</h5><p>å¾ˆå¤šå®šä¹‰çš„ä¸œè¥¿æˆ‘ä»¬è¿˜æš‚æ—¶ç”¨ä¸ä¸Šï¼Œä½†æ˜¯æå‰æŒ‰ç…§è®ºæ–‡è¯´çš„å®šä¹‰å¥½å‡†æ²¡é”™</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Raft <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu        sync<span class="token punctuation">.</span>Mutex          <span class="token comment">// Lock to protect shared access to this peer's state</span>
	peers     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd <span class="token comment">// RPC end points of all peers</span>
	persister <span class="token operator">*</span>Persister          <span class="token comment">// Object to hold this peer's persisted state</span>
	me        <span class="token builtin">int</span>                 <span class="token comment">// this peer's index into peers[]</span>
	dead      <span class="token builtin">int32</span>               <span class="token comment">// set by Kill()</span>

	<span class="token comment">// Your data here (3A, 3B, 3C).</span>
	<span class="token comment">// Look at the paper's Figure 2 for a description of what</span>
	<span class="token comment">// state a Raft server must maintain.</span>

	<span class="token comment">//peer state</span>
	state <span class="token builtin">int32</span>

	<span class="token comment">//persister æŒä¹…æ€§</span>
	currentTerm      <span class="token builtin">int</span>
	votedFor         <span class="token builtin">int</span>
	log              <span class="token punctuation">[</span><span class="token punctuation">]</span>LogType
	lastIncludeIndex <span class="token builtin">int</span>
	lastIncludeTerm  <span class="token builtin">int</span>

	<span class="token comment">//volatility æ˜“å¤±æ€§</span>
	commitIndex <span class="token builtin">int</span>
	lastApplied <span class="token builtin">int</span>

	<span class="token comment">//leader volatility</span>
	nextIndex  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	matchIndex <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>

	<span class="token comment">//AppendEntris info</span>
	lastHearBeatTime      time<span class="token punctuation">.</span>Time
	lastSendHeartbeatTime time<span class="token punctuation">.</span>Time

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>å¿ƒè·³åŒ…ç»“æ„çš„å®šä¹‰</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> AppendEntriesArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Term         <span class="token builtin">int</span> 		<span class="token comment">//leaderä»»æœŸ</span>
	LeaderId     <span class="token builtin">int</span>		<span class="token comment">//leaderId</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> AppendEntriesReply <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Term          <span class="token builtin">int</span>  <span class="token comment">//æ¥æ”¶è€…ä»»æœŸ</span>
	Success       <span class="token builtin">bool</span> <span class="token comment">//æ˜¯å¦æ¥å—äº†å¿ƒè·³åŒ…çš„é™„å¸¦æ—¥å¿—</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-é€‰ä¸¾æœºåˆ¶"><a href="#2-é€‰ä¸¾æœºåˆ¶" class="headerlink" title="2.é€‰ä¸¾æœºåˆ¶"></a>2.<strong>é€‰ä¸¾æœºåˆ¶</strong></h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> RequestVoteArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your data here (3A, 3B).</span>
	Term         <span class="token builtin">int</span>
	CandidateId  <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RequestVoteReply <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your data here (3A).</span>
	Term        <span class="token builtin">int</span>
	VoteGranted <span class="token builtin">bool</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ä¸€ä¸ªå¤§å¾ªç¯ä¸­è¿›è¡Œæµç¨‹ï¼Œæ¯å¾ªç¯ä¸€æ¬¡sleep 10ms</p>
<ol>
<li>æ£€æŸ¥çŠ¶æ€ï¼Œå·²ç»æ˜¯leaderäº†ï¼Œcontinueä¸‹ä¸€æ¬¡å¾ªç¯</li>
<li>æ£€æŸ¥è¶…æ—¶æ—¶é—´timeCount := time.Since(rf.lastHearBeatTime).Milliseconds()<ol>
<li>æ²¡æœ‰è¶…æ—¶ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</li>
<li>è¶…æ—¶ï¼Œç»§ç»­å¾€ä¸‹èµ°</li>
</ol>
</li>
<li>æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯followerï¼ŒçŠ¶æ€æ”¹ä¸ºcandidateï¼Œç»§ç»­å¾€ä¸‹èµ°</li>
<li>æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€ï¼Œè‹¥æœæ˜¯candidateï¼Œæ›´æ–°è®¡æ—¶å™¨ï¼Œè‡ªå¢ä»»æœŸï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼Œç»§ç»­å¾€ä¸‹èµ°</li>
<li>å‘é€æŠ•ç¥¨è¯·æ±‚ï¼Œé˜»å¡ç»Ÿè®¡æŠ•ç¥¨ç»“æœ<ol>
<li>è¿˜æ²¡ç»Ÿè®¡å®Œæ¯•å°±è¶…æ—¶äº†ï¼Œè§£é™¤é˜»å¡ï¼Œç»§ç»­å¾€ä¸‹èµ°</li>
<li>è¶…æ—¶å‰æ‹¿åˆ°äº†ç»“æœï¼Œå¾€ä¸‹èµ°</li>
</ol>
</li>
<li><strong>æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€è¿˜æ˜¯ä¸æ˜¯candidate</strong>ï¼Œå¦‚æœä¸æ˜¯äº†ï¼Œcontinueè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå¦‚æœè¿˜æ˜¯candidateï¼Œç»§ç»­å¾€ä¸‹èµ°</li>
<li>æŸ¥çœ‹æŠ•ç¥¨ç»“æœï¼Œ<ol>
<li>å¾—åˆ°åŠæ•°åŠä»¥ä¸ŠæŠ•ç¥¨ï¼ˆåŠ ä¸Šè‡ªå·±ç»™è‡ªå·±å¤´çš„ä¸€ç¥¨å°±è¶…åŠæ•°äº†ï¼‰åˆ™è½¬å˜çŠ¶æ€ä¸ºleaderï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</li>
<li>é€‰ä¸¾å¤±è´¥ï¼Œä¸åšæ“ä½œï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</li>
</ol>
</li>
</ol>
<p>ä¸ºä»€ä¹ˆéœ€è¦åœ¨ç¬¬6æ­¥æ£€æŸ¥è‡ªå·±æ˜¯ä¸æ˜¯candidateï¼Ÿå› ä¸ºæ‰€æœ‰RPCçš„å‘é€å’Œå“åº”éƒ½å¸¦æœ‰Termä¿¡æ¯ï¼Œæ¥æ”¶æ–¹éƒ½éœ€è¦å¯¹Termçš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæŠ•ç¥¨RPCè¯·æ±‚çš„å“åº”çš„Termæ¯”è‡ªå·±å¤§ï¼Œéœ€è¦å°†è‡ªå·±çš„çŠ¶æ€è½¬å˜ä¸ºfollowerï¼Œæ›´æ–°è‡ªå·±çš„ä»»æœŸï¼Œæ¸…ç©ºvoteForã€‚</p>
<p>å¦‚æœçŠ¶æ€è½¬å˜ä¸ºfollowerï¼Œå…¶ä»–æ‰€æœ‰æµç¨‹ï¼ˆcandidateé€‰ä¸¾æµç¨‹ï¼Œleaderå‘é€å¿ƒè·³ï¼‰éƒ½è¦ç«‹åˆ»ä¸­æ–­ï¼Œè¿™å°±æ˜¯ä½¿ç”¨å¤§å¾ªç¯çš„å¥½å¤„ï¼Œå¯ä»¥éšæ—¶ä½¿ç”¨continueä¸­æ–­å½“å‰æµç¨‹ã€‚å¦‚æœä½¿ç”¨å„ç§å‡½æ•°åµŒå¥—å®ç°æµç¨‹ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯ä¼ é€’å¾ˆå¤æ‚ï¼Œæå…¶å®¹æ˜“å‡ºé”™ã€‚</p>
<p>æœ¬äººå°±å› ä¸ºè¿™ä¸€ç‚¹åƒè¿‡è‹¦</p>
<h4 id="3-å¿ƒè·³æœºåˆ¶"><a href="#3-å¿ƒè·³æœºåˆ¶" class="headerlink" title="3.å¿ƒè·³æœºåˆ¶"></a>3.å¿ƒè·³æœºåˆ¶</h4><p>leaderå½“é€‰åå®šæ—¶å‘é€å¿ƒè·³åŒ…ç»™å…¶ä»–followeræˆ–candidate</p>
<p>ç”±äºlab1åªéœ€è¦å®ç°æ— æ—¥å¿—çš„é¢†å¯¼äººé€‰ä¸¾ï¼Œæ‰€ä»¥å¿ƒè·³åŒ…çš„å‚æ•°åªéœ€è¦æœ‰Termå’ŒLeaderIdå°±å¤Ÿäº†</p>
<p>ä¸»è¦æ€è·¯æ˜¯ä½¿ç”¨forå¤§å¾ªç¯ï¼Œæ£€æµ‹è‡ªå·±æ˜¯å¦ä¸ºleaderï¼Œæ˜¯åˆ™è¿›è¡Œå¿ƒè·³åŒ…å‘é€åˆ¤æ–­</p>
<p>æ£€æŸ¥ä¸Šæ¬¡å‘é€å¿ƒè·³åŒ…çš„æ—¶é—´è·ç¦»å½“å‰æ—¶é—´çš„å€¼ï¼Œå¦‚æœè¶…è¿‡äº†è§„å®šçš„å¿ƒè·³åŒ…å‘é€é—´éš”å°±è¿›è¡Œä¸€æ¬¡å¿ƒè·³åŒ…çš„å‘é€</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">appendEntriesLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>rf<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> leader <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			countTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>lastSendHeartbeatTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> countTime <span class="token operator">&lt;</span> HeartBeatInterval <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			rf<span class="token punctuation">.</span>lastSendHeartbeatTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">//å‘é€å¿ƒè·³</span>
			rf<span class="token punctuation">.</span><span class="token function">SendAppendEntriesToAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»leaderçš„è§’åº¦æ¥çœ‹ï¼Œå¿ƒè·³åŒ…æœ‰è¿™äº”ç§å“åº”ç±»å‹ï¼Œæ³¨æ„è¿™å¹¶ä¸æ˜¯éœ€è¦å†™åœ¨å¿ƒè·³åŒ…çš„å‚æ•°ï¼Œåªæ˜¯ä¸ºäº†debugæ–¹ä¾¿è¢«æˆ‘å®šä¹‰å‡ºæ¥çš„</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>
	AEresult_Accept      <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//æ¥å—æ—¥å¿—</span>
	AEresult_Reject             <span class="token comment">//ä¸æ¥å—æ—¥å¿—</span>
	AEresult_StopSending        <span class="token comment">//æˆ‘ä»»æœŸæ¯”ä½ å¤§ï¼</span>
	AEresult_Ignore             <span class="token comment">//ä¸Šä¸ªä»»æœŸæˆ–æ›´ä¹…å‰å‘é€çš„å¿ƒè·³çš„å“åº”</span>
	AEresult_Lost               <span class="token comment">//è¶…æ—¶ï¼Œå¯¹æ–¹æ²¡æ”¶åˆ°å¿ƒè·³åŒ…/å·±æ–¹æ²¡æ”¶åˆ°å“åº”</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”±äºlab1éƒ½æ˜¯æ— æ—¥å¿—çš„ç©ºå¿ƒè·³åŒ…ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°AEresult_Rejectï¼Œä½†å…¶å®ƒæƒ…å†µéƒ½æœ‰å¯èƒ½</p>
<p>leaderæ”¶åˆ°çš„å¿ƒè·³åŒ…å“åº”åéœ€è¦ç«‹åˆ»ç¡®è®¤åŒ…è¿”å›å‚æ•°ä¸­çš„Termï¼Œå¦‚æœTermæ¯”è‡ªå·±çš„ä»»æœŸå¤§ï¼Œ</p>
<ol>
<li>éœ€è¦ç«‹åˆ»åœæ­¢å‰©ä½™å¿ƒè·³çš„å‘é€ï¼Œå°†è‡ªå·±çš„çŠ¶æ€æ›´æ”¹ä¸ºfollower</li>
<li>æ›´æ–°è‡ªå·±çš„term</li>
<li><strong>ä¸è¦</strong>é‡ç½®å®šæ—¶å™¨</li>
</ol>
<p>è¿™é‡Œä»‹ç»ä¸€ä¸‹å¦‚ä½•å®ç°ElectionTimeoutå®šæ—¶å™¨ï¼Œæ€è·¯å¾ˆç®€å•ï¼Œå¯¹äºfollowerå’Œcandidateï¼Œä»ç„¶æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ä¸åœæ£€æµ‹å½“å‰æ—¶é—´å’Œä¸Šæ¬¡æ”¶åˆ°å¿ƒè·³çš„æ—¶é—´lastHearBeatTimeçš„å·®å€¼ï¼Œå¦‚æœè·ç¦»ä¸Šæ¬¡æ”¶åˆ°å¿ƒè·³åŒ…çš„æ—¶é—´æ²¡è¶…è¿‡è®¾å®šçš„éšæœºå€¼ï¼Œç¡ä¸€å°ä¼šï¼ˆ10msï¼‰ç„¶åé‡å¤æ£€æµ‹ï¼Œå¦‚æœè¶…è¿‡äº†ï¼Œå°±å¯ä»¥åœ¨å¾ªç¯é‡Œå¾€ä¸‹èµ°æµç¨‹ï¼ˆåˆæ¬¡é€‰ä¸¾æµç¨‹ï¼Œé€‰ä¸¾è¶…æ—¶æµç¨‹ï¼Œé€‰ä¸¾å¤±è´¥æµç¨‹ï¼‰</p>
<p>é‚£ä¹ˆæ‰€è°“çš„é‡ç½®å®šæ—¶å™¨å°±åªæ˜¯æ›´æ–°lastHearBeatTimeä¸ºå½“å‰æ—¶é—´è€Œå·²ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé‡ç½®æ¦‚å¿µä¸è¦æ··æ·†ï¼š</p>
<ol>
<li>followerè¶…æ—¶/candiataé€‰ä¸¾è¶…æ—¶ï¼Œè¶…æ—¶åˆ°è¾¾åé‡ç½®ä¸€ä¸ªæ–°çš„æ—¶é—´é—´éš”ï¼Œæ¯”å¦‚åŸæœ¬çš„ElectionTimeoutæ—¶é—´é•¿åº¦ä¸º359msï¼Œä¸‹ä¸€æ¬¡å°±éšæœºä¸€ä¸ªæ–°çš„ElectionTimeoutæ—¶é—´ï¼Œæ¯”å¦‚524ms</li>
<li>follower/candidateæ”¶åˆ°ä¸€ä¸ªåˆæ³•ï¼ˆä»»æœŸå¤§äºç­‰äºè‡ªå·±çš„ä»»æœŸï¼‰leaderçš„å¿ƒè·³ï¼Œé‡ç½®<strong>lastHearbeatTime</strong>ä¸ºæ”¶åˆ°leaderå¿ƒè·³çš„æ—¶é—´ï¼Œå½“ç„¶ç»†è¯»è®ºæ–‡åï¼Œè¿˜æœ‰ä¸¤ä¸ªæ²¡æœ‰æ”¶åˆ°å¿ƒè·³å´è¦é‡ç½®å®šæ—¶å™¨çš„æ—¶æœºï¼Œåˆ†åˆ«æ˜¯ï¼š<ol>
<li>followerå› ä¸ºè¶…æ—¶ï¼Œæˆä¸ºcandidateçš„æ—¶å€™ï¼Œ </li>
<li>followeræ”¶åˆ°é€‰ç¥¨è¯·æ±‚å¹¶ä¸”<strong>æŠ•å‡ºèµåŒç¥¨</strong>æ—¶ã€‚</li>
</ol>
</li>
</ol>
<p>   åªæœ‰è¿™ä¸‰ç§æƒ…å†µå¯ä»¥æ›´æ–°lastHearBeatTimeï¼Œï¼ˆå½“ç„¶è¯ä¸èƒ½è¯´å¤ªç»ï¼Œåé¢åŠ å…¥å¿«ç…§æœºåˆ¶çš„æ—¶å€™ï¼Œfolloweræ”¶åˆ°å¿«ç…§ååŒæ ·å¯ä»¥é‡ç½®</p>
<p>ä»Šåæœ¬æ–‡æ‰€è¯´çš„é‡ç½®å®šæ—¶å™¨å‡æ˜¯æŒ‡çš„ç¬¬äºŒç§æƒ…å†µï¼šæ›´æ–°lastHeartbeatTIme</p>
<p><strong>å¿ƒè·³åŒ…æ¥æ”¶è€…çš„ä¸¥æ ¼æŒ‰é¡ºåºæµç¨‹ï¼š</strong></p>
<ol>
<li>å¿ƒè·³åŒ…çš„ä»»æœŸæ¯”è‡ªå·±å°ï¼Œç›´æ¥å¿½è§†ï¼Œå½“ç„¶è¿”å›å€¼è¿˜æ˜¯è¦å¸¦ä¸Šè‡ªå·±çš„ä»»æœŸï¼Œä»¥ä¾¿ä»»æœŸè½åçš„leaderæ›´æ–°è‡ªå·±çš„çŠ¶æ€ã€‚ä¸­æ­¢æµç¨‹ï¼Œä¸‹é¢æ“ä½œéƒ½ä¸åšï¼Œç›´æ¥è¿”å›</li>
<li>å¿ƒè·³åŒ…çš„ä»»æœŸå¤§äºè‡ªå·±çš„ä»»æœŸï¼ŒæŠŠè‡ªå·±çš„ä»»æœŸæ›´æ–°åˆ°å¿ƒè·³åŒ…çš„ä»»æœŸï¼Œæ¸…ç©ºvoteforï¼Œå¦‚æœè‡ªå·±çš„çŠ¶æ€æ˜¯candidateï¼Œé€€åŒ–ä¸ºfollowerï¼Œç»§ç»­å¾€ä¸‹èµ°</li>
<li>å¿ƒè·³åŒ…çš„ä»»æœŸç­‰äºè‡ªå·±çš„ä»»æœŸï¼Œå¦‚æœè‡ªå·±çš„çŠ¶æ€æ˜¯candidateï¼Œé€€åŒ–ä¸ºfollowerï¼Œæ¸…ç©ºvoteforï¼Œç»§ç»­å¾€ä¸‹èµ°</li>
<li>æ›´æ–°å®šæ—¶å™¨ï¼Œæ›´æ–°leaderIdä¸ºå¿ƒè·³åŒ…çš„leaderidï¼Œè¿”å›successå’Œè‡ªå·±çš„term</li>
</ol>
<p>æ— æ—¥å¿—æƒ…å†µä¸‹çš„å¿ƒè·³æœºåˆ¶å°±è¿™äº›</p>
<p>å®ç°å¥½ä¸¤è¿™ä¸ªæµç¨‹ï¼ŒPartAåŸºæœ¬å°±èƒ½é€šè¿‡äº†</p>
<p>åˆæ¬¡å®éªŒå¯èƒ½ä¼šå‡ºç°æµ‹è¯•é€šè¿‡äº†ï¼Œä½†æµ‹è¯•å´è­¦å‘Šï¼šâ€œåœ¨æ²¡æœ‰ç½‘ç»œå´©æºƒçš„æƒ…å†µä¸‹å‘ç”Ÿäº†é€‰ä¸¾â€</p>
<p>è¿™è¯´æ˜ä¸€å®šæœ‰å“ªä¸ªæµç¨‹æ²¡æœ‰è¢«æ­£ç¡®å®ç°ï¼Œæ¯”è¾ƒå¸¸è§çš„é”™è¯¯æ˜¯æ”¶åˆ°å¿ƒè·³çš„æ—¶å€™æ²¡æœ‰æ­£ç¡®æ›´æ–°å®šæ—¶å™¨</p>
<hr>
<h3 id="Part-3B-log-hard"><a href="#Part-3B-log-hard" class="headerlink" title="Part 3B: log (hard)"></a>Part 3B: log (hard)</h3><p>åœ¨è¿™ä¸€èŠ‚å¼€å§‹å…³äºé”çš„ä½¿ç”¨å°±éœ€è¦é‡è§†äº†ï¼Œä¸åœä½¿ç”¨å¤§é”æŠŠæ¯ä¸ªå‡½æ•°é”èµ·æ¥ç¡®å®å¯ä»¥å¾ˆå¤§ä¸€éƒ¨åˆ†å¹¶å‘å¸¦æ¥çš„é—®é¢˜ï¼Œä½†æ˜¯æ•ˆç‡ä¹Ÿæ˜¯ä½ä¸‹çš„ï¼Œæœ€å¥½åœ¨è€ƒè™‘å¹¶å‘å®‰å…¨çš„åŒæ—¶å°½å¯èƒ½ç¼©å°é”çš„èŒƒå›´ã€‚</p>
<p>ç…§ä¾‹çœ‹Hint</p>
<blockquote>
<p>You will need to implement the election restriction (section 5.4.1 in the paper).</p>
</blockquote>
<p><img src="/"></p>
<p>ç®€å•ç¿»è¯‘ï¼Œcandidateçš„æ—¥å¿—å¦‚æœä¸æ¯”è‡ªå·±ï¼ˆfollowerï¼‰çš„æ—¥å¿—æ–°ï¼Œé‚£å°±æ‹’ç»æŠ•ç¥¨</p>
<p>å¦‚ä½•å®šä¹‰æ–°ï¼Ÿæ¯”è¾ƒä¸¤è€…çš„æœ€åä¸€æ¡æ—¥å¿—çš„termï¼Œtermæ›´å¤§çš„å°±æ˜¯æ›´æ–°ï¼Œå¦‚æœtermä¸€æ ·ï¼Œæ¯”è¾ƒæœ€åä¸€æ¡æ—¥å¿—çš„indexï¼Œè°çš„indexæ›´å¤§è°å°±æ–°</p>
<p>æ‰€ä»¥followeræ¯”candidateæ–°,followerå°±ä¸ä¼šæŠ•èµæˆç¥¨ï¼Œå¦‚æœcandidateæ›´æ–°ï¼Œæˆ–è€…ä¸¤è€…åŒæ ·æ–°ï¼Œå°±å¯ä»¥èµåŒæŠ•ç¥¨</p>
<p>ä¸ºäº†å®ç°æ¯”è¾ƒtermå’Œindexï¼Œå¢åŠ voteç»“æ„ä½“æˆå‘˜ LastLogIndexå’ŒLastLogTermï¼Œå¦‚æœä¸€å¼€å§‹å¤§å®¶éƒ½æ²¡æœ‰æ—¥å¿—ï¼Œé‚£å°±è®¾ç½®ä¸ºæŸä¸ªé»˜è®¤å€¼ï¼Œæˆ‘æ˜¯è®¾æˆ-1</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> RequestVoteArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your data here (3A, 3B).</span>
	Term         <span class="token builtin">int</span>
	CandidateId  <span class="token builtin">int</span>
	LastLogIndex <span class="token builtin">int</span>
	LastLogTerm  <span class="token builtin">int</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>followerå¤„ç†æŠ•ç¥¨çš„å…·ä½“å®ç°ä»£ç ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> rf<span class="token punctuation">.</span>votedFor <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> rf<span class="token punctuation">.</span>votedFor <span class="token operator">==</span> args<span class="token punctuation">.</span>CandidateId <span class="token punctuation">{</span>
	lastLogTerm <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">lastTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LastLogTerm <span class="token operator">&gt;</span> lastLogTerm <span class="token operator">||</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>LastLogTerm <span class="token operator">==</span> lastLogTerm <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>LastLogIndex <span class="token operator">&gt;=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		rf<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> args<span class="token punctuation">.</span>CandidateId
		reply<span class="token punctuation">.</span>VoteGranted <span class="token operator">=</span> <span class="token boolean">true</span>
		rf<span class="token punctuation">.</span>lastHearBeatTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ«Rec Term[%d] [%d] -&gt; [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>CandidateId<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ³¨æ„ç»†èŠ‚</p>
<p>1ï¼šrf.votedFor == -1çš„åˆ¤æ–­ï¼Œä¸€ä¸ªä»»æœŸå†…ï¼Œfolloweråªèƒ½æŠ•ä¸€å¼ èµæˆç¥¨ï¼Œè¿™ä¿è¯äº†ä¸€ä¸ªä»»æœŸå†…åªä¼šåˆæ³•äº§ç”Ÿä¸€ä¸ªleaderã€‚</p>
<p>2ï¼šrf.votedFor == args.CandidateId è¿™ä¸ªåˆ¤æ–­æ˜¯æˆ‘åœ¨debugä¹‹æ—…åšå‡ºçš„å°è¯•ï¼Œé€»è¾‘ä¸Šå¹¶æ²¡æœ‰é—®é¢˜ï¼Œfollowerå‘å‡ºçš„èµæˆç¥¨å¯èƒ½å› ä¸ºç½‘ç»œä¸¢åŒ…å¯¼è‡´candidateæ²¡æ”¶åˆ°è¿™å¼ ç¥¨ï¼Œé‚£ä¹ˆfollowerå†æ¬¡æ”¶åˆ°åŒä¸€ä¸ªcandidateçš„æŠ•ç¥¨è¯·æ±‚æ—¶ï¼Œæ—¢ç„¶å·²ç»æŠ•ç»™å®ƒäº†é‚£ä¹ˆå†æŠ•ä¸€æ¬¡ä¹Ÿæ— å¦¨ã€‚ä½†å®é™…ä¸Šcandidateåœ¨ä¸€ä¸ªä»»æœŸå†…åªä¼šå‘ä¸€ä¸ªæœåŠ¡å™¨å‘é€ä¸€æ¬¡æŠ•ç¥¨RPCï¼Œä½•æ¥é‡å¤ä¸€è¯´â€¦ä½†æ—¢ç„¶ç•™ç€æ²¡é—®é¢˜ï¼Œæˆ‘ä¹Ÿä¸åˆ äº†</p>
<h4 id="æ—¥å¿—å¤åˆ¶"><a href="#æ—¥å¿—å¤åˆ¶" class="headerlink" title="æ—¥å¿—å¤åˆ¶"></a>æ—¥å¿—å¤åˆ¶</h4><p>ä¿®æ”¹å¿ƒè·³åŒ…ç›¸å…³ä»£ç </p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> AppendEntriesArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Term         <span class="token builtin">int</span> <span class="token comment">//leaderä»»æœŸ</span>
	LeaderId     <span class="token builtin">int</span> <span class="token comment">//leaderId</span>
	PrevLogIndex <span class="token builtin">int</span>
	PrevLogTerm  <span class="token builtin">int</span>
	Entries      <span class="token punctuation">[</span><span class="token punctuation">]</span>LogType
	LeaderCommit <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> AppendEntriesReply <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Term          <span class="token builtin">int</span>  <span class="token comment">//æ¥æ”¶è€…ä»»æœŸ</span>
	Success       <span class="token builtin">bool</span> <span class="token comment">//æ˜¯å¦æ¥å—å¿ƒè·³åŒ…</span>
	ConflictIndex <span class="token builtin">int</span>
	ConflictTerm  <span class="token builtin">int</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ConflictIndex ConflictTermï¼šè¿™ä¸¤ä¸ªå‚æ•°è®ºæ–‡ä¸Šæ²¡æœ‰ï¼Œè¿™æ˜¯ç”¨äºåŠ å¿«leaderä¼ è¾“æ—¥å¿—çš„å›é€€é€Ÿåº¦æ‰€éœ€è¦ä½¿ç”¨çš„å‚æ•°ï¼Œæš‚æ—¶æŒ‰ä¸‹ä¸è¡¨</p>
<p>æ—¢ç„¶è¦å®ç°æ—¥å¿—å¤åˆ¶ï¼Œé‚£é¦–å…ˆå¾—æœ‰æ—¥å¿—ã€‚</p>
<p>æµ‹è¯•æ¡†æ¶é€šè¿‡Start()å‡½æ•°ï¼Œä¸ºå½“å‰leaderæ–°å¢æ—¥å¿—ï¼Œ</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>command <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	index <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>
	term <span class="token operator">:=</span> rf<span class="token punctuation">.</span>currentTerm
	isLeader <span class="token operator">:=</span> rf<span class="token punctuation">.</span>state <span class="token operator">==</span> leader

	<span class="token comment">// Your code here (3B).</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>isLeader <span class="token punctuation">{</span>
		<span class="token keyword">return</span> index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isLeader
	<span class="token punctuation">}</span>

	<span class="token comment">//æ·»åŠ æ¡ç›®åˆ°æœ¬åœ°</span>
	rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">,</span> LogType<span class="token punctuation">{</span>
		Term<span class="token punctuation">:</span>  rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span> command<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"CLIENTğŸ“¨ Term[%d] [%d] Receive [%v] logIndex[%d](leader action)\n"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> command<span class="token punctuation">,</span> index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isLeader
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœæ˜¯éleaderè¢«è°ƒç”¨äº†Start()ï¼Œè¿”å›falseå³å¯ï¼Œæˆ‘å‘æµ‹è¯•æ¡†æ¶è¿”å›çš„indexä¸ºrf.lastIndex() + 2ï¼Œè¿™æ˜¯å› ä¸ºå®˜æ–¹çš„è®¤ä¸ºç¬¬ä¸€æ¡logçš„indexä¸º1ï¼Œæˆ‘è¿™é‡Œå¹¶æ²¡æœ‰åœ¨logä¸­å®ç°å“¨å…µä½ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¡logçš„indexæ˜¯ä»0å¼€å§‹çš„ï¼Œæ‰€ä»¥å¢åŠ ä¸€æ¡logä¹‹åindexçš„å€¼è¿˜å¾—+1ï¼Œæ‰æ˜¯æµ‹è¯•ç¨‹åºå¸Œæœ›å¾—åˆ°çš„è¿”å›å€¼ã€‚</p>
<p>è¿½åŠ å®Œæ–°æ—¥å¿—æ¡ç›®åå¯ä»¥é€‰æ‹©ç›´æ¥ç”¨ä¸€ä¸ªåç¨‹æ¥å‘é€AppendEntries RPCåŒæ­¥æ—¥å¿—ï¼Œå¯ä»¥ç­‰leaderä¸‹ä¸€æ¬¡å¿ƒè·³å‘¨æœŸåˆ°è¾¾ï¼Œå†è‡ªåŠ¨å‘é€ã€‚</p>
<blockquote>
<p>æˆ‘ä¸€å¼€å§‹å¹¶æ²¡æœ‰å¤ªåœ¨æ„è¿™ä¸ªåœ°æ–¹ï¼Œæ²¡æƒ³åˆ°åœ¨lab4ä¸€ä¸ªæ¯”è¾ƒä¸¥æ ¼çš„æµ‹è¯•ä¸­èƒŒåˆºåˆ°äº†ï¼Œé‚£ä¸ªæµ‹è¯•æ€»å…±å‘é€å‘leaderå‘é€1000æ—¥å¿—ï¼Œè€Œä¸”åªæœ‰å‰ä¸€æ¡æ—¥å¿—è¢«ç¡®è®¤å¤åˆ¶åˆ°äº†å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šä¹‹åï¼Œæ‰å‘é€ä¸‹ä¸€æ¡æ—¥å¿—ï¼Œæœ€åç»Ÿè®¡å‡ºæ¥100ms/op &gt; 33.3ms/op Fail Test</p>
</blockquote>
<p>leaderæœ‰äº†æ–°æ—¥å¿—ä¹‹åå°±å¯ä»¥å¼€å§‹æ—¥å¿—å¤åˆ¶æµç¨‹äº†ï¼Œæ—¥å¿—å¤åˆ¶çš„éƒ¨åˆ†æ”¾åœ¨å¿ƒè·³åŒ…çš„å‘é€æµç¨‹ä¸­ï¼Œè¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ªæ•°ç»„æ¥ç¡®å®šleaderéœ€è¦å‘é€å“ªäº›æ—¥å¿—ï¼Œ</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">nextIndex  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
matchIndex <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>nextIndexæ•°ç»„</strong></p>
<p>nextIndexæ•°ç»„çš„æ„ä¹‰éå¸¸æ˜ç¡®ï¼Œleaderæ¯æ¬¡å‘idä¸ºiçš„followerå‘é€çš„å¿ƒè·³åŒ…ä¸­ï¼Œéœ€è¦é™„åŠ nextIndex[i]åˆ°æœ€æ–°æ—¥å¿—æ¡ç›®çš„æ‰€æœ‰æ—¥å¿—</p>
<p>æ¯æ¬¡leaderå½“é€‰åéƒ½è¦é‡ç½®nextIndexæ•°ç»„ï¼Œè®©å…¶æ‰€æœ‰å…ƒç´ çš„å€¼æŒ‡å‘leaderå½“å‰æœ€æ–°æ—¥å¿—çš„ä¸‹ä¸€ä½ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡å‘äº†ä¸€ä¸ªç©ºä½ç½®</p>
<p>æ‰€ä»¥æ–°leaderå½“é€‰åå‘é€çš„ç¬¬ä¸€æ¡AEå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ç©ºæ—¥å¿—</p>
<p>leaderå½“é€‰åè¿˜è¦é‡ç½®matchIndexæ•°ç»„çš„å€¼ä¸º0ï¼Œå½“ç„¶è¿˜æ˜¯å› ä¸ºæˆ‘çš„logæ²¡æœ‰è®¾ç½®å“¨å…µä½ï¼Œæ‰€ä»¥æˆ‘è®¾ç½®æˆ-1</p>
<p><strong>matchIndexæ•°ç»„</strong></p>
<p>matchIndexæ•°ç»„çš„æ„ä¹‰æ˜¯è¡¨ç¤ºï¼šleaderç¡®è®¤è¿‡çš„ï¼Œfollowerã€iã€‘ä¸è‡ªå·±æ—¥å¿—ä¿æŒä¸€è‡´çš„æœ€æ–°Indexï¼Œå…·ä½“å¦‚ä½•æ›´æ–°å®ƒçš„å€¼åé¢ä¼šè¯´æ˜</p>
<p>matchIndexæ•°ç»„çš„ä½œç”¨åªæ˜¯ä¸ºäº†ç»™commitIndexçš„æ›´æ–°åšå‚è€ƒ</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> voteCount <span class="token operator">&gt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token punctuation">{</span>
	rf<span class="token punctuation">.</span>IisBack <span class="token operator">=</span> <span class="token boolean">false</span>
	rf<span class="token punctuation">.</span>state <span class="token operator">=</span> leader
	rf<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> rf<span class="token punctuation">.</span>me
	rf<span class="token punctuation">.</span>nextIndex <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
	rf<span class="token punctuation">.</span>matchIndex <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//è¿™æ¡logä¸å…¶ä»–logç›¸æ¯”æ‰“å°åœ¨å±å¹•ä¸Šä¼šæœ‰å¾ˆæ˜æ˜¾çš„é”™ä½æ•ˆæœï¼Œæ¯”è¾ƒé‡è¦çš„logå¯ä»¥æ•…æ„ä¸éµå®ˆæ ¼å¼ï¼Œæ–¹ä¾¿ç¬¬ä¸€çœ¼æ‰¾åˆ°ï¼Œå½“ç„¶åé¢å®éªŒæ•°åä¸‡æ¡logï¼Œideè‡ªå·±éƒ½ä¸æ„¿æ„æ‰“å¼€çš„è¶…å¤§æ—¥å¿—æ–‡ä»¶å†æ€ä¹ˆæ˜¾çœ¼éƒ½æ²¡åµç”¨ã€‚åªèƒ½æ˜¯è®¾ç½®å¥½å…³é”®è¯ï¼Œå–„ç”¨æœç´¢åŠŸèƒ½äº†</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"â— Term[%d] [%d] candidate -&gt; leader"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
	rf<span class="token punctuation">.</span>lastSendHeartbeatTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">-</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> HeartBeatInterval<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åleaderå°±å¯ä»¥å¼€å§‹æ ¹æ®nextIndexçš„å€¼å‘é€æ—¥å¿—äº†</p>
<p><strong>leaderæ—¥å¿—å‘é€</strong></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">*</span>args <span class="token operator">=</span> AppendEntriesArgs<span class="token punctuation">{</span>
	Term<span class="token punctuation">:</span>         rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span>
	LeaderId<span class="token punctuation">:</span>     rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span>
	PrevLogIndex<span class="token punctuation">:</span> rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
	PrevLogTerm<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
	Entries<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LogType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	LeaderCommit<span class="token punctuation">:</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> 	<span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//æœ‰PrevIndex</span>
	args<span class="token punctuation">.</span>PrevLogTerm <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term
<span class="token punctuation">}</span>
<span class="token keyword">if</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//æœ‰nextIndex</span>
	args<span class="token punctuation">.</span>Entries <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Entries<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>leaderå°†ä¸‹æ ‡ä¸ºnextIndexåˆ°æœ€æ–°ä¸‹æ ‡çš„æ‰€æœ‰æ—¥å¿—æ”¾åˆ°å¿ƒè·³åŒ…é‡Œå‘ç»™å¯¹åº”çš„æœåŠ¡å™¨</p>
<p>argsä¸­çš„PreLogIndexå’ŒPreLogTermæ˜¯leaderè¦å‘ç»™è¯¥serveçš„æ—¥å¿—æ®µçš„å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œfolloweréœ€è¦æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°çš„å€¼åˆ¤æ–­è‡ªå·±çš„æ—¥å¿—æœ‰æ²¡æœ‰è·ŸleaderåŒ¹é…ä¸Šï¼Œæ²¡åŒ¹é…ä¸Šçš„è¯æ˜¯ä¸èƒ½å¤åˆ¶è¿™ä»½å¿ƒè·³é‡Œçš„æ—¥å¿—çš„</p>
<p>leaderå‘é€å®Œå¿ƒè·³RPCåå¤„ç†å›å‚çš„éƒ¨åˆ†æ”¾åœ¨ä¸‹æ–‡</p>
<p>LeaderCommitç”¨æ¥æ›´æ–°followerçš„commitIndex</p>
<p>å›é¡¾matchIndexçš„ä½œç”¨ï¼Œ</p>
<p>leaderçš„commitIndexç”±matchIndexå†³å®šï¼Œ</p>
<p>followerçš„commitInedxç”±leaderå¿ƒè·³çš„LeaderCommitï¼ˆcommitIndexï¼‰å†³å®šï¼Œ</p>
<p>matchIndexçš„å€¼æ ¹æ®followerçš„å¿ƒè·³å›å‚å†³å®šï¼Œå¦‚æœfolloweråŒ¹é…ä¸Šäº†æ—¥å¿—ï¼Œé‚£ä¹ˆleaderå°±å¯ä»¥æ›´æ–°matchIndexçš„å€¼ä¸ºå‘é€å¿ƒè·³æ—¶çš„æœ€æ–°æ—¥å¿—æ¡ç›®çš„index</p>
<p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå¼¯å¼¯ç»•ç»•çš„æ›´æ–°commitIndexçš„å€¼å‘¢ã€‚è¿™æ˜¯ä¿è¯æ—¥å¿—åœ¨å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šä¿æŒä¸€è‡´çš„å…³é”®ã€‚</p>
<p>leaderå¯ä»¥åªåœ¨ä¸€æ¬¡å¿ƒè·³å‘¨æœŸå†…æ›´æ–°è‡ªå·±çš„commitIndexçš„å€¼ï¼Œè¿™æ˜¯å› ä¸ºleaderæ‹¥æœ‰è·Ÿå¤§å¤šæ•°followeré€šä¿¡çš„ç‰¹æƒï¼Œå®ƒç¡®å®çŸ¥é“commitIndexåœ¨å¤šæ•°æœåŠ¡å™¨ä¸Šè¾¾æˆå…±è¯†äº†æ‰€ä»¥leaderå¯ä»¥æ›´æ–°ã€‚</p>
<p>å…¶ä»–æœåŠ¡å™¨åˆ™è‡³å°‘éœ€è¦ç»è¿‡<strong>ä¸¤æ¬¡å¿ƒè·³å‘¨æœŸ</strong>æ‰èƒ½æ›´æ–°è‡ªå·±çš„commitIndexåˆ°leaderæ°´å¹³ï¼Œå› ä¸ºfollowerä¾èµ–äºleaderçš„åˆ¤æ–­ã€‚ </p>
<p>è¿™æœ‰ç‚¹ç±»ä¼¼äºTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œåªæœ‰ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ‰èƒ½ä½¿åŒæ–¹è¾¾æˆå…±è¯†ï¼Œå°‘ä¸€æ¬¡éƒ½æ— æ³•ç¡®è®¤ã€‚</p>
<p><strong>followeræ—¥å¿—å¤åˆ¶</strong></p>
<p>followerä¹Ÿä¸æ˜¯æ”¶åˆ°æ—¥å¿—å°±ä¸‡äº‹å¤§å‰çš„ï¼Œéœ€è¦ç»è¿‡é¢å¤–åˆ¤æ–­ç¡®è®¤èƒ½å¦æ¥å—æ—¥å¿—</p>
<p>é‚£å°±æ˜¯åˆ¤æ–­PrevLogIndexå’ŒPrevLogTermå’Œè‡ªå·±çš„æ—¥å¿—æ˜¯å¦åŒ¹é…ä¸Šäº†</p>
<p>æ²¡åŒ¹é…ä¸Šå°±ä¸¢å¼ƒæœ¬æ¬¡æ¥æ”¶åˆ°çš„æ—¥å¿—ï¼Œå›å¤leaderé¢å¤–ä¿¡æ¯æŒ‡å¯¼leaderä¸‹æ¬¡è¯¥å‘é€å“ªäº›æ—¥å¿—ã€‚</p>
<p>åŒ¹é…ä¸Šäº†ï¼Œå°±å¯ä»¥å°†å¿ƒè·³é™„åŠ æ—¥å¿—ä¸­è‡ªå·±æ²¡æœ‰çš„é‚£ä¸€éƒ¨åˆ†è¿½åŠ åˆ°è‡ªå·±logä¸­</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">if</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>PrevLogIndex <span class="token punctuation">{</span>
	reply<span class="token punctuation">.</span>ConflictIndex <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’”Rec Term[%d] [%d] Reject:PreLogIndex[%d] Out of Len -&gt;[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> args<span class="token punctuation">.</span>PrevLogIndex <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">!=</span> args<span class="token punctuation">.</span>PrevLogTerm <span class="token punctuation">{</span>
	reply<span class="token punctuation">.</span>ConflictTerm <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term
	<span class="token keyword">for</span> index <span class="token operator">:=</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> index <span class="token operator">&lt;=</span> args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">;</span> index<span class="token operator">++</span> <span class="token punctuation">{</span> <span class="token comment">// æ‰¾åˆ°å†²çªtermçš„é¦–æ¬¡å‡ºç°ä½ç½®ï¼Œæœ€å·®å°±æ˜¯PrevLogIndex</span>
		<span class="token keyword">if</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">==</span> reply<span class="token punctuation">.</span>ConflictTerm <span class="token punctuation">{</span>
			reply<span class="token punctuation">.</span>ConflictIndex <span class="token operator">=</span> index
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’”Rev Term[%d] [%d] Reject :PreLogTerm Not Match [%d] != [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term<span class="token punctuation">,</span> args<span class="token punctuation">.</span>PrevLogTerm<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
rf<span class="token punctuation">.</span><span class="token function">CopyEntries</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ—¥å¿—å¤åˆ¶</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">CopyEntries</span><span class="token punctuation">(</span>args <span class="token operator">*</span>AppendEntriesArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	logchange <span class="token operator">:=</span> <span class="token boolean">false</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Entries<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		rfIndex <span class="token operator">:=</span> i <span class="token operator">+</span> args<span class="token punctuation">.</span>PrevLogIndex <span class="token operator">+</span> <span class="token number">1</span>
		logPos <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rfIndex<span class="token punctuation">)</span>
		<span class="token keyword">if</span> rfIndex <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//è¶…å‡ºåŸæœ¬logé•¿åº¦äº†</span>
			rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Entries<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
			rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			logchange <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>logPos<span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">!=</span> args<span class="token punctuation">.</span>Entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token punctuation">{</span> <span class="token comment">//æœ‰è„ä¸œè¥¿</span>
			rf<span class="token punctuation">.</span>log <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span><span class="token punctuation">:</span>logPos<span class="token punctuation">]</span> <span class="token comment">//åˆ é™¤è„æ•°æ®</span>
			<span class="token comment">//ä¸€å£æ°”å¤åˆ¶å®Œ</span>
			rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Entries<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
			rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			logchange <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//ç”¨äºdebug</span>
	<span class="token keyword">if</span> logchange <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’–Rev Term[%d] [%d] Copy: Len -&gt; [%d] "</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"Term[%d] [%d] after copy:"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
		i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">10</span>
		<span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			i <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"Term[%d] [%d] index[%d] log[%v]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> i<span class="token operator">+</span>rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> min <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LeaderCommit <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		min <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		min <span class="token operator">=</span> args<span class="token punctuation">.</span>LeaderCommit
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> rf<span class="token punctuation">.</span>commitIndex <span class="token operator">&lt;</span> min <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"COMIT Term[%d] [%d] CommitIndex: [%d] -&gt; [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">,</span> min<span class="token punctuation">)</span>
		rf<span class="token punctuation">.</span>commitIndex <span class="token operator">=</span> min
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œä½¿ç”¨äº†ConflictIndexå’ŒConflictTermçš„å¿«é€Ÿå›é€€ä¼˜åŒ–ã€‚</p>
<p>è®ºæ–‡å¹¶æ²¡æœ‰å®ç°å¿«é€Ÿå›é€€ï¼Œè®ºæ–‡å¯¹äºå¿ƒè·³æ—¥å¿—è¢«æ‹’ç»çš„å¤„ç†ä¸ºï¼šleaderæ”¶åˆ°æ—¥å¿—å¤åˆ¶å¤±è´¥çš„å“åº”åï¼Œå°†å¯¹åº”çš„nextIndex[i] -= 1å³å¯ï¼Œä¸‹ä¸€æ¬¡å¿ƒè·³å‘¨æœŸleaderå¾€å›å¤šå‘ä¸€ä¸ªlogï¼ˆå½“ç„¶æ–°çš„logä¹Ÿä¸ä¼šè½ä¸‹ï¼Œä¸€èµ·å‘ï¼Œåªæ˜¯è¿˜éœ€è¦å¾€å‰å¤šå‘ä¸€ä¸ªæ—§çš„æ—¥å¿—ï¼‰ï¼Œçœ‹çœ‹è¿™æ¬¡è¿˜ä¸åŒ¹é…çš„è¯ï¼Œé‚£å°±æ…¢æ…¢æ¥ç€å§ï¼Œä¸€ç›´å›é€€åˆ°åŒ¹é…ä¸ºæ­¢ã€‚è¿™å°±æ˜¯æ—¥å¿—å›é€€ç°è±¡ï¼šå‡ºç°äºleaderå’Œfollowerä¹‹é—´æ—¥å¿—å·®å¼‚è¾ƒå¤§çš„æ—¶å€™ï¼Œä¸ºäº†åŒæ­¥ï¼Œleaderéœ€è¦å¤šå‘ä¸€äº›æ—¥å¿—</p>
<p>è®ºæ–‡ä¹Ÿè¯´ï¼Œè¿™ç§æ“ä½œçœ‹ä¼¼æ•ˆç‡ä½ä¸‹ï¼Œä½†å‘ç”Ÿæƒ…å†µå¾ˆå°‘ï¼Œåœ¨ç°å®ä¸­è°å®¶çš„ç½‘ç»œæœåŠ¡ä¼šå·®åˆ°ä¸¢åŒ…ç‡30%ï¼Œç½‘ç»œå»¶è¿Ÿè¾¾åˆ°2000msï¼ŒæœåŠ¡å™¨åå¤å®•æœºä»°å§èµ·åï¼Œè„‘è£‚å¦‚åŒå®¶å¸¸ä¾¿é¥­å‘¢ï¼Œè¿˜è¦ç»§ç»­åšæŒæä¾›å¯é åŒæ­¥æœåŠ¡å‘¢ï¼Ÿä½†æ˜¯åœ¨æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œå¦‚æœä¸æ—¥å¿—å¿«é€Ÿå›é€€çš„ä¼˜åŒ–ï¼Œæå¤§æ¦‚ç‡ä¼šåœ¨æŸä¸ªTestæŒ‚æ‰</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°æ—¥å¿—å¿«é€Ÿå›é€€æœºåˆ¶ï¼Œå¥½åœ¨å®éªŒå®˜æ–¹æŒ‡å¯¼ä¸­ç»™äº†è§£å†³åŠæ³•</p>
<blockquote>
<p>how to roll back quickly  the Figure 2 design backs up one entry per RPC â€“ slow!  </p>
<p>lab tester may require faster roll-back  </p>
<p>paper outlines a scheme towards end of Section 5.3    no details; </p>
<p>hereâ€™s my guess; </p>
<p>better schemes are possible </p>
<table>
<thead>
<tr>
<th></th>
<th>Case 1</th>
<th>Case 2</th>
<th>Case 2</th>
</tr>
</thead>
<tbody><tr>
<td>S1</td>
<td>4 5 5</td>
<td>4 4 4</td>
<td>4</td>
</tr>
<tr>
<td>S2</td>
<td>4 6 6 6</td>
<td>4 6 6 6</td>
<td>4 6 6 6</td>
</tr>
</tbody></table>
<p>is leader for term 6, S1 comes back to life, S2 sends AE for last 6    AE has prevLogTerm=6  rejection from S1 includes:</p>
<p>XTerm:  term in the conflicting entry (if any)    </p>
<p>XIndex: index of first entry with that term (if any)    </p>
<p>XLen:   log length  </p>
<p>Case 1 (leader doesnâ€™t have XTerm):    nextIndex = XIndex  </p>
<p>Case 2 (leader has XTerm):   nextIndex = leaderâ€™s last entry for XTerm  </p>
<p>Case 3 (followerâ€™s log is too short):    nextIndex = XLen</p>
</blockquote>
<p>åŠ©æ•™è¿˜æä¾›äº†ä¸€ä¸ªæ”¹è¿›ç‰ˆï¼Œä¹Ÿå°±æ˜¯æˆ‘æ‰€ä½¿ç”¨çš„ç‰ˆæœ¬</p>
<blockquote>
<p>If a follower does not have prevLogIndex in its log, it should return with conflictIndex = len(log) and conflictTerm = None.</p>
<p>If a follower does have prevLogIndex in its log, but the term does not match, it should return conflictTerm = log[prevLogIndex].Term, and then search its log for the first index whose entry has term equal to conflictTerm.</p>
<p>Upon receiving a conflict response, the leader should first search its log for conflictTerm. If it finds an entry in its log with that term, it should set nextIndex to be the one beyond the index of the last entry in that term in its log.</p>
<p>If it does not find an entry with that term, it should set nextIndex = conflictIndex.</p>
</blockquote>
<p>æ—¥å¿—å¿«é€Ÿå›é€€çš„ä»£ç å®ç°</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">ok <span class="token operator">:=</span> rf<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"Raft.AppendEntries"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">)</span>

rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">!=</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’”Rec Term[%d] [%d] Receive Send.Term[%d][too OLD]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> rf<span class="token punctuation">.</span>currentTerm <span class="token operator">&lt;</span> reply<span class="token punctuation">.</span>Term <span class="token punctuation">{</span>
		rf<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		rf<span class="token punctuation">.</span>state <span class="token operator">=</span> follower
		rf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> reply<span class="token punctuation">.</span>Term
		rf<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ’”Rec Term[%d] [%d] Receive Discover newer Term[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> reply<span class="token punctuation">.</span>Success <span class="token punctuation">{</span>
		rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>PrevLogIndex <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Entries<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
		rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">//å·¦é—­å³å¼€ï¼Œå› æ­¤curLatestIndexæŒ‡å‘çš„æ˜¯æœ€åä¸€ä¸ªå‘é€çš„logçš„ä¸‹ä¸€ä½å¯èƒ½ä¸ºç©º</span>

		<span class="token keyword">return</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> reply<span class="token punctuation">.</span>ConflictTerm <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
			searchIndex <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>
			<span class="token keyword">for</span> i <span class="token operator">:=</span> args<span class="token punctuation">.</span>PrevLogIndex<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">==</span> reply<span class="token punctuation">.</span>ConflictTerm <span class="token punctuation">{</span>
					searchIndex <span class="token operator">=</span> i
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> searchIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
				rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> searchIndex <span class="token operator">+</span> <span class="token number">1</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">.</span>ConflictIndex
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">.</span>ConflictIndex <span class="token operator">+</span> <span class="token number">1</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="æ—¥å¿—æäº¤"><a href="#æ—¥å¿—æäº¤" class="headerlink" title="æ—¥å¿—æäº¤"></a>æ—¥å¿—æäº¤</h4><p>æ¯ä¸€ä¸ªæœåŠ¡å™¨followerï¼Œcandidatï¼Œleaderéƒ½éœ€è¦å°†LastAppliedåˆ°commitIndexä¹‹é—´çš„æ—¥å¿—é€šè¿‡applychæäº¤ç»™ä¸Šå±‚åº”ç”¨</p>
<blockquote>
<p>lastappliedå’ŒcommitIndexä¸æ˜¯æ˜“å¤±æ€§çŠ¶æ€å—ï¼Ÿ</p>
</blockquote>
<p>æ˜¯çš„ï¼Œæ‰€ä»¥ä¸Šå±‚åº”ç”¨è¦å…·æœ‰æ¥å—raftå±‚çš„é‡å¤æ—¥å¿—çš„èƒ½åŠ›</p>
<blockquote>
<p>æ—¢ç„¶å·²ç»æœ‰äº†commitIndexï¼Œè€Œä¸”ä¸Šå±‚åº”ç”¨ä¹Ÿèƒ½æ¥å—é‡å¤æ—¥å¿—ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦æœ‰lastappliedï¼Ÿ</p>
</blockquote>
<p>å¤§æ¦‚è€ƒè™‘åˆ°è¿™å‡ ç‚¹å§</p>
<p>1ï¼šcommitIndexæ˜¯è·³å˜çš„ï¼Œå¦‚æœä¸å®ç°lastappliedï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è®°å½•commitIndexå˜åŒ–ä¹‹å‰çš„ä½ç½®ï¼Œç„¶åå‘åº”ç”¨å±‚å‘é€è¿™ä¸€æ®µlogï¼Œè€Œä¸”ä¸ºäº†ä¿è¯åº”ç”¨å±‚èƒ½æ¥æ”¶åˆ°æ‰€æœ‰æ—¥å¿—å‘ï¼Œéœ€è¦åœ¨commitIndexå†æ¬¡å˜åŒ–ä¹‹å‰ï¼Œç™¾åˆ†ç™¾å®Œæˆä¹‹å‰è¿™æ¬¡å‘é€logçš„æµç¨‹ï¼Œè¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®ç°å°±å¾ˆå¤æ‚äº†</p>
<p>2ï¼šlastAppliedæœ‰ä¸ªç‰¹ç‚¹ï¼Œå®ƒä¸€æ¬¡åªå¢åŠ 1ï¼Œåœ¨å‰ä¸€ä¸ªlogè¢«åº”ç”¨å±‚ç¡®å®šæ¥å—ä¹‹å‰ï¼Œä¸ä¼šæäº¤ä¸‹ä¸€æ¡logã€‚è¿™å°±å¾ˆå¤§ç¨‹åº¦ä¿éšœäº†åº”ç”¨å±‚çš„æ•°æ®å®‰å…¨</p>
<blockquote>
<p>éœ€è¦ç•™æ„çš„æ˜¯ä»»ä½•æ“ä½œapplychçš„ä¸èƒ½è¿›è¡ŒåŠ é”æ“ä½œï¼Œå› ä¸ºapplyChæ˜¯ä¸ªæ— ç¼“å†²channelï¼ŒåŠ é”å‡ ä¹ç™¾åˆ†ç™¾å¯¼è‡´æ­»é”é—®é¢˜<br>ä½†æ˜¯å¦‚æœä¸åŠ é”åˆä¼šå‡ºç°ä¸€äº›å°é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜ä¸»è¦åœ¨3Då®éªŒä¸­ä½“ç°ï¼Œåé¢ç»†è¯´</p>
</blockquote>
<p>Applyå‡½æ•°ï¼Œä½¿ç”¨goå•ç‹¬å¼€è¾Ÿçš„åç¨‹</p>
<p>ä½¿ç”¨<strong>å‡½æ•°é—­åŒ…+return+defer</strong>æœ‰å¥‡æ•ˆï¼Œä¸»æ‰“çš„å°±æ˜¯ä¸€ä¸ªæ€€å¿µgotoå…³é”®å­—</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ä¿®æ”¹rf.lastApplied</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">undateLastApplied</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> nomore <span class="token operator">=</span> <span class="token boolean">false</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>rf<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> nomore <span class="token punctuation">{</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// rf.snapshotXapplych.Lock()</span>
			<span class="token comment">// defer rf.snapshotXapplych.Unlock()</span>
			<span class="token comment">// DPrintf("APPLY Term[%d] [%d] Wait for the lockğŸ”", rf.currentTerm, rf.me)</span>
			rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// DPrintf("APPLY Term[%d] [%d] Hode the lockğŸ”", rf.currentTerm, rf.me)</span>
			nomore <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">if</span> rf<span class="token punctuation">.</span>lastApplied <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span>commitIndex <span class="token punctuation">{</span>
				rf<span class="token punctuation">.</span>lastApplied <span class="token operator">+=</span> <span class="token number">1</span>
				index <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>lastApplied<span class="token punctuation">)</span>
				<span class="token keyword">if</span> index <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> index <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					rf<span class="token punctuation">.</span>lastApplied <span class="token operator">=</span> rf<span class="token punctuation">.</span>lastIncludeIndex
					<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ERROR? ğŸ‘¿ [%d]Ready to apply index[%d] But index out of Len of log, lastApplied[%d] commitIndex[%d] lastIncludeIndex[%d] logLen:%d"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> index<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastApplied<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">)</span>
					rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
				<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"APPLY Term[%d] [%d] -&gt; LOG [%d] value:[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastApplied<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">)</span>

				ApplyMsg <span class="token operator">:=</span> ApplyMsg<span class="token punctuation">{</span>
					CommandValid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
					Command<span class="token punctuation">:</span>      rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">,</span>
					CommandIndex<span class="token punctuation">:</span> rf<span class="token punctuation">.</span>lastApplied <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
				<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"APPLY Term[%d] [%d] Unlock the lockğŸ” For Start applyerCh &lt;- len[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>applyChTerm<span class="token punctuation">)</span><span class="token punctuation">)</span>
				rf<span class="token punctuation">.</span>applyChTerm <span class="token operator">&lt;-</span> ApplyMsg
				<span class="token keyword">if</span> rf<span class="token punctuation">.</span>IisBackIndex <span class="token operator">==</span> rf<span class="token punctuation">.</span>lastApplied <span class="token punctuation">{</span>
					<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"Term [%d] [%d] iisback = true iisbackIndex =[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>IisBackIndex<span class="token punctuation">)</span>
					rf<span class="token punctuation">.</span>IisBack <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// DPrintf("APPLY Term[%d] [%d] lock the lockğŸ” For Finish applyerCh &lt;-", rf.currentTerm, rf.me)</span>
				nomore <span class="token operator">=</span> <span class="token boolean">false</span>
				<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"APPLY Term[%d] [%d] AppliedIndex [%d] CommitIndex [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastApplied<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// DPrintf("APPLY Term[%d] [%d] Open the lockğŸ”“", rf.currentTerm, rf.me)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ›´æ–°commitindexçš„å‡½æ•°ï¼Œæˆ‘è¿™é‡Œè¿˜æ˜¯å•ç‹¬å¼€è¾Ÿäº†ä¸€ä¸ªåç¨‹ç‹¬ç«‹è¿›è¡Œï¼Œä¸»è¦è¿˜æ˜¯ä¸ºäº†ç®€åŒ–é€»è¾‘å§ï¼Œå…¶å®æ”¾åˆ°leaderçš„å¿ƒè·³å‘é€å‘¨æœŸé‡Œé¢æ›´æ–°ä¹Ÿé—®é¢˜ä¸å¤§</p>
<blockquote>
<p>æ³¨æ„åªæœ‰leaderå¯ä»¥å‚è€ƒmatchIndexçš„æ–¹å¼æ›´æ–°commitIndex</p>
<p>followeråªèƒ½å‚è€ƒå¿ƒè·³ä¸­çš„LeaderCommitIndexæ›´æ–°è‡ªå·±çš„commitIndex</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">updateCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//ä»matchIndexå¯»æ‰¾ä¸€ä¸ªå¤§å¤šæ•°æœåŠ¡å™¨è®¤åŒçš„N</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>rf<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> isleader <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> isleader <span class="token punctuation">{</span>
			rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			matchIndex <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			matchIndex <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>matchIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> rf<span class="token punctuation">.</span>peers <span class="token punctuation">{</span>
				<span class="token keyword">if</span> i <span class="token operator">!=</span> rf<span class="token punctuation">.</span>me <span class="token punctuation">{</span>
					matchIndex <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>matchIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			sort<span class="token punctuation">.</span><span class="token function">Ints</span><span class="token punctuation">(</span>matchIndex<span class="token punctuation">)</span>

			lenMat <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>matchIndex<span class="token punctuation">)</span> 
			N <span class="token operator">:=</span> matchIndex<span class="token punctuation">[</span>lenMat<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> 
			<span class="token keyword">if</span> N <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>commitIndex <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>N <span class="token operator">&lt;=</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">||</span> rf<span class="token punctuation">.</span>currentTerm <span class="token operator">==</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// DPrintf("COMIT Term[%d] [%d] It's matchIndex = %v", rf.currentTerm, rf.me, matchIndex)</span>
				<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"COMIT Term[%d] [%d] commitIndex [%d] -&gt; [%d] (leader action)"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>commitIndex<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
				rf<span class="token punctuation">.</span>IisBackIndex <span class="token operator">=</span> N
				rf<span class="token punctuation">.</span>commitIndex <span class="token operator">=</span> N
			<span class="token punctuation">}</span>
			rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éœ€è¦å¯†åˆ‡å…³æ³¨çš„ç»†èŠ‚æ˜¯ï¼š<br>if N &gt; rf.commitIndex &amp;&amp; (N &lt;= rf.lastIncludeIndex || <strong>rf.currentTerm == rf.log[rf.index2LogPos(N)].Term</strong>)</p>
<p>è®ºæ–‡ä¸­æœ‰æåˆ°</p>
<p><img src="/12.png" alt="å›¾ç‰‡"></p>
<p>commitIndexå°†è¦è¢«æ›´æ–°åˆ°çš„Nè¿™ä¸ªå€¼ï¼Œå…¶Termå¿…é¡»ç­‰äºleaderçš„currentTermï¼Œå¦åˆ™å°±ä¸èƒ½è¿›è¡Œæ›´æ–°ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºé¢†å¯¼äººä¸å¯ä»¥ç›´æ¥æäº¤ä»¥å‰ä»»æœŸçš„æ—¥å¿—ï¼Œåªæœ‰é¢†å¯¼äººè‡ªå·±å‘å‡ºå»çš„æ—¥å¿—è¢«å¤šæ•°followeråº”ç”¨ä¹‹åï¼Œä»–æ‰å¯ä»¥å°†CommitIndexæ›´æ–°åˆ°è¿™ä¸ªä»»æœŸè·Ÿè‡ªå·±åŒ¹é…çš„æ–°çš„indexï¼Œå¦åˆ™ä¼šå‘ç”Ÿæ•°æ®é”™ä¹±é—®é¢˜ã€‚</p>
<p>è¿™é‡Œè´´ä¸Šä¸­æ–‡è§£é‡Š</p>
<p><img src="/14.png" alt="å›¾ç‰‡"></p>
<p>è¿™æ˜¯ä¸ªæ¯”è¾ƒéšç§˜çš„è§„åˆ™ï¼Œå¾ˆå®¹æ˜“è¢«å¿½ç•¥ä»è€Œå¯¼è‡´æ•°æ®é”™ä¹±</p>
<hr>
<h3 id="Part-3C-persistence-hard"><a href="#Part-3C-persistence-hard" class="headerlink" title="Part 3C: persistence (hard)"></a>Part 3C: persistence (hard)</h3><p>æœ¬æ¬¡å®éªŒçš„ä»£ç é‡æœ€å°‘ï¼Œé˜…è¯»å®˜æ–¹å®éªŒæŒ‡å¯¼ï¼Œå®ƒæ˜ç¡®é“åœ¨æ¯ä¸€ä¸ªæŒä¹…åŒ–æˆå‘˜å‘ç”Ÿæ”¹å˜çš„æ—¶å€™è°ƒç”¨persistï¼ˆï¼‰å‡½æ•°è¿›è¡ŒæŒä¹…åŒ–å³å¯ã€‚</p>
<p>æ‰€è°“æŒä¹…åŒ–å°±æ˜¯å°†æ•°æ®è¯»åˆ°ç¡¬ç›˜ï¼ŒæœåŠ¡å™¨å´©æºƒåèƒ½ä»ç¡¬ç›˜ä¸­è¯»å–åˆ°æœ€è¿‘ä¸€æ¬¡æŒä¹…åŒ–çš„æ•°æ®ã€‚</p>
<p>ä»£ç å®ç°ç®€å•ï¼Œä½†å®ƒç¡®å®æ˜¯å¡æˆ‘ï¼ˆç›¸ä¿¡ä¹Ÿæ˜¯å¤§å¤šæ•°äººï¼‰æœ€ä¹…çš„Partï¼ŒåŸå› æ— å®ƒï¼Œæµ‹è¯•ä»£ç å¤ªå˜æ€äº†</p>
<p>è€Œå³ä½¿æ˜¯å¦‚æ­¤å˜æ€çš„Testç¯å¢ƒï¼Œä»ç„¶æ— æ³•å®Œå…¨æµ‹å‡ºå…³äºraftç®—æ³•çš„bugï¼Œè¿™ä¹Ÿæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œraftç®—æ³•æœ¬èº«å†å®Œå¤‡ï¼Œç»ç¨‹åºå‘˜å®ç°ä¸€æ‰‹ååˆå¤§ä¸ä¸€æ ·äº†</p>
<p>æœ¬æ¬¡å®éªŒæˆ‘æ‰€æ£€æŸ¥å‡ºçš„bugæœ‰è¿™äº›ï¼š</p>
<p>followeræŠ•å‡ºèµæˆç¥¨åå¿˜è®°æ›´æ–°å®šæ—¶å™¨äº†</p>
<p>è¿˜æœ‰ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„åŸå› ï¼šä¸€æ˜¯RPCå›å¤çš„é€Ÿåº¦å¤ªå¿«ï¼Œä»¥è‡³äºåŸæœ¬æœŸæœ›çš„Leaderå¹¶è¡ŒåŒæ—¶å‘é€å¤šä¸ªå¿ƒè·³RPCï¼Œç„¶åå†ä¸å—å¹²æ‰°çš„ä¸€ä¸ªä¸€ä¸ªå¤„ç†è¿”å›çš„RPCè¿™ç§æƒ…æ™¯å¯èƒ½ä¸ä¼šå‡ºç°ï¼Œå®é™…æƒ…å†µå¯èƒ½ä¼šå‡ºç°Leaderå‘é€äº†ç¬¬1ä¸ªRPCï¼Œç„¶åæ”¶åˆ°äº†å›å¤ï¼Œæ ¹æ®å›å¤è¿›è¡Œäº†å¤„ç†ï¼Œç„¶åå†ç»§ç»­å‘é€å‰©ä½™çš„å¿ƒè·³RPC</p>
<p>äºŒæ˜¯å‡½æ•°åµŒå¥—å¤ªå¤šï¼Œå¯¼è‡´æœ€å¤–å±‚çš„å‡½æ•°å¾ˆéš¾æ ¹æ®å†…å±‚å‡½æ•°çš„ç»“æœè¿›è¡Œå“åº”ï¼Œæ¯”å¦‚å†…å±‚å‡½æ•°æœ¬æ„æ˜¯æƒ³è¦ç»ˆæ­¢æœ€å¤–å±‚å‡½æ•°çš„æ•´ä¸ªæ“ä½œï¼Œäºæ˜¯å®ƒè¿›è¡Œäº†returnï¼Œä½†æ˜¯åªreturnäº†è‡ªå·±è¿™ä¸€å±‚ï¼Œå¤–å±‚å¾ªç¯è¿˜åœ¨ç»§ç»­</p>
<p>å‡è®¾leaderçš„Termæ¯”æ¥æ”¶è€…ä½ï¼Œä½†æ˜¯å®ƒåˆšä»ç½‘ç»œä¸­éš”ç¦»äº†æ‰€ä»¥ä¸çŸ¥é“ï¼Œç»§ç»­å‘é€å¸¦æœ‰æ—§Termçš„RPCï¼Œç”±äºleaderå¹¶è¡Œå‘é€å¤šä¸ªå¸¦æœ‰æ¡ç›®çš„RPCï¼Œä½†ä¸æ˜¯çœŸçš„å¹¶è¡Œï¼Œæ‰€ä»¥å‘é€å‰é¢çš„RPCä¸­ï¼Œleaderå¦‚æœåœ¨ä¸€ä¸ªå¿ƒè·³RPCçš„å“åº”ä¸­ï¼Œå‘ç°æ¥æ”¶è€…çš„ä»»æœŸæ¯”è‡ªå·±é«˜ï¼Œäºæ˜¯æ›´æ–°è‡ªå·±çš„ä»»æœŸï¼Œå¹¶è½¬å˜ä¸ºfollowerï¼Œä½†æ˜¯æ­¤æ—¶å¿ƒè·³å‘é€æµç¨‹å¹¶æ²¡æœ‰ç«‹åˆ»è¢«åœæ­¢ï¼Œåé¢è¿˜åœ¨ä¸åœçš„å‘é€RPCï¼Œå¹¶ä¸”ç”±äºå·²ç»æ›´æ–°åˆ°äº†æ–°ä»»æœŸï¼Œåé¢è¿™äº›RPCå°±çœŸçš„è¢«æ¥æ”¶è€…é‡‡ç”¨äº†ï¼Œä»è€Œå¯¼è‡´æ•°æ®é”™ä¹±</p>
<p>æœ¬æ¬¡å®éªŒéœ€è¦è¾ƒé•¿æ—¶é—´è¿›è¡Œdebugï¼Œçˆ±æŠ¤çœ¼ç›ï¼Œå†™å¥½è¯¦ç»†çš„logä¿¡æ¯ï¼Œç¥å„ä½debugæ„‰å¿«</p>
<h3 id="Part-3D-log-compaction-hard"><a href="#Part-3D-log-compaction-hard" class="headerlink" title="Part 3D: log compaction (hard)"></a>Part 3D: log compaction (hard)</h3><p>3Dè¦æ±‚å®ç°å¿«ç…§æœºåˆ¶ï¼Œç”±äºä¸æ­¢leaderå¯ä»¥è¿›è¡Œå¿«ç…§ï¼ŒfolloweråŒæ ·å¯ä»¥è‡ªè¡Œå¤‡ä»½å¿«ç…§ã€‚</p>
<p>å…³äºå¿ƒè·³æœºåˆ¶ä¸­æ—¥å¿—å¤åˆ¶çš„éƒ¨åˆ†ï¼Œè¿˜æœ‰leaderå’Œfolloweräº¤äº’è¿™éƒ¨åˆ†è¦è¿›è¡Œå¤§æ”¹ã€‚</p>
<p>å»ºè®®æ¯æ”¹åŠ¨ä¸€å¤„åœ°æ–¹å°±é©¬ä¸Šå†å»æµ‹ä¸€éABCçš„æµ‹è¯•ï¼Œå¦åˆ™åç»­å†debugä¸å ªè®¾æƒ³</p>
<h4 id="å¿«ç…§æµç¨‹"><a href="#å¿«ç…§æµç¨‹" class="headerlink" title="å¿«ç…§æµç¨‹"></a>å¿«ç…§æµç¨‹</h4><p>å‰é¢çš„å®éªŒä¸­ï¼Œleaderé€šè¿‡applychå°†è¢«åº”ç”¨çš„æ—¥å¿—å‘é€ç»™åº”ç”¨å±‚ï¼ˆä¸Šå±‚ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬lab4éœ€è¦å®ç°çš„kvRaftä¸­çš„kvserverå±‚ï¼‰</p>
<p>ä¸Šå±‚å®é™…ä¸Šå¹¶æ²¡æœ‰ä¸€æ¯”ä¸€ä¿å­˜è¿™äº›logï¼Œä¸Šå±‚è¦åšçš„æ˜¯è¯»å–logä¸­çš„æ“ä½œä¿¡æ¯ï¼Œå°†å…¶ä¸­çš„putï¼Œappendç­‰æ“ä½œåº”ç”¨åˆ°æ•°æ®åº“é‡Œï¼Œæ—¢ç„¶æ˜¯æ•°æ®åº“ï¼Œè‚¯å®šåŒ…å«äº†å¾ˆå¤šå¯¹åŒä¸€ä¸ªé”®å€¼å¯¹çš„æ“ä½œï¼Œè¿™äº›æ“ä½œæ˜¯å¯ä»¥å‹ç¼©çš„</p>
<p>å‡è®¾ä¸€ä¸ªä¾‹å­ï¼š</p>
<blockquote>
<p>ä¸Šå±‚æ•°æ®åº“<strong>åˆå§‹çŠ¶æ€</strong> ã€keyï¼š1ï¼Œvalueï¼šx 0 yã€‘</p>
<p>ä¸Šå±‚æ•°æ®åº“ä»raftå±‚çš„applychæŒ‰é¡ºåºæ”¶åˆ°ä¸€äº›æ“ä½œæ•°æ®åº“çš„logï¼š log1ã€putï¼Œ1ï¼Œx 10 yã€‘ï¼Œlog2ã€appendï¼Œ1ï¼Œx 11 yã€‘â€¦. log42ã€<strong>put</strong>ï¼Œ1ï¼Œx 100 yã€‘ï¼Œé€æ¡åº”ç”¨ï¼Œæœ€åæ˜¯ä¸€æ¡putå‘½ä»¤</p>
<p>ä¸Šå±‚æ•°æ®åº“log42åº”ç”¨åçš„æ•°æ®åº“æœ€æ–°çŠ¶æ€ã€keyï¼š1ï¼Œvalueï¼šx 100 yã€‘</p>
<p>ä¸Šå±‚æ•°æ®åº“å°†å½“å‰æ•°æ®åº“çš„çŠ¶æ€å¤åˆ¶ä¸€ä»½ï¼Œä¿å­˜åˆ°ç¡¬ç›˜é‡Œï¼Œè¿™ä»½å¤‡ä»½å°±æ˜¯<strong>æ•°æ®åº“å¿«ç…§</strong>ï¼Œä¹‹åæ— è®ºé‡å¯å¤šå°‘æ¬¡ï¼Œéƒ½è¯»å–è¿™ä»½å¿«ç…§ä½œä¸ºæœåŠ¡å™¨é‡å¯åçš„æ•°æ®åº“<strong>åˆå§‹çŠ¶æ€</strong></p>
<p>é‚£ä¹ˆå¾ˆæ˜¾ç„¶ï¼Œraftå±‚å°±å†ä¹Ÿä¸éœ€è¦å‘ä¸Šå±‚å‘é€log42ä¹‹å‰çš„å¿«ç…§ï¼Œè€Œä¸”ä¹Ÿä¸éœ€è¦ä¿å­˜å®ƒä»¬ï¼ˆé™¤äº†æŸäº›å¿…è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚lastInludeIndex,lastIncludeTermï¼‰</p>
</blockquote>
<p>è¿™å°±æ˜¯å¿«ç…§æœºåˆ¶,å‡å°‘raftå±‚åœ¨å†…å­˜å’Œç¡¬ç›˜ä¸­ä¿å­˜çš„logæ•°é‡ï¼ŒåŠ å¿«é‡å¯ååº”ç”¨å±‚(ä¸Šå±‚æ•°æ®åº“)æ¢å¤æ•°æ®åº“çš„é€Ÿåº¦</p>
<p>ç”±ä¸Šå±‚è°ƒç”¨çš„Snapshotï¼ˆï¼‰å‡½æ•°ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">Snapshot</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">,</span> snapshot <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your code here (3D).</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] ğŸ“·Snapshot ask to snap Index[%d] Raft log Len:[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">)</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	index <span class="token operator">-=</span> <span class="token number">1</span>
	<span class="token keyword">if</span> index <span class="token operator">&lt;=</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	compactLoglen <span class="token operator">:=</span> index <span class="token operator">-</span> rf<span class="token punctuation">.</span>lastIncludeIndex
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] AfterğŸ“·,lastIncludeIndex[%d]-&gt;[%d] lastIncludeTerm[%d]-&gt;[%d] len of Log-&gt;[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> index<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token operator">-</span>compactLoglen<span class="token punctuation">)</span>

	rf<span class="token punctuation">.</span>lastIncludeTerm <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term
	rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">=</span> index

	<span class="token comment">//å‹ç¼©æ—¥å¿—</span>
	afterLog <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LogType<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token operator">-</span>compactLoglen<span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>afterLog<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>compactLoglen<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	rf<span class="token punctuation">.</span>log <span class="token operator">=</span> afterLog
	<span class="token comment">//æŠŠsnapshotå’ŒraftstateæŒä¹…åŒ–</span>
	rf<span class="token punctuation">.</span>SnapshotDate <span class="token operator">=</span> snapshot
	rf<span class="token punctuation">.</span>persister<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span><span class="token function">persistWithSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“·Cmi Term[%d] [%d] ğŸ“¦Save snapshot to application[%d] (Receive from up Application)"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>persister<span class="token punctuation">.</span>snapshot<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2024æ–°ç‰ˆlabæœ€å‘çš„ä¸€ç‚¹æ¥äº†ï¼Œrf.persister.SaveåŒæ—¶ä¿å­˜raftStateå’Œsnapshot</p>
<p>åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œå®éªŒæŒ‡å¯¼ç»™ç¬¬äºŒä¸ªå‚æ•°èµ‹å€¼nilï¼Œä½†æ˜¯åœ¨lab3Dä¸­ï¼Œä»»ä½•ä¸€å¤„rf.persister.Save(rf.persistWithSnapshot(), nil)éƒ½ä¼šå°†å·²ä¿å­˜çš„snapshotæ•°æ®<strong>å®Œå…¨åˆ æ‰</strong>ï¼Œå¾ˆå‘ï¼Œéå¸¸å‘</p>
<p>å› ä¸ºå¿«ç…§æœºåˆ¶ï¼Œleaderä¼šå°†indexå‰çš„æ‰€æœ‰logåˆ å¹²å‡€ï¼Œé‚£å¦‚æœå‘ç”Ÿæ—¥å¿—å›é€€äº†ï¼ŒnextIndexä¸€ç›´å›é€€åˆ°ç­‰äºlog42åŠä¹‹å‰æ€ä¹ˆåŠå‘¢</p>
<p>åœ¨è¿™ç§æƒ…å†µï¼Œæ ¹æ®è®ºæ–‡ï¼Œæˆ‘ä»¬éœ€è¦leaderä¸»åŠ¨å°†è‡ªå·±çš„å¿«ç…§å‘é€è¿‡å»ï¼Œè¦†ç›–æ‰è¿™ä¸ªè½åfollowrçš„å¿«ç…§ï¼Œç„¶åleaderå¯¹äºè¿™ä¸ªfollowerçš„matchIndexè‡³å°‘ä¹Ÿæ˜¯42äº†ï¼Œåç»­å†å‘ç”Ÿæ—¥å¿—å›é€€ï¼Œä¹Ÿä¸å¯èƒ½å›é€€åˆ°42ï¼Œå› ä¸ºå‘é€è¿‡å¿«ç…§çš„ç¼˜æ•…ä¸¤è€…ä¹‹é—´çš„æ—¥å¿—åœ¨42å¤„ä¸€å®šæ˜¯åŒ¹é…çš„</p>
<p>leaderå‘é€å¿«ç…§ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">sendInstallSnapshotToPeerId</span><span class="token punctuation">(</span>server <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// DPrintf("SNAPS Term[%d] [%d] goSendğŸ“·Wait for a lockğŸ¤¨ to [%d],", rf.currentTerm, rf.me, server)</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	args <span class="token operator">:=</span> <span class="token operator">&amp;</span>SnapshotInstallArgs<span class="token punctuation">{</span><span class="token punctuation">}</span>
	args<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>currentTerm
	args<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> rf<span class="token punctuation">.</span>me
	args<span class="token punctuation">.</span>LastIncludeIndex <span class="token operator">=</span> rf<span class="token punctuation">.</span>lastIncludeIndex
	args<span class="token punctuation">.</span>LastIncludeTerm <span class="token operator">=</span> rf<span class="token punctuation">.</span>lastIncludeTerm
	args<span class="token punctuation">.</span>Data <span class="token operator">=</span> rf<span class="token punctuation">.</span>SnapshotDate
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] goSendğŸ“· to [%d] args.LastIncludeIndex[%d],args.LastIncludeTerm[%d],len of snapshot[%d],"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> server<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeTerm<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">)</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">*</span>SnapshotInstallArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		reply <span class="token operator">:=</span> <span class="token operator">&amp;</span>SnapshotInstallreplys<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token keyword">if</span> rf<span class="token punctuation">.</span><span class="token function">sendInstallSnapshot</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> rf<span class="token punctuation">.</span>currentTerm <span class="token operator">!=</span> args<span class="token punctuation">.</span>Term <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> reply<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
				rf<span class="token punctuation">.</span>state <span class="token operator">=</span> follower
				rf<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
				rf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> reply<span class="token punctuation">.</span>Term
				rf<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
				rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] leader success to Send a ğŸ“· to [%d] nextIndex for it [%d] -&gt; [%d] matchIndex [%d] -&gt; [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> server<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">)</span>
			rf<span class="token punctuation">.</span>nextIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
			rf<span class="token punctuation">.</span>matchIndex<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>LastIncludeIndex
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>followeræ¥å—å¿«ç…§ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">InstallSnapshot</span><span class="token punctuation">(</span>args <span class="token operator">*</span>SnapshotInstallArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>SnapshotInstallreplys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] ReceivğŸ“· from[%d] lastIncludeIndex[%d] lastIncludeTerm[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LeaderId<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeTerm<span class="token punctuation">)</span>

	reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>currentTerm

	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] rejectğŸ“· for it's Term[%d] [too old]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
		rf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> args<span class="token punctuation">.</span>Term
		rf<span class="token punctuation">.</span>state <span class="token operator">=</span> follower
		rf<span class="token punctuation">.</span>votedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		rf<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	rf<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> args<span class="token punctuation">.</span>LeaderId
	rf<span class="token punctuation">.</span>lastHearBeatTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> args<span class="token punctuation">.</span>LastIncludeIndex <span class="token operator">&lt;=</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> args<span class="token punctuation">.</span>LastIncludeIndex <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Term <span class="token operator">!=</span> args<span class="token punctuation">.</span>LastIncludeTerm <span class="token punctuation">{</span>
				rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LogType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// leftLog := make([]LogType, rf.lastIndex()-args.LastIncludeIndex)</span>
				<span class="token comment">// copy(leftLog, rf.log[rf.index2LogPos(rf.lastIncludeIndex+1):])</span>
				<span class="token comment">// rf.log = leftLog</span>
				rf<span class="token punctuation">.</span>log <span class="token operator">=</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>rf<span class="token punctuation">.</span><span class="token function">index2LogPos</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>LastIncludeIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			rf<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LogType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"SNAPS Term[%d] [%d] AcceptğŸ“· Now it's lastIncludeIndex [%d] -&gt; [%d] lastIncludeTerm [%d] -&gt; [%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">,</span> args<span class="token punctuation">.</span>LastIncludeTerm<span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"snaps Term[%d] [%d] after snapshot log:"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">)</span>

	rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">=</span> args<span class="token punctuation">.</span>LastIncludeIndex
	rf<span class="token punctuation">.</span>lastIncludeTerm <span class="token operator">=</span> args<span class="token punctuation">.</span>LastIncludeTerm

	i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">10</span>
	<span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		i <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"Term[%d] [%d] index[%d] value[%v]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> i<span class="token operator">+</span>rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>log<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“·Cmi Term[%d] [%d] ğŸ“¦Save snapshot to application[%d] (Receive from leader)"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>persister<span class="token punctuation">.</span>snapshot<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//snapshotæäº¤ç»™åº”ç”¨å±‚</span>
	applyMsg <span class="token operator">:=</span> ApplyMsg<span class="token punctuation">{</span>
		SnapshotValid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		Snapshot<span class="token punctuation">:</span>      args<span class="token punctuation">.</span>Data<span class="token punctuation">,</span>
		SnapshotIndex<span class="token punctuation">:</span> rf<span class="token punctuation">.</span>lastIncludeIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//è®°å¾—è¿™é‡Œæœ‰ä¸ªå‘</span>
		SnapshotTerm<span class="token punctuation">:</span>  rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//å¿«ç…§æäº¤ç»™äº†application</span>
	rf<span class="token punctuation">.</span>lastApplied <span class="token operator">=</span> rf<span class="token punctuation">.</span>lastIncludeIndex
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“·Cmi Term[%d] [%d] Ready to commit snapshot snapshotIndex[%d] snapshotTerm[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">)</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rf<span class="token punctuation">.</span>applyChTerm <span class="token operator">&lt;-</span> applyMsg
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//æŒä¹…åŒ–å¿«ç…§</span>
	rf<span class="token punctuation">.</span>SnapshotDate <span class="token operator">=</span> args<span class="token punctuation">.</span>Data
	rf<span class="token punctuation">.</span>persister<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span><span class="token function">persistWithSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>Data<span class="token punctuation">)</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ğŸ“·Cmi Term[%d] [%d] Done Success to comit snapshot snapshotIndex[%d] snapshotTerm[%d]"</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeIndex<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>lastIncludeTerm<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”±äºæ—¥å¿—ä¼šå› ä¸ºå¿«ç…§è¢«åˆ é™¤ï¼Œæ‰€ä»¥logåœ¨logsæ•°ç»„ä¸­çš„ä½ç½®å‘ç”Ÿäº†é”™è¯¯ï¼Œå…·ä½“æ¥è¯´ï¼šrealPos = index - lastIncludeIndex - 1</p>
<p>è¿™å°±æ˜¯æˆ‘å®ç°Lab3 Raftçš„ä¸»è¦æ€è·¯äº†ï¼Œå®é™…å®ç°çš„æ—¶å€™è¿˜æœ‰å¾ˆå¤šå…¶ä»–ç»†èŠ‚éœ€è¦è€ƒè™‘ï¼Œç•™ç»™è¯»è€…è‡ªè¡Œä½“éªŒäº†</p>
<p><img src="/8.png" alt="æµ‹è¯•å›¾"></p>
<p><img src="/15.png" alt="å¤šæ¬¡æµ‹è¯•å›¾"></p>

  </article>
  <!-- tag -->
  <div class="mt-12 pt-6 border-t border-gray-200">
    
      
        <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 m-1 text-sm rounded-md transition-colors hover:bg-gray-200">
          <a href="/tags/MIT6-5840/">MIT6.5840</a>
        </span>
      
    
  </div>
  <!-- prev and next -->
  <div class="flex justify-between mt-12 pt-6 border-t border-gray-200">
    <div>
      
        <a href="/2024/04/05/mit65840lab4shixian/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          <iconify-icon width="20" icon="ri:arrow-left-s-line" data-inline="false"></iconify-icon>
          MIT6.5840 Lab4 Getæ— æ—¥å¿—å®ç°
        </a>
      
    </div>
    <div>
      
        <a href="/2024/04/04/mit65840lab2shixian/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          MIT6.5840 Lab2 å®ç°
          <iconify-icon width="20" icon="ri:arrow-right-s-line" data-inline="false"></iconify-icon>
        </a>
      
    </div>
  </div>
  <!-- comment -->
  <div class="article-comments mt-12">
    

  </div>
</section>
<!-- js inspect -->

<script src="/lib/clipboard.min.js"></script>


<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>



<script src="/lib/fancybox/fancybox.umd.min.js"></script>

<script>
  $(document).ready(() => {
    $('.post-content').each(function(i){
      $(this).find('img').each(function(){
        if ($(this).parent().hasClass('fancybox') || $(this).parent().is('a')) return;
        var alt = this.alt;
        if (alt) $(this).after('<span class="fancybox-alt">' + alt + '</span>');
        $(this).wrap('<a class="fancybox-img" href="' + this.src + '" data-fancybox=\"gallery\" data-caption="' + alt + '"></a>')
      });
      $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article' + i);
      });
    });

    Fancybox.bind('[data-fancybox="gallery"]', {
        // options
    })
  })
</script>

<!-- tocbot begin -->

<script src="/lib/tocbot/tocbot.min.js"></script>

<script>
  $(document).ready(() => {
      tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.post-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });
  })
</script>
<!-- tocbot end -->


  </main>
  <footer class="flex flex-col h-40 items-center justify-center text-gray-400 text-sm">
  <!-- busuanzi -->
  
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- Busuanzi Analytics -->
<div class="flex items-center gap-2">
  <span>Visitors</span>
  <span id="busuanzi_value_site_uv"></span>
  <span>Page Views</span>
  <span id="busuanzi_value_site_pv"></span>
</div>
<!-- End Busuanzi Analytics -->


  <!-- copyright -->
  <div class="flex items-center gap-2">
    <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: inherit;">CC BY-NC-SA 4.0</a>
    <span>Â© 2022</span>
    <iconify-icon width="18" icon="emojione-monotone:maple-leaf" ></iconify-icon>
    <a href="https://github.com/xbmlz" target="_blank" rel="noopener noreferrer">xbmlz</a>
  </div>
  <!-- powered by -->
  <div class="flex items-center gap-2">
    <span>Powered by</span>
    <a href="https://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a>
    <span>&</span>
    <a href="https://github.com/xbmlz/hexo-theme-maple" target="_blank" rel="noopener noreferrer">Maple</a>
  </div>

</footer>

  <div class="back-to-top box-border fixed right-6 z-1024 -bottom-20 rounded py-1 px-1 bg-slate-900 opacity-60 text-white cursor-pointer text-center dark:bg-slate-600">
    <span class="flex justify-center items-center text-sm">
      <iconify-icon width="18" icon="ion:arrow-up-c" id="go-top"></iconify-icon>
      <span id="scrollpercent"><span>0</span> %</span>
    </span>
  </div>
  
<script src="/js/main.js"></script>


  <script>
    $(document).ready(function () {
      const mapleCount = "10";
      const speed = "0.5";
      const mapleEl = document.getElementById("maple");
      const maples = Array.from({ length: mapleCount }).map(() => {
        const maple = document.createElement("div");
        const scale = Math.random() * 0.5 + 0.5;
        const offset = Math.random() * 2 - 1;
        const x = Math.random() * mapleEl.clientWidth;
        const y = -Math.random() * mapleEl.clientHeight;
        const duration = 10 / speed;
        const delay = -duration;
        maple.className = "maple";
        maple.style.width = `${24 * scale}px`;
        maple.style.height = `${24 * scale}px`;
        maple.style.left = `${x}px`;
        maple.style.top = `${y}px`;
        maple.style.setProperty("--maple-fall-offset", offset);
        maple.style.setProperty("--maple-fall-height", `${Math.abs(y) + mapleEl.clientHeight}px`);
        maple.style.animation = `fall ${duration}s linear infinite`;
        maple.style.animationDelay = `${delay}s`;
        mapleEl.appendChild(maple)
        return maple
      })
    });
  </script>
  


  <div class="fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden" id="maple"></div>
</body>

</html>
